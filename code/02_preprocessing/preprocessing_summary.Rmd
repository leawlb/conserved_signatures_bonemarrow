---
title: "preprocessing_report"
author: "Amy Danson, Lea WÃ¶lbert"
date: '2022-09-20'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Summary report QC for all objects at once.
Some operations from the scripts must be repeated to generate relevant plots,
but any new objects cannot be saved from an .Rmd script.

#### Load libraries, source code 

```{r load,  message = FALSE}

library(SingleCellExperiment, quietly = TRUE) 
library(DropletUtils, quietly = TRUE) 
library(tidyverse, quietly = TRUE) 
library(scater, quietly = TRUE) 
library(scuttle, quietly = TRUE) 
library(scran, quietly = TRUE) 

```

```{r load_code, message = FALSE}

source(file = "../source/colors.R")

sce_02_path <- snakemake@input[["sce_02_path"]]
#sce_03_path <- snakemake@input[["sce_03_path"]]
#sce_04_path <- snakemake@input[["sce_04_path"]]
#sce_05_path <- snakemake@input[["sce_05_path"]]

metadata <- read.csv(file = snakemake@params[["metadata"]], 
                     head = TRUE, 
                     sep = ",", 
                     check.names=FALSE, 
                     stringsAsFactors=FALSE, 
                     as.is=TRUE, 
                     colClasses = "character")

targets <- snakemake@params[["targets"]]

nr_hvgs <- snakemake@params[["nr_hvgs"]]
cutoff_sum <- snakemake@params[["cutoff_sum"]]
cutoff_detected <- snakemake@params[["cutoff_detected"]]

```

# QC

Check Quality per sample.

```{r}

sce_list_02 <- list()
#print(paste0(sce_02_path, "/sce_", targets[1]))

for(i in targets){
  #print(paste0(sce_02_path, "/sce_", i, "-02"))
  sce_list_02[[i]] <- readRDS(file = paste0(sce_02_path, "/sce_", i, "-02"))

}

qcdf_list_02 <- lapply(sce_list_02, function(sce){
  
  sce$Keep_sample <- rep("TRUE", ncol(sce))
  
  if(metadata$Keep_sample[which(metadata$Object_ID == sce$Object_ID[1])[1]] == FALSE){
    sce$Keep_sample <- rep("FALSE", ncol(sce))
  }
  
  qcdf <- perCellQCMetrics(sce)
  qcdf$Object_ID <- sce$Object_ID
  qcdf$Species_ID <- sce$Species_ID
  qcdf$Age <- sce$Age
  qcdf$Batch_exp_day <- sce$Batch_exp_day
  qcdf$Batch_sequencing <- sce$Batch_sequencing
  qcdf$Date_collected <- sce$Date_collected
  qcdf$Species <- sce$Species
  qcdf$Fraction <- sce$Fraction
  qcdf$Keep_sample <- sce$Keep_sample

return(qcdf)
})

qcdf_gg <- DataFrame()

for(i in qcdf_list_02){
  qcdf_gg <- rbind(qcdf_gg, i)
}
qcdf_gg <- data.frame(qcdf_gg)

# by Sample
ggplot(qcdf_gg, aes(x = Object_ID, y = sum, color = Keep_sample))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 100000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 
  

ggplot(qcdf_gg, aes(x = Object_ID, y = detected, color = Keep_sample))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 15000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected)) 

# by Species_ID
ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Species_ID, y = sum,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 100000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Species_ID, y = detected,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 15000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected)) 

# by Age
ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Age, y = sum,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 100000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Age, y = detected,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 15000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected)) 

# by Fraction
ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Fraction, y = sum,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 100000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Fraction, y = detected,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 15000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected)) 

# by Batch_exp_day
ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Batch_exp_day, y = sum,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 100000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Batch_exp_day, y = detected,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 15000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected))

# by Batch_sequencing
ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Batch_sequencing, y = sum,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 100000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Batch_sequencing, y = detected,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 15000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected))

# by Date_collected
ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Date_collected, y = sum,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 100000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg[qcdf_gg$Keep_sample == TRUE,], aes(x = Date_collected, y = detected,))+
  ggbeeswarm::geom_quasirandom(alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 15000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected))

```

```{r}
sessionInfo()
```
