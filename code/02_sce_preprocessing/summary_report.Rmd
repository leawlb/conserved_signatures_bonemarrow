---
title: "preprocessing_report"
author: "Amy Danson, Lea WÃ¶lbert"
date: '2022-09-20'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Summary report QC for all objects at once.
Some operations from the scripts must be repeated to generate relevant plots,
but any new objects cannot be saved from an .Rmd script.

#### Load libraries, source code 

```{r load,  message = FALSE}

library(SingleCellExperiment, quietly = TRUE) 
library(DropletUtils, quietly = TRUE) 
library(tidyverse, quietly = TRUE) 
library(scater, quietly = TRUE) 
library(scuttle, quietly = TRUE) 
library(scran, quietly = TRUE) 

```

```{r load_code, message = FALSE}

source(file = "../source/colors.R")

sce_02_path <- snakemake@input[["sce_02_path"]]
#sce_03_path <- snakemake@input[["sce_03_path"]]
sce_04_path <- snakemake@input[["sce_04_path"]]
#sce_05_path <- snakemake@input[["sce_05_path"]]

targets <- snakemake@params[["targets"]]

nr_hvgs <- snakemake@params[["nr_hvgs"]]
cutoff_sum <- snakemake@params[["cutoff_sum"]]
cutoff_detected <- snakemake@params[["cutoff_detected"]]

```

# QC

Check Quality per sample.

```{r}

sce_list_02 <- list()
#print(paste0(sce_02_path, "/sce_", targets[1]))

for(i in targets){
  #print(paste0(sce_02_path, "/sce_", i, "-02"))
  sce_list_02[[i]] <- readRDS(file = paste0(sce_02_path, "/sce_", i, "-02"))
}

qcdf_list_02 <- lapply(sce_list_02, function(sce){
  qcdf <- perCellQCMetrics(sce)
  qcdf$Object_ID <- sce$Object_ID
  qcdf$Species_ID <- sce$Species_ID
  qcdf$Age <- sce$Age
  qcdf$Batch_exp_day <- sce$Batch_exp_day
  qcdf$Batch_sequencing <- sce$Batch_sequencing
  qcdf$Date_collected <- sce$Date_collected
  qcdf$Species <- sce$Species
  qcdf$Fraction <- sce$Fraction

return(qcdf)
})

qcdf_gg <- DataFrame()

for(i in qcdf_list_02){
  qcdf_gg <- rbind(qcdf_gg, i)
}
qcdf_gg <- data.frame(qcdf_gg)

# by Sample
ggplot(qcdf_gg, aes(x = Object_ID, y = sum))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 80000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 
  

ggplot(qcdf_gg, aes(x = Object_ID, y = detected))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 40000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected)) 

# by Species_ID
ggplot(qcdf_gg, aes(x = Species_ID, y = sum))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 80000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg, aes(x = Species_ID, y = detected))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 40000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected)) 

# by Age
ggplot(qcdf_gg, aes(x = Age, y = sum))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 80000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg, aes(x = Age, y = detected))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 40000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected)) 

# by Fraction
ggplot(qcdf_gg, aes(x = Fraction, y = sum))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 80000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg, aes(x = Fraction, y = detected))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 40000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected)) 

# by Batch_exp_day
ggplot(qcdf_gg, aes(x = Batch_exp_day, y = sum))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 80000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg, aes(x = Batch_exp_day, y = detected))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 40000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected))

# by Batch_sequencing
ggplot(qcdf_gg, aes(x = Batch_sequencing, y = sum))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 80000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg, aes(x = Batch_sequencing, y = detected))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 40000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected))

# by Date_collected
ggplot(qcdf_gg, aes(x = Date_collected, y = sum))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 80000))+
  geom_abline(intercept = cutoff_sum, color = marker1,  slope = 0)+
  ggtitle(paste("cutoff sum = ", cutoff_sum)) 

ggplot(qcdf_gg, aes(x = Date_collected, y = detected))+
  ggbeeswarm::geom_quasirandom(color = "grey80", alpha = 0.5, size = 0.1)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 40000))+
  geom_abline(intercept = cutoff_detected, color = marker1, slope = 0)+
  ggtitle(paste("cutoff detected = ", cutoff_detected))

```

# Merging

Merge the objects WITHOUT any normalization and/or correction steps, 
re-calculate PCA, HVGs and UMAP to visualize basic overlap of samples.

```{r}

sce_list_04 <- list()

for(i in targets){
  sce_list_04[[i]] <- readRDS(file = paste0(sce_04_path, "/sce_", i, "-04"))
}

# get genes shared by all objects
rownames_list <- lapply(sce_list_04, function(sce){
  rownames <- rownames(sce)
  return(rownames)
})
shared_genes <- Reduce(intersect, rownames_list)

# subset all objects by shared_genes
sce_list_04 <- lapply(sce_list_04, function(sce){
  sce <- sce[rownames(sce) %in% shared_genes,]
  return(sce)
})

# add individual sample name to barcodes to avoid random doublets
sce_list_04 <- lapply(sce_list_04, function(sce){
  colnames(sce) <- paste0(colnames(sce), "_", sce$Object_ID)
  return(sce)
})

sce_list_04

```


```{r}

# cbind to merge multiple objects
for(i in 1:length(sce_list_04)){
  if(i == 1){
    sce_all <- sce_list_04[[i]]
  }else{
    sce_all <- cbind(sce_all, sce_list_04[[i]])
  }
}

# mcar
#targets_mcar <- targets[grep("mcar", targets)] # other species for later

#mcas
#targets_mcas <- targets[grep("mcas", targets)]

# mmus
targets_mmus <- targets[grep("mmus", targets)]
sce_list_mmus <- sce_list_04[targets_mmus]
for(i in 1:length(sce_list_mmus)){
  if(i == 1){
    sce_mmus <- sce_list_mmus[[i]]
  }else{
    sce_mmus <- cbind(sce_mmus, sce_list_mmus[[i]])
  }
} 

#mspr
#targets_mspr <- targets[grep("mspr", targets)]

merged_list <- list(sce_all, sce_mmus)

merged_list

```

```{r}

merged_list <- lapply(merged_list, function(sce){
  genevar <- modelGeneVar(sce)
  hvg <- getTopHVGs(genevar, n=nr_hvgs)

  # reduce dimensions
  sce <- runPCA(sce, ncomponents=25, subset_row = hvg) 
  sce <- runUMAP(sce, dimred = 'PCA', external_neighbors=TRUE,  
                 subset_row = hvg)
    
  return(sce)

})

merged_list

```

```{r}

make_plots <- function(sce, title){
  
  plot_1 <- plotUMAP(sce, colour_by = "Object_ID")+ 
    ggtitle(title)+
    theme(legend.key.size = unit(0.3, "cm"), legend.key.width = unit(0.3, "cm"))+
    theme(legend.spacing = unit(0.06, "cm"), legend.text = element_text(size = 7))

  plot_2 <- plotUMAP(sce, colour_by = "Species_ID")+ 
    ggtitle(title)+
    theme(legend.key.size = unit(0.3, "cm"), legend.key.width = unit(0.3, "cm"))+
    theme(legend.spacing = unit(0.06, "cm"), legend.text = element_text(size = 7))

  plot_3 <- plotUMAP(sce, colour_by = "Age")+ 
    ggtitle(title)+
    theme(legend.key.size = unit(0.3, "cm"), legend.key.width = unit(0.3, "cm"))+
    theme(legend.spacing = unit(0.06, "cm"), legend.text = element_text(size = 7))

  plot_4 <- plotUMAP(sce, colour_by = "Fraction")+ 
    ggtitle(title)+
    theme(legend.key.size = unit(0.3, "cm"), legend.key.width = unit(0.3, "cm"))+
    theme(legend.spacing = unit(0.06, "cm"), legend.text = element_text(size = 7))
  
  plot_5 <- plotUMAP(sce, colour_by = "Batch_exp_day")+ 
    ggtitle(title)+
    theme(legend.key.size = unit(0.3, "cm"), legend.key.width = unit(0.3, "cm"))+
    theme(legend.spacing = unit(0.06, "cm"), legend.text = element_text(size = 7))

  plot_6 <- plotUMAP(sce, colour_by = "Batch_sequencing")+ 
    ggtitle(title)+
    theme(legend.key.size = unit(0.3, "cm"), legend.key.width = unit(0.3, "cm"))+
    theme(legend.spacing = unit(0.06, "cm"), legend.text = element_text(size = 7))
  
  plot_7 <- plotUMAP(sce, colour_by = "Date_collected")+ 
    ggtitle(title)+
    theme(legend.key.size = unit(0.3, "cm"), legend.key.width = unit(0.3, "cm"))+
    theme(legend.spacing = unit(0.06, "cm"), legend.text = element_text(size = 7))

  return(list(plot_1, plot_2, plot_3, plot_4, plot_5, plot_6, plot_7))
  
}

plot_list_all <- make_plots(merged_list[[1]], title = "all merged")
plot_list_mmus <- make_plots(merged_list[[2]],title = "mmus merged")

```

```{r}
plot_list_all 
```

```{r}
plot_list_mmus
```


```{r}

# testing purposes

#sce_05_path <- "/omics/groups/OE0538/internal/users/l012t/Interspecies_BM_phd/data/02_preprocessing/dimr"
#targets <- c("mmus_old_hsc_1_0", "mmus_old_hsc_2_0", "mmus_old_str_2_0", "mmus_old_str_1_0")

#cutoff_detected = 300
#cutoff_sum = 400
#nr_hvgs = 2000
#marker1 = "dodgerblue3"

```

```{r}
sessionInfo()
```
