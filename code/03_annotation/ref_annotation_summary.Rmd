---
title: "preprocessing_report"
author: "Amy Danson, Lea WÃ¶lbert"
date: '2022-09-20'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Summary report on cell type annotation and quality for all objects at once.

#### Load libraries, source code 

```{r load,  message = FALSE}

library(SingleCellExperiment, quietly = TRUE) 
library(DropletUtils, quietly = TRUE) 
library(tidyverse, quietly = TRUE) 
library(scater, quietly = TRUE) 
library(scuttle, quietly = TRUE) 
library(scran, quietly = TRUE) 

```

```{r load_code, message = FALSE}

sce_06_path <- snakemake@input[["sce_06_path"]]
samples_to_remove <- snakemake@params[["samples_to_remove"]] # samples to exclude from merging
individuals <- snakemake@params[["individuals"]]
species <- snakemake@params[["species"]]

```

# QC

### Preparation

```{r}

sce_list_06 <- list()

print(paste0(sce_06_path, "/", "species", "/sce_", "individual", "-06"))
for(s in species){
  for(i in individuals){
    if(grepl(s, i) == TRUE){
      sce_list_06[[i]] <- readRDS(file = paste0(sce_06_path, "/", s, "/sce_", i, "-06"))
    }
  }
}

sce_list_06 <- sce_list_06[names(sce_list_06)[!names(sce_list_06) %in% samples_to_remove]]

```

Use only Baccin et al dataset because it's the only one containing both
stromal and hematopoetic cell types in a single dataset.

```{r}

hsc_cts <- c(
  "B cell",
  "Dendritic cells",
  "Eo/Baso prog.",
  "Ery prog.",
  "Ery/Mk prog.",
  "Erythroblasts",
  "Gran/Mono prog.",
  "LMPPs",
  "Mk prog.",
  "Mono prog.",
  "Monocytes",
  "NK cells",
  "Neutro prog.",
  "Neutrophils",
  "T cells",
  "large pre-B.",
  "pro-B",
  "small pre-B."
)

str_cts <- c(
  "Adipo-CAR",
  "Arteriolar ECs",
  "Arteriolar fibro.",
  "Chondrocytes",
  "Endosteal fibro.",
  "Fibro/Chondro p.",
  "Myofibroblasts",
  "Ng2+ MSCs",
  "Osteo-CAR",
  "Osteoblasts",
  "Schwann cells",
  "Sinusoidal ECs",
  "Smooth muscle",
  "Stromal fibro."
)

# add to sce objects
sce_list_06 <- lapply(sce_list_06, function(sce){
  sce$right_fraction <- rep("TRUE", n = ncol(sce))
  name_curr <- colData(sce)$Object_ID[1] 
  
  if(grepl("str", name_curr)){
    wrong_pos <- which(sce$Identity_ref_all %in% hsc_cts)
    sce$right_fraction[wrong_pos] <- "FALSE"
  }else if(grepl("hsc", name_curr)){
    wrong_pos <- which(sce$Identity_ref_all %in% str_cts)
    sce$right_fraction[wrong_pos] <- "FALSE"
  }  
  return(sce)
})

```

Identify all mature cells.

```{r}

hsc_mature_cts <- c(
  "B cell",
  "Dendritic cells",
  "Monocytes",
  "small pre-B.",
  "T cells",
  "NK cells",
  "Neutrophils",
  "large pre-B"
)

sce_list_06 <- lapply(sce_list_06, function(sce){
  sce$mature_cells <- rep("FALSE", n = ncol(sce))
  sce$mature_cells[sce$Identity_ref_all %in% hsc_mature_cts] <- "TRUE"
  return(sce)
})

```

## All cells after QC

Check Quality per sample in a large overview.

```{r fig.width = 14}

qcdf_list_06 <- lapply(sce_list_06, function(sce){
  
  qcdf <- perCellQCMetrics(sce)
  qcdf$Object_ID <- sce$Object_ID
  qcdf$Species_ID <- sce$Species_ID
  qcdf$Age <- sce$Age
  qcdf$Batch_exp_day <- sce$Batch_exp_day
  qcdf$Batch_sequencing <- sce$Batch_sequencing
  qcdf$Date_collected <- sce$Date_collected
  qcdf$Species <- sce$Species
  qcdf$Fraction <- sce$Fraction
  qcdf$right_fraction <- sce$right_fraction
  qcdf$mature_cells <- sce$mature_cells
  qcdf$Identity_ref_all <- sce$Identity_ref_all
  qcdf$Identity_ref_fraction1 <- sce$Identity_ref_fraction1
  qcdf$Identity_ref_fraction2 <- sce$Identity_ref_fraction2
  
  return(qcdf)
})

qcdf_gg <- DataFrame()

for(i in qcdf_list_06){
  qcdf_gg <- rbind(qcdf_gg, i)
}
qcdf_gg <- data.frame(qcdf_gg)

# by Sample
ggplot(qcdf_gg, aes(x = Object_ID, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()

ggplot(qcdf_gg, aes(x = Object_ID, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()

# by Age and Species
ggplot(qcdf_gg, aes(x = Age, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg$Species))

ggplot(qcdf_gg, aes(x = Age, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg$Species))

# by Fraction and Species
ggplot(qcdf_gg, aes(x = Fraction, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg$Species))

ggplot(qcdf_gg, aes(x = Fraction, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg$Species))

# by Age and Fraction
ggplot(qcdf_gg, aes(x = Age, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg$Fraction))

ggplot(qcdf_gg, aes(x = Age, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg$Fraction))

# by Batch experimental day
ggplot(qcdf_gg, aes(x = Batch_exp_day, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()

ggplot(qcdf_gg, aes(x = Batch_exp_day, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()

# by Batch sequencing
ggplot(qcdf_gg, aes(x = Batch_sequencing, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()

ggplot(qcdf_gg, aes(x = Batch_sequencing, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()

# by Cell type
ggplot(qcdf_gg, aes(x = Identity_ref_all, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()

ggplot(qcdf_gg, aes(x = Identity_ref_all, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()


```

## Without contaminants

```{r fig.width = 14}

ggplot(qcdf_gg[qcdf_gg$right_fraction == TRUE,], aes(x = Object_ID, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()

ggplot(qcdf_gg[qcdf_gg$right_fraction == TRUE,], aes(x = Object_ID, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()

```

## Without mature cells

```{r fig.width = 14}

ggplot(qcdf_gg[qcdf_gg$mature_cells == FALSE,], aes(x = Object_ID, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()

ggplot(qcdf_gg[qcdf_gg$mature_cells == FALSE,], aes(x = Object_ID, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()

```

## Without either

```{r fig.width = 14}

remove_pos <- as.logical(qcdf_gg$mature_cells) | !as.logical(qcdf_gg$right_fraction)
table(qcdf_gg$mature_cells)
table(qcdf_gg$right_fraction)
table(remove_pos)

qcdf_gg <- qcdf_gg[!remove_pos,]

ggplot(qcdf_gg, aes(x = Object_ID, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()

ggplot(qcdf_gg, aes(x = Object_ID, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()

# by Age and Species
ggplot(qcdf_gg, aes(x = Age, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg$Species))

ggplot(qcdf_gg, aes(x = Age, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg$Species))

# by Fraction and Species
ggplot(qcdf_gg, aes(x = Fraction, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg$Species))

ggplot(qcdf_gg, aes(x = Fraction, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg$Species))

# by Cell type
ggplot(qcdf_gg, aes(x = Identity_ref_all, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()

ggplot(qcdf_gg, aes(x = Identity_ref_all, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()

ggplot(qcdf_gg, aes(x = Identity_ref_fraction1, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()

ggplot(qcdf_gg, aes(x = Identity_ref_fraction1, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()

ggplot(qcdf_gg, aes(x = Identity_ref_fraction2, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()

ggplot(qcdf_gg, aes(x = Identity_ref_fraction2, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()


# per species
ggplot(qcdf_gg[qcdf_gg$Species == "mcar",], 
       aes(x = Identity_ref_fraction2, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  ggtitle("mcar")

ggplot(qcdf_gg[qcdf_gg$Species == "mcar",], 
       aes(x = Identity_ref_fraction2, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()+
  ggtitle("mcar")

ggplot(qcdf_gg[qcdf_gg$Species == "mcas",], 
       aes(x = Identity_ref_fraction2, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  ggtitle("mcas")

ggplot(qcdf_gg[qcdf_gg$Species == "mcas",], 
       aes(x = Identity_ref_fraction2, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()+
  ggtitle("mcas")

ggplot(qcdf_gg[qcdf_gg$Species == "mmus",], 
       aes(x = Identity_ref_fraction2, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  ggtitle("mmus")

ggplot(qcdf_gg[qcdf_gg$Species == "mmus",], 
       aes(x = Identity_ref_fraction2, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()+
  ggtitle("mmus")

ggplot(qcdf_gg[qcdf_gg$Species == "mspr",], 
       aes(x = Identity_ref_fraction2, y = sum))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  ggtitle("mspr")

ggplot(qcdf_gg[qcdf_gg$Species == "mspr",], 
       aes(x = Identity_ref_fraction2, y = detected))+
  ggbeeswarm::geom_quasirandom(size = 0.1, color = "grey60")+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 10000))+
  scale_y_log10()+
  ggtitle("mspr")


```

