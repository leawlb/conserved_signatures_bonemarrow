---
title: "integration_report"
author: "Amy Danson, Lea WÃ¶lbert"
date: '2022-10-12'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Summary report for data integration.

#### Load libraries, source code 

```{r load,  message = FALSE}

library(DropletUtils, quietly = TRUE) 
library(tidyverse, quietly = TRUE) 
library(scater, quietly = TRUE) 
library(scuttle, quietly = TRUE) 
library(scran, quietly = TRUE) 

```

```{r load_code, message = FALSE}

source(file = "../source/colors.R")

sce_06_path <- snakemake@input[["sce_06_path"]] # before renormalization
sce_07_path <- snakemake@input[["sce_07_path"]] # after renormalization, before correction
sce_08mnn_path <- snakemake@input[["sce_08mnn_path"]] # after correctMNN correction

nr_hvgs <- snakemake@params[["nr_hvgs"]]
species_all <- snakemake@params[["species_all"]]
batches <- snakemake@params[["batches"]]

print(nr_hvgs)
print(species_all)
print(batches)

```

# Before batch correction

Merge the objects WITHOUT any normalization and/or correction steps, 
re-calculate PCA, HVGs and UMAP to visualize basic overlap of samples.

```{r}

sce_list_06 <- list()
for(s in species_all){
  print(paste0(sce_06_path, "/sce_", s, "-06"))
  sce_list_06[[i]] <- readRDS(file = paste0(sce_06_path, "/sce_", s, "-06"))
}

sce_list_07 <- list()
for(s in species_all){
  print(paste0(sce_07_path, "/sce_", s, "-07"))
  sce_list_07[[i]] <- readRDS(file = paste0(sce_07_path, "/sce_", s, "-07"))
}

sce_list_08mnn <- list()
for(s in species_all){
  for(b in batches){
    if(exists(b)){
      print(paste0(sce_08mnn_path, "/sce_", s, "_correctedby_", b, "-08"))
      sce_list_08mnn[[i]] <- readRDS(file = paste0(sce_08mnn_path, 
                                                   "/sce_",
                                                   s, 
                                                   "_correctedby_", 
                                                   b, 
                                                   "-08"))
    }
  }
}

print(sce_list_06)
print(sce_list_07)
print(sce_list_08mnn)

```

```{r}

reduce_dims_all <- function(sce){
  
  # hvgs first
  hvgs <- modelGeneVar(prepd_sce)
  hvgs <- getTopHVGs(hvgs, n=nr_hvgs)
  
  if(!"corrected" %in% reducedDimNames(mmus)){ # corrected doesn't need PCs
    sce <- runPCA(sce, ncomponents=25, subset_row = hvgs) 
  }
  
  sce <- runUMAP(sce, dimred = 'PCA', external_neighbors=TRUE, subset_row = hvgs)

  return(sce)  
}

sce_list_06 <- reduce_dims_all(sce_list_06)
sce_list_07 <- reduce_dims_all(sce_list_07)
sce_list_08mnn <- reduce_dims_all(sce_list_08mnn)

print(sce_list_06)
print(sce_list_07)
print(sce_list_08mnn)
```

