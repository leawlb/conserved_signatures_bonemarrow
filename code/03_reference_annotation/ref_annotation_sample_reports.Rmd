---
title: "ref_annotation_report"
author: "Lea WÃ¶lbert"
date: '2022-11-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Load libraries, source code 

```{r load,  message = FALSE}

library(SingleCellExperiment, quietly = TRUE) 
library(DropletUtils, quietly = TRUE) 
library(tidyverse, quietly = TRUE) 
library(scater, quietly = TRUE) 
library(scuttle, quietly = TRUE) 
library(scran, quietly = TRUE) 

```

```{r load_object, message = FALSE}

sce <- readRDS(file = snakemake@input[["sce_06"]])
nr_hvgs <- snakemake@params[["nr_hvgs"]]
color_tables <- snakemake@params[["color_tables"]]

# set name for plots
name_curr <- colData(sce)$Object_ID[1] # choose name to display in plots

```


```{r load_code, message = FALSE}

source(file = "../source/colors.R")
source(file = "../source/plotting.R")
source(file = "../source/sce_functions.R")

col_cts_all <- col_cts[names(col_cts) %in% sce$Identity_ref_all]
col_cts_fraction1 <- col_cts[names(col_cts) %in% sce$Identity_ref_fraction1]
col_cts_fraction2 <- col_cts[names(col_cts) %in% sce$Identity_ref_fraction2]

```

## Cell types

### Reduce dimensions

```{r}

sce <- reduce_dims(sce, nr_hvgs = nr_hvgs) # own function

```


### All Identities

```{r fig.width=8}

plot_1 <- umap_base(sce, color_by = "Identity_ref_all")+ # own function
  ggtitle(name_curr)+
  scale_color_manual("Identity1", values = col_cts_all)
plot_1l <- umap_legend(sce, color_by = "Identity_ref_all")+
  scale_color_manual("Identity1", values = col_cts_all)
legend_1 <- get_legend(plot_1l)

plot_2 <- umap_base(sce, color_by = "Identity_ref_fraction1")+ 
  ggtitle(name_curr)+
  scale_color_manual("Identity2", values = col_cts_fraction1)
plot_2l <- umap_legend(sce, color_by = "Identity_ref_fraction1")+
  scale_color_manual("Identity2", values = col_cts_fraction1)
legend_2 <- get_legend(plot_2l)

plot_3 <- umap_base(sce, color_by = "Identity_ref_fraction2")+ 
  ggtitle(name_curr)+
  scale_color_manual("Identity3", values = col_cts_fraction2)
plot_3l <- umap_legend(sce, color_by = "Identity_ref_fraction2")+
  scale_color_manual("Identity3", values = col_cts_fraction2)
legend_3 <- get_legend(plot_3l)

PLOT_1 <- ggarrange(plot_1, legend_1)
PLOT_2 <- ggarrange(plot_2, legend_2)
PLOT_3 <- ggarrange(plot_3, legend_3)

PLOT_1
PLOT_2
PLOT_3

```

## Contamination vs. correct cell types vs mature cell types

### Contamination

Use only Baccin et al dataset because it's the only one containing both
stromal and hematopoetic cell types in a single dataset.

```{r}

# find contamination in sce objects

if(grepl("str", name_curr)){
  sce <- find_contamination_ref_all(sce, input = "stromal") # own function
}else if(grepl("hsc", name_curr)){
  sce <- find_contamination_ref_all(sce, input = "hsc") # own function
}

```

```{r fig.width=8}

if(grepl("TRUE", sce$right_fraction)){
  plot_4 <- umap_base(sce, color_by = "right_fraction")+
    ggtitle(name_curr)+
    scale_color_manual("Correct fraction", values = c("TRUE" = "black", 
                                                      "FALSE" = "orange"))
  plot_4l <- umap_legend(sce, color_by = "right_fraction")+
    scale_color_manual("Correct fraction", values = c("TRUE" = "black", 
                                                      "FALSE" = "orange"))
  legend_4 <- get_legend(plot_4l)

  PLOT_4 <- ggarrange(plot_4, legend_4)
  PLOT_4
}

```

```{r fig.width=8}

qcdf <- perCellQCMetrics(sce)
sce$sum <- qcdf$sum
sce$detected <- qcdf$detected

plot_5 <- umap_base(sce, color_by = "detected")+
  ggtitle(name_curr)+
  scale_color_gradientn("Number of detected genes", 
                         limits = c(0, 10000),
                         colors = c("black", "darkorange3", 
                                    "orange", "lightgoldenrod"))+
  ggtitle("With contaminants")
plot_5l <- umap_legend(sce, color_by = "detected")+
  scale_color_gradientn("Number of detected genes", 
                         limits = c(0, 10000),
                        
                         colors = c("black", "darkorange3", "orange", "lightgoldenrod"))
legend_5 <- get_legend(plot_5l)

PLOT_5 <- ggarrange(plot_5, legend_5)
PLOT_5

plot_6 <- umap_base(sce, color_by = "sum")+
  ggtitle(name_curr)+
  scale_color_gradientn("Library size", 
                         limits = c(0, 100000),
                         colors = c("black", "darkorange4", 
                                    "darkorange3", "darkorange1",
                                    "orange", "orange", "gold1", "gold",
                                    "lightgoldenrod", "lightgoldenrod", 
                                    "lightgoldenrod", "lightgoldenrod", 
                                    "lightgoldenrod", "lightgoldenrod"))+
  ggtitle("With contaminants")
plot_6l <- umap_legend(sce, color_by = "sum")+
  scale_color_gradientn("Library size", 
                         limits = c(0, 1000000),
                          colors = c("black", "darkorange4", 
                                     "darkorange3", "darkorange1",
                                    "orange", "orange", "gold1", "gold",
                                    "lightgoldenrod", "lightgoldenrod", 
                                    "lightgoldenrod", "lightgoldenrod", 
                                    "lightgoldenrod", "lightgoldenrod"))
legend_6 <- get_legend(plot_6l)

PLOT_6 <- ggarrange(plot_6, legend_6)
PLOT_6


```

```{r fig.width=8}

if(grepl("TRUE", sce$right_fraction)){
  sce_wo <- sce[,sce$right_fraction == TRUE]

  qcdf_wo <- perCellQCMetrics(sce_wo)
  sce_wo$sum <- qcdf_wo$sum
  sce_wo$detected <- qcdf_wo$detected

  plot_7 <- umap_base(sce_wo, color_by = "detected")+
    ggtitle(name_curr)+
    scale_color_gradientn("Number of detected genes", 
                           limits = c(0, 10000),
                           colors = c("black", "darkorange3", 
                                      "orange", "lightgoldenrod"))+
  ggtitle("Without contaminants")
  plot_7l <- umap_legend(sce_wo, color_by = "detected")+
    scale_color_gradientn("Number of detected genes", 
                           limits = c(0, 10000),
                           colors = c("black", "darkorange3",
                                      "orange", "lightgoldenrod"))
  legend_7 <- get_legend(plot_7l)

  PLOT_7 <- ggarrange(plot_7, legend_7)
  PLOT_7
  
  plot_8 <- umap_base(sce_wo, color_by = "sum")+
    ggtitle(name_curr)+
    scale_color_gradientn("Library size", 
                           limits = c(0, 100000),
                           colors = c("black", "darkorange4",
                                      "darkorange3", "darkorange1",
                                      "orange", "orange", "gold1", "gold",
                                      "lightgoldenrod", "lightgoldenrod", 
                                      "lightgoldenrod", "lightgoldenrod", 
                                      "lightgoldenrod", "lightgoldenrod"))+
    ggtitle("Without contaminants")
  plot_8l <- umap_legend(sce_wo, color_by = "sum")+
    scale_color_gradientn("Library size", 
                           limits = c(0, 1000000),
                            colors = c("black", "darkorange4",
                                       "darkorange3", "darkorange1",
                                       "orange", "orange", "gold1", "gold",
                                       "lightgoldenrod", "lightgoldenrod", 
                                       "lightgoldenrod", "lightgoldenrod", 
                                       "lightgoldenrod", "lightgoldenrod"))
  legend_8 <- get_legend(plot_8l)

  PLOT_8 <- ggarrange(plot_8, legend_8)
  PLOT_8
}

```

### Mature cells

```{r}

sce <- get_mature_cts_all(sce) # own function 

```

```{r fig.width=8}

plot_4 <- umap_base(sce, color_by = "mature_cells")+
  ggtitle(name_curr)+
  scale_color_manual("Mature cells", values = c("FALSE" = "black", 
                                                    "TRUE" = "orange"))
plot_4l <- umap_legend(sce, color_by = "mature_cells")+
  ggtitle(name_curr)+
  scale_color_manual("Mature cells", values = c("FALSE" = "black", 
                                                    "TRUE" = "orange"))
legend_4 <- get_legend(plot_4l)

PLOT_4 <- ggarrange(plot_4, legend_4)
PLOT_4

```

```{r}

qcdf <- perCellQCMetrics(sce)
sce$sum <- qcdf$sum
sce$detected <- qcdf$detected

plot_5 <- umap_base(sce, color_by = "detected")+
  ggtitle(name_curr)+
  scale_color_gradientn("Number of detected genes", 
                         limits = c(0, 10000),
                         colors = c("black", "darkorange3", 
                                    "orange", "lightgoldenrod"))+
  ggtitle("With mature cell types")
plot_5l <- umap_legend(sce, color_by = "detected")+
  scale_color_gradientn("Number of detected genes", 
                         limits = c(0, 10000),
                         colors = c("black", "darkorange3", 
                                    "orange", "lightgoldenrod"))
legend_5 <- get_legend(plot_5l)

PLOT_5 <- ggarrange(plot_5, legend_5)
PLOT_5

plot_6 <- umap_base(sce, color_by = "sum")+
  ggtitle(name_curr)+
  scale_color_gradientn("Library size", 
                         limits = c(0, 100000),
                         colors = c("black", "darkorange4", 
                                    "darkorange3", "darkorange1",
                                    "orange", "orange", "gold1", "gold",
                                    "lightgoldenrod", "lightgoldenrod", 
                                    "lightgoldenrod", "lightgoldenrod", 
                                    "lightgoldenrod", "lightgoldenrod"))+
  ggtitle("With mature cell types")
plot_6l <- umap_legend(sce, color_by = "sum")+
  scale_color_gradientn("Library size", 
                         limits = c(0, 1000000),
                          colors = c("black", "darkorange4", "darkorange3", "darkorange1",
                                    "orange", "orange", "gold1", "gold",
                                    "lightgoldenrod", "lightgoldenrod", 
                                    "lightgoldenrod", "lightgoldenrod", 
                                    "lightgoldenrod", "lightgoldenrod"))
legend_6 <- get_legend(plot_6l)

PLOT_6 <- ggarrange(plot_6, legend_6)
PLOT_6


```

```{r}

sce_wo <- sce[,sce$mature_cells == FALSE]

qcdf_wo <- perCellQCMetrics(sce_wo)
sce_wo$sum <- qcdf_wo$sum
sce_wo$detected <- qcdf_wo$detected

plot_7 <- umap_base(sce_wo, color_by = "detected")+
  ggtitle(name_curr)+
  scale_color_gradientn("Number of detected genes", 
                         limits = c(0, 10000),
                         colors = c("black", "darkorange3", 
                                    "orange", "lightgoldenrod"))+
  ggtitle("Without contaminants")
plot_7l <- umap_legend(sce_wo, color_by = "detected")+
  scale_color_gradientn("Number of detected genes", 
                         limits = c(0, 10000),
                         colors = c("black", "darkorange3", 
                                    "orange", "lightgoldenrod"))
legend_7 <- get_legend(plot_7l)

PLOT_7 <- ggarrange(plot_7, legend_7)
PLOT_7

plot_8 <- umap_base(sce_wo, color_by = "sum")+
  ggtitle(name_curr)+
  scale_color_gradientn("Library size", 
                         limits = c(0, 100000),
                         colors = c("black", "darkorange4", 
                                    "darkorange3", "darkorange1",
                                    "orange", "orange", "gold1", "gold",
                                    "lightgoldenrod", "lightgoldenrod", 
                                    "lightgoldenrod", "lightgoldenrod", 
                                    "lightgoldenrod", "lightgoldenrod"))+
  ggtitle("Without contaminants")
plot_8l <- umap_legend(sce_wo, color_by = "sum")+
  scale_color_gradientn("Library size", 
                         limits = c(0, 1000000),
                          colors = c("black", "darkorange4", 
                                     "darkorange3", "darkorange1",
                                     "orange", "orange", "gold1", "gold",
                                     "lightgoldenrod", "lightgoldenrod", 
                                     "lightgoldenrod", "lightgoldenrod", 
                                     "lightgoldenrod", "lightgoldenrod"))
legend_8 <- get_legend(plot_8l)

PLOT_8 <- ggarrange(plot_8, legend_8)
PLOT_8

```

## Cell numbers

All cells

```{r}

table(sce$Identity_ref_all)
table(sce$Identity_ref_fraction1)
table(sce$Identity_ref_fraction2)

```

Without contamination

```{r}

if(grepl("TRUE", sce$right_fraction)){
  table(sce[,sce$right_fraction == TRUE]$Identity_ref_all)
  table(sce[,sce$right_fraction == TRUE]$Identity_ref_fraction1)
  table(sce[,sce$right_fraction == TRUE]$Identity_ref_fraction2)
}else{
  print("only contaminants")
}
```

Only contamination

```{r}

table(sce[,sce$right_fraction == FALSE]$Identity_ref_all)
table(sce[,sce$right_fraction == FALSE]$Identity_ref_fraction1)
table(sce[,sce$right_fraction == FALSE]$Identity_ref_fraction2)

```


### Cell type overlap

The percentage of cells per Haas cell type that is assigned another
identity with another dataset.

#### In Identity 1

```{r}

ggdf <- data.frame(colData(sce))

plot1a <- ggplot(ggdf, aes(x = Identity_ref_all, y=Identity_ref_fraction1,
                           fill=Identity_ref_fraction1, 
                           color = Identity_ref_fraction1))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("Identity2", values = col_cts_fraction1)+
  scale_color_manual(values = col_cts_fraction1)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity1")

plot_frc1 <- ggplot(ggdf, aes(x = Identity_ref_all, y=Identity_ref_fraction1,
                                 fill=Identity_ref_fraction1))+
  geom_col()+
  scale_fill_manual("Identity2", values = col_cts_fraction1)
legend_frc1 <- get_legend(plot_frc1)

plot1b <- ggplot(ggdf, aes(x = Identity_ref_all,
                           fill=Identity_ref_fraction1, 
                           color = Identity_ref_fraction1))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("Identity2", values = col_cts_fraction1)+
  scale_color_manual(values = col_cts_fraction1)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity1")

plot2a <- ggplot(ggdf, aes(x = Identity_ref_all, y=Identity_ref_fraction2,
                          fill=Identity_ref_fraction2, 
                          color = Identity_ref_fraction2))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("Identity3", values = col_cts_fraction2)+
  scale_color_manual(values = col_cts_fraction2)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity1")

plot2b <- ggplot(ggdf, aes(x = Identity_ref_all,
                           fill=Identity_ref_fraction2, 
                           color = Identity_ref_fraction2))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("Identity3", values = col_cts_fraction2)+
  scale_color_manual(values = col_cts_fraction2)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity1")

plot_frc2 <- ggplot(ggdf, aes(x = Identity_ref_all, y=Identity_ref_fraction2,
                                 fill=Identity_ref_fraction2))+
  geom_col()+
  scale_fill_manual("Identity3", values = col_cts_fraction2)
legend_frc2 <- get_legend(plot_frc2)

PLOT1a <- ggarrange(plot1a, legend_frc1, ncol = 1)
PLOT1b <- ggarrange(plot1b, legend_frc1, ncol = 1)
PLOT2a <- ggarrange(plot2a, legend_frc2, ncol = 1)
PLOT2b <- ggarrange(plot2b, legend_frc2, ncol = 1)

```

```{r fig.width=10, fig.height = 11}
PLOT1a
PLOT1b
PLOT2a
PLOT2b
```

#### In Identity 2

```{r}

plot1a <- ggplot(ggdf, aes(x = Identity_ref_fraction1, y=Identity_ref_all,
                           fill=Identity_ref_all, 
                           color = Identity_ref_all))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("Identity1", values = col_cts_all)+
  scale_color_manual(values = col_cts_all)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity2")

plot1b <- ggplot(ggdf, aes(x = Identity_ref_fraction1, 
                           fill=Identity_ref_all, 
                           color = Identity_ref_all))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("Identity1", values = col_cts_all)+
  scale_color_manual(values = col_cts_all)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity2")

plot_all <- ggplot(ggdf, aes(x = Identity_ref_fraction1, y=Identity_ref_all,
                                 fill=Identity_ref_all))+
  geom_col()+
  scale_fill_manual("Identity1", values = col_cts_all)
legend_all <- get_legend(plot_all)


plot2a <- ggplot(ggdf, aes(x = Identity_ref_fraction1, y=Identity_ref_fraction2,
                           fill=Identity_ref_fraction2, 
                           color = Identity_ref_fraction2))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("Identity3", values = col_cts_fraction2)+
  scale_color_manual(values = col_cts_fraction2)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity2")

plot2b <- ggplot(ggdf, aes(x = Identity_ref_fraction1,
                           fill=Identity_ref_fraction2, 
                           color = Identity_ref_fraction2))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("Identity3", values = col_cts_fraction2)+
  scale_color_manual(values = col_cts_fraction2)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity2")

PLOT1a <- ggarrange(plot1a, legend_all, ncol = 1)
PLOT1b <- ggarrange(plot1b, legend_all, ncol = 1)
PLOT2a <- ggarrange(plot2a, legend_frc2, ncol = 1)
PLOT2b <- ggarrange(plot2b, legend_frc2, ncol = 1)

```

```{r fig.width=10, fig.height = 11}
PLOT1a
PLOT1b
PLOT2a
PLOT2b
```

#### In Identity 3

```{r}

plot1a <- ggplot(ggdf, aes(x = Identity_ref_fraction2, y=Identity_ref_all,
                           fill=Identity_ref_all, 
                           color = Identity_ref_all))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("Identity1", values = col_cts_all)+
  scale_color_manual(values = col_cts_all)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity3")

plot1b <- ggplot(ggdf, aes(x = Identity_ref_fraction2,
                           fill=Identity_ref_all, 
                           color = Identity_ref_all))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("Identity1", values = col_cts_all)+
  scale_color_manual(values = col_cts_all)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity3")

plot2a <- ggplot(ggdf, aes(x = Identity_ref_fraction2, y=Identity_ref_fraction1,
                           fill=Identity_ref_fraction1, 
                           color = Identity_ref_fraction1))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("Identity2", values = col_cts_fraction1)+
  scale_color_manual(values = col_cts_fraction1)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity3")

plot2b <- ggplot(ggdf, aes(x = Identity_ref_fraction2, 
                           fill=Identity_ref_fraction1, 
                           color = Identity_ref_fraction1))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("Identity2", values = col_cts_fraction1)+
  scale_color_manual(values = col_cts_fraction1)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(name_curr)+
  xlab("Identity3")

PLOT1a <- ggarrange(plot1a, legend_all, ncol = 1)
PLOT1b <- ggarrange(plot1b, legend_all, ncol = 1)
PLOT2a <- ggarrange(plot2a, legend_frc1, ncol = 1)
PLOT2b <- ggarrange(plot2b, legend_frc1, ncol = 1)

```

```{r fig.width=10, fig.height = 11}
PLOT1a
PLOT1b
PLOT2a
PLOT2b
```

```{r}
sessionInfo()
```

