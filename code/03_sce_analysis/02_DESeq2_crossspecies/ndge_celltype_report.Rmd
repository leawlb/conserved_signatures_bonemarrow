---
title: "Species nDGE report"
author: "Lea WÃ¶lbert"
date: '2023-11-07'
output: html_document
---

Report on nDGE results at cell type level (annotated).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Load objects

```{r seed, message = FALSE}
set.seed(37)
```

```{r load, message = FALSE}
library(EnhancedVolcano)
```

```{r source, message = FALSE}
source(file = snakemake@params[["plotting"]])
```

```{r load_objects}

fc_cutoff <- snakemake@params[["fc_cutoff"]]
padj_cutoff <- snakemake@params[["padj_cutoff"]]

sce <- base::readRDS(snakemake@input[["sce_input"]])
celltype <- snakemake@wildcards[["celltype"]]

# alter celltypes to fit the wildcards for subsetting
sce$celltypes_alt <- sce$celltypes
sce$celltypes_alt <- gsub(" ", "_", sce$celltypes_alt)
sce$celltypes_alt <- gsub("/", "_", sce$celltypes_alt)
sce$celltypes_alt <- gsub("[.]", "", sce$celltypes_alt)

sce_ct <- sce[,which(sce$celltypes_alt == celltype)]
ct_curr <- sce_ct$celltypes[1]
print(ct_curr)
```

```{r load_subset}
celltype_res_list <- base::readRDS(snakemake@input[["celltype_res"]])
celltype_res_list_orig <- base::readRDS(snakemake@input[["celltype_res_orig"]])
shared_gene_list <- base::readRDS(snakemake@input[["celltype_res_list_shared"]])
shared_gene_list_orig <- base::readRDS(snakemake@input[["celltype_res_list_shared_orig"]])

# subset objects to required cluster and fractions
celltype_res_list <- celltype_res_list[[ct_curr]]
shared_gene_list_ct <- shared_gene_list[[ct_curr]]
```

# Show Pval distributions

```{r}
see_pvals <- function(celltype_res, comparison){
  plot1 <- EnhancedVolcano::EnhancedVolcano(celltype_res, 
                                            lab = "",
                                            x = 'log2FoldChange',
                                            y = 'pvalue', 
                                            col = c("grey70",
                                                    "grey70", 
                                                    "dodgerblue3",
                                                    "grey70"),
                                            subtitle = "",
                                            colAlpha = 0.9, 
                                            pointSize = 0.5,
                                            pCutoff = padj_cutoff,
                                            FCcutoff = fc_cutoff)+
    ggplot2::theme_classic()+
    ggplot2::ggtitle(paste(comparison))+
    ggplot2::theme(legend.position="none", 
                   plot.subtitle = element_blank())

  print(plot1)
}
```

## MMUS MCAS

```{r}
print(celltype_res_list[["mmus-mcas"]])
res_df_comb_mmus_mcas <- celltype_res_list[["mmus-mcas"]]
see_pvals(celltype_res = res_df_comb_mmus_mcas, comparison = "mmus-mcas")
```

## MMUS MSPR

```{r}
res_df_comb_mmus_mspr <- celltype_res_list[["mmus-mspr"]]
see_pvals(celltype_res = res_df_comb_mmus_mspr, comparison = "mmus-mspr")
```

## MMUS MCAR

```{r}
res_df_comb_mmus_mcar <- celltype_res_list[["mmus-mcar"]]
see_pvals(celltype_res = res_df_comb_mmus_mcar, comparison = "mmus-mcar")
```

## MCAS MSPR

```{r}
res_df_comb_mcas_mspr <- celltype_res_list[["mcas-mspr"]]
see_pvals(celltype_res = res_df_comb_mcas_mspr, comparison = "mcas-mspr")
```

## MCAS MCAR

```{r}
res_df_comb_mcas_mcar <- celltype_res_list[["mcas-mcar"]]
see_pvals(celltype_res = res_df_comb_mcas_mcar, comparison = "mcas-mcar")
```

## MSPR MCAR

```{r}
res_df_comb_mspr_mcar <- celltype_res_list[["mspr-mcar"]]
see_pvals(celltype_res = res_df_comb_mspr_mcar, comparison = "mspr-mcar")
```

# Print lists

If possible, compare if nDGE results are the same for clusters/cell types
which have not been subclustered.

```{r}
if(!ct_curr %in% subclustered){
  print(identical(celltype_res_list, celltype_res_list))
  print(identical(shared_gene_list_ct$all, shared_gene_list_ct$all))
  print(identical(shared_gene_list_ct$at_least_three,
                  shared_gene_list_ct$at_least_three))
}
```


```{r}
print(ct_curr)
print(shared_gene_list_ct$all)
print(shared_gene_list_ct$at_least_three)
```

```{r}
utils::sessionInfo()
```