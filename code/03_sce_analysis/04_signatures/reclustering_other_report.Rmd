---
title: "Reclustering of datasets from other species"
author: "Lea WÃ¶lbert"
date: '2024-04-15'
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Report on datasets from other species that were re-clustered using:

- random genes
- conserved signature genes
- conserved marker genes

#### Load objects

```{r seed, message = FALSE}
set.seed(37)
```

```{r source, message = FALSE}
#source(file = snakemake@params[["plotting"]])
#source(file = snakemake@params[["reclustering_function"]])
```

```{r load, message = FALSE}
library(Seurat, quietly = TRUE)
library(tidyverse, quietly = TRUE)
# library(mclust, quietly = TRUE)
# library(mcclust, quietly = TRUE)
# library(bluster, quietly = TRUE)
# library(cluster, quietly = TRUE)
# library(dendextend, quietly = TRUE)
```

```{r eval = FALSE, include = FALSE}

base_path <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/04_rcls/"

seu_list_all <- readRDS(paste0(base_path, "reclustered_zeb_all_hspc_list"))

seu_list_all <- readRDS(paste0(base_path, "reclustered_ts_bone_marrow_list"))

seu_list_all <- readRDS(paste0(base_path, "reclustered_ts_all_stromal_list"))
seu_list_all <- readRDS(paste0(base_path, "reclustered_li_all_stromal_list"))


colors_path <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data/metadata/colors/colors.txt"
source("../../source/colors.R")
source("../../source/plotting.R")
source("../../source/sce_functions_reclustering.R")

wildcard_curr <- "zeb_all_hspc"


for(i in 1:length(seu_list_all$seu_sign)){
  seu_list_all$seu_sign[[i]]@meta.data$cell_type <- seu_list_all$seu_sign[[i]]@meta.data$manually_annotated_ct
}

col_cts <- col_cts_hsc
```

```{r load_objects}
seu_list_all <- base::readRDS(snakemake@input[["seu_list"]])
score_df_list_all <- base::readRDS(snakemake@input[["score_df_list"]])

dataset_curr <- snakemake@wildcards[["dataset"]]
```

```{r nr_cts}
nr_celltypes <- length(base::unique(seu_list_all[[1]][[1]]$cell_type))
print(nr_celltypes)
```

## Functions

### Plotting from seurat object

#### Wide

Cell types on y axis.
Proportions of cells of a cluster per cell type.

```{r wide_function, include = FALSE }

vis_perc_wide_gg <- function(seu, correction_vec = NULL, title_add= NULL){
  
  mat <- base::table(seu$cell_type, seu$seurat_clusters)
  
  mat1 <- mat/rowSums(mat)*100
  if(!is.null(correction_vec)){
    mat1 <- mat1[,correction_vec]
  }
  
  df_vis <- base::as.data.frame(mat1)
  df_vis$Var1 <- factor(df_vis$Var1, levels = base::rev(levels(seu$cell_type)))
  
  plot_wide <- ggplot2::ggplot(df_vis, aes(y = Var1, x = Var2, fill= Freq))+ 
    ggplot2::geom_tile()+
    ggplot2::scale_fill_continuous("% cells/cell type", 
                                   limits = c(0, 100), 
                                   breaks = seq(0, 100,by = 20),
                                   low = "white",
                                   high = "blue")+
    ggplot2::theme_classic()+
    ggplot2::theme(axis.text.x = element_text(angle=0),
                   axis.ticks = element_blank(),
                   legend.position = "none")+
    ggplot2::xlab("new clusters")+
    ggplot2::ylab("original cell types")+
    ggplot2::ggtitle(base::paste("resolution", 
                                 seu@misc$resolution[1], 
                                 title_add))
  
  return(plot_wide)
}
```

#### Long

Cell types on x axis.
Proportion of cells of a cell type per cluster.

```{r long_function, include = FALSE}
vis_perc_long_gg <- function(seu, correction_vec = NULL, title_add= NULL){
  
  mat <- t(base::table(seu$cell_type, seu$seurat_clusters))
  
  mat2 <- mat/rowSums(mat)*100
  
  if(!is.null(correction_vec)){
    mat2 <- mat2[correction_vec,]
  }
  
  df_vis <- base::as.data.frame(mat2)
  df_vis$Var2 <- factor(df_vis$Var2, levels = levels(seu$cell_type))

  plot_long <- ggplot2::ggplot(df_vis, aes(y = Var1, x = Var2, fill= Freq))+ 
    ggplot2::geom_tile()+
    ggplot2::scale_fill_continuous("% cells/cluster", 
                                   limits = c(0, 100),
                                   breaks = seq(0, 100, by = 20),
                                   low = "white", 
                                   high = "blue")+
    ggplot2::theme_classic()+
    ggplot2::theme(axis.ticks = element_blank(),
                   legend.position = "none",
                   axis.text.x = element_text(angle = 60,
                                              vjust = 1, 
                                              hjust = 1))+
    ggplot2::ylab("new clusters")+
    ggplot2::xlab("original cell types")+
    ggplot2::ggtitle(base::paste("resolution", seu@misc$resolution[1], title_add))

  return(plot_long)
}
```

```{r vis_per_cluster, include = FALSE}
# heatmap vis
# vis_perc_cluster <- function(seu, correction_vec = NULL, title_add= NULL){
#   
#   mat <- t(base::table(seu$cell_type, seu$seurat_clusters))
#   
#   mat2 <- mat/rowSums(mat)*100
#   
#   if(!is.null(correction_vec)){
#     mat2 <- mat2[correction_vec,]
#   }
#   
#   df_vis <- base::as.data.frame(mat2)
#   df_vis$Var2 <- factor(df_vis$Var2, levels = levels(seu$cell_type))
# 
#   plot_long <- ggplot2::ggplot(df_vis, aes(x = Var2, y = Var1, fill= Freq))+ 
#     ggplot2::geom_tile()+
#     ggplot2::scale_fill_continuous("% cells/cluster", 
#                                    limits = c(0, 100),
#                                    breaks = seq(0, 100, by = 20),
#                                    low = "white", 
#                                    high = "blue")+
#     ggplot2::theme_classic()+
#     ggplot2::theme(axis.ticks = element_blank(),
#                    legend.position = "none",
#                    axis.text.x = element_text(angle = 60, 
#                                               vjust = 1, 
#                                               hjust = 1))+
#     ggplot2::ylab("new clusters")+
#     ggplot2::xlab("original cell types")+
#     ggplot2::ggtitle(base::paste("resolution", seu@misc$resolution[1], title_add))
# 
#   return(plot_long)
# }
```

```{r values, include = FALSE}
# get_reclustering_mat <- function(seu){
#   
#   mat <- base::table(seu$cell_type, seu$seurat_clusters)
# 
#   mat1_raw <- mat
#   prop_in_ct <- mat1_raw/BiocGenerics::rowSums(mat1_raw)
# 
#   mat2_raw <- t(mat)
#   prop_in_clust <- mat2_raw/BiocGenerics::rowSums(mat2_raw)
# 
#   # get the average of both values for each field
#   mat_val <- (t(prop_in_ct) + prop_in_clust)/2
#   return(mat_val)
# }

# get_reclustering_scores <- function(resolution, df_list, seu_list){
#   
#   mat <- mat_list[[resolution]]
#   seu <- seu_list[[resolution]]
#   
#   # extract which nr is higher; nr of clusters or number of cell types
#   if(nrow(mat) >= ncol(mat)){
#     max_nr <- nrow(mat)
#   }else if(nrow(mat) < ncol(mat)){
#     max_nr <- ncol(mat)
#   }
#   
#   # get the proportion of fields that are 0 
#   # from the max possible nr of fields that can be 0 in perfect re-clustering. 
#   # That nr is equivalent to all fields - max_nr
#   
#   prop_zeros <- length(which(mat == 0))/(ncol(mat)*nrow(mat)-max_nr)
# 
#   # get the average of all proportion average, let's just call it "score"
#   non_zeros <- mat[which(mat > 0)]
#   score <- sum(non_zeros)/length(non_zeros)
#   
#   # let's also try to reduce the nr of cell types per cluster. 
#   # because technically, 1 cluster containing all cell types would be a
#   # good re-clustering, too according to prop_zeros and adjusted rand index
#   
#   nr_ct_per_cluster_all <- vector()
#   for(cluster in rownames(mat)){
#     nr_ct_per_cluster <- length(which(mat[cluster,] !=0))
#     nr_ct_per_cluster_all <- c(nr_ct_per_cluster_all, nr_ct_per_cluster)
#   }
#   
#   # same for clusters
#   nr_clusters_per_ct_all <- vector()
#   for(ct in colnames(mat)){
#     nr_clusters_per_ct <- length(which(mat[,ct] !=0))
#     nr_clusters_per_ct_all <- c(nr_clusters_per_ct_all, nr_clusters_per_ct)
#   }
# 
#   # also calculate the adjusted rand index
#   
#   adjrand <- adjustedRandIndex(seu$cell_type, seu$seurat_clusters)
# 
#   return(
#     base::data.frame(
#       "prop_zeros" = prop_zeros,
#       "score" = score,
#       "adjrand" = adjrand,
#       "mean_ct_per_cluster" = base::mean(nr_ct_per_cluster_all),
#       "median_ct_per_cluster" = stats::median(nr_ct_per_cluster_all),
#       "mean_cluster_per_ct" = base::mean(nr_clusters_per_ct_all),
#       "median_cluster_per_ct" = stats::median(nr_clusters_per_ct_all),
#       "nr_clusters" = nrow(mat),
#       "resolution" = reso))
# }
#
```

```{r score_vis_function, include = FALSE}
vis_clustering_scores <- function(score_df_list, title){
  
  score_df <- dplyr::bind_rows(score_df_list)
  title <- base::paste(title, score_df$conservation_level[1])

  vis_df_1 <- score_df[score_df$type %in% c("proportion_of_zeros",
                                            "mean_prop_cells/cluster",
                                            "mean_cluster_purity"),]
  
  col_vec1 <- c(
    "proportion_of_zeros" = "goldenrod1",
    "mean_prop_cells/cluster" = "steelblue2",
    "mean_cluster_purity" = "olivedrab4"
  )
  
  plot1 <- ggplot2::ggplot(vis_df_1, 
                           aes(x = resolution, y = value, color = type))+
    ggplot2::geom_point()+
    ggplot2::theme_classic()+
    ggplot2::geom_hline(yintercept = 0.5,
                        color = "grey20",
                        linetype = "dashed")+
    ggplot2::ylim(c(0, 1))+
    ggplot2::ggtitle(title)+
    ggplot2::scale_color_manual("score", values = col_vec1)
  
  vis_df_2 <- score_df[score_df$type %in% c("adjusted_rand_index",
                                            "fowles_mallow_index",
                                            "variation_information"),]
  
  col_vec2 <-  c(
    "adjusted_rand_index" = "orchid",
    "fowles_mallow_index" = "darkblue",
    "variation_information" = "orange")
  
  plot2 <- ggplot2::ggplot(vis_df_2, 
                           aes(x = resolution, y = value, color = type))+
    ggplot2::geom_point()+
    ggplot2::theme_classic()+
    ggplot2::geom_hline(yintercept = 0.5,
                        color = "grey20",
                        linetype = "dashed")+
    ggplot2::ylim(c(0, max(vis_df_2$value)))+
    ggplot2::ggtitle(title)+
    ggplot2::scale_color_manual("score", values = col_vec2)
  
  return(list(plot1, plot2))
  
}
plotlist <- lapply(score_df_list_all, 
                   vis_clustering_scores, 
                   title = dataset_curr)
```

```{r print_scores_plot1, fig.width = 7, fig.height = 3}
plotlist
knitr::knit_exit()
```


```{r score_vis_function_no, include = FALSE}
plot3 <- ggplot2::ggplot(res_df,
                           aes(x = resolution, y= adjrand))+
    ggplot2::geom_point(color = "green4")+
    ggplot2::theme_classic()+
    ggplot2::geom_hline(yintercept = 0.5, color = "black")+
    ggplot2::ylim(c(0, 1))+
    ggplot2::ggtitle(title)
  
  plot5 <- ggplot2::ggplot(res_df, 
                           aes(x = nr_clusters, y= adjrand))+
    ggplot2::geom_point(color = "green4", alpha = 0.6)+
    ggplot2::theme_classic()+
    ggplot2::ylim(c(0, 1))+
    ggplot2::ggtitle(title)+
    ggplot2::xlim(c(0, max(res_df$nr_clusters)))
  
  plot6 <- ggplot2::ggplot(vis_df_1, 
                           aes(x = nr_clusters, y= value, color = type))+
    ggplot2::geom_point(alpha = 0.6)+
    ggplot2::theme_classic()+
    ggplot2::ylim(c(0, 2))+
    ggplot2::ggtitle(title)+
    ggplot2::xlim(c(0, max(res_df$nr_clusters)))

  vis_df_2 <- res_df
  vis_df_2 <- tidyr::pivot_longer(vis_df_2, 
                                  cols = c("mean_ct_per_cluster",
                                           "median_ct_per_cluster", 
                                           "mean_cluster_per_ct",
                                           "median_cluster_per_ct",
                                           "nr_clusters"), 
                                  names_to = "type",
                                  values_to = "value")
  vis_df_2$type <- factor(
    vis_df_2$type,
    levels = c("nr_clusters",
               "mean_cluster_per_ct",
               "median_cluster_per_ct",
               "mean_ct_per_cluster",
               "median_ct_per_cluster"))
                            
  plot4 <- ggplot2::ggplot(vis_df_2, 
                           aes(x = resolution, y = value, color = type))+
    ggplot2::geom_point(alpha = 0.7)+
    ggplot2::scale_color_manual(
      "",
      values = c("mean_ct_per_cluster" = "pink4",
                 "median_ct_per_cluster" = "pink1", 
                 "mean_cluster_per_ct" = "green1",
                 "median_cluster_per_ct" = "green4",
                 "nr_clusters" = "black"))+
    ggplot2::geom_hline(yintercept = nr_celltypes, 
                        color = "grey60", 
                        linetype = "dashed")+
    ggplot2::theme_classic()+
    ggplot2::ylim(c(0, max(nr_celltypes, res_df$nr_clusters)))+
    ggplot2::ggtitle(title)
  
  return(list(plot1, plot2, plot3, plot4, plot5, plot6))
}
```

## Conserved Signature Genes

```{r sign1}
seu_sign_list <- seu_list_all$seu_sign
seu_sign_list <- add_res_info(seu_sign_list)
```

```{r sign2, fig.width = 20, fig.height=30}
plot_listw <- lapply(seu_sign_list,
                     vis_perc_wide_gg, 
                     title_add = "conserved signature genes")
cowplot::plot_grid(plotlist = plot_listw, ncol = 2)
```

```{r sign3, fig.height = 40, fig.width=12}
plot_listl <- lapply(seu_sign_list, 
                     vis_perc_long_gg, 
                     title_add = "conserved signature genes")
cowplot::plot_grid(plotlist = plot_listl, ncol = 3)
```

```{r sign4, fig.height = 3, fig.width = 8}
mat_list <- lapply(seu_sign_list, get_reclustering_mat)

res_list <- lapply(as.list(names(mat_list)),
                   get_reclustering_values,
                   mat_list = mat_list, 
                   seu_list = seu_sign_list)

plot_listv <- vis_clustering_values(res_list,
                                    title = "conserved signature genes")
plot_listv
```

```{r sign5, fig.width = 4, fig.height = 3}
plot_listv
```

# Conserved Markers

```{r markers1}
seu_marker_list <- seu_list_all$seu_mark
seu_marker_list <- add_res_info(seu_marker_list)
```

```{r markers2, fig.width = 14, fig.height=30}
plot_listw <- lapply(seu_marker_list, 
                     vis_perc_wide_gg, 
                     title_add = "conserved Markers")
cowplot::plot_grid(plotlist = plot_listw, ncol = 2)
```

```{r markers3, fig.height = 40, fig.width=12}
plot_listl <- lapply(seu_marker_list,
                     vis_perc_long_gg, 
                     title_add = "conserved Markers")
cowplot::plot_grid(plotlist = plot_listl, ncol = 3)
```

```{r markers4, fig.height = 3, fig.width = 8}
mat_list <- lapply(seu_marker_list, 
                   get_reclustering_mat)

res_list <- lapply(as.list(names(mat_list)), 
                   get_reclustering_values,
                   mat_list = mat_list, 
                   seu_list = seu_marker_list)

plot_listv <- vis_clustering_values(res_list,
                                    title = "conserved Markers")
plot_listv
```

# All BL6 Markers

```{r bl6markers1}
seu_mmusm_list <- seu_list_all$seu_mmms
seu_mmusm_list <- add_res_info(seu_mmusm_list)
```

```{r bl6markers2, fig.width = 14, fig.height=30}
plot_listw <- lapply(seu_mmusm_list, 
                     vis_perc_wide_gg, 
                     title_add = "all BL6 Markers")
cowplot::plot_grid(plotlist = plot_listw, ncol = 2)
```

```{r bl6markers3, fig.height = 40, fig.width=12}
plot_listl <- lapply(seu_mmusm_list,
                     vis_perc_long_gg, 
                     title_add = "all BL6 Markers")
cowplot::plot_grid(plotlist = plot_listl, ncol = 3)
```

```{r bl6markers4, fig.height = 3, fig.width = 8}
mat_list <- lapply(seu_mmusm_list, 
                   get_reclustering_mat)

res_list <- lapply(as.list(names(mat_list)), 
                   get_reclustering_values,
                   mat_list = mat_list, 
                   seu_list = seu_mmusm_list)

plot_listv <- vis_clustering_values(res_list,
                                    title = "all BL6 Markers")
plot_listv
```

## Random

```{r random1}
seu_random_list <- seu_list_all$seu_rand
seu_random_list <- add_res_info(seu_random_list)
```

```{r random2, fig.width = 14, fig.height=30}
plot_listw <- lapply(seu_random_list, 
                     vis_perc_wide_gg, 
                     title_add = "random")
cowplot::plot_grid(plotlist = plot_listw, ncol = 2)
```

```{r random3, fig.height = 40, fig.width=12}
plot_listl <- lapply(seu_random_list, 
                     vis_perc_long_gg, 
                     title_add = "random")
cowplot::plot_grid(plotlist = plot_listl, ncol = 3)
```

```{r random4, fig.height = 3, fig.width = 8}
mat_list <- lapply(seu_random_list,
                   get_reclustering_mat)

res_list <- lapply(as.list(names(mat_list)), 
                   get_reclustering_values,
                   mat_list = mat_list,
                   seu_list = seu_random_list)

plot_listv <- vis_clustering_values(res_list, title = "random")
plot_listv
```

```{r knit_exit_stop}
knitr::knit_exit()
```

### compare all

This has to be done manually

```{r fig.width = 9, fig.height=3}
resolution_chosen <- list()
cluster_vec <- list()

wildcard_curr <- snakemake@wildcards[["reference"]]
```


```{r}
if(wildcard_curr == "ts_all_stromal"){
  resolution_chosen[["correct_EMFs"]] <- "0.55"
  resolution_chosen[["reverse_EMFs"]] <- "0.45"
  resolution_chosen[["correct_markers"]] <- "0.45"
  resolution_chosen[["random"]] <- "0.25"
  
  cluster_vec[["correct_EMFs"]] <- c(1, 4, 9, 5, 8, 7, 6, 2, 3, 10)
  cluster_vec[["reverse_EMFs"]] <- c(1, 2, 5, 6, 7, 8, 3, 4)
  cluster_vec[["correct_markers"]] <- c(2, 3, 5, 4, 7, 8, 9, 10, 1, 6)
  cluster_vec[["random"]] <- c(1, 3, 5, 4, 2, 6)
  
}else if(wildcard_curr == "ts_hsc_progenitors"){
  resolution_chosen[["correct_EMFs"]] <- "0.3"
  resolution_chosen[["reverse_EMFs"]] <- "0.45"
  resolution_chosen[["correct_markers"]] <- "0.3"
  resolution_chosen[["random"]] <- "0.5"
  
  cluster_vec[["correct_EMFs"]] <- c(2, 4, 5, 8, 3, 1, 6, 7, 9)
  cluster_vec[["reverse_EMFs"]] <- c(1, 4, 5, 8, 2, 3, 7, 6)
  cluster_vec[["correct_markers"]] <- c(2, 5, 4, 3, 1, 6, 7, 8)
  cluster_vec[["random"]] <- c(3, 5, 4, 2, 7, 8, 6, 1)
  
}else if(wildcard_curr == "ts_bone_marrow"){
  resolution_chosen[["correct_EMFs"]] <- "0.45"
  resolution_chosen[["reverse_EMFs"]] <- "0.85"
  resolution_chosen[["correct_markers"]] <- "0.5"
  resolution_chosen[["random"]] <- "0.15"
  
  cluster_vec[["correct_EMFs"]] <- c(3, 4, 6, 8, 2, 5, 7, 8, 1, 9)
  cluster_vec[["reverse_EMFs"]] <- c(6, 8, 1, 9, 3, 5, 10, 2, 4, 13, 11, 12, 7)
  cluster_vec[["correct_markers"]] <- c(4, 3, 6, 8, 9, 2, 5, 7, 1, 10)
  cluster_vec[["random"]] <- c(3, 2, 1, 4)
  
}else if(wildcard_curr == "li_all_stromal"){
  #knitr::knit_exit()
  resolution_chosen[["correct_EMFs"]] <- "0.6"
  resolution_chosen[["reverse_EMFs"]] <- "0.4"
  resolution_chosen[["correct_markers"]] <- "0.9"
  resolution_chosen[["random"]] <- "0.85"
  
  cluster_vec[["correct_EMFs"]] <- c(3, 1, 2, 4, 8, 7, 6, 5)
  cluster_vec[["reverse_EMFs"]] <- c(1, 2, 5, 7, 8, 6, 4, 3)
  cluster_vec[["correct_markers"]] <- c(2, 1, 3, 7, 6, 4, 10, 8, 5, 9)
  cluster_vec[["random"]] <- c(4, 1, 3, 2, 7, 8, 10, 9, 5, 6)
}
```


```{r fig.width = 9, fig.height=3}
plot1 <- vis_perc_wide_gg(seu_emf_cor_list[[resolution_chosen[["correct_EMFs"]]]],
                        title_add = "correct EMFs", 
                        correction_vec = cluster_vec[["correct_EMFs"]])

plot2 <- vis_perc_wide_gg(seu_emf_rev_list[[resolution_chosen[["reverse_EMFs"]]]],
                        title_add = "reverse EMFs", 
                        correction_vec = cluster_vec[["reverse_EMFs"]])

plot3 <- vis_perc_wide_gg(seu_marker_list[[resolution_chosen[["correct_markers"]]]],
                        title_add = "correct Markers", 
                        correction_vec = cluster_vec[["correct_markers"]])

plot4 <- vis_perc_wide_gg(seu_random_list[[resolution_chosen[["random"]]]],
                        title_add = "random", 
                        correction_vec = cluster_vec[["random"]])
plot1
plot2
plot3
plot4
```

```{r fig.height = 6, fig.width = 4}
plot1 <- vis_perc_long_gg(seu_emf_cor_list[[resolution_chosen[["correct_EMFs"]]]],
                        title_add = "correct EMFs", 
                        correction_vec = cluster_vec[["correct_EMFs"]])

plot2 <- vis_perc_long_gg(seu_emf_rev_list[[resolution_chosen[["reverse_EMFs"]]]],
                        title_add = "reverse EMFs", 
                        correction_vec = cluster_vec[["reverse_EMFs"]])

plot3 <- vis_perc_long_gg(seu_marker_list[[resolution_chosen[["correct_markers"]]]],
                        title_add = "correct Markers", 
                        correction_vec = cluster_vec[["correct_markers"]])

plot4 <- vis_perc_long_gg(seu_random_list[[resolution_chosen[["random"]]]],
                        title_add = "random", 
                        correction_vec = cluster_vec[["random"]])
plot1
plot2
plot3
plot4
```

```{r fig.width = 9, fig.height=3}
plot1 <- vis_perc_cluster(seu_emf_cor_list[[resolution_chosen[["correct_EMFs"]]]],
                        title_add = "correct EMFs", 
                        correction_vec = cluster_vec[["correct_EMFs"]])

plot2 <- vis_perc_cluster(seu_emf_rev_list[[resolution_chosen[["reverse_EMFs"]]]],
                        title_add = "reverse EMFs", 
                        correction_vec = cluster_vec[["reverse_EMFs"]])

plot3 <- vis_perc_cluster(seu_marker_list[[resolution_chosen[["correct_markers"]]]],
                        title_add = "correct Markers", 
                        correction_vec = cluster_vec[["correct_markers"]])

plot4 <- vis_perc_cluster(seu_random_list[[resolution_chosen[["random"]]]],
                        title_add = "random", 
                        correction_vec = cluster_vec[["random"]])
plot1
plot2
plot3
plot4
```

```{r fig.height = 6.2, fig.width = 3}
if(wildcard_curr == "ts_hsc_progenitors"){
  vis_perc_cluster(seu_emf_cor_list[[resolution_chosen[["correct_EMFs"]]]],
                   title_add = "correct EMFs", 
                   correction_vec = cluster_vec[["correct_EMFs"]])+
    theme(legend.position = "none")+
    theme(axis.text.x = element_text(angle = 90, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_blank(),
        plot.title = element_blank())
} 
```

```{r fig.height = 5, fig.width = 3}
if(wildcard_curr == "ts_bone_marrow"){
  vis_perc_cluster(seu_emf_cor_list[[resolution_chosen[["correct_EMFs"]]]],
                   title_add = "correct EMFs", 
                   correction_vec = cluster_vec[["correct_EMFs"]])+
    theme(legend.position = "none")+
    theme(axis.text.x = element_text(angle = 90, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_blank(),
        plot.title = element_blank())
} 
```

```{r fig.height = 6, fig.width = 3}
if(wildcard_curr == "ts_all_stromal"){
  vis_perc_cluster(seu_emf_cor_list[[resolution_chosen[["correct_EMFs"]]]],
                   title_add = "correct EMFs", 
                   correction_vec = cluster_vec[["correct_EMFs"]])+
    theme(legend.position = "none")+
    theme(axis.text.x = element_text(angle = 90, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_blank(),
        plot.title = element_blank())
} 
```

```{r fig.height = 6.4, fig.width = 3}
if(wildcard_curr == "li_all_stromal"){
  vis_perc_cluster(seu_emf_cor_list[[resolution_chosen[["correct_EMFs"]]]],
                   title_add = "correct EMFs", 
                   correction_vec = cluster_vec[["correct_EMFs"]])+
    theme(legend.position = "none")+
    theme(axis.text.x = element_text(angle = 90, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_blank(),
        plot.title = element_blank())
} 
```

```{r}
knitr::knit_exit()
```
