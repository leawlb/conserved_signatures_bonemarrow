---
title: "Reclustering other datasets, selected resolution"
author: "Lea WÃ¶lbert"
date: '2024-04-19'
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Report on datasets from other species that were re-clustered using:

- random genes
- conserved signature genes
- conserved marker genes

Using only the selected resolution with the best combination of markers.

#### Load objects

```{r seed, message = FALSE}
set.seed(37)
```

```{r source, message = FALSE, include = FALSE}
#source(file = snakemake@params[["plotting"]])
#source(file = snakemake@params[["reclustering_function"]])
```

```{r load, message = FALSE}
library(Seurat, quietly = TRUE)
library(tidyverse, quietly = TRUE)
```

```{r eval = FALSE, include = FALSE}

base_path <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/04_rcls/"

seu_list_all <- readRDS(paste0(base_path, "reclustered_zeb_all_hspc_list"))

seu_list_all <- readRDS(paste0(base_path, "reclustered_ts_bone_marrow_list"))

seu_list_all <- readRDS(paste0(base_path, "reclustered_ts_all_stromal_list"))
seu_list_all <- readRDS(paste0(base_path, "reclustered_li_all_stromal_list"))


colors_path <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data/metadata/colors/colors.txt"
source("../../source/colors.R")
source("../../source/plotting.R")
source("../../source/sce_functions_reclustering.R")


resolution_df_path <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data/metadata/scRNAseq/03_sce_analysis/reclustering_bm/reclustering_other_resolution.txt"

dataset_curr <- "zeb_all_hspc"

score_df_list_all <- readRDS("/omics/odcf/analysis/OE0538_projects/DO-0008/data/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/04_rcls/score_df_zeb_all_hspc_list")

for(i in 1:length(seu_list_all$seu_sign)){
  seu_list_all$seu_sign[[i]]@meta.data$cell_type <- seu_list_all$seu_sign[[i]]@meta.data$manually_annotated_ct
}

col_cts <- col_cts_hsc
```

```{r load_objects}
seu_list_all <- base::readRDS(snakemake@input[["seu_list"]])
score_df_list_all <- base::readRDS(snakemake@input[["score_df_list"]])

resolution_df_path <- snakemake@input[["resolution_df"]]

resolution_df <- utils::read.csv(file = resolution_df_path, 
                               header = TRUE, 
                               sep = ";", 
                               check.names=FALSE, 
                               stringsAsFactors=FALSE, 
                               as.is=TRUE, 
                               colClasses = "character")

dataset_curr <- snakemake@wildcards[["dataset"]]

resolution_df <- resolution_df[resolution_df$dataset == dataset_curr,]

```

```{r nr_cts}
nr_celltypes <- length(base::unique(seu_list_all[[1]][[1]]$cell_type))
print(nr_celltypes)
```

```{r subset_selected}

selected_seu_list <- lapply(seu_list_all, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  
  resdf_temp <- resolution_df[resolution_df$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
  
})
selected_seu_list

dataset_list <- names(score_df_list_all)
selected_score_df_list <- lapply(dataset_list, function(dataset){
  
  seu_list_curr <- seu_list_all[[dataset]]
  score_df_list <- score_df_list_all[[dataset]]

  conslev_curr <- seu_list_curr[[1]]@misc$used_genes
  
  resdf_temp <- resolution_df[resolution_df$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  score_df_return <- score_df_list[[res_curr]]
  return(score_df_return)
  
})

selected_seu_list
selected_score_df_list
```


## Functions

### Plotting from seurat object

#### Wide

Cell types on y axis.
Proportions of cells of a cluster per cell type.

```{r wide_function, include = FALSE }

vis_perc_wide_gg <- function(seu, correction_vec_list = NULL, title_add= NULL){
  
  nr_genes <- nrow(seu)

  title <- base::paste(seu@misc$used_genes, title_add, nr_genes, "genes")
  print(seu@misc$used_genes)
  
  mat <- base::table(seu$cell_type, seu$seurat_clusters)
  
  mat1 <- mat/rowSums(mat)*100
  if(!is.null(correction_vec_list)){
    correction_vec <- correction_vec_list[[seu@misc$used_genes]]
    mat1 <- mat1[,correction_vec]
  }
  
  df_vis <- base::as.data.frame(mat1)
  df_vis$Var1 <- factor(df_vis$Var1, levels = base::rev(levels(seu$cell_type)))
  
  plot_wide <- ggplot2::ggplot(df_vis, aes(y = Var1, x = Var2, fill= Freq))+ 
    ggplot2::geom_tile()+
    ggplot2::scale_fill_continuous("% cells/cell type", 
                                   limits = c(0, 100), 
                                   breaks = seq(0, 100,by = 20),
                                   low = "white",
                                   high = "blue")+
    ggplot2::theme_classic()+
    ggplot2::theme(axis.text.x = element_text(angle=0),
                   axis.ticks = element_blank(),
                   legend.position = "none")+
    ggplot2::xlab("new clusters")+
    ggplot2::ylab("original cell types")+
    ggplot2::ggtitle(base::paste("resolution", 
                                 seu@misc$resolution[1], 
                                 title))
  
  return(plot_wide)
}
```

#### Long

Cell types on x axis.
Proportion of cells of a cell type per cluster.

```{r long_function, include = FALSE}
vis_perc_long_gg <- function(seu, correction_vec_list = NULL, title_add= NULL){
  
  nr_genes <- nrow(seu)

  title <- base::paste(seu@misc$used_genes, title_add, nr_genes, "genes")
  print(seu@misc$used_genes)
    
  mat <- t(base::table(seu$cell_type, seu$seurat_clusters))
  
  mat2 <- mat/rowSums(mat)*100
  
  if(!is.null(correction_vec_list)){
    correction_vec <- correction_vec_list[[seu@misc$used_genes]]
    mat2 <- mat2[rev(correction_vec),]
  }
  
  df_vis <- base::as.data.frame(mat2)
  df_vis$Var2 <- factor(df_vis$Var2, levels = levels(seu$cell_type))

  plot_long <- ggplot2::ggplot(df_vis, aes(y = Var1, x = Var2, fill= Freq))+ 
    ggplot2::geom_tile()+
    ggplot2::scale_fill_continuous("% cells/cluster", 
                                   limits = c(0, 100),
                                   breaks = seq(0, 100, by = 20),
                                   low = "white", 
                                   high = "blue")+
    ggplot2::theme_classic()+
    ggplot2::theme(axis.ticks = element_blank(),
                   legend.position = "none",
                   axis.text.x = element_text(angle = 60,
                                              vjust = 1, 
                                              hjust = 1))+
    ggplot2::ylab("new clusters")+
    ggplot2::xlab("original cell types")+
    ggplot2::ggtitle(base::paste("resolution", seu@misc$resolution[1], title))

  return(plot_long)
}
```

# Heatmaps

```{r fig.width = 7, fig.height = 4}
plot_list_wide <- lapply(selected_seu_list, 
                         vis_perc_wide_gg,
                         title_add = dataset_curr)
plot_list_wide
```

```{r fig.width = 7, fig.height = 4}

correction_vec_list <- list(
  "conserved_signature" = c(4, 2, 6, 2, 7, 1, 5, 3, 8),
  "conserved_markers" = c(3, 5, 7, 2, 4, 6, 1, 8, 9),
  "mmusall_markers" = c(2, 6, 4, 1, 3, 7, 5, 9, 8),
  "random_features" = c(1, 2, 4, 3)
)

plot_list_wide <- lapply(selected_seu_list, 
                         vis_perc_wide_gg,
                         title_add = dataset_curr,
                         correction_vec_list = correction_vec_list)
plot_list_wide
```

```{r fig.width = 6, fig.height = 5}
plot_list_long <- lapply(selected_seu_list, 
                         vis_perc_long_gg,
                         title_add = dataset_curr,
                         correction_vec_list = correction_vec_list)
plot_list_long
```

# Scores

```{r score_df}
score_df <- dplyr::bind_rows(selected_score_df_list)
```

```{r all_0_to_1, fig.width = 4, fig.height = 3.5}

title <- base::paste(dataset_curr)

col_vec_cons <- c(
    "conserved_signature" = "yellowgreen",
    "conserved_markers" = "darkgreen",
    "mmusall_markers" = "blue2",
    "random_features" = "purple2")

ggplot2::ggplot(
  score_df[!score_df$type %in% c("variation_information", 
                                 "nr_celltypes",
                                 "nr_clusters"),], 
  aes(y = value, x = type, color = conservation_level))+
  ggplot2::geom_point(alpha = 0.7)+
  ggplot2::theme_classic()+
  ggplot2::ylim(c(0, 1))+
  ggplot2::theme(axis.text.x = element_text(angle = 90))+
  ggplot2::scale_color_manual("conservation level", values = col_vec_cons)+
  ggplot2::ggtitle(title)
```

```{r, fig.width = 3, fig.height = 3.5}
ggplot2::ggplot(score_df[score_df$type == "variation_information",], 
                aes(y = value, x = type, color = conservation_level))+
  ggplot2::geom_point(alpha = 0.7)+
  ggplot2::theme_classic()+
  ggplot2::theme(axis.text.x = element_text(angle = 90))+
  ggplot2::scale_color_manual("conservation level", 
                              values = col_vec_cons)+
  ggplot2::ylim(c(0, max(score_df$value[
    score_df$type == "variation_information"])))+
  ggplot2::ggtitle(title)
```

```{r sessioninfo}
utils::sessionInfo()
```
