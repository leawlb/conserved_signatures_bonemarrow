---
title: "batch_correction_fraction_report"
author: "Lea WÃ¶lbert"
date: '2022-12-06'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Report for data integration and batch correction at fraction level.

#### Load libraries, source code 

```{r load,  message = FALSE}

library(DropletUtils, quietly = TRUE) 
library(scater, quietly = TRUE) 
library(scuttle, quietly = TRUE) 
library(scran, quietly = TRUE) 
library(tidyverse, quietly = TRUE) 
library(cowplot, quietly = TRUE) 
library(CellMixS, quietly = TRUE) 
library(lisi)
set.seed(37)
```

```{r}
sce_07 <- readRDS(file = snakemake@input[["sce_07"]])
sce_08 <- readRDS(file = snakemake@input[["sce_08"]])
sce_09 <- readRDS(file = snakemake@input[["sce_09"]])

nr_hvgs <- snakemake@params[["nr_hvgs"]]
color_tables <- snakemake@params[["color_tables"]]
fraction_curr <- sce_07$Fraction_ID[1]
```

```{r}
source(file = "../source/colors.R")
source(file = "../source/plotting.R")
source(file = "../source/sce_functions.R")
```

```{r}

sce_07 <- factor_reference_cts(sce_07)# own function
sce_08 <- factor_reference_cts(sce_08)
sce_09 <- factor_reference_cts(sce_09)

# redo dimensionality reduction for renormalized objects
set.seed(37)
sce_08 <- reduce_dims(sce_08, nr_hvgs = snakemake@params[["nr_hvgs"]])
```

```{r}

if(fraction_curr == "hsc"){
  col_cts["unassigned"] <- "lightblue2"
}else if(fraction_curr == "str"){
  col_cts["unassigned"] <- "mistyrose3"
}

col_cts_baccin <- col_cts[match(levels(sce$baccin_celltype_scmapclust), 
                                names(col_cts))]
col_cts_dahlin <- col_cts[match(levels(sce$baccin_celltype_scmapclust), 
                                names(col_cts))]
col_cts_dolgalev <- col_cts[match(levels(sce$baccin_celltype_scmapclust), 
                                  names(col_cts))]

col_batch_exp_day <- col_alp[names(col_alp) %in% sce_07$Batch_exp_day]
col_batch_seq <- col_num[names(col_num) %in% sce_07$Batch_sequencing]
col_ann_age <- col_ann[names(col_ann) %in% sce_07$Age_ID]
col_ann_fraction <- col_ann[names(col_ann) %in% sce_07$Fraction_ID]
col_species <- col_spc[names(col_spc) %in% sce_07$Species_ID]

```

```{r}
sce_07
```

```{r}
sce_08
```

```{r}
sce_09
```

# Reference cell types 

Cells were annotated with scmapclust and three reference datasets.

```{r}

identity_plots <- function(sce, title){
  
  plot_1 <- umap_base(sce, color_by = "baccin_celltype_scmapclust")+ 
    ggtitle(paste0(fraction_curr, title))+
    scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)
  plot_1l <- umap_legend(sce, color_by = "baccin_celltype_scmapclust")+
    scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)
  legend_1 <- get_legend(plot_1l)

  plot_2 <- umap_base(sce, color_by = "dahlin_celltype_scmapclust")+
    ggtitle(paste0(fraction_curr, title))+
    scale_color_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)
  plot_2l <- umap_legend(sce, color_by = "dahlin_celltype_scmapclust")+
    scale_color_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)
  legend_2 <- get_legend(plot_2l)
  
  plot_3 <- umap_base(sce, color_by = "dolgalev_celltype_scmapclust")+n
    ggtitle(paste0(fraction_curr, title))+
    scale_color_manual("dolgalev_celltype_scmapclust", 
                       values = col_cts_dolgalev)
  plot_3l <- umap_legend(sce, color_by = "dolgalev_celltype_scmapclust")+
    scale_color_manual("dolgalev_celltype_scmapclust",
                       values = col_cts_dolgalev)
  legend_3 <- get_legend(plot_3l)
  
  PLOT_1 <- ggarrange(plot_1, legend_1)
  PLOT_2 <- ggarrange(plot_2, legend_2)
  PLOT_3 <- ggarrange(plot_3, legend_3)

  return(list(PLOT_1, PLOT_2, PLOT_3))
}

```

```{r}
print(fraction_curr)
print(table(sce_07$baccin_celltype_scmapclust))
print(table(sce_07$dahlin_celltype_scmapclust))
print(table(sce_07$dolgalev_celltype_scmapclust))
```

### After merging

```{r}
identity_plots_07 <- identity_plots(sce_07, title = ", after merging")
```

```{r fig.width=8, fig.height=4}
identity_plots_07
```

### After renormalization

```{r}
identity_plots_08 <- identity_plots(sce_08, title = ", after renormalization")
```

```{r fig.width=8, fig.height=4}
identity_plots_08
```

### After batch correction

```{r}
identity_plots_09 <- identity_plots(sce_09, title = ", MNN batch correction")
```

```{r fig.width=8, fig.height=4}
identity_plots_09
```

## Contamination and mature cell types

Use only Baccin et al dataset because it's the only one containing both
stromal and hematopoetic cell types in a single data set.
Contamination: cells that were annotated as reference cell types from the
incorrect fraction, i.e. B cells in the stromal fraction.
Mature cell types have been defined in code/source/sce_functions.R

```{r}

# find contamination and mature cells in sce objects
find_contamination_mature <- function(sce, title){
  
  # CONTAMINATION
  if(fraction_curr == "hsc"){
    sce <- find_contamination_ref_all(sce, input = "hsc") # own function
  }else{
    sce <- find_contamination_ref_all(sce, input = "stromal") 
  }

  plot_4 <- umap_base(sce, color_by = "right_fraction")+
      scale_color_manual("Correct fraction", values = c("TRUE" = "grey50", 
                                                        "FALSE" = "orange"))
    plot_4l <- umap_legend(sce, color_by = "right_fraction")+
      scale_color_manual("Correct fraction", values = c("TRUE" = "grey50", 
                                                        "FALSE" = "orange"))
    legend_4 <- get_legend(plot_4l)

    PLOT_4 <- ggarrange(plot_4 + ggtitle(paste0(fraction_curr, 
                                                title, " contamination")), 
                        legend_4)

  sce <- get_mature_cts_all(sce) # own function 

  plot_5 <- umap_base(sce, color_by = "mature_cells")+
  scale_color_manual("Mature cell types", values = c("FALSE" = "grey50", 
                                                    "TRUE" = "orange"))
  plot_5l <- umap_legend(sce, color_by = "mature_cells")+
  scale_color_manual("Mature cell types", values = c("FALSE" = "grey50", 
                                                    "TRUE" = "orange"))
  legend_5 <- get_legend(plot_5l)

  PLOT_5 <- ggarrange(plot_5 + ggtitle(paste0(fraction_curr,  
                                              title, ", mature HSPCs")),
                      legend_5)
  
  return(list(PLOT_4, PLOT_5))
}  

cont_plots_species_07 <- find_contamination_mature(
  sce_07, title = ", after merging,")
cont_plots_species_08 <- find_contamination_mature(
  sce_08, title = ", after renormalization,")
cont_plots_species_09 <- find_contamination_mature(
  sce_09, title = ", after MNN batch correction,")


```

### After merging

```{r fig.width=10, fig.height=5}
cont_plots_species_07
```

### After renormalization

```{r fig.width=10, fig.height=5}
cont_plots_species_08
```

### After Batch correction

```{r fig.width=10, fig.height=5}
cont_plots_species_09
```

# All QC metrics

```{r}

qc_plots <- function(sce, title){
  
  plot_1 <- umap_base(sce, color_by = "Object_ID")+ # own function
    ggtitle(paste0(fraction_curr, title))
  plot_1l <- umap_legend(sce, color_by = "Object_ID")+
    scale_color_discrete("Object_ID")
  legend_1 <- get_legend(plot_1l)
  
  plot_2 <- umap_base(sce, color_by = "Batch_sequencing")+
    scale_color_manual("Batch_sequencing", values = col_batch_seq)+
    ggtitle(paste0(fraction_curr, title))
  plot_2l <- umap_legend(sce, color_by = "Batch_sequencing")+
    scale_color_manual("Batch_sequencing", values = col_batch_seq)
  legend_2 <- get_legend(plot_2l)
  
  plot_3 <- umap_base(sce, color_by = "Batch_exp_day")+ 
    scale_color_manual("Batch_experimental_day",values =  col_batch_exp_day)+
    ggtitle(paste0(fraction_curr, title))
  plot_3l <- umap_legend(sce, color_by = "Batch_exp_day")+
    scale_color_manual("Batch_experimental_day", values = col_batch_exp_day)
  legend_3 <- get_legend(plot_3l)
  
  plot_4 <- umap_base(sce, color_by = "Date_collected")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_4l <- umap_legend(sce, color_by = "Date_collected")+
    scale_color_discrete("Date of collection")
  legend_4 <- get_legend(plot_4l)
  
  # check everything else
  plot_5 <- umap_base(sce, color_by = "Species_ID")+ 
    scale_color_manual("Species", values = col_species)+
    ggtitle(paste0(fraction_curr, title))
  plot_5l <- umap_legend(sce, color_by = "Species_ID")+
    scale_color_manual("Species", values = col_species)
  legend_5 <- get_legend(plot_5l)
  
  plot_6 <- umap_base(sce, color_by = "Age_ID")+ 
    scale_color_manual("Age", values = col_ann_age)+
    ggtitle(paste0(fraction_curr, title))
  plot_6l <- umap_legend(sce, color_by = "Age_ID")+
    scale_color_manual("Age", values = col_ann_age)
  legend_6 <- get_legend(plot_6l) 
  
  plot_7 <- umap_base(sce, color_by = "Fraction_ID")+ 
    scale_color_manual("Fraction", values = col_ann_fraction)+
    ggtitle(paste0(fraction_curr, title))
  plot_7l <- umap_legend(sce, color_by = "Fraction_ID")+
    scale_color_manual("Fraction", values = col_ann_fraction)
  legend_7 <- get_legend(plot_7l) 
 
  plot_8 <- umap_base(sce, color_by = "Antibody_combination")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_8l <- umap_legend(sce, color_by = "Antibody_combination")+
    scale_color_discrete("Antibody combination")
  legend_8 <- get_legend(plot_8l)
  
  plot_9 <- umap_base(sce, color_by = "doublet_score")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_9l <- umap_legend(sce, color_by = "doublet_score")+
    scale_color_continuous("Doublet score")
  legend_9 <- get_legend(plot_9l)
  
  plot_10 <- umap_base(sce, color_by = "Keep_sample")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_10l <- umap_legend(sce, color_by = "Keep_sample")+
    scale_color_discrete("Keep_sample")
  legend_10 <- get_legend(plot_10l)
  
  qcdf <- perCellQCMetrics(sce)
  sce$sum <- qcdf$sum
  sce$detected <- qcdf$detected

  plot_11 <- umap_base(sce, color_by = "sum")+
    scale_color_gradientn("Library size", 
                           limits = c(0, 100000),
                           colors = c("black", "darkorange4", "darkorange3",
                                      "darkorange1",
                                      "orange", "orange", "gold1", "gold",
                                      "lightgoldenrod", "lightgoldenrod", 
                                      "lightgoldenrod", "lightgoldenrod", 
                                      "lightgoldenrod", "lightgoldenrod"))+
    ggtitle(name_curr)
  plot_11l <- umap_legend(sce, color_by = "sum")+
    scale_color_gradientn("Library size", 
                           limits = c(0, 1000000),
                            colors = c("black", "darkorange4", "darkorange3", 
                                       "darkorange1",
                                      "orange", "orange", "gold1", "gold",
                                      "lightgoldenrod", "lightgoldenrod", 
                                      "lightgoldenrod", "lightgoldenrod", 
                                      "lightgoldenrod", "lightgoldenrod"))
  legend_11 <- get_legend(plot_11l)

  plot_12 <- umap_base(sce, color_by = "detected")+
    scale_color_gradientn("Number of detected genes", 
                           limits = c(0, 10000),
                           colors = c("black", "darkorange3", "orange", 
                                      "lightgoldenrod"))+
    ggtitle(name_curr)
  plot_12l <- umap_legend(sce, color_by = "detected")+
    scale_color_gradientn("Number of detected genes", 
                           limits = c(0, 10000),
                           colors = c("black", "darkorange3", "orange", 
                                      "lightgoldenrod"))
  legend_12 <- get_legend(plot_12l)
  
  PLOT_12 <- ggarrange(plot_12, legend_12)

  PLOT_1 <- ggarrange(plot_1, legend_1)
  PLOT_2 <- ggarrange(plot_2, legend_2)
  PLOT_3 <- ggarrange(plot_3, legend_3)
  PLOT_4 <- ggarrange(plot_4, legend_4)
  PLOT_5 <- ggarrange(plot_5, legend_5)
  PLOT_6 <- ggarrange(plot_6, legend_6)
  PLOT_7 <- ggarrange(plot_7, legend_7)
  PLOT_8 <- ggarrange(plot_8, legend_8)
  PLOT_9 <- ggarrange(plot_9, legend_9)
  PLOT_10 <- ggarrange(plot_10, legend_10)
  PLOT_11 <- ggarrange(plot_11, legend_11)
  PLOT_12 <- ggarrange(plot_12, legend_12)


  plot_list <- list(PLOT_1, PLOT_2, PLOT_3, PLOT_4, PLOT_5, PLOT_6, PLOT_7,
                    PLOT_8, PLOT_9, PLOT_10, PLOT_11, PLOT_12)
  return(plot_list)
  
}

qc_plots_species_07 <- qc_plots(sce_07, title = ", after merging")
qc_plots_species_08 <- qc_plots(sce_08, title = ", after renormalization")
qc_plots_species_09 <- qc_plots(sce_09, title = ", MNN batch correction")
```

### After merging

```{r fig.width=10, fig.height=5}
qc_plots_species_07
```

### After renormalization

```{r fig.width=10, fig.height=5}
qc_plots_species_08
```

### After batch correction

```{r fig.width=10, fig.height=5}
qc_plots_species_09
```

## Facet grid UMAPs

To merge across ages and fractions using MNNcorrect, every age and fraction 
should have at least one overlapping BATCH.

Also, batches should have overlapping cell types for use of MNNCorrect or
Seurat.

```{r}

facet_plots <- function(sce, title){

  plot_1 <- umap_base(sce, color_by = "Object_ID")+ 
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Fraction))
  plot_1l <- umap_legend(sce, color_by = "Object_ID")+
    scale_color_discrete("Object_ID")
  legend_1 <- get_legend(plot_1l)
  
  plot_2 <- umap_base(sce, color_by = "Batch_sequencing")+
    scale_color_manual("Batch_sequencing", values = col_batch_seq)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Fraction))
  plot_2l <- umap_legend(sce, color_by = "Batch_sequencing")+
    scale_color_manual("Batch_sequencing", values = col_batch_seq)
  legend_2 <- get_legend(plot_2l)
  
  plot_3 <- umap_base(sce, color_by = "Batch_exp_day")+
    scale_color_manual("Batch_experimental_day", values = col_batch_exp_day)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Fraction))
  plot_3l <- umap_legend(sce, color_by = "Batch_exp_day")+
    scale_color_manual("Batch_experimental_day", values = col_batch_exp_day)
  legend_3 <- get_legend(plot_3l)

  # check age
  plot_4 <- umap_base(sce, color_by = "Object_ID")+ 
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Age))
  plot_4l <- umap_legend(sce, color_by = "Object_ID")+
    scale_color_discrete("Object_ID")
  legend_4 <- get_legend(plot_4l)
  
  plot_5 <- umap_base(sce, color_by = "Batch_sequencing")+
    scale_color_manual("Batch_sequencing", values = col_batch_seq)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Age))
  plot_5l <- umap_legend(sce, color_by = "Batch_sequencing")+
    scale_color_manual("Batch_sequencing", values = col_batch_seq)
  legend_5 <- get_legend(plot_5l)
  
  plot_6 <- umap_base(sce, color_by = "Batch_exp_day")+
    scale_color_manual("Batch_experimental_day", values = col_batch_exp_day)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Age))
  plot_6l <- umap_legend(sce, color_by = "Batch_exp_day")+
    scale_color_manual("Batch_experimental_day", values = col_batch_exp_day)
  legend_6 <- get_legend(plot_6l)
  
  plot_6 <- umap_base(sce, color_by = "Batch_exp_day")+
    scale_color_manual("Batch_experimental_day", values = col_batch_exp_day)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Age))
  plot_6l <- umap_legend(sce, color_by = "Batch_exp_day")+
    scale_color_manual("Batch_experimental_day", values = col_batch_exp_day)
  legend_6 <- get_legend(plot_6l)
  
  # Identities

  plot_7 <- umap_base(sce, color_by = "baccin_celltype_scmapclust")+
    scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Species_ID))
  plot_7l <- umap_legend(sce, color_by = "baccin_celltype_scmapclust")+
    scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)
  legend_baccin <- get_legend(plot_7l)
  
  plot_8 <- umap_base(sce, color_by = "dahlin_celltype_scmapclust")+
    scale_color_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Species_ID))
  plot_8l <- umap_legend(sce, color_by = "dahlin_celltype_scmapclust")+
    scale_color_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)
  legend_dahlin <- get_legend(plot_8l)
  
  plot_9 <- umap_base(sce, color_by = "dolgalev_celltype_scmapclust")+
    scale_color_manual("dolgalev_celltype_scmapclust",
                       values = col_cts_dolgalev)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Species_ID))
  plot_9l <- umap_legend(sce, color_by = "dolgalev_celltype_scmapclust")+
    scale_color_manual("dolgalev_celltype_scmapclust",
                       values = col_cts_dolgalev)
  legend_dolgalev <- get_legend(plot_9l)
  
  
  plot_10 <- umap_base(sce, color_by = "baccin_celltype_scmapclust")+
    scale_color_manual("baccin_celltype_scmapclust",
                       values = col_cts_baccin)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Age))
  
  plot_11 <- umap_base(sce, color_by = "dahlin_celltype_scmapclust")+
    scale_color_manual("dahlin_celltype_scmapclust",
                       values = col_cts_dahlin)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Age))
  
  plot_12 <- umap_base(sce, color_by = "dolgalev_celltype_scmapclust")+
    scale_color_manual("dolgalev_celltype_scmapclust", 
                       values = col_cts_dolgalev)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Age))
  
  
  plot_13 <- umap_base(sce, color_by = "baccin_celltype_scmapclust")+
    scale_color_manual("baccin_celltype_scmapclust", 
                       values = col_cts_baccin)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Batch_exp_day))
  
  plot_14 <- umap_base(sce, color_by = "dahlin_celltype_scmapclust")+
    scale_color_manual("dahlin_celltype_scmapclust", 
                       values = col_cts_dahlin)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Batch_exp_day))
  
  plot_15 <- umap_base(sce, color_by = "dolgalev_celltype_scmapclust")+
    scale_color_manual("dolgalev_celltype_scmapclust", 
                       values = col_cts_dolgalev)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Batch_exp_day))
  
  
  plot_16 <- umap_base(sce, color_by = "baccin_celltype_scmapclust")+
    scale_color_manual("baccin_celltype_scmapclust", 
                       values = col_cts_baccin)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Batch_sequencing))
  
  plot_17 <- umap_base(sce, color_by = "dahlin_celltype_scmapclust")+
    scale_color_manual("dahlin_celltype_scmapclust", 
                       values = col_cts_dahlin)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Batch_sequencing))
  
  plot_18 <- umap_base(sce, color_by = "dolgalev_celltype_scmapclust")+
    scale_color_manual("dolgalev_celltype_scmapclust", 
                       values = col_cts_dolgalev)+
    ggtitle(paste0(fraction_curr, title))+
    facet_grid(cols = vars(sce$Batch_sequencing)) 
  

  
 
  PLOT_1 <- ggarrange(plot_1, legend_1, widths = c(2, 1))
  PLOT_2 <- ggarrange(plot_2, legend_2, widths = c(2, 1))
  PLOT_3 <- ggarrange(plot_3, legend_3, widths = c(2, 1))
  PLOT_4 <- ggarrange(plot_4, legend_4, widths = c(2, 1))
  PLOT_5 <- ggarrange(plot_5, legend_5, widths = c(2, 1))
  PLOT_6 <- ggarrange(plot_6, legend_6, widths = c(2, 1))
  PLOT_7 <- ggarrange(plot_7, legend_baccin, widths = c(2, 1))
  PLOT_8 <- ggarrange(plot_8, legend_dahlin, widths = c(2, 1))
  PLOT_9 <- ggarrange(plot_9, legend_dolgalev, widths = c(2, 1))
  PLOT_10 <- ggarrange(plot_10, legend_baccin, widths = c(2, 1))
  PLOT_11 <- ggarrange(plot_11, legend_dahlin, widths = c(2, 1))
  PLOT_12 <- ggarrange(plot_12, legend_dolgalev, widths = c(2, 1))
  PLOT_13 <- ggarrange(plot_13, legend_baccin, widths = c(2, 1))
  PLOT_14 <- ggarrange(plot_14, legend_dahlin, widths = c(2, 1))
  PLOT_15 <- ggarrange(plot_13, legend_dolgalev, widths = c(2, 1))
  PLOT_16 <- ggarrange(plot_14, legend_baccin, widths = c(2, 1))
  PLOT_17 <- ggarrange(plot_13, legend_dahlin, widths = c(2, 1))
  PLOT_18 <- ggarrange(plot_14, legend_dolgalev, widths = c(2, 1))  
  plot_list <- list(PLOT_1, PLOT_2, PLOT_3, PLOT_4, PLOT_5, PLOT_6, PLOT_7,
                    PLOT_8, PLOT_9, PLOT_10, PLOT_11, PLOT_12, PLOT_13, PLOT_14,
                    PLOT_15, PLOT_16, PLOT_17, PLOT_18)
  
  return(plot_list)
}

facet_plots_species_07 <- facet_plots(sce_07, title = ", after merging")
facet_plots_species_08 <- facet_plots(sce_08, title = ", after renormalization")
facet_plots_species_09 <- facet_plots(sce_09, title = ", MNN batch correction")

```

### After merging

```{r fig.width=10, fig.height=4}
facet_plots_species_07
```

### After renormalization

```{r fig.width=10, fig.height=4}
facet_plots_species_08
```

### After batch correction

```{r fig.width=10, fig.height=4}
facet_plots_species_09
```

## PCAs

```{r}

make_qc_pcas2 <- function(sce, title){
  
  plot_a <- pca_base2(sce, color_by = "baccin_celltype_scmapclust")+ 
    ggtitle(paste0(fraction_curr, title))+
    scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)
  plot_al <- pca_legend(sce, color_by = "baccin_celltype_scmapclust")+
    scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)
  legend_a <- get_legend(plot_al)

  plot_b <- pca_base2(sce, color_by = "dahlin_celltype_scmapclust")+ 
    ggtitle(paste0(fraction_curr, title))+
    scale_color_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)
  plot_bl <- pca_legend(sce, color_by = "dahlin_celltype_scmapclust")+
    scale_color_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)
  legend_b <- get_legend(plot_bl)
  
  plot_c <- pca_base2(sce, color_by = "dolgalev_celltype_scmapclust")+ 
    ggtitle(paste0(fraction_curr, title))+
    scale_color_manual("dolgalev_celltype_scmapclust", 
                       values = col_cts_dolgalev)
  plot_cl <- pca_legend(sce, color_by = "dolgalev_celltype_scmapclust")+
    scale_color_manual("dolgalev_celltype_scmapclust", 
                       values = col_cts_dolgalev)
  legend_c <- get_legend(plot_cl)
  
  
  plot_1 <- pca_base2(sce, color_by = "Object_ID")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_1l <- pca_legend(sce, color_by = "Object_ID")+
    scale_color_discrete("Object_ID")
  legend_1 <- get_legend(plot_1l)
  
  plot_2 <- pca_base2(sce, color_by = "Batch_sequencing")+
    scale_color_manual("Batch_sequencing", values = col_batch_seq)+
    ggtitle(paste0(fraction_curr, title))
  plot_2l <- pca_legend(sce, color_by = "Batch_sequencing")+
    scale_color_manual("Batch_sequencing", values = col_batch_seq)
  legend_2 <- get_legend(plot_2l)
  
  plot_3 <- pca_base2(sce, color_by = "Batch_exp_day")+ 
    scale_color_manual("Batch_experimental_day",values =  col_batch_exp_day)+
    ggtitle(paste0(fraction_curr, title))
  plot_3l <- pca_legend(sce, color_by = "Batch_exp_day")+
    scale_color_manual("Batch_experimental_day", values = col_batch_exp_day)
  legend_3 <- get_legend(plot_3l)
  
  plot_4 <- pca_base2(sce, color_by = "Date_collected")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_4l <- pca_legend(sce, color_by = "Date_collected")+
    scale_color_discrete("Date of collection")
  legend_4 <- get_legend(plot_4l)
  
  # check everything else
  plot_5 <- pca_base2(sce, color_by = "Species_ID")+ 
    scale_color_manual("Species", values = col_species)+
    ggtitle(paste0(fraction_curr, title))
  plot_5l <- pca_legend(sce, color_by = "Species_ID")+
    scale_color_manual("Species", values = col_species)
  legend_5 <- get_legend(plot_5l)
  
  plot_6 <- pca_base2(sce, color_by = "Age_ID")+ 
    scale_color_manual("Age", values = col_ann_age)+
    ggtitle(paste0(fraction_curr, title))
  plot_6l <- pca_legend(sce, color_by = "Age_ID")+
    scale_color_manual("Age", values = col_ann_age)
  legend_6 <- get_legend(plot_6l) 
  
  plot_7 <- pca_base2(sce, color_by = "Fraction_ID")+ 
    scale_color_manual("Fraction", values = col_ann_fraction)+
    ggtitle(paste0(fraction_curr, title))
  plot_7l <- pca_legend(sce, color_by = "Fraction_ID")+
    scale_color_manual("Fraction", values = col_ann_fraction)
  legend_7 <- get_legend(plot_7l) 
 
  plot_8 <- pca_base2(sce, color_by = "Antibody_combination")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_8l <- pca_legend(sce, color_by = "Antibody_combination")+
    scale_color_discrete("Antibody combination")
  legend_8 <- get_legend(plot_8l)
  
  plot_9 <- pca_base2(sce, color_by = "doublet_score")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_9l <- pca_legend(sce, color_by = "doublet_score")+
    scale_color_continuous("Doublet score")
  legend_9 <- get_legend(plot_9l)
  
  plot_10 <- pca_base2(sce, color_by = "Keep_sample")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_10l <- pca_legend(sce, color_by = "Keep_sample")+
    scale_color_discrete("Keep_sample")
  legend_10 <- get_legend(plot_10l)
  
  PLOT_A <- ggarrange(plot_a, legend_a)
  PLOT_B <- ggarrange(plot_b, legend_b)
  PLOT_C <- ggarrange(plot_c, legend_c)
  PLOT_1 <- ggarrange(plot_1, legend_1)
  PLOT_2 <- ggarrange(plot_2, legend_2)
  PLOT_3 <- ggarrange(plot_3, legend_3)
  PLOT_4 <- ggarrange(plot_4, legend_4)
  PLOT_5 <- ggarrange(plot_5, legend_5)
  PLOT_6 <- ggarrange(plot_6, legend_6)
  PLOT_7 <- ggarrange(plot_7, legend_7)
  PLOT_8 <- ggarrange(plot_8, legend_8)
  PLOT_9 <- ggarrange(plot_9, legend_9)
  PLOT_10 <- ggarrange(plot_10, legend_10)

  plot_list <- list(PLOT_1, PLOT_2, PLOT_3, PLOT_4, PLOT_5, PLOT_6, PLOT_7,
                    PLOT_8, PLOT_9, PLOT_10, PLOT_A, PLOT_B, PLOT_C)
  return(plot_list)
  
}

qc_pcas_species_07 <- make_qc_pcas2(sce_07, title = ", after merging")
qc_pcas_species_08 <- make_qc_pcas2(sce_08, title = ", after renormalization")
qc_pcas_species_09 <- make_qc_pcas2(sce_09, title = ", MNN batch correction")

```

### After merging

```{r fig.width=10, fig.height=5}
qc_pcas_species_07
```

### After renormalization

```{r fig.width=10, fig.height=5}
qc_pcas_species_08
```

### After batch correction

```{r fig.width=10, fig.height=5}
qc_pcas_species_09
```

```{r}

make_qc_pcas3 <- function(sce, title){

  plot_a <- pca_base3(sce, color_by = "baccin_celltype_scmapclust")+ # own function
    ggtitle(paste0(fraction_curr, title))+
    scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)
  plot_al <- pca_legend(sce, color_by = "baccin_celltype_scmapclust")+
    scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)
  legend_a <- get_legend(plot_al)

  plot_b <- pca_base3(sce, color_by = "dahlin_celltype_scmapclust")+ 
    ggtitle(paste0(fraction_curr, title))+
    scale_color_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)
  plot_bl <- pca_legend(sce, color_by = "dahlin_celltype_scmapclust")+
    scale_color_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)
  legend_b <- get_legend(plot_bl)
  
  plot_c <- pca_base3(sce, color_by = "dolgalev_celltype_scmapclust")+ 
    ggtitle(paste0(fraction_curr, title))+
    scale_color_manual("dolgalev_celltype_scmapclust",
                       values = col_cts_dolgalev)
  plot_cl <- pca_legend(sce, color_by = "dolgalev_celltype_scmapclust")+
    scale_color_manual("dolgalev_celltype_scmapclust",
                       values = col_cts_dolgalev)
  legend_c <- get_legend(plot_cl)
  
    
  plot_1 <- pca_base3(sce, color_by = "Object_ID")+ # own function
    ggtitle(paste0(fraction_curr, title))
  plot_1l <- pca_legend(sce, color_by = "Object_ID")+
    scale_color_discrete("Object_ID")
  legend_1 <- get_legend(plot_1l)
  
  plot_2 <- pca_base3(sce, color_by = "Batch_sequencing")+
    scale_color_manual("Batch_sequencing", values = col_batch_seq)+
    ggtitle(paste0(fraction_curr, title))
  plot_2l <- pca_legend(sce, color_by = "Batch_sequencing")+
    scale_color_manual("Batch_sequencing", values = col_batch_seq)
  legend_2 <- get_legend(plot_2l)
  
  plot_3 <- pca_base3(sce, color_by = "Batch_exp_day")+ 
    scale_color_manual("Batch_experimental_day",values =  col_batch_exp_day)+
    ggtitle(paste0(fraction_curr, title))
  plot_3l <- pca_legend(sce, color_by = "Batch_exp_day")+
    scale_color_manual("Batch_experimental_day", values = col_batch_exp_day)
  legend_3 <- get_legend(plot_3l)
  
  plot_4 <- pca_base3(sce, color_by = "Date_collected")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_4l <- pca_legend(sce, color_by = "Date_collected")+
    scale_color_discrete("Date of collection")
  legend_4 <- get_legend(plot_4l)
  
  # check everything else
  plot_5 <- pca_base3(sce, color_by = "Species_ID")+ 
    scale_color_manual("Species", values = col_species)+
    ggtitle(paste0(fraction_curr, title))
  plot_5l <- pca_legend(sce, color_by = "Species_ID")+
    scale_color_manual("Species", values = col_species)
  legend_5 <- get_legend(plot_5l)
  
  plot_6 <- pca_base3(sce, color_by = "Age_ID")+ 
    scale_color_manual("Age", values = col_ann_age)+
    ggtitle(paste0(fraction_curr, title))
  plot_6l <- pca_legend(sce, color_by = "Age_ID")+
    scale_color_manual("Age", values = col_ann_age)
  legend_6 <- get_legend(plot_6l) 
  
  plot_7 <- pca_base3(sce, color_by = "Fraction_ID")+ 
    scale_color_manual("Fraction", values = col_ann_fraction)+
    ggtitle(paste0(fraction_curr, title))
  plot_7l <- pca_legend(sce, color_by = "Fraction_ID")+
    scale_color_manual("Fraction", values = col_ann_fraction)
  legend_7 <- get_legend(plot_7l) 
 
  plot_8 <- pca_base3(sce, color_by = "Antibody_combination")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_8l <- pca_legend(sce, color_by = "Antibody_combination")+
    scale_color_discrete("Antibody combination")
  legend_8 <- get_legend(plot_8l)
  
  plot_9 <- pca_base3(sce, color_by = "doublet_score")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_9l <- pca_legend(sce, color_by = "doublet_score")+
    scale_color_continuous("Doublet score")
  legend_9 <- get_legend(plot_9l)
  
  plot_10 <- pca_base3(sce, color_by = "Keep_sample")+ 
    ggtitle(paste0(fraction_curr, title))
  plot_10l <- pca_legend(sce, color_by = "Keep_sample")+
    scale_color_discrete("Keep_sample")
  legend_10 <- get_legend(plot_10l)
  
  PLOT_A <- ggarrange(plot_a, legend_a)
  PLOT_B <- ggarrange(plot_b, legend_b)
  PLOT_C <- ggarrange(plot_c, legend_c)
  PLOT_1 <- ggarrange(plot_1, legend_1)
  PLOT_2 <- ggarrange(plot_2, legend_2)
  PLOT_3 <- ggarrange(plot_3, legend_3)
  PLOT_4 <- ggarrange(plot_4, legend_4)
  PLOT_5 <- ggarrange(plot_5, legend_5)
  PLOT_6 <- ggarrange(plot_6, legend_6)
  PLOT_7 <- ggarrange(plot_7, legend_7)
  PLOT_8 <- ggarrange(plot_8, legend_8)
  PLOT_9 <- ggarrange(plot_9, legend_9)
  PLOT_10 <- ggarrange(plot_10, legend_10)

  plot_list <- list(PLOT_1, PLOT_2, PLOT_3, PLOT_4, PLOT_5, PLOT_6, PLOT_7,
                    PLOT_8, PLOT_9, PLOT_10, PLOT_A, PLOT_B, PLOT_C)
  return(plot_list)
  
}

qc_pcas_species_07 <- make_qc_pcas3(sce_07, title = ", after merging")
qc_pcas_species_08 <- make_qc_pcas3(sce_08, title = ", after renormalization")
qc_pcas_species_09 <- make_qc_pcas3(sce_09,  title = ", MNN batch correction")

```

### After merging

```{r fig.width=10, fig.height=5}
qc_pcas_species_07
```

### After renormalization

```{r fig.width=10, fig.height=5}
qc_pcas_species_08
```

### After batch correction

```{r fig.width=10, fig.height=5}
qc_pcas_species_09
```

# Cell Mixing Score

Evaluates how well cells are mixed
(https://bioconductor.org/packages/release/bioc/vignettes/CellMixS/inst/doc/CellMixS.html#cellspecific-mixing-scores)
and https://www.life-science-alliance.org/content/4/6/e202001004
This takes quite long.

```{r}

sce_07 <- cms(sce_07, group = "Batch_exp_day", k = 30,
              assay_name = "logcounts", res_name = "Logcounts")

sce_09 <- cms(sce_09, group = "Batch_exp_day", k = 30,
              assay_name = "reconstructed", 
              res_name = "MNN")

```

The p-val distribution should be relatively even for good batch mixing.
Due to cell type imbalance (see below) it is unlikely that the results
will be great.

```{r}
visHist(sce_07, n_col = 3)
```

```{r}
visHist(sce_09, n_col = 3)
```

# Lisi

The majority of values should be closer to the maximum number of categories 
per variable.
Due to the observed imbalance in certain cell types per batch (see below), 
perfect LISI scores are unlikely.

https://github.com/immunogenomics/LISI
and
https://www.nature.com/articles/s41592-019-0619-0

```{r}

batches <- c("Object_ID", "Batch_exp_day", "Batch_sequencing")

max_obj <- length(unique(sce_07$Object_ID))
max_bed <- length(unique(sce_07$Batch_exp_day))
max_bsq <- length(unique(sce_07$Batch_sequencing))

```

```{r}

plot_lisi <- function(sce, title){
  
  batches <- c("Object_ID", "Batch_exp_day", "Batch_sequencing")
  
  mat <- reducedDim(sce, type = "PCA")
  meta_data <- colData(sce)[,colnames(colData(sce)) %in% batches]
  res <- compute_lisi(mat, meta_data, batches)

  plot_a <- ggplot(res, aes(x = Object_ID,))+
    geom_histogram()+
    theme_classic()+
    ggtitle(paste(fraction_curr, 
                  title, "Features, max nr category:", max_obj), " ")

  plot_b <- ggplot(res, aes(x = Batch_exp_day,))+
    geom_histogram()+
    theme_classic()+
    ggtitle(paste(fraction_curr, 
                  title, "Features, max nr category:", max_bed), " ")

  plot_c <- ggplot(res, aes(x = Batch_sequencing,))+
    geom_histogram()+
    theme_classic()+
    ggtitle(paste(fraction_curr, 
                  title, "Features, max nr category:",max_bsq), " ")

  return(list(plot_a, plot_b, plot_c))
  
}

lisi_07 <- plot_lisi(sce_07, title = "after merging")
lisi_09 <- plot_lisi(sce_09, title = "MNN Batch correction")

lisi_07
lisi_09

```

# Cell type proportions

To get an idea of cell numbers (according to refernce dataset).
Also helps understand balance of cell types in batches.

Using only one object is enough for this.

```{r}
sce <- sce_07
```

## Per Sample

```{r}

ggdf <- data.frame(colData(sce))

# BACCIN
plot1 <- ggplot(ggdf, aes(x = Object_ID,
                          y=baccin_celltype_scmapclust,
                          fill=baccin_celltype_scmapclust, 
                          color = baccin_celltype_scmapclust))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("baccin_celltype_scmapclust", values = col_cts_baccin)+
  scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)

plot_baccin_leg <- ggplot(ggdf, aes(x = Object_ID, 
                                    y=baccin_celltype_scmapclust,
                                    fill=baccin_celltype_scmapclust))+
  geom_col()+
  scale_fill_manual("baccin_celltype_scmapclust", values = col_cts_baccin)
legend_baccin <- get_legend(plot_baccin_leg)

plot2 <- ggplot(ggdf, aes(x = Object_ID, 
                          fill=baccin_celltype_scmapclust, 
                          color = baccin_celltype_scmapclust))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("baccin_celltype_scmapclust", values = col_cts_baccin)+
  scale_color_manual(values = col_cts_baccin)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)


# DAHLIN
plot3 <- ggplot(ggdf, aes(x = Object_ID, 
                          y=dahlin_celltype_scmapclust,
                          fill=dahlin_celltype_scmapclust,
                          color = dahlin_celltype_scmapclust))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)+
  scale_color_manual(values = col_cts_dahlin)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)

plot_dahlin_leg <- ggplot(ggdf, aes(x = Object_ID, 
                                  y=dahlin_celltype_scmapclust,
                                  fill=dahlin_celltype_scmapclust))+
  geom_col()+
  scale_fill_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)
legend_dahlin <- get_legend(plot_dahlin_leg)
                    
plot4 <- ggplot(ggdf, aes(x = Object_ID, 
                          fill=dahlin_celltype_scmapclust, 
                          color = dahlin_celltype_scmapclust))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)+
  scale_color_manual(values = col_cts_dahlin)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)


# DOLGALEV
plot5 <- ggplot(ggdf, aes(x = Object_ID, 
                          y=dolgalev_celltype_scmapclust,
                          fill=dolgalev_celltype_scmapclust,
                          color = dolgalev_celltype_scmapclust))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("dolgalev_celltype_scmapclust", values = col_cts_dolgalev)+
  scale_color_manual(values = col_cts_dolgalev)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)

plot_dolgalev_leg <- ggplot(ggdf, aes(x = Object_ID, 
                                  y=dolgalev_celltype_scmapclust,
                                  fill=dolgalev_celltype_scmapclust))+
  geom_col()+
  scale_fill_manual("dolgalev_celltype_scmapclust", values = col_cts_dolgalev)
legend_dolgalev <- get_legend(plot_dolgalev_leg)
                    
plot6 <- ggplot(ggdf, aes(x = Object_ID, 
                          fill=dolgalev_celltype_scmapclust, 
                          color = dolgalev_celltype_scmapclust))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("dolgalev_celltype_scmapclust", values = col_cts_dolgalev)+
  scale_color_manual(values = col_cts_dolgalev)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)



PLOT1 <- ggarrange(plot1, legend_baccin)
PLOT2 <- ggarrange(plot2, legend_baccin)
PLOT3 <- ggarrange(plot3, legend_dahlin)
PLOT4 <- ggarrange(plot4, legend_dahlin)
PLOT5 <- ggarrange(plot5, legend_dolgalev)
PLOT6 <- ggarrange(plot6, legend_dolgalev)

PLOT1
PLOT2
PLOT3
PLOT4
PLOT5
PLOT6
```

## Per Experimental Day

```{r}

# BACCIN
plot1 <- ggplot(ggdf, aes(x = Batch_exp_day,
                          y=baccin_celltype_scmapclust,
                          fill=baccin_celltype_scmapclust, 
                          color = baccin_celltype_scmapclust))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("baccin_celltype_scmapclust", values = col_cts_baccin)+
  scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)

plot2 <- ggplot(ggdf, aes(x = Batch_exp_day, 
                          fill=baccin_celltype_scmapclust, 
                          color = baccin_celltype_scmapclust))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("baccin_celltype_scmapclust", values = col_cts_baccin)+
  scale_color_manual(values = col_cts_baccin)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)


# DAHLIN
plot3 <- ggplot(ggdf, aes(x = Batch_exp_day, 
                          y=dahlin_celltype_scmapclust,
                          fill=dahlin_celltype_scmapclust,
                          color = dahlin_celltype_scmapclust))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)+
  scale_color_manual(values = col_cts_dahlin)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)

plot4 <- ggplot(ggdf, aes(x = Batch_exp_day, 
                          fill=dahlin_celltype_scmapclust, 
                          color = dahlin_celltype_scmapclust))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)+
  scale_color_manual(values = col_cts_dahlin)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)


# DOLGALEV
plot5 <- ggplot(ggdf, aes(x = Batch_exp_day, 
                          y=dolgalev_celltype_scmapclust,
                          fill=dolgalev_celltype_scmapclust,
                          color = dolgalev_celltype_scmapclust))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("dolgalev_celltype_scmapclust", values = col_cts_dolgalev)+
  scale_color_manual(values = col_cts_dolgalev)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)

plot6 <- ggplot(ggdf, aes(x = Batch_exp_day, 
                          fill=dolgalev_celltype_scmapclust, 
                          color = dolgalev_celltype_scmapclust))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("dolgalev_celltype_scmapclust", values = col_cts_dolgalev)+
  scale_color_manual(values = col_cts_dolgalev)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)



PLOT1 <- ggarrange(plot1, legend_baccin)
PLOT2 <- ggarrange(plot2, legend_baccin)
PLOT3 <- ggarrange(plot3, legend_dahlin)
PLOT4 <- ggarrange(plot4, legend_dahlin)
PLOT5 <- ggarrange(plot5, legend_dolgalev)
PLOT6 <- ggarrange(plot6, legend_dolgalev)

PLOT1
PLOT2
PLOT3
PLOT4
PLOT5
PLOT6
```

## Per species

```{r}

# BACCIN
plot1 <- ggplot(ggdf, aes(x = Species_ID,
                          y=baccin_celltype_scmapclust,
                          fill=baccin_celltype_scmapclust, 
                          color = baccin_celltype_scmapclust))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("baccin_celltype_scmapclust", values = col_cts_baccin)+
  scale_color_manual("baccin_celltype_scmapclust", values = col_cts_baccin)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)

plot2 <- ggplot(ggdf, aes(x = Species_ID, 
                          fill=baccin_celltype_scmapclust, 
                          color = baccin_celltype_scmapclust))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("baccin_celltype_scmapclust", values = col_cts_baccin)+
  scale_color_manual(values = col_cts_baccin)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)


# DAHLIN
plot3 <- ggplot(ggdf, aes(x = Species_ID, 
                          y=dahlin_celltype_scmapclust,
                          fill=dahlin_celltype_scmapclust,
                          color = dahlin_celltype_scmapclust))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)+
  scale_color_manual(values = col_cts_dahlin)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)


plot4 <- ggplot(ggdf, aes(x = Species_ID, 
                          fill=dahlin_celltype_scmapclust, 
                          color = dahlin_celltype_scmapclust))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("dahlin_celltype_scmapclust", values = col_cts_dahlin)+
  scale_color_manual(values = col_cts_dahlin)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)


# DOLGALEV
plot5 <- ggplot(ggdf, aes(x = Species_ID, 
                          y=dolgalev_celltype_scmapclust,
                          fill=dolgalev_celltype_scmapclust,
                          color = dolgalev_celltype_scmapclust))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("dolgalev_celltype_scmapclust", values = col_cts_dolgalev)+
  scale_color_manual(values = col_cts_dolgalev)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)

plot6 <- ggplot(ggdf, aes(x = Species_ID, 
                          fill=dolgalev_celltype_scmapclust, 
                          color = dolgalev_celltype_scmapclust))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual("dolgalev_celltype_scmapclust", values = col_cts_dolgalev)+
  scale_color_manual(values = col_cts_dolgalev)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(fraction_curr)

PLOT1 <- ggarrange(plot1, legend_baccin)
PLOT2 <- ggarrange(plot2, legend_baccin)
PLOT3 <- ggarrange(plot3, legend_dahlin)
PLOT4 <- ggarrange(plot4, legend_dahlin)
PLOT5 <- ggarrange(plot5, legend_dolgalev)
PLOT6 <- ggarrange(plot6, legend_dolgalev)

PLOT1
PLOT2
PLOT3
PLOT4
PLOT5
PLOT6

```

```{r}
sessionInfo()
```
