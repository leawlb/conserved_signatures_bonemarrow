---
title: "Downsampling report"
author: "Lea WÃ¶lbert"
date: '2022-12-06'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

To evaluate the effect of downsampling on the age merge counts.

#### Load libraries, source code 

```{r load,  message = FALSE}
library(scater, quietly = TRUE) 
library(scran, quietly = TRUE) 
library(tidyverse, quietly = TRUE) 
set.seed(37)
```

```{r}

source(file = "../../source/plotting.R")
source(file = "../../source/sce_functions.R")

sce_input_path <- snakemake@input[["sce_input_path"]]

sce_list <- list()
for(i in 1:length(sce_input_path)){
  sce_list[[i]] <- readRDS(file = sce_input_path[[i]])
}

lrdb <- readRDS(file = snakemake@input[["lrdb_input"]])
```

# Check all Conditions

- cluster or cell type labels:
  - should be in colData slot called "Identity"
  - should not be able to grep each other (e.g. "B cell" and "pre-B cell")
  - should not contain ungreppable characters (+, (, ), or &)
  - should be factored (preferably in a reasonable sequence)

- RowData
  - rownames should contain Gene Symbols
  - a rowData slot called "ENSMUS_ID" should countain Gene IDs 

- Emitter/Receiver Assignment:
  - should be in colData slot called "Assignment"
  - should contain "emitter" for designated emitter cells
  - should contain "receiver" for designated receiver cells  
  
- Quality
  - all SCE objects to be compared should have comparable counts matrices
  - downsampled to lowest quality samples
  
  
## 1. Cluster cell type labels and 3. Assignment

```{r}
for(i in 1:length(sce_list)){
  print(paste(sce_list[[i]]$species_ID[1], sce_list[[i]]$Age_ID[1]))
  print(levels(sce_list[[i]]$Identity))
}
```

## 2. RowData

```{r}
for(i in 1:length(sce_list)){
  print(rowData(sce_list[[i]]))
}
```

```{r}
for(i in 1:length(sce_list)){
  print(paste(sce_list[[i]]$species_ID[1], sce_list[[i]]$Age_ID[1]))
  print(table(sce_list[[i]]$Identity, sce_list[[i]]$Assignment))
}
```


# Calculate Stats

```{r}

qcdf_list <- lapply(sce_list, function(sce){
  
  qcdf_counts <- perCellQCMetrics(sce, assay.type = "counts")
  qcdf_downsm <- perCellQCMetrics(sce, assay.type = "downsampled")
  
  qcdf_counts$Object_ID <- sce$Object_ID
  qcdf_downsm$Object_ID <- sce$Object_ID

  qcdf_counts$Species_ID <- sce$Species_ID
  qcdf_downsm$Species_ID <- sce$Species_ID

  qcdf_counts$Age_ID <- sce$Age
  qcdf_downsm$Age_ID <- sce$Age
  
  qcdf_counts$Identity <- sce$Identity
  qcdf_downsm$Identity <- sce$Identity
  
  qcdf_counts$Status <- "before downsampling"
  qcdf_downsm$Status <- "after downsampling"
  
  qcdf_both <- rbind(qcdf_counts, qcdf_downsm)

  return(qcdf_both)
}) 

qcdf_gg <- DataFrame()
for(i in qcdf_list){
  qcdf_gg <- rbind(qcdf_gg, i)
}
qcdf_gg <- as.data.frame(qcdf_gg)
```

# Show stats

## How much did they change (per cell type)?

```{r, fig.height = 12}

qcdf_gg_yng <- qcdf_gg[qcdf_gg$Age_ID == "young",]
ggplot(qcdf_gg_yng, aes(x = Status, y = sum,
                    color = Status, alpha = 0.5))+
  geom_jitter(size = 0.1, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_yng$Identity),
             rows = vars(qcdf_gg_yng$Species_ID))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r, fig.height = 12}

qcdf_gg_old <- qcdf_gg[qcdf_gg$Age_ID == "old",]
ggplot(qcdf_gg_old, aes(x = Status, y = sum,
                    color = Status, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_old$Identity),
             rows = vars(qcdf_gg_old$Species_ID))+
  theme(strip.text.x = element_text(angle = 90))
```

## Are they similar afterwards?

```{r, fig.width= 12}

qcdf_gg_ds <- qcdf_gg[qcdf_gg$Status == "after downsampling",]
ggplot(qcdf_gg_ds, aes(x = Species_ID, y = sum,
                        color = Species_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_ds$Identity))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r, fig.width= 12}

ggplot(qcdf_gg_ds, aes(x = Age_ID, y = sum,
                        color = Age_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_ds$Identity))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r}

ggplot(qcdf_gg_ds, aes(x = Species_ID, y = sum,
                        color = Species_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_ds$Age_ID))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r}

ggplot(qcdf_gg_ds, aes(x = Age_ID, y = sum,
                        color = Age_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_ds$Species_ID))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r}

qcdf_gg_ds <- qcdf_gg[qcdf_gg$Status == "after downsampling",]
ggplot(qcdf_gg_ds, aes(x = Species_ID, y = detected,
                        color = Species_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_ds$Age_ID))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r}

ggplot(qcdf_gg_ds, aes(x = Age_ID, y = detected,
                        color = Age_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_ds$Species_ID))+
  theme(strip.text.x = element_text(angle = 90))
```

# How similar were they before?

```{r, fig.width= 12}

qcdf_gg_bf <- qcdf_gg[qcdf_gg$Status == "before downsampling",]
ggplot(qcdf_gg_bf, aes(x = Species_ID, y = sum,
                        color = Species_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_bf$Identity))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r, fig.width= 12}

ggplot(qcdf_gg_bf, aes(x = Age_ID, y = sum,
                        color = Age_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_bf$Identity))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r}

ggplot(qcdf_gg_bf, aes(x = Species_ID, y = sum,
                        color = Species_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_bf$Age_ID))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r}

ggplot(qcdf_gg_bf, aes(x = Age_ID, y = sum,
                        color = Age_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  ylim(limits = c(0, 120000))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_bf$Species_ID))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r}

ggplot(qcdf_gg_bf, aes(x = Species_ID, y = detected,
                        color = Species_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_bf$Age_ID))+
  theme(strip.text.x = element_text(angle = 90))
```

```{r}

ggplot(qcdf_gg_bf, aes(x = Age_ID, y = detected,
                        color = Age_ID, alpha = 0.25))+
  geom_jitter(size = 0.3, alpha = 50)+
  geom_violin(color = "black", alpha = 0, draw_quantiles = 0.5)+
  theme_classic()+
  theme(axis.text = element_text(angle = 90))+
  scale_y_log10()+
  facet_grid(cols = vars(qcdf_gg_bf$Species_ID))+
  theme(strip.text.x = element_text(angle = 90))
```

# Check LRDB and SCE Gene Symbol/Gene ID mapping

There should be no duplicated Gene Symbols for unique Gene IDs, and vice versa.

## LRDB Ligands

```{r}
# unique symbols
# a TRUE would indicate that one ID can have two genes
# or in other words, that two genes shared an ID
lrdb_temp <- lrdb[!duplicated(lrdb$ligand_gene_symbol),]
table(duplicated(lrdb_temp$ligand_gene_id))
```

```{r}
# unique IDs
# a TRUE would indicate that one gene can have two IDs
# or in other words, that two IDs share one gene
lrdb_temp <- lrdb[!duplicated(lrdb$ligand_gene_id),]
table(duplicated(lrdb_temp$ligand_gene_symbol))
```

## LRDB Receptors

```{r}
lrdb_temp <- lrdb[!duplicated(lrdb$receptor_gene_symbol),]
table(duplicated(lrdb_temp$receptor_gene_id))
```

```{r}
lrdb_temp <- lrdb[!duplicated(lrdb$receptor_gene_id),]
table(duplicated(lrdb_temp$receptor_gene_symbol))
```

## SCE 

```{r}
for(i in 1:length(sce_list)){
  sce_temp <- sce_list[[i]]
  sce_temp2 <- sce_temp[!duplicated(rowData(sce_temp)$Symbol),]
  table(duplicated(rowData(sce_temp2)$ENSMUS_ID))
  
  sce_temp2 <- sce_temp[!duplicated(rowData(sce_temp)$ENSMUS_ID),]
  table(duplicated(rowData(sce_temp2)$Symbol))
}
```

```{r}
sessionInfo()
```