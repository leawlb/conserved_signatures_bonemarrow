---
title: "Full Clustering report"
author: "Lea WÃ¶lbert"
date: '2022-12-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Report for clustering as part of manual annotation

#### Load libraries, source code 

```{r load,  message = FALSE}
library(DropletUtils, quietly = TRUE) 
library(scater, quietly = TRUE) 
library(scuttle, quietly = TRUE) 
library(scran, quietly = TRUE) 
library(tidyverse, quietly = TRUE) 
library(dendextend, quietly = TRUE) 
library(factoextra, quietly = TRUE) 
library(pheatmap, quietly = TRUE) 
library(bluster, quietly = TRUE)
library(pheatmap, quietly = TRUE)
library(RColorBrewer, quietly = TRUE)
library(phateR, quietly = TRUE)
```

```{r}
sce_09 <- readRDS(file = snakemake@input[["sce_09"]])
sce_13 <- readRDS(file = snakemake@input[["sce_13"]])

number_k <- snakemake@params[["number_k"]]
color_tables <- snakemake@params[["color_tables"]]

species_curr <- sce_09$Species_ID[1]
```

```{r}
source(file = "../source/colors.R")
source(file = "../source/plotting.R")
source(file = "../source/sce_functions.R")
```

```{r}
col_cts_all <- col_cts[names(col_cts) %in% sce_13$Identity_ref_all]
col_cts_fraction <- col_cts[names(col_cts) %in% sce_13$Identity_ref_fraction]
col_batch_exp_day <- col_alp[names(col_alp) %in% sce_13$Batch_exp_day]
col_batch_seq <- col_num[names(col_num) %in% sce_13$Batch_sequencing]
col_ann_age <- col_ann[names(col_ann) %in% sce_13$Age_ID]
col_ann_fraction <- col_ann[names(col_ann) %in% sce_13$Fraction_ID]
col_species <- col_spc[names(col_spc) %in% sce_13$Species_ID]
col_clust_h <- col_num[names(col_num) %in% sce_13$cluster_hierarchical]
col_clust_s <- col_num[names(col_num) %in% sce_13$cluster_seurat]
col_clust_l <- col_num[names(col_num) %in% sce_13$cluster_louvain]

col_cts_cluster_baccin <- col_cts[names(col_cts) %in% sce_13$cluster_ref_baccin]
col_cts_cluster_dahlin <- col_cts[names(col_cts) %in% sce_13$cluster_ref_dahlin]
col_cts_cluster_dolgalev <- col_cts[names(col_cts) %in% sce_13$cluster_ref_dolgalev]
```

Annotations for reference.

```{r}

identity_plots <- function(sce){
  
  plot_1 <- umap_base(sce, color_by = "Identity_ref_all")+ # own function
    ggtitle(paste0(species_curr))+
    scale_color_manual("Identity1", values = col_cts_all)
  
  plot_1l <- umap_legend(sce, color_by = "Identity_ref_all")+
    scale_color_manual("Identity1", values = col_cts_all)
  legend_1 <- get_legend(plot_1l)

    
  plot_2 <- umap_base(sce, color_by = "Identity_ref_fraction")+
    ggtitle(paste0(species_curr))+
    scale_color_manual("Identity2", values = col_cts_fraction)
  
  plot_2l <- umap_legend(sce, color_by = "Identity_ref_fraction")+
    scale_color_manual("Identity2", values = col_cts_fraction)
  legend_2 <- get_legend(plot_2l)
  
  PLOT_1 <- ggarrange(plot_1, legend_1)
  PLOT_2 <- ggarrange(plot_2, legend_2, ncol = 1)

  return(list(PLOT_1, PLOT_2))
}

identity_plots_09 <- identity_plots(sce_13)

```

```{r fig.width=8, fig.height=4}
identity_plots_09[[1]]
```

```{r fig.width=4, fig.height=8}
identity_plots_09[[2]]
rm(identity_plots_09)
```

Annotated with scmap cluster.

```{r}
print(table(sce_13$cluster_ref_baccin))
```

```{r}
print(table(sce_13$cluster_ref_dahlin))
```

```{r}
print(table(sce_13$cluster_ref_dolgalev))
```

```{r}

identity_plots <- function(sce){
  
  plot_1a <- umap_base(sce, color_by = "cluster_ref_baccin")+ # own function
    ggtitle(paste0(species_curr))+
    scale_color_manual("Baccin reference clusters", values = col_cts_cluster_baccin)
  plot_1al <- umap_legend(sce, color_by = "cluster_ref_baccin")+
    scale_color_manual("Baccin reference clusters", values = col_cts_cluster_baccin)
  legend_1a <- get_legend(plot_1al)

  plot_1b <- umap_base(sce, color_by = "cluster_ref_baccin_similarities")+
    ggtitle(paste0(species_curr))+
    scale_colour_gradient(low = "black", high = "gold")
  plot_1bl <- umap_legend(sce, color_by = "cluster_ref_baccin_similarities")+
    scale_colour_gradient(low = "black", high = "gold", name = "Baccin reference cluster similarity")
  legend_1b <- get_legend(plot_1bl)

  plot_2a <- umap_base(sce, color_by = "cluster_ref_dahlin")+
    ggtitle(paste0(species_curr))+
  scale_color_manual("Dahlin reference clusters", values = col_cts_cluster_dahlin)
  plot_2al <- umap_legend(sce, color_by = "cluster_ref_dahlin")+
    scale_color_manual("Dahlin reference clusters", values = col_cts_cluster_dahlin)
  legend_2a <- get_legend(plot_2al)
  
  plot_2b <- umap_base(sce, color_by = "cluster_ref_dahlin_similarities")+
    ggtitle(paste0(species_curr))+
    scale_colour_gradient(low = "black", high = "gold")
  plot_2bl <- umap_legend(sce, color_by = "cluster_ref_dahlin_similarities")+
    scale_colour_gradient(low = "black", high = "gold", name = "Dahlin reference cluster similarity")
  legend_2b <- get_legend(plot_2bl)
  
   plot_3a <- umap_base(sce, color_by = "cluster_ref_dolgalev")+
    ggtitle(paste0(species_curr))+
    scale_color_manual("Dolgalev reference clusters", values = col_cts_cluster_dolgalev)
  plot_3al <- umap_legend(sce, color_by = "cluster_ref_dolgalev")+
    scale_color_manual("Dolgalev reference clusters", values = col_cts_cluster_dolgalev)
  legend_3a <- get_legend(plot_3al)
  
  plot_3b <- umap_base(sce, color_by = "cluster_ref_dolgalev_similarities")+
    ggtitle(paste0(species_curr))+
    scale_colour_gradient(low = "black", high = "gold")
  plot_3bl <- umap_legend(sce, color_by = "cluster_ref_dolgalev_similarities")+
    scale_colour_gradient(low = "black", high = "gold", name = "Dolgalev reference cluster similarity")
  legend_3b <- get_legend(plot_3bl)
  
  PLOT_1a <- ggarrange(plot_1a, legend_1a)
  PLOT_1b <- ggarrange(plot_1b, legend_1b)
  PLOT_2a <- ggarrange(plot_2a, legend_2a)
  PLOT_2b <- ggarrange(plot_2b, legend_2b)
  PLOT_3a <- ggarrange(plot_3a, legend_3a)
  PLOT_3b <- ggarrange(plot_3b, legend_3b)
  return(list(PLOT_1a, PLOT_1b, PLOT_2a, PLOT_2b, PLOT_3a, PLOT_3b))
}

cluster_plots_13 <- identity_plots(sce_13)

```

```{r fig.width=8, fig.height=4}
cluster_plots_13
```

# Hierarchical clustering

```{r}
print(table(sce_13$cluster_hierarchical))
```

## Clusters

```{r fig.width=8, fig.height=4}

plot_1 <- umap_base(sce_13, color_by = "cluster_hierarchical")+ # own function
  ggtitle(paste0(species_curr, " ", sce_13$hierarchical_mode[1]))+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)
plot_1l <- umap_legend(sce_13, color_by = "cluster_hierarchical")+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)
legend_1 <- get_legend(plot_1l)

plot_2 <- pca_base2(sce_13, color_by = "cluster_hierarchical")+ # own function
  ggtitle(paste0(species_curr, " ", sce_13$hierarchical_mode[1]))+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)
plot_2l <- pca_legend(sce_13, color_by = "cluster_hierarchical")+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)
legend_2 <- get_legend(plot_2l)

plot_3 <- pca_base3(sce_13, color_by = "cluster_hierarchical")+ # own function
  ggtitle(paste0(species_curr, " ", sce_13$hierarchical_mode[1]))+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)
plot_3l <- pca_legend(sce_13, color_by = "cluster_hierarchical")+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)
legend_3 <- get_legend(plot_3l)

PLOT_1 <- ggarrange(plot_1, legend_1)
PLOT_2 <- ggarrange(plot_2, legend_2)
PLOT_3 <- ggarrange(plot_3, legend_3)
  
PLOT_1
PLOT_2
PLOT_3

rm(PLOT_1, PLOT_2, PLOT_3, plot_1, plot_2, plot_3, legend_1, legend_2, legend_3)
```

## QC

```{r fig.width=8, fig.height=4}

ggdf <- data.frame(colData(sce_13))

plot1a <- ggplot(ggdf, aes(x = cluster_hierarchical, y=Batch_exp_day,
                          fill=Batch_exp_day, color = Batch_exp_day))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Experimental day", values = col_batch_exp_day)+
  scale_color_manual(name = "Experimental day", values = col_batch_exp_day)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  theme(axis.title.y = element_blank())

plot1b <- ggplot(ggdf, aes(x = cluster_hierarchical, fill=Batch_exp_day, 
                          color = Batch_exp_day))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Experimental day", values = col_batch_exp_day)+
  scale_color_manual(name = "Experimental day", values = col_batch_exp_day)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  theme(axis.title.y = element_blank())

plot2a <- ggplot(ggdf, aes(x = Batch_exp_day, y=cluster_hierarchical,
                          fill=cluster_hierarchical, 
                          color = cluster_hierarchical))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Cluster (hierarchical)", values = col_clust_h)+
  scale_color_manual(name = "Cluster (hierarchical)", values = col_clust_h)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  facet_grid(cols = vars(ggdf$Fraction))+
  theme(axis.title.y = element_blank())

plot2b <- ggplot(ggdf, aes(x = Batch_exp_day, fill=cluster_hierarchical, 
                          color = cluster_hierarchical))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Cluster (hierarchical)", values = col_clust_h)+
  scale_color_manual(name = "Cluster (hierarchical)", values = col_clust_h)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  facet_grid(cols = vars(ggdf$Fraction))+
  theme(axis.title.y = element_blank())

plot3a <- ggplot(ggdf, aes(x = cluster_hierarchical, y=Age_ID,
                          fill=Age_ID, color = Age_ID))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Age", values = col_ann_age)+
  scale_color_manual(name = "Age", values = col_ann_age)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  theme(axis.title.y = element_blank())

plot3b <- ggplot(ggdf, aes(x = cluster_hierarchical, fill=Age_ID, 
                          color = Age_ID))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Age", values = col_ann_age)+
  scale_color_manual(name = "Age", values = col_ann_age)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  theme(axis.title.y = element_blank())

plot4a <- ggplot(ggdf, aes(x = Age_ID, y=cluster_hierarchical,
                          fill=cluster_hierarchical, 
                          color = cluster_hierarchical))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Cluster (hierarchical)", values = col_clust_h)+
  scale_color_manual(name = "Cluster (hierarchical)", values = col_clust_h)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  theme(axis.title.y = element_blank())

plot4b <- ggplot(ggdf, aes(x = Age_ID,
                          fill=cluster_hierarchical, 
                          color = cluster_hierarchical))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Cluster (hierarchical)", values = col_clust_h)+
  scale_color_manual(name = "Cluster (hierarchical)", values = col_clust_h)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  theme(axis.title.y = element_blank())

plot5a <- ggplot(ggdf, aes(x = cluster_hierarchical, y=Identity_ref_all,
                          fill=Identity_ref_all, 
                          color = Identity_ref_all))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Identity 1", values = col_cts_all)+
  scale_color_manual(name = "Identity 1", values = col_cts_all)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  theme(axis.title.y = element_blank())

plot5b <- ggplot(ggdf, aes(x = cluster_hierarchical, fill=Identity_ref_all, 
                          color = Identity_ref_all))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Identity 1", values = col_cts_all)+
  scale_color_manual(name = "Identity 1", values = col_cts_all)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  theme(axis.title.y = element_blank())

plot6a <- ggplot(ggdf, aes(x = cluster_hierarchical, y=Identity_ref_fraction,
                          fill=Identity_ref_fraction, 
                          color = Identity_ref_fraction))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Identity 2", values = col_cts_fraction)+
  scale_color_manual(name = "Identity 2", values = col_cts_fraction)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  theme(axis.title.y = element_blank())

plot6b <- ggplot(ggdf, aes(x = cluster_hierarchical, fill=Identity_ref_fraction, 
                          color = Identity_ref_fraction))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Identity 2",  values = col_cts_fraction)+
  scale_color_manual(name = "Identity 2", values = col_cts_fraction)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$hierarchical_mode[1]))+
  theme(axis.title.y = element_blank())

plot_all_leg <- ggplot(ggdf, aes(x = cluster_hierarchical, y=Identity_ref_all,
                                 fill=Identity_ref_all))+
  geom_col()+
  scale_fill_manual("Identity1", values = col_cts_all)
legend_all <- get_legend(plot_all_leg)
plot_frc_leg <- ggplot(ggdf, aes(x = Object_ID, y=Identity_ref_fraction,
                                  fill=Identity_ref_fraction))+
  geom_col()+
  scale_fill_manual("Identity2", values = col_cts_fraction)
legend_frc <- get_legend(plot_frc_leg)
# also use legends for later
 
plot1a
plot1b
plot2a
plot2b
plot3a
plot3b
plot4a
plot4b

```

```{r fig.width=8, fig.height = 11}

PLOT5a <- ggarrange(plot5a, legend_all, ncol = 1)
PLOT5b <- ggarrange(plot5b, legend_all, ncol = 1)
PLOT6a <- ggarrange(plot6a, legend_frc, ncol = 1)
PLOT6b <- ggarrange(plot6b, legend_frc, ncol = 1)

PLOT5a
PLOT5b
PLOT6a
PLOT6b

rm(plot1a, plot1b, plot2a, plot2b, plot3a, plot3b, plot4, PLOT5a, PLOT5b,
   PLOT6a, PLOT6b)
```

## Silhouette and Purity

From http://bioconductor.org/books/3.16/OSCA.advanced/clustering-redux.html

```{r}

# Silhouette 
sil_approx <- approxSilhouette(reducedDim(sce_13, "PCA"), 
                               clusters = sce_13$cluster_hierarchical)

sil_data <- as.data.frame(sil_approx)
sil_data$closest <- factor(ifelse(sil_data$width > 0, 
                                  sce_13$cluster_hierarchical, 
                                  sil_data$other))
sil_data$cluster <- sce_13$cluster_hierarchical

ggplot(sil_data, aes(x=cluster, y=width, colour=closest))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$hierarchical_mode[1]))+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)+
  theme(legend.position = "none")+
  xlab("cluster (hierarchical)")+
  ylim(-1, 1)+
  ylab("Silhouette width")

ggplot(sil_data, aes(x=cluster, y=width, colour=closest))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$hierarchical_mode[1]))+
  facet_grid(cols = vars(sce_13$Fraction_ID))+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)+
  theme(legend.position = "none")+
  xlab("cluster (hierarchical)")+
  ylim(-1, 1)+
  ylab("Silhouette width")

# Purity
pure_sce <- neighborPurity(reducedDim(sce_13, "PCA"), sce_13$cluster_hierarchical)
pure_data <- as.data.frame(pure_sce)
pure_data$maximum <- factor(pure_data$maximum)
pure_data$cluster <- sce_13$cluster_hierarchical

ggplot(pure_data, aes(x=cluster, y=purity, colour=maximum))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$hierarchical_mode[1]))+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)+
  theme(legend.position = "none")+
  xlab("cluster (hierarchical)")+
  ylim(0, 1)+
  ylab("Cluster purity")

ggplot(pure_data, aes(x=cluster, y=purity, colour=maximum))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$hierarchical_mode[1]))+
  facet_grid(cols = vars(sce_13$Fraction_ID))+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)+
  theme(legend.position = "none")+
  xlab("cluster (hierarchical)")+
  ylim(0, 1)+
  ylab("Cluster purity")

ggplot(pure_data, aes(x=cluster, y=purity, color=cluster))+
  geom_boxplot(outlier.size = 0.1)+
  ggtitle(paste0(species_curr, " ", sce_13$hierarchical_mode[1]))+
  theme_classic()+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)+
  theme(legend.position = "none")+
  xlab("cluster (hierarchical)")+
  ylim(0, 1)+
  ylab("Cluster purity")

ggplot(pure_data, aes(x=cluster, y=purity, color=cluster))+
  geom_boxplot(outlier.size = 0.1)+
  ggtitle(paste0(species_curr, " ", sce_13$hierarchical_mode[1]))+
  facet_grid(cols = vars(sce_13$Fraction_ID))+
  theme_classic()+
  scale_color_manual("cluster (hierarchical)", values = col_clust_h)+
  theme(legend.position = "none")+
  xlab("cluster (hierarchical)")+
  ylim(0, 1)+
  ylab("Cluster purity")

rm(pure_data)
rm(pure_sce)
rm(sil_approx)
rm(sil_sce)
```

## Fraction-specific

Look at specific clustering of HSCs and Stromal cells.

```{r}

sce_hsc <- sce_09[,sce_09$Fraction_ID == "hsc"]
sce_str <- sce_09[,sce_09$Fraction_ID == "str"]

number_k_hsc <- number_k[[species_curr]]$hsc
number_k_str <- number_k[[species_curr]]$str

# HSC clustering
mat_hsc <- reducedDim(sce_hsc, "PCA") # PCA is batch corrected
mat_hsc <- scale(mat_hsc)
dist_hsc <- dist(mat_hsc, method = 'euclidean')
ward_hsc <- hclust(dist_hsc, method = "ward.D2")

# Stromal clustering
mat_str <- reducedDim(sce_str, "PCA")
mat_str <- scale(mat_str)
dist_str <- dist(mat_str, method = 'euclidean')
ward_str <- hclust(dist_str, method = "ward.D2")

```

### HSCs

```{r}

dend_hsc <- as.dendrogram(ward_hsc)
col_dend_hsc <- color_branches(dend_hsc, k = (number_k_hsc-1), 
                               groupLabels = FALSE, col = col_clust_h)
plot(col_dend_hsc, main = paste0(species_curr, 
                                 " HSCs, ward.D2, k=", (number_k_hsc-1)))

col_dend_hsc <- color_branches(dend_hsc, k = number_k_hsc, 
                               groupLabels = FALSE, col = col_clust_h)
plot(col_dend_hsc, main = paste0(species_curr, 
                                 " HSCs, ward.D2, used k=", number_k_hsc))

col_dend_hsc <- color_branches(dend_hsc, k = (number_k_hsc+1), 
                               groupLabels = FALSE, col = col_clust_h)
plot(col_dend_hsc, main = paste0(species_curr, 
                                 " HSCs, ward.D2, k=", (number_k_hsc+1)))

```

### Stromal

```{r}

dend_str <- as.dendrogram(ward_str)
col_dend_str <- color_branches(dend_str, k = (number_k_str-1), 
                               groupLabels = FALSE, col = col_clust_h)
plot(col_dend_str, main = paste0(species_curr, 
                                 " Stromal, ward.D2, k=", (number_k_str-1)))

col_dend_str <- color_branches(dend_str, k = number_k_str, 
                               groupLabels = FALSE, col = col_clust_h)
plot(col_dend_str, main = paste0(species_curr, 
                                 " Stromal, ward.D2, used k=", number_k_str))

col_dend_str <- color_branches(dend_str, k = (number_k_str+1), 
                               groupLabels = FALSE, col = col_clust_h)
plot(col_dend_str, main = paste0(species_curr, 
                                 " Stromal, ward.D2, k=", (number_k_str+1)))

```

### BOTH

```{r}

number_k_both <- number_k[[species_curr]]$both

mat <- reducedDim(sce_09, "PCA") # PCA is batch corrected
mat <- scale(mat)
dist <- dist(mat, method = 'euclidean')
ward <- hclust(dist, method = "ward.D2")
dend <- as.dendrogram(ward)

col_dend <- color_branches(dend, k = (number_k_both-1), 
                               groupLabels = FALSE, col = col_clust_h)
plot(col_dend, main = paste0(species_curr, 
                                 " BOTH, ward.D2, k=", (number_k_both-1)))

col_dend <- color_branches(dend, k = number_k_both, 
                               groupLabels = FALSE, col = col_clust_h)
plot(col_dend, main = paste0(species_curr, 
                                 " BOTH, ward.D2, used k=", number_k_both))

col_dend <- color_branches(dend, k = (number_k_both+1), 
                               groupLabels = FALSE, col = col_clust_h)
plot(col_dend, main = paste0(species_curr, 
                                 " BOTH, ward.D2, k=", (number_k_both+1)))

```

# Seurat clustering

```{r}
print(table(sce_13$cluster_seurat))
```

## Clusters

```{r fig.width=8, fig.height=4}

plot_1 <- umap_base(sce_13, color_by = "cluster_seurat")+ # own function
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  scale_color_manual("cluster (seurat)", values = col_clust_s)
plot_1l <- umap_legend(sce_13, color_by = "cluster_seurat")+
  scale_color_manual("cluster (seurat)", values = col_clust_s)
legend_1 <- get_legend(plot_1l)

plot_2 <- pca_base2(sce_13, color_by = "cluster_seurat")+ 
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  scale_color_manual("cluster (seurat)", values = col_clust_s)
plot_2l <- pca_legend(sce_13, color_by = "cluster_seurat")+
  scale_color_manual("cluster (seurat)", values = col_clust_s)
legend_2 <- get_legend(plot_2l)

plot_3 <- pca_base3(sce_13, color_by = "cluster_seurat")+ 
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  scale_color_manual("cluster (seurat)", values = col_clust_s)
plot_3l <- pca_legend(sce_13, color_by = "cluster_seurat")+
  scale_color_manual("cluster (seurat)", values = col_clust_s)
legend_3 <- get_legend(plot_3l)

PLOT_1 <- ggarrange(plot_1, legend_1)
PLOT_2 <- ggarrange(plot_2, legend_2)
PLOT_3 <- ggarrange(plot_3, legend_3)
  
PLOT_1
PLOT_2
PLOT_3
```

## QC

```{r fig.width=8, fig.height=4}

ggdf <- data.frame(colData(sce_13))

plot1a <- ggplot(ggdf, aes(x = cluster_seurat, y=Batch_exp_day,
                          fill=Batch_exp_day, color = Batch_exp_day))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Experimental day", values = col_batch_exp_day)+
  scale_color_manual(name = "Experimental day", values = col_batch_exp_day)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  theme(axis.title.y = element_blank())

plot1b <- ggplot(ggdf, aes(x = cluster_seurat, fill=Batch_exp_day, 
                          color = Batch_exp_day))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Experimental day", values = col_batch_exp_day)+
  scale_color_manual(name = "Experimental day", values = col_batch_exp_day)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  theme(axis.title.y = element_blank())

plot2a <- ggplot(ggdf, aes(x = Batch_exp_day, y=cluster_seurat,
                          fill=cluster_seurat, color = cluster_seurat))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Cluster (seurat)", values = col_clust_s)+
  scale_color_manual(name = "Cluster (seurat)", values = col_clust_s)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  facet_grid(cols = vars(ggdf$Fraction))+
  theme(axis.title.y = element_blank())

plot2b <- ggplot(ggdf, aes(x = Batch_exp_day, fill=cluster_seurat, 
                          color = cluster_seurat))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Cluster (seurat)", values = col_clust_s)+
  scale_color_manual(name = "Cluster (seurat)", values = col_clust_s)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  facet_grid(cols = vars(ggdf$Fraction))+
  theme(axis.title.y = element_blank())

plot3a <- ggplot(ggdf, aes(x = cluster_seurat, y=Age_ID,
                          fill=Age_ID, color = Age_ID))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Age", values = col_ann_age)+
  scale_color_manual(name = "Age", values = col_ann_age)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  theme(axis.title.y = element_blank())

plot3b <- ggplot(ggdf, aes(x = cluster_seurat, fill=Age_ID, 
                          color = Age_ID))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Age", values = col_ann_age)+
  scale_color_manual(name = "Age", values = col_ann_age)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  theme(axis.title.y = element_blank())

plot4a <- ggplot(ggdf, aes(x = Age_ID, y=cluster_seurat,
                          fill=cluster_seurat, color = cluster_seurat))+
  geom_col()+
  theme_classic()+
  scale_fill_manual("Cluster (seurat)", values = col_clust_s)+
  scale_color_manual(values = col_clust_s)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  theme(axis.title.y = element_blank())

plot4b <- ggplot(ggdf, aes(x = Age_ID,
                          fill=cluster_seurat, 
                          color = cluster_seurat))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Cluster (seurat)", values = col_clust_s)+
  scale_color_manual(name = "Cluster (seurat)", values = col_clust_s)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$seurat_mode[1]))+
  theme(axis.title.y = element_blank())

plot5a <- ggplot(ggdf, aes(x = cluster_seurat, y=Identity_ref_all,
                          fill=Identity_ref_all, 
                          color = Identity_ref_all))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Identity 1", values = col_cts_all)+
  scale_color_manual(name = "Identity 1", values = col_cts_all)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  theme(axis.title.y = element_blank())

plot5b <- ggplot(ggdf, aes(x = cluster_seurat, fill=Identity_ref_all, 
                          color = Identity_ref_all))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Identity 1", values = col_cts_all)+
  scale_color_manual(name = "Identity 1", values = col_cts_all)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  theme(axis.title.y = element_blank())

plot6a <- ggplot(ggdf, aes(x = cluster_seurat, y=Identity_ref_fraction,
                          fill=Identity_ref_fraction, 
                          color = Identity_ref_fraction))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Identity 2", values = col_cts_fraction)+
  scale_color_manual(name = "Identity 2", values = col_cts_fraction)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  theme(axis.title.y = element_blank())

plot6b <- ggplot(ggdf, aes(x = cluster_seurat, fill=Identity_ref_fraction, 
                          color = Identity_ref_fraction))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Identity 2",  values = col_cts_fraction)+
  scale_color_manual(name = "Identity 2", values = col_cts_fraction)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  theme(axis.title.y = element_blank())

plot1a
plot1b
plot2a
plot2b
plot3a
plot3b
plot4a
plot4b

```

```{r fig.width=8, fig.height = 11}

PLOT5a <- ggarrange(plot5a, legend_all, ncol = 1)
PLOT5b <- ggarrange(plot5b, legend_all, ncol = 1)
PLOT6a <- ggarrange(plot6a, legend_frc, ncol = 1)
PLOT6b <- ggarrange(plot6b, legend_frc, ncol = 1)

PLOT5a
PLOT5b
PLOT6a
PLOT6b
```

## Silhouette and Purity

```{r}

# Silhouette
sil.approx <- approxSilhouette(reducedDim(sce_13, "PCA"), 
                               clusters = sce_13$cluster_seurat)
sil.data <- as.data.frame(sil.approx)
sil.data$closest <- factor(ifelse(sil.data$width > 0, 
                                  sce_13$cluster_seurat, 
                                  sil.data$other))
sil.data$cluster <- sce_13$cluster_seurat

ggplot(sil.data, aes(x=cluster, y=width, colour=closest))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  scale_color_manual("cluster (seurat)", values = col_clust_s)+
  theme(legend.position = "none")+
  xlab("cluster (seurat)")+
  ylim(-1, 1)+
  ylab("Silhouette width")

ggplot(sil.data, aes(x=cluster, y=width, colour=closest))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  facet_grid(cols = vars(sce_13$Fraction_ID))+
  scale_color_manual("cluster (seurat)", values = col_clust_s)+
  theme(legend.position = "none")+
  xlab("cluster (seurat)")+
  ylim(-1, 1)+
  ylab("Silhouette width")

# Purity
pure_sce <- neighborPurity(reducedDim(sce_13, "PCA"), sce_13$cluster_seurat)
pure_data <- as.data.frame(pure_sce)
pure_data$maximum <- factor(pure_data$maximum)
pure_data$cluster <- sce_13$cluster_seurat

ggplot(pure_data, aes(x=cluster, y=purity, colour=maximum))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  scale_color_manual("cluster (seurat)", values = col_clust_s)+
  theme(legend.position = "none")+
  xlab("cluster (seurat)")+
  ylim(0, 1)+
  ylab("Cluster purity")

ggplot(pure_data, aes(x=cluster, y=purity, colour=maximum))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  facet_grid(cols = vars(sce_13$Fraction_ID))+
  scale_color_manual("cluster (seurat)", values = col_clust_s)+
  theme(legend.position = "none")+
  xlab("cluster (seurat)")+
  ylim(0, 1)+
  ylab("Cluster purity")

ggplot(pure_data, aes(x=cluster, y=purity, color=cluster))+
  geom_boxplot(outlier.size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  scale_color_manual("cluster (seurat)", values = col_clust_s)+
  theme(legend.position = "none")+
  xlab("cluster (seurat)")+
  ylim(0, 1)+
  ylab("Cluster purity")

ggplot(pure_data, aes(x=cluster, y=purity, color=cluster))+
  geom_boxplot(outlier.size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$seurat_mode[1]))+
  scale_color_manual("cluster (seurat)", values = col_clust_s)+
  facet_grid(cols = vars(sce_13$Fraction_ID))+
  theme(legend.position = "none")+
  xlab("cluster (seurat)")+
  ylim(0, 1)+
  ylab("Cluster purity")

```

# Louvain

```{r}
print(table(sce_13$cluster_louvain))
```

## Clusters

```{r fig.width=8, fig.height=4}

plot_1 <- umap_base(sce_13, color_by = "cluster_louvain")+ # own function
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))+
  scale_color_manual("cluster (louvain)", values = col_clust_l)
plot_1l <- umap_legend(sce_13, color_by = "cluster_louvain")+
  scale_color_manual("cluster (louvain)", values = col_clust_l)
legend_1 <- get_legend(plot_1l)

plot_2 <- pca_base2(sce_13, color_by = "cluster_louvain")+ # own function
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))+
  scale_color_manual("cluster (louvain)", values = col_clust_l)
plot_2l <- pca_legend(sce_13, color_by = "cluster_louvain")+
  scale_color_manual("cluster (louvain)", values = col_clust_l)
legend_2 <- get_legend(plot_2l)

plot_3 <- pca_base3(sce_13, color_by = "cluster_louvain")+ # own function
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))+
  scale_color_manual("cluster (louvain)", values = col_clust_l)
plot_3l <- pca_legend(sce_13, color_by = "cluster_louvain")+
  scale_color_manual("cluster (louvain)", values = col_clust_l)
legend_3 <- get_legend(plot_3l)

PLOT_1 <- ggarrange(plot_1, legend_1)
PLOT_2 <- ggarrange(plot_2, legend_2)
PLOT_3 <- ggarrange(plot_3, legend_3)
  
PLOT_1
PLOT_2
PLOT_3
```

## QC

```{r fig.width=8, fig.height=4}

ggdf <- data.frame(colData(sce_13))

plot1a <- ggplot(ggdf, aes(x = cluster_louvain, y=Batch_exp_day,
                          fill=Batch_exp_day, color = Batch_exp_day))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Experimental day", values = col_batch_exp_day)+
  scale_color_manual(name = "Experimental day", values = col_batch_exp_day)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))

plot1b <- ggplot(ggdf, aes(x = cluster_louvain, fill=Batch_exp_day, 
                          color = Batch_exp_day))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Experimental day", values = col_batch_exp_day)+
  scale_color_manual(name = "Experimental day", values = col_batch_exp_day)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))

plot2a <- ggplot(ggdf, aes(x = Batch_exp_day, y=cluster_louvain,
                          fill=cluster_louvain, color = cluster_louvain))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Cluster (louvain)", values = col_clust_l)+
  scale_color_manual(name = "Cluster (louvain)", values = col_clust_l)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))
  facet_grid(cols = vars(ggdf$Fraction))

plot2b <- ggplot(ggdf, aes(x = Batch_exp_day, fill=cluster_louvain, 
                          color = cluster_louvain))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Cluster (louvain)",  values = col_clust_l)+
  scale_color_manual(name = "Cluster (louvain)", values = col_clust_l)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))+
  facet_grid(cols = vars(ggdf$Fraction))

plot3a <- ggplot(ggdf, aes(x = cluster_louvain, y=Age_ID,
                          fill=Age_ID, color = Age_ID))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Age", values = col_ann_age)+
  scale_color_manual(name = "Age", values = col_ann_age)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))

plot3b <- ggplot(ggdf, aes(x = cluster_louvain, fill=Age_ID, 
                          color = Age_ID))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Age", values = col_ann_age)+
  scale_color_manual(name = "Age", values = col_ann_age)+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))

plot4a <- ggplot(ggdf, aes(x = Age_ID, y=cluster_louvain,
                          fill=cluster_louvain, color = cluster_louvain))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Cluster (louvain)", values = col_clust_l)+
  scale_color_manual(name = "Cluster (louvain)", values = col_clust_l)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))

plot4b <- ggplot(ggdf, aes(x = Age_ID,
                          fill=cluster_louvain, 
                          color = cluster_louvain))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Cluster (louvain)", values = col_clust_l)+
  scale_color_manual(name = "Cluster (louvain)", values = col_clust_l)+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", ggdf$louvain_mode[1]))


plot5a <- ggplot(ggdf, aes(x = cluster_louvain, y=Identity_ref_all,
                          fill=Identity_ref_all, 
                          color = Identity_ref_all))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Identity 1", values = col_cts_all)+
  scale_color_manual(name = "Identity 1", values = col_cts_all)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))

plot5b <- ggplot(ggdf, aes(x = cluster_louvain, fill=Identity_ref_all, 
                          color = Identity_ref_all))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Identity 1", values = col_cts_all)+
  scale_color_manual(name = "Identity 1", values = col_cts_all)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))

plot6a <- ggplot(ggdf, aes(x = cluster_louvain, y=Identity_ref_fraction,
                          fill=Identity_ref_fraction, 
                          color = Identity_ref_fraction))+
  geom_col()+
  theme_classic()+
  scale_fill_manual(name = "Identity 2", values = col_cts_fraction)+
  scale_color_manual(name = "Identity 2", values = col_cts_fraction)+
  theme(legend.position = "none", axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))

plot6b <- ggplot(ggdf, aes(x = cluster_louvain, fill=Identity_ref_fraction, 
                          color = Identity_ref_fraction))+
  geom_bar(position = "fill") + 
  theme_classic()+
  scale_fill_manual(name = "Identity 2", values = col_cts_fraction)+
  scale_color_manual(name = "Identity 2", values = col_cts_fraction)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))


plot1a
plot1b
plot2a
plot2b
plot3a
plot3b
plot4a
plot4b

```

```{r fig.width=8, fig.height = 11}

PLOT5a <- ggarrange(plot5a, legend_all, ncol = 1)
PLOT5b <- ggarrange(plot5b, legend_all, ncol = 1)
PLOT6a <- ggarrange(plot6a, legend_frc, ncol = 1)
PLOT6b <- ggarrange(plot6b, legend_frc, ncol = 1)

PLOT5a
PLOT5b
PLOT6a
PLOT6b
```

## Silhouette and Purity

```{r}

# Silhouette
sil.approx <- approxSilhouette(reducedDim(sce_13, "PCA"), 
                               clusters = sce_13$cluster_louvain)
sil.data <- as.data.frame(sil.approx)
sil.data$closest <- factor(ifelse(sil.data$width > 0, 
                                  sce_13$cluster_louvain, 
                                  sil.data$other))
sil.data$cluster <- sce_13$cluster_louvain

ggplot(sil.data, aes(x=cluster, y=width, colour=closest))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))+
  scale_color_manual("cluster (louvain)", values = col_clust_l)+
  theme(legend.position = "none")+
  xlab("cluster (louvain)")+
  ylim(-1, 1)+
  ylab("Silhouette width")

ggplot(sil.data, aes(x=cluster, y=width, colour=closest))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))+
  facet_grid(cols = vars(sce_13$Fraction_ID))+
  scale_color_manual("cluster (louvain)", values = col_clust_l)+
  theme(legend.position = "none")+
  xlab("cluster (louvain)")+
  ylim(-1, 1)+
  ylab("Silhouette width")

# Purity
pure_sce <- neighborPurity(reducedDim(sce_13, "PCA"), sce_13$cluster_louvain)
pure_data <- as.data.frame(pure_sce)
pure_data$maximum <- factor(pure_data$maximum)
pure_data$cluster <- sce_13$cluster_louvain

ggplot(pure_data, aes(x=cluster, y=purity, colour=maximum))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))+
  scale_color_manual("cluster (louvain)", values = col_clust_l)+
  theme(legend.position = "none")+
  xlab("cluster (louvain)")+
  ylim(0, 1)+
  ylab("Cluster purity")

ggplot(pure_data, aes(x=cluster, y=purity, colour=maximum))+
  ggbeeswarm::geom_quasirandom(size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))+
  facet_grid(cols = vars(sce_13$Fraction_ID))+
  scale_color_manual("cluster (louvain)", values = col_clust_l)+
  theme(legend.position = "none")+
  xlab("cluster (louvain)")+
  ylim(0, 1)+
  ylab("Cluster purity")

ggplot(pure_data, aes(x=cluster, y=purity, color=cluster))+
  geom_boxplot(outlier.size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))+
  scale_color_manual("cluster (louvain)", values = col_clust_l)+
  theme(legend.position = "none")+
  xlab("cluster (louvain)")+
  ylim(0, 1)+
  ylab("Cluster purity")

ggplot(pure_data, aes(x=cluster, y=purity, color=cluster))+
  geom_boxplot(outlier.size = 0.1)+
  theme_classic()+
  ggtitle(paste0(species_curr, " ", sce_13$louvain_mode[1]))+
  scale_color_manual("cluster (louvain)", values = col_clust_l)+
  facet_grid(cols = vars(sce_13$Fraction_ID))+
  theme(legend.position = "none")+
  xlab("cluster (louvain)")+
  ylim(0, 1)+
  ylab("Cluster purity")


```

# Comparison of labels

```{r}
col_palette <- RColorBrewer::brewer.pal(n = 9, "Blues")
```


## Clusters

### Seurat and Hierarchical

```{r fig.height = 10}

sce_temp <- sce_13
sce_temp$cluster_hierarchical <- paste0(sce_temp$cluster_hierarchical,
                                        "_hierarchical")
sce_temp$cluster_seurat <- paste0(sce_temp$cluster_seurat, "_seurat")

mat1 <- matrix(nrow = length(unique(sce_temp$cluster_hierarchical)),
               ncol = length(unique(sce_temp$cluster_seurat)))

rownames(mat1) <- unique(sce_temp$cluster_hierarchical)
colnames(mat1) <- unique(sce_temp$cluster_seurat)

for(i in 1:nrow(mat1)){
  for(j in 1:ncol(mat1)){
    mat1[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$cluster_hierarchical == rownames(mat1)[i])],
      colnames(sce_temp)[which(
        sce_temp$cluster_seurat == colnames(mat1)[j])]
      )
      )
      )
      )/length(which(sce_temp$cluster_seurat == colnames(mat1)[j]))
  } 
}

pheatmap(t(mat1), main = paste0(species_curr, " seurat ", 
                                sce_13$seurat_mode[1]),
         color = col_palette)

mat2 <- matrix(nrow = length(unique(sce_temp$cluster_hierarchical)),
               ncol = length(unique(sce_temp$cluster_seurat)))

rownames(mat2) <- unique(sce_temp$cluster_hierarchical)
colnames(mat2) <- unique(sce_temp$cluster_seurat)

for(i in 1:nrow(mat2)){
  for(j in 1:ncol(mat2)){
    mat2[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$cluster_hierarchical == rownames(mat2)[i])],
      colnames(sce_temp)[which(
        sce_temp$cluster_seurat == colnames(mat2)[j])]
      )
      )
      )
      )/length(which(sce_temp$cluster_hierarchical == rownames(mat2)[i]))
  } 
}

pheatmap(mat2, main = paste0(species_curr, " hierarchical ", 
                             sce_13$hierarchical_mode[1]),
         color = col_palette)

```

### Hierarchical and Louvain

```{r fig.height = 10}

sce_temp <- sce_13
sce_temp$cluster_hierarchical <- paste0(sce_temp$cluster_hierarchical,
                                        "_hierarchical")
sce_temp$cluster_louvain <- paste0(sce_temp$cluster_louvain, "_louvain")

mat1 <- matrix(nrow = length(unique(sce_temp$cluster_hierarchical)),
               ncol = length(unique(sce_temp$cluster_louvain)))

rownames(mat1) <- unique(sce_temp$cluster_hierarchical)
colnames(mat1) <- unique(sce_temp$cluster_louvain)

for(i in 1:nrow(mat1)){
  for(j in 1:ncol(mat1)){
    mat1[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$cluster_hierarchical == rownames(mat1)[i])],
      colnames(sce_temp)[which(
        sce_temp$cluster_louvain == colnames(mat1)[j])]
      )
      )
      )
      )/length(which(sce_temp$cluster_louvain == colnames(mat1)[j]))
  } 
}

pheatmap(t(mat1),main = paste0(species_curr, " louvain ", 
                                sce_13$seurat_mode[1]),
         color = col_palette)

mat2 <- matrix(nrow = length(unique(sce_temp$cluster_hierarchical)),
               ncol = length(unique(sce_temp$cluster_louvain)))

rownames(mat2) <- unique(sce_temp$cluster_hierarchical)
colnames(mat2) <- unique(sce_temp$cluster_louvain)

for(i in 1:nrow(mat2)){
  for(j in 1:ncol(mat2)){
    mat2[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$cluster_hierarchical == rownames(mat2)[i])],
      colnames(sce_temp)[which(
        sce_temp$cluster_louvain == colnames(mat2)[j])]
      )
      )
      )
      )/length(which(sce_temp$cluster_hierarchical == rownames(mat2)[i]))
  } 
}

pheatmap(mat2, main = paste0(species_curr, " hierarchical ", 
                             sce_13$hierarchical_mode[1]),
         color = col_palette)

```

### Seurat and Louvain

```{r fig.height = 10}

sce_temp <- sce_13
sce_temp$cluster_seurat <- paste0(sce_temp$cluster_seurat, "_seurat")
sce_temp$cluster_louvain <- paste0(sce_temp$cluster_louvain, "_louvain")

mat1 <- matrix(nrow = length(unique(sce_temp$cluster_seurat)),
               ncol = length(unique(sce_temp$cluster_louvain)))

rownames(mat1) <- unique(sce_temp$cluster_seurat)
colnames(mat1) <- unique(sce_temp$cluster_louvain)

for(i in 1:nrow(mat1)){
  for(j in 1:ncol(mat1)){
    mat1[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$cluster_seurat == rownames(mat1)[i])],
      colnames(sce_temp)[which(
        sce_temp$cluster_louvain == colnames(mat1)[j])]
      )
      )
      )
      )/length(which(sce_temp$cluster_louvain == colnames(mat1)[j]))
  } 
}

pheatmap(t(mat1),main = paste0(species_curr, " louvain ", 
                                sce_13$louvain_mode[1]),
         color = col_palette)

mat2 <- matrix(nrow = length(unique(sce_temp$cluster_seurat)),
               ncol = length(unique(sce_temp$cluster_louvain)))

rownames(mat2) <- unique(sce_temp$cluster_seurat)
colnames(mat2) <- unique(sce_temp$cluster_louvain)

for(i in 1:nrow(mat2)){
  for(j in 1:ncol(mat2)){
    mat2[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$cluster_seurat == rownames(mat2)[i])],
      colnames(sce_temp)[which(
        sce_temp$cluster_louvain == colnames(mat2)[j])]
      )
      )
      )
      )/length(which(sce_temp$cluster_seurat == rownames(mat2)[i]))
  } 
}

pheatmap(mat2, main = paste0(species_curr, " seurat ", 
                             sce_13$seurat_mode[1]),
         color = col_palette)

```

## Identity (2)

### Hierarchical

```{r fig.height = 10}

sce_temp <- sce_13
sce_temp$cluster_hierarchical <- paste0(sce_temp$cluster_hierarchical,
                                        "_hierarchical")

mat1 <- matrix(nrow = length(unique(sce_temp$cluster_hierarchical)),
               ncol = length(unique(sce_temp$Identity_ref_fraction)))

rownames(mat1) <- unique(sce_temp$cluster_hierarchical)
colnames(mat1) <- unique(sce_temp$Identity_ref_fraction)

for(i in 1:nrow(mat1)){
  for(j in 1:ncol(mat1)){
    mat1[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$cluster_hierarchical == rownames(mat1)[i])],
      colnames(sce_temp)[which(
        sce_temp$Identity_ref_fraction == colnames(mat1)[j])]
      )
      )
      )
      )/length(which(sce_temp$Identity_ref_fraction == colnames(mat1)[j]))
  } 
}

pheatmap(t(mat1), main = paste0(species_curr, " hierarchical ", 
                                sce_13$hierarchical_mode[1]),
         color = col_palette)

mat2 <- matrix(nrow = length(unique(sce_temp$cluster_hierarchical)),
               ncol = length(unique(sce_temp$Identity_ref_fraction)))

rownames(mat2) <- unique(sce_temp$cluster_hierarchical)
colnames(mat2) <- unique(sce_temp$Identity_ref_fraction)

for(i in 1:nrow(mat2)){
  for(j in 1:ncol(mat2)){
    mat2[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$cluster_hierarchical == rownames(mat2)[i])],
      colnames(sce_temp)[which(
        sce_temp$Identity_ref_fraction == colnames(mat2)[j])]
      )
      )
      )
      )/length(which(sce_temp$cluster_hierarchical == rownames(mat2)[i]))
  } 
}

pheatmap(mat2, main = paste0(species_curr, " hierarchical ", 
                             sce_13$hierarchical_mode[1]),
         color = col_palette)

```

### Seurat

```{r fig.height = 10}

sce_temp <- sce_13
sce_temp$cluster_seurat <- paste0(sce_temp$cluster_seurat, "_seurat")

mat1 <- matrix(nrow = length(unique(sce_temp$Identity_ref_fraction)),
               ncol = length(unique(sce_temp$cluster_seurat)))

rownames(mat1) <- unique(sce_temp$Identity_ref_fraction)
colnames(mat1) <- unique(sce_temp$cluster_seurat)

for(i in 1:nrow(mat1)){
  for(j in 1:ncol(mat1)){
    mat1[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$Identity_ref_fraction == rownames(mat1)[i])],
      colnames(sce_temp)[which(
        sce_temp$cluster_seurat == colnames(mat1)[j])]
      )
      )
      )
      )/length(which(sce_temp$cluster_seurat == colnames(mat1)[j]))
  } 
}

pheatmap(t(mat1), main = paste0(species_curr, " seurat ", 
                                sce_13$seurat_mode[1]),
         color = col_palette)

mat2 <- matrix(nrow = length(unique(sce_temp$Identity_ref_fraction)),
               ncol = length(unique(sce_temp$cluster_seurat)))

rownames(mat2) <- unique(sce_temp$Identity_ref_fraction)
colnames(mat2) <- unique(sce_temp$cluster_seurat)

for(i in 1:nrow(mat2)){
  for(j in 1:ncol(mat2)){
    mat2[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$Identity_ref_fraction == rownames(mat2)[i])],
      colnames(sce_temp)[which(
        sce_temp$cluster_seurat == colnames(mat2)[j])]
      )
      )
      )
      )/length(which(sce_temp$Identity_ref_fraction == rownames(mat2)[i]))
  } 
}

pheatmap(mat2, main = paste0(species_curr, " seurat ", 
                             sce_13$seurat_mode[1]),
         color = col_palette)

```

### Louvain 

```{r fig.height = 10}

sce_temp <- sce_13
sce_temp$cluster_louvain <- paste0(sce_temp$cluster_louvain, "_louvain")

mat1 <- matrix(nrow = length(unique(sce_temp$Identity_ref_fraction)),
               ncol = length(unique(sce_temp$cluster_louvain)))

rownames(mat1) <- unique(sce_temp$Identity_ref_fraction)
colnames(mat1) <- unique(sce_temp$cluster_louvain)

for(i in 1:nrow(mat1)){
  for(j in 1:ncol(mat1)){
    mat1[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$Identity_ref_fraction == rownames(mat1)[i])],
      colnames(sce_temp)[which(
        sce_temp$cluster_louvain == colnames(mat1)[j])]
      )
      )
      )
      )/length(which(sce_temp$cluster_louvain == colnames(mat1)[j]))
  } 
}

pheatmap(t(mat1), main = paste0(species_curr, " louvain ", 
                             sce_13$louvain_mode[1]),
         color = col_palette)

mat2 <- matrix(nrow = length(unique(sce_temp$Identity_ref_fraction)),
               ncol = length(unique(sce_temp$cluster_louvain)))

rownames(mat2) <- unique(sce_temp$Identity_ref_fraction)
colnames(mat2) <- unique(sce_temp$cluster_louvain)

for(i in 1:nrow(mat2)){
  for(j in 1:ncol(mat2)){
    mat2[i,j] <- length(which(!is.na(match(
      colnames(sce_temp)[which(
        sce_temp$Identity_ref_fraction == rownames(mat2)[i])],
      colnames(sce_temp)[which(
        sce_temp$cluster_louvain == colnames(mat2)[j])]
      )
      )
      )
      )/length(which(sce_temp$Identity_ref_fraction == rownames(mat2)[i]))
  } 
}

pheatmap(mat2, main = paste0(species_curr, " louvain ", 
                             sce_13$louvain_mode[1]),
         color = col_palette)

```

# Trajectories

Separate objects by cell type (hematopoietic or stromal)
Not by fraction because mcar and mcas stromal fractions contain many 
hematopoietic cells.
Use Baccin reference to separate.

```{r}

hsc_cells <- c(
  "Dendritic cells",
  "Monocytes",
  "Mk prog.",
  "large pre-B.",
  "Mono prog.",
  "Erythroblasts",
  "Ery prog.",
  "small pre-B.",
  "pro-B",
  "Neutrophils",
  "Eo/Baso prog.",
  "Gran/Mono prog.",
  "LMPPs",
  "Ery/Mk prog.",
  "Neutro prog.",
  "NK cells",
  "B cell",
  "T cells" 
)


str_cells <- c(
  "Sinusoidal ECs",
  "Arteriolar fibro.",
  "Endosteal fibro.",
  "Adipo-CAR",
  "Osteo-CAR",
  "Myofibroblasts",
  "Arteriolar ECs",
  "Fibro/Chondro p.",
  "Stromal fibro.",
  "Ng2+ MSCs",
  "Smooth muscle",
  "Osteoblasts",
  "Chondrocytes",
  "Schwann cells" 
)

sce_hsc <- sce[,sce$Identity_ref_all %in% hsc_cells]
sce_str <- sce[,sce$Identity_ref_all %in% str_cells]

sce_list <- list(sce_hsc, sce_str)

```

```{r}

pres_list <- lapply(sce_list, function(sce){
  print(sce)
  pres <- phate(data = as.data.frame(assays(sce, type = "corrected")), knn = 5)
  return(pres)
})

pres_list

```

```{r}

for(i in 1:length(pres_list)){
  
  sce <- sce_list[[i]]
  pres <- pres_list5[[i]]
  
  plot1 <- ggplot(pres, aes(x = PHATE1, y = PHATE2,
                                 color = sce$Identity_ref_all))+
    geom_point()+
    theme_classic()+
    scale_color_manual("Identity 1", values = col_cts_all)+
    theme(legend.position = "none")+
    ggtitle(species_curr)
  
  plot2 <- ggplot(pres, aes(x = PHATE1, y = PHATE2, 
                              color = sce$Identity_ref_fractions))+
    geom_point()+
    theme_classic()+
    scale_color_manual("Identity 2", values = col_cts_fraction)+
    theme(legend.position = "none")+
    ggtitle(species_curr)
  
 plot3 <- ggplot(pres, aes(x = PHATE1, y = PHATE2, 
                              color = sce$cluster_hierarchical))+
    geom_point()+
    theme_classic()+
    scale_color_manual("cluster (hierarchical)", values = col_clust_h)+
    ggtitle(names(pres_list)[i])
 
  plot4 <- ggplot(pres, aes(x = PHATE1, y = PHATE2, 
                                color = sce$cluster_seurat))+
    geom_point()+
    theme_classic()+
    scale_color_manual("cluster (seurat)", values = col_clust_s)+
    ggtitle(names(pres_list)[i])
   
  plot5 <- ggplot(pres, aes(x = PHATE1, y = PHATE3, 
                                color = sce$cluster_louvain))+
    geom_point()+
    theme_classic()+
    scale_color_manual("cluster (louvain)", values = col_clust_l)+
    ggtitle(names(pres_list)[i])
  
  
  plot6 <- ggplot(pres, aes(x = PHATE1, y = PHATE3,
                                 color = sce$Identity_ref_all))+
    geom_point()+
    theme_classic()+
    scale_color_manual("Identity 1", values = col_cts_all)+
    theme(legend.position = "none")+
    ggtitle(species_curr)
  
  plot7 <- ggplot(pres, aes(x = PHATE1, y = PHATE3, 
                              color = sce$Identity_ref_fractions))+
    geom_point()+
    theme_classic()+
    scale_color_manual("Identity 2", values = col_cts_fraction)+
    theme(legend.position = "none")+
    ggtitle(species_curr)
  
 plot8 <- ggplot(pres, aes(x = PHATE1, y = PHATE3, 
                              color = sce$cluster_hierarchical))+
    geom_point()+
    theme_classic()+
    scale_color_manual("cluster (hierarchical)", values = col_clust_h)+
    ggtitle(species_curr)
 
  plot9 <- ggplot(pres, aes(x = PHATE1, y = PHATE3, 
                                color = sce$cluster_seurat))+
    geom_point()+
    theme_classic()+
    scale_color_manual("cluster (seurat)", values = col_clust_s)+
    ggtitle(species_curr)
   
  plot10 <- ggplot(pres, aes(x = PHATE1, y = PHATE3, 
                                color = sce$cluster_louvain))+
    geom_point()+
    theme_classic()+
    scale_color_manual("cluster (louvain)", values = col_clust_l)+
    ggtitle(species_curr)
  
  plot11 <- ggplot(pres, aes(x = PHATE1, y = PHATE2, 
                                color = sce$cluster_ref_baccin))+
    geom_point()+
    theme_classic()+
    scale_color_manual("Baccin reference cluster", values = col_cts_all)+
    ggtitle(species_curr)
  
  plot12 <- ggplot(pres, aes(x = PHATE1, y = PHATE2, 
                                color = sce$cluster_ref_baccin_similarities))+
    geom_point()+
    theme_classic()+
    scale_color_manual("Baccin reference cluster similarities")+
    scale_colour_gradient(low = "black", high = "gold", 
                          name = "Dolgalev reference cluster similarity")+
    ggtitle(species_curr)
    
  plot13 <- ggplot(pres, aes(x = PHATE1, y = PHATE3, 
                                color = sce$cluster_ref_baccin))+
    geom_point()+
    theme_classic()+
    scale_color_manual("Baccin reference cluster", values = col_cts_all)+
    ggtitle(species_curr)
  
  plot14 <- ggplot(pres, aes(x = PHATE1, y = PHATE3, 
                                color = sce$cluster_ref_baccin_similarities))+
    geom_point()+
    theme_classic()+
    scale_color_manual("Baccin reference cluster similarities")+
    scale_colour_gradient(low = "black", high = "gold", 
                          name = "Dolgalev reference cluster similarity")+
    ggtitle(species_curr)
  
  print(plot1)
  print(plot2)
  print(plot3)
  print(plot4)  
  print(plot5)  
  print(plot6)  
  print(plot7)  
  print(plot8)  
  print(plot9)  
  print(plot10)  
  print(plot11)  
  print(plot12)  
  print(plot13)  
  print(plot14)  

}

```

```{r}
sessionInfo()
```
