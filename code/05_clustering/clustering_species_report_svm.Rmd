---
title: "clustering_species_reports_svm"
author: "Lea WÃ¶lbert"
date: '2022-12-21'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Report for SVM as part of clustering

#### Load libraries, source code 

```{r load,  message = FALSE}
library(DropletUtils, quietly = TRUE) 
library(scater, quietly = TRUE) 
library(scuttle, quietly = TRUE) 
library(scran, quietly = TRUE) 
library(tidyverse, quietly = TRUE) 
library(pheatmap, quietly = TRUE) 
```

```{r}

sce_test <- readRDS(file = snakemake@input[["sce_test"]])
objects_hir <- readRDS(file = snakemake@input[["objects_hierarchical"]])
objects_ser <- readRDS(file = snakemake@input[["objects_seurat"]])
objects_lou <- readRDS(file = snakemake@input[["objects_louvain"]])

species_curr <- sce_test$Species_ID[1]

```

# SVM on hierarchical clustering

```{r}
tune_out_hir <- objects_hir[[1]]
pred_hir <- objects_hir[[2]]
```

```{r}
summary(tune_out_hir)
```

```{r}
tune_out_hir$best.parameters
tune_out_hir$performances
```

```{r}
mat_comp <- as.matrix(table(as.numeric(unfactor(sce_test$cluster_hierarchical)),
                            as.numeric(pred_hir)))

rownames(mat_comp) <- paste0(rownames(mat_comp), "_h")
colnames(mat_comp) <- paste0(colnames(mat_comp), "_p")
print(mat_comp)
```

```{r}

mat_comp <- as.matrix(table(as.numeric(unfactor(sce_test$cluster_hierarchical)),
                            as.numeric(pred_hir)))
mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                     which(colMeans(mat_comp) > 0)]

for(i in 1:nrow(mat_comp)){
  mat_comp[i,] <- mat_comp[i,]/max(mat_comp[i,])
}
rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                             levels = as.numeric(rownames(mat_comp)))
colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                             levels = as.numeric(colnames(mat_comp)))

rownames(mat_comp) <- paste0(rownames(mat_comp), "_cluster_hierarchical")
colnames(mat_comp) <- paste0(colnames(mat_comp), "_predicted")

pheatmap(mat_comp, cluster_cols = FALSE, cluster_rows = FALSE, 
         main = paste0(species_curr, " hierarchical ", sce_test$hierarchical_mode[1]))

```

# SVM on Seurat clustering

```{r}
tune_out_ser <- objects_ser[[1]]
pred_ser <- objects_ser[[2]]
```

```{r}
summary(tune_out_ser)
```

```{r}
tune_out_ser$best.parameters
tune_out_ser$performances
```

```{r}
mat_comp <- as.matrix(table(as.numeric(unfactor(sce_test$cluster_seurat)),
                            as.numeric(pred_ser)))

rownames(mat_comp) <- paste0(rownames(mat_comp), "_s")
colnames(mat_comp) <- paste0(colnames(mat_comp), "_p")
print(mat_comp)
```

```{r}

mat_comp <- as.matrix(table(as.numeric(unfactor(sce_test$cluster_seurat)),
                            as.numeric(pred_ser)))
mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                     which(colMeans(mat_comp) > 0)]

for(i in 1:nrow(mat_comp)){
  mat_comp[i,] <- mat_comp[i,]/max(mat_comp[i,])
}
rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                             levels = as.numeric(rownames(mat_comp)))
colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                             levels = as.numeric(colnames(mat_comp)))

rownames(mat_comp) <- paste0(rownames(mat_comp), "_cluster_seurat")
colnames(mat_comp) <- paste0(colnames(mat_comp), "_predicted")

pheatmap(mat_comp, cluster_cols = FALSE, cluster_rows = FALSE, 
         main = paste0(species_curr, " seurat ", sce_test$seurat_mode[1]))

```

# SVM on louvain clustering

```{r}
tune_out_lou <- objects_lou[[1]]
pred_lou <- objects_lou[[2]]
```

```{r}
summary(tune_out_lou)
```

```{r}
tune_out_lou$best.parameters
tune_out_lou$performances
```

```{r}
mat_comp <- as.matrix(table(as.numeric(unfactor(sce_test$cluster_louvain)),
                            as.numeric(pred_lou)))

rownames(mat_comp) <- paste0(rownames(mat_comp), "_l")
colnames(mat_comp) <- paste0(colnames(mat_comp), "_p")
print(mat_comp)
```

```{r}

mat_comp <- as.matrix(table(as.numeric(unfactor(sce_test$cluster_louvain)),
                            as.numeric(pred_lou)))
mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                     which(colMeans(mat_comp) > 0)]

for(i in 1:nrow(mat_comp)){
  mat_comp[i,] <- mat_comp[i,]/max(mat_comp[i,])
}
rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                             levels = as.numeric(rownames(mat_comp)))
colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                             levels = as.numeric(colnames(mat_comp)))

rownames(mat_comp) <- paste0(rownames(mat_comp), "_cluster_louvain")
colnames(mat_comp) <- paste0(colnames(mat_comp), "_predicted")

pheatmap(mat_comp, cluster_cols = FALSE, cluster_rows = FALSE, 
         main = paste0(species_curr, " louvain ", sce_test$louvain_mode[1]))

```
