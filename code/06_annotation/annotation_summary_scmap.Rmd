---
title: "annotation_summary_scmap"
author: "Lea WÃ¶lbert"
date: '2023-01-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Report for clustering overlap between species, using scmap to transfer labels.

#### Load libraries, source code 

```{r load,  message = FALSE}
library(DropletUtils, quietly = TRUE) 
library(scater, quietly = TRUE) 
library(scuttle, quietly = TRUE) 
library(scran, quietly = TRUE) 
library(tidyverse, quietly = TRUE) 
library(pheatmap, quietly = TRUE) 
set.seed(37)
```

```{r}
color_tables <- snakemake@params[["color_tables"]]
source(file = "../source/colors.R")
source(file = "../source/plotting.R")

```

```{r}

sce_path <- snakemake@input[["sce_14_path"]]
species <- snakemake@params[["species"]]

print(sce_path)
sce_list <- list()
for(s in species){
  sce_list[[s]] <- readRDS(file = paste0(sce_path, "/sce_", s, "-14"))
}

sce_list_nbc <- list()
for(s in species){
  sce_list_nbc[[s]] <- readRDS(file = paste0(sce_path, "/sce_", s, "_nbc-14"))
}

```

SCE objects already contain scmap annotation from mmus

# SCMAP cluster

## QC

```{r}

make_plot_list <- function(x){

  gg_df <- as.data.frame(colData(x))

  plot1 <- ggplot(gg_df, aes(x = cluster_hierarchical, 
                    y = mmus_hierarchical_pred_cluster_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])
  
  plot2 <- ggplot(gg_df, aes(x = mmus_hierarchical_pred_cluster, 
                    y = mmus_hierarchical_pred_cluster_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])+
    xlab("mmus_hierarchical_pred_cluster")
  
  plot3 <- ggplot(gg_df, aes(x = cluster_seurat, 
                    y = mmus_seurat_pred_cluster_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])
  
  plot4 <- ggplot(gg_df, aes(x = mmus_seurat_pred_cluster, 
                    y = mmus_seurat_pred_cluster_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])+
    xlab("mmus_seurat_pred_cluster")
  
  plot5 <- ggplot(gg_df, aes(x = cluster_louvain, 
                    y = mmus_louvain_pred_cluster_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])
  
  plot6 <- ggplot(gg_df, aes(x = mmus_louvain_pred_cluster, 
                    y = mmus_louvain_pred_cluster_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])+
    xlab("mmus_louvain_pred_cluster")
  
  return(list(plot1, plot2, plot3, plot4, plot5, plot6))
  
}

plot_list <- lapply(sce_list, make_plot_list)

```

#### BATCH CORRECTED

```{r}
plot_list
```

## Heatmaps

### Hierarchical

```{r}

get_heatmap_hierarchical <- function(sce){
  
  mat_comp <- as.matrix(table(as.numeric(unfactor(sce$cluster_hierarchical)),
                              as.numeric(sce$mmus_hierarchical_pred_cluster)))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_cluster_h")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_predicted")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", h_clusters (model=mmus), SCMAPcluster"))
  
  mat_comp <- as.matrix(table(as.numeric(sce$mmus_hierarchical_pred_cluster),
                              as.numeric(unfactor(sce$cluster_hierarchical))))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_predicted")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_cluster_h")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", h_clusters (model=mmus), SCMAPcluster"))
}

plot_list <- lapply(sce_list, get_heatmap_hierarchical)

```

### Seurat

```{r}

get_heatmap_seurat <- function(sce){
  
  mat_comp <- as.matrix(table(as.numeric(unfactor(sce$cluster_seurat)),
                              as.numeric(sce$mmus_seurat_pred_cluster)))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_cluster_s")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_predicted")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", s_clusters (model=mmus), SCMAPcluster"))
  
  mat_comp <- as.matrix(table(as.numeric(sce$mmus_seurat_pred_cluster),
                              as.numeric(unfactor(sce$cluster_seurat))))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_predicted")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_cluster_s")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", s_clusters (model=mmus), SCMAPcluster"))
}

plot_list <- lapply(sce_list, get_heatmap_seurat)

```

### Louvain

```{r}

get_heatmap_louvain <- function(sce){
  
  mat_comp <- as.matrix(table(as.numeric(unfactor(sce$cluster_louvain)),
                              as.numeric(sce$mmus_louvain_pred_cluster)))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_cluster_l")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_predicted")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", l_clusters (model=mmus), SCMAPcluster"))
  
  mat_comp <- as.matrix(table(as.numeric(sce$mmus_louvain_pred_cluster),
                              as.numeric(unfactor(sce$cluster_louvain))))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_predicted")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_cluster_l")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", l_clusters (model=mmus), SCMAPcluster"))
}

plot_list <- lapply(sce_list, get_heatmap_louvain)

```

## UMAPs

```{r fig.width=10, fig.height=5}

cluster_plots <- function(sce){
  
  col_clust_h <- col_num[names(col_num) %in% sce$mmus_hierarchical_pred_cluster]
  col_clust_s <- col_num[names(col_num) %in% sce$mmus_seurat_pred_cluster]
  col_clust_l <- col_num[names(col_num) %in% sce$mmus_louvain_pred_cluster]

  species_curr <- sce$Species_ID[1]
  
  plot_1 <- umap_base(sce, 
                      color_by = "mmus_hierarchical_pred_cluster")+ 
    ggtitle(paste0(species_curr))+
    scale_color_manual("mmus_hierarchical_pred_cluster", 
                       values = c("unassigned" = "thistle", col_clust_h))
  plot_1l <- umap_legend(sce, color_by = "mmus_hierarchical_pred_cluster")+
    scale_color_manual("mmus_hierarchical_pred_cluster", 
                       values = c("unassigned" = "thistle", col_clust_h))
  legend_1 <- get_legend(plot_1l)

  plot_2 <- umap_base(sce,
                      color_by = "mmus_seurat_pred_cluster")+ # own function
    ggtitle(paste0(species_curr))+
    scale_color_manual("mmus_seurat_pred_cluster", 
                      values = c("unassigned" = "thistle", col_clust_s))
  plot_2l <- umap_legend(sce, color_by = "mmus_seurat_pred_cluster")+
    scale_color_manual("mmus_seurat_pred_cluster", 
                       values = c("unassigned" = "thistle", col_clust_s))
  legend_2 <- get_legend(plot_2l)
  
  plot_3 <- umap_base(sce, 
                      color_by = "mmus_louvain_pred_cluster")+ # own function
    ggtitle(paste0(species_curr))+
    scale_color_manual("mmus_louvain_pred_cluster", 
                       values = c("unassigned" = "thistle", col_clust_l))
  plot_3l <- umap_legend(sce, color_by = "mmus_louvain_pred_cluster")+
    scale_color_manual("mmus_louvain_pred_cluster", 
                       values = c("unassigned" = "thistle", col_clust_l))
  legend_3 <- get_legend(plot_3l)
  
  
  plot_4 <- umap_base(sce, 
                      color_by = "mmus_hierarchical_pred_cluster_sim")+
    ggtitle(paste0(species_curr))+
    scale_colour_gradient(low = "black", high = "gold")
  plot_4l <- umap_legend(sce, 
                         color_by = "mmus_hierarchical_pred_cluster_sim")+
    scale_colour_gradient(low = "black", high = "gold",
                          name = "mmus_hierarchical_pred_cluster_sim")
  legend_4 <- get_legend(plot_4l)  
  
  plot_5 <- umap_base(sce, color_by = "mmus_seurat_pred_cluster_sim")+
    ggtitle(paste0(species_curr))+
    scale_colour_gradient(low = "black", high = "gold")
  plot_5l <- umap_legend(sce, 
                         color_by = "mmus_seurat_pred_cluster_sim")+
    scale_colour_gradient(low = "black", high = "gold",
                          name = "mmus_seurat_pred_cluster_sim")
  legend_5 <- get_legend(plot_5l)  

  plot_6 <- umap_base(sce, color_by = "mmus_louvain_pred_cluster_sim")+
    ggtitle(paste0(species_curr))+
    scale_colour_gradient(low = "black", high = "gold")
  plot_6l <- umap_legend(sce,
                         color_by = "mmus_louvain_pred_cluster_sim")+
    scale_colour_gradient(low = "black", high = "gold",
                          name = "mmus_louvain_pred_cluster_sim")
  legend_6 <- get_legend(plot_6l)  
  
  PLOT_1 <- ggarrange(plot_1, legend_1)
  PLOT_2 <- ggarrange(plot_2, legend_2)
  PLOT_3 <- ggarrange(plot_3, legend_3)
  PLOT_4 <- ggarrange(plot_4, legend_4)
  PLOT_5 <- ggarrange(plot_5, legend_5)
  PLOT_6 <- ggarrange(plot_6, legend_6)

  return(list(PLOT_1, PLOT_2, PLOT_3, PLOT_4, PLOT_5, PLOT_6))
}

cluster_plot_list <- lapply(sce_list, cluster_plots)

```

#### BATCH CORRECTED

```{r fig.width=10, fig.height=5}
cluster_plot_list
```

# SCmap Cell

## QC

```{r}

make_plot_list_cell <- function(x){

  gg_df <- as.data.frame(colData(x))
  colnames(gg_df)[colnames(colData(x)) == "mmus_hierarchical_pred_cell_sim"] <- "mmus_hierarchical_pred_cell_sim"
  colnames(gg_df)[colnames(colData(x)) == "mmus_seurat_pred_cell_sim"] <- "mmus_seurat_pred_cell_sim"
  colnames(gg_df)[colnames(colData(x)) == "mmus_louvain_pred_cell_sim"] <- "mmus_louvain_pred_cell_sim"

  plot1 <- ggplot(gg_df, aes(x = cluster_hierarchical, 
                    y = mmus_hierarchical_pred_cell_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])+
    ylab("Similarities")
  
  plot2 <- ggplot(gg_df, aes(x = mmus_hierarchical_pred_cell, 
                    y = mmus_hierarchical_pred_cell_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])+
    xlab("mmus_hierarchical_pred_cell")+
    ylab("Similarities")
  
  plot3 <- ggplot(gg_df, aes(x = cluster_seurat, 
                    y = mmus_seurat_pred_cell_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])+
    ylab("Similarities")
  
  plot4 <- ggplot(gg_df, aes(x = mmus_seurat_pred_cell, 
                    y = mmus_seurat_pred_cell_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])+
    xlab("mmus_seurat_pred_cell")+
    ylab("Similarities")
  
  plot5 <- ggplot(gg_df, aes(x = cluster_louvain, 
                    y = mmus_louvain_pred_cell_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])+
    ylab("Similarities")
  
  plot6 <- ggplot(gg_df, aes(x = mmus_louvain_pred_cell, 
                    y = mmus_louvain_pred_cell_sim))+
    ggbeeswarm::geom_quasirandom(size = 0.3)+
    theme_classic()+
    ggtitle(x$Species_ID[1])+
    xlab("mmus_louvain_pred_cell")+
    ylab("Similarities")
  
  return(list(plot1, plot2, plot3, plot4, plot5, plot6))
  
}

plot_list <- lapply(sce_list, make_plot_list_cell)
plot_list_nbc <- lapply(sce_list_nbc, make_plot_list_cell)

```

#### BATCH CORRECTED

```{r}
plot_list
```

#### NOT BATCH CORRECTED

```{r}
plot_list_nbc
```

## Heatmaps

### Hierarchical

```{r}

get_heatmap_hierarchical <- function(sce){
  
  mat_comp <- as.matrix(table(as.numeric(unfactor(sce$cluster_hierarchical)),
                              as.numeric(sce$mmus_hierarchical_pred_cell)))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_cluster_h")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_predicted_cell")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", h_clusters (model=mmus), SCMAPcell"))
  
  mat_comp <- as.matrix(table(as.numeric(sce$mmus_hierarchical_pred_cell),
                              as.numeric(unfactor(sce$cluster_hierarchical))))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_predicted_cell")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_cluster_h")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", h_clusters (model=mmus), SCMAPcell"))
}

```

#### BATCH CORRECTED

```{r}
plot_list <- lapply(sce_list, get_heatmap_hierarchical)
```

#### NOT BATCH CORRECTED

```{r}
plot_list_nbc <- lapply(sce_list_nbc, get_heatmap_hierarchical)
```

### Seurat

```{r}

get_heatmap_seurat <- function(sce){
  
  mat_comp <- as.matrix(table(as.numeric(unfactor(sce$cluster_seurat)),
                              as.numeric(sce$mmus_seurat_pred_cell)))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_cluster_s")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_predicted_cells")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", s_clusters (model=mmus), SCMAPcell"))
  
  mat_comp <- as.matrix(table(as.numeric(sce$mmus_seurat_pred_cell),
                              as.numeric(unfactor(sce$cluster_seurat))))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_predicted_cells")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_cluster_s")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", s_clusters (model=mmus), SCMAPcell"))
}

plot_list <- lapply(sce_list, get_heatmap_seurat)
plot_list_nbc <- lapply(sce_list_nbc, get_heatmap_seurat)

```

#### BATCH CORRECTED

```{r}
plot_list <- lapply(sce_list, get_heatmap_seurat)
```

#### NOT BATCH CORRECTED

```{r}
plot_list_nbc <- lapply(sce_list_nbc, get_heatmap_seurat)
```

### Louvain

```{r}

get_heatmap_louvain <- function(sce){
  
  mat_comp <- as.matrix(table(as.numeric(unfactor(sce$cluster_louvain)),
                              as.numeric(sce$mmus_louvain_pred_cell)))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_cluster_l")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_predicted_cells")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", l_clusters (model=mmus), SCMAPcell"))
  
  mat_comp <- as.matrix(table(as.numeric(sce$mmus_louvain_pred_cell),
                              as.numeric(unfactor(sce$cluster_louvain))))
  mat_comp <- mat_comp[which(rowMeans(mat_comp) > 0), 
                       which(colMeans(mat_comp) > 0)]

  for(i in 1:nrow(mat_comp)){
    mat_comp[i,] <- mat_comp[i,]/sum(mat_comp[i,])
  }
  rownames(mat_comp) <- factor(as.numeric(rownames(mat_comp)), 
                               levels = as.numeric(rownames(mat_comp)))
  colnames(mat_comp) <- factor(as.numeric(colnames(mat_comp)), 
                               levels = as.numeric(colnames(mat_comp)))
  
  rownames(mat_comp) <- paste0(rownames(mat_comp), "_predicted_cells")
  colnames(mat_comp) <- paste0(colnames(mat_comp), "_cluster_l")
  
  pheatmap(mat_comp,
           main = paste0(sce$Species_ID[1], 
                         ", l_clusters (model=mmus), SCMAPcell"))
}

plot_list <- lapply(sce_list, get_heatmap_louvain)
plot_list_nbc <- lapply(sce_list_nbc, get_heatmap_louvain)

```

#### BATCH CORRECTED

```{r}
plot_list <- lapply(sce_list, get_heatmap_louvain)
```

#### NOT BATCH CORRECTED

```{r}
plot_list_nbc <- lapply(sce_list_nbc, get_heatmap_louvain)
```

## UMAPs

```{r fig.width=10, fig.height=5}

cluster_plots <- function(sce){
  
  col_clust_h <- col_num[names(col_num) %in% sce$mmus_hierarchical_pred_cell]
  col_clust_s <- col_num[names(col_num) %in% sce$mmus_seurat_pred_cell]
  col_clust_l <- col_num[names(col_num) %in% sce$mmus_louvain_pred_cell]

  species_curr <- sce$Species_ID[1]
  
  plot_1 <- umap_base(sce, 
                      color_by = "mmus_hierarchical_pred_cell")+ 
    ggtitle(paste0(species_curr))+
    scale_color_manual("mmus_hierarchical_pred_cell", 
                       values = c("unassigned" = "thistle", col_clust_h))
  plot_1l <- umap_legend(sce, color_by = "mmus_hierarchical_pred_cell")+
    scale_color_manual("mmus_hierarchical_pred_cell", 
                       values = c("unassigned" = "thistle", col_clust_h))
  legend_1 <- get_legend(plot_1l)

  plot_2 <- umap_base(sce,
                      color_by = "mmus_seurat_pred_cell")+ # own function
    ggtitle(paste0(species_curr))+
    scale_color_manual("mmus_seurat_pred_cell", 
                      values = c("unassigned" = "thistle", col_clust_s))
  plot_2l <- umap_legend(sce, color_by = "mmus_seurat_pred_cell")+
    scale_color_manual("mmus_seurat_pred_cell", 
                       values = c("unassigned" = "thistle", col_clust_s))
  legend_2 <- get_legend(plot_2l)
  
  plot_3 <- umap_base(sce, 
                      color_by = "mmus_louvain_pred_cell")+ # own function
    ggtitle(paste0(species_curr))+
    scale_color_manual("mmus_louvain_pred_cell", 
                       values = c("unassigned" = "thistle", col_clust_l))
  plot_3l <- umap_legend(sce, color_by = "mmus_louvain_pred_cell")+
    scale_color_manual("mmus_louvain_pred_cell", 
                       values = c("unassigned" = "thistle", col_clust_l))
  legend_3 <- get_legend(plot_3l)
  
  
  plot_4 <- umap_base(sce, 
                      color_by = "mmus_hierarchical_pred_cell_sim")+
    ggtitle(paste0(species_curr))+
    scale_colour_gradient(low = "black", high = "gold")
  plot_4l <- umap_legend(sce, 
                         color_by = "mmus_hierarchical_pred_cell_sim")+
    scale_colour_gradient(low = "black", high = "gold",
                          name = "mmus_hierarchical_pred_cell_sim")
  legend_4 <- get_legend(plot_4l)  
  
  plot_5 <- umap_base(sce, color_by = "mmus_seurat_pred_cell_sim")+
    ggtitle(paste0(species_curr))+
    scale_colour_gradient(low = "black", high = "gold")
  plot_5l <- umap_legend(sce, 
                         color_by = "mmus_seurat_pred_cell_sim")+
    scale_colour_gradient(low = "black", high = "gold",
                          name = "mmus_seurat_pred_cell_sim")
  legend_5 <- get_legend(plot_5l)  

  plot_6 <- umap_base(sce, color_by = "mmus_louvain_pred_cell_sim")+
    ggtitle(paste0(species_curr))+
    scale_colour_gradient(low = "black", high = "gold")
  plot_6l <- umap_legend(sce,
                         color_by = "mmus_louvain_pred_cell_sim")+
    scale_colour_gradient(low = "black", high = "gold",
                          name = "mmus_louvain_pred_cell_sim")
  legend_6 <- get_legend(plot_6l)  
  
  PLOT_1 <- ggarrange(plot_1, legend_1)
  PLOT_2 <- ggarrange(plot_2, legend_2)
  PLOT_3 <- ggarrange(plot_3, legend_3)
  PLOT_4 <- ggarrange(plot_4, legend_4)
  PLOT_5 <- ggarrange(plot_5, legend_5)
  PLOT_6 <- ggarrange(plot_6, legend_6)

  return(list(PLOT_1, PLOT_2, PLOT_3, PLOT_4, PLOT_5, PLOT_6))
}

cluster_plot_list <- lapply(sce_list, cluster_plots)

sce_list_nbc2 <- list()
for(i in names(sce_list)){
  sce_list_nbc2[[i]] <- sce_list[[i]]
  sce_list_nbc2[[i]]$mmus_hierarchical_pred_cell <- sce_list_nbc[[i]]$mmus_hierarchical_pred_cell
  sce_list_nbc2[[i]]$mmus_seurat_pred_cell <- sce_list_nbc[[i]]$mmus_seurat_pred_cell
  sce_list_nbc2[[i]]$mmus_louvain_pred_cell <- sce_list_nbc[[i]]$mmus_louvain_pred_cell

                                                            
  sce_list_nbc2[[i]]$mmus_hierarchical_pred_cell_sim <- sce_list_nbc[[i]]$mmus_hierarchical_pred_cell_sim
  sce_list_nbc2[[i]]$mmus_seurat_pred_cell_sim <- sce_list_nbc[[i]]$mmus_seurat_pred_cell_sim
  sce_list_nbc2[[i]]$mmus_louvain_pred_cell_sim <- sce_list_nbc[[i]]$mmus_louvain_pred_cell_sim
}

cluster_plot_list_nbc <- lapply(sce_list_nbc2, cluster_plots)

```

#### BATCH CORRECTED

```{r fig.width=10, fig.height=5}
cluster_plot_list
```

#### NOT BATCH CORRECTED

```{r fig.width=10, fig.height=5}
cluster_plot_list_nbc
```

```{r}
sessionInfo()
```
