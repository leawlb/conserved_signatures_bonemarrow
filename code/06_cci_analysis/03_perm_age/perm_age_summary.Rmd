---
title: "permutation_summary"
author: "Lea WÃ¶lbert"
date: '2023-08-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Load objects

```{r seed,  message = FALSE}
set.seed(37)
```

```{r load,  message = FALSE}
library(tidyverse)
library(ggpubr)
```

```{r load_objects}
summary_df <- readRDS(file = snakemake@input[["summary_df"]])
#summary_df <- readRDS(file = "/omics/odcf/analysis/OE0538_projects/DO-0008/data/main_analysis/cci_objects/03_cci_analysis/05_psum_age/summary_df")
```

```{r}
summary_df_shared <- summary_df[summary_df$shared == TRUE,]

summary_df_sig <- summary_df_shared[which(summary_df_shared$p_adj <= 0.05),]

shared_ctps <- intersect(
  summary_df$ctp[summary_df$species == "mmus"],
  intersect(summary_df$ctp[summary_df$species == "mcas"],
            intersect(summary_df$ctp[summary_df$species == "mspr"],
                      summary_df$ctp[summary_df$species == "mcar"])))

summary_df_subs <- summary_df[summary_df$ctp %in% shared_ctps,]
summary_df_shared_subs <- summary_df_shared[summary_df_shared$ctp %in% shared_ctps,]
```

```{r}
colors_path <- snakemake@params[["colors_path"]]
source(snakemake@params[["colors"]])
#colors_path <- "/omics/odcf/analysis/OE0538_projects/DO-0008/metadata/colors/colors.txt"
#source("/home/l012t/repositories/Interspecies_BM_phd/code/source/colors.R")

col_cts_emi <- col_cts_str[names(col_cts_str) %in% unique(summary_df$emitter)]
col_cts_rec <- col_cts_hsc[names(col_cts_hsc) %in% unique(summary_df$receiver)]

summary_df$emitter <- factor(
  summary_df$emitter,
  levels = names(col_cts_emi[names(col_cts_emi) %in% summary_df$emitter]))

summary_df$receiver <- factor(
  summary_df$receiver,
  levels = names(col_cts_rec[names(col_cts_rec) %in% summary_df$receiver]))

col_detected <- c("not detected" = "grey90", 
                  "old only" = "grey60", 
                  "young only" = "black",
                  "shared" = "goldenrod1")

col_direction <-  c("delta_score significantly higher" = "grey60",
                    "delta_score significantly lower" = "black", 
                    "not significant" = "goldenrod2",
                    "pval not estimated" = "thistle",
                    "not shared" = "grey80",
                    "not detected" = "grey90")

col_change_age <-  c("increased" = "grey60",
                     "decreased" = "black", 
                     "no significant change (detectable)" = "goldenrod2",
                     "not detected" = "grey90")

```

# Ratios of detected/shared/significantly changes interactions

```{r}

df1 <- data.frame(table(summary_df$detected, summary_df$species))
df1

ggplot(df1, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "stack")+
  theme_classic()+
  ylab("Nr of possible interactions")+
  xlab("Species")+
  scale_fill_manual("Detected", values = col_detected)+
  scale_color_manual("Detected", values = col_detected)+
  ggtitle("all CTPs")

ggplot(df1, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "fill")+
  theme_classic()+
  ylab("% of possible interactions")+
  xlab("Species")+
  scale_fill_manual("Detected", values = col_detected)+
  scale_color_manual("Detected", values = col_detected)+
  ggtitle("all CTPs")

summary_df_subs <- summary_df[summary_df$ctp %in% shared_ctps,]
df2 <- data.frame(table(summary_df_subs$detected, summary_df_subs$species))
df2

ggplot(df2, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "stack")+
  theme_classic()+
  ylab("Nr of possible interactions")+
  xlab("Species")+
  scale_fill_manual("Detected", values = col_detected)+
  scale_color_manual("Detected", values = col_detected)+
  ggtitle("shared CTPs only")
```

```{r}
df3 <- data.frame(table(
  summary_df$detected[summary_df$detected != "not detected"], 
  summary_df$species[summary_df$detected != "not detected"]))
df3

ggplot(df3, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "stack")+
  theme_classic()+
  ylab("Nr of detected interactions")+
  xlab("Species")+
  scale_fill_manual("", values = col_detected)+
  scale_color_manual("", values = col_detected)+
  ggtitle("all CTPs, detected interactions only")

ggplot(df3, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "fill")+
  theme_classic()+
  ylab("% of detected interactions")+
  xlab("Species")+
  scale_fill_manual("", values = col_detected)+
  scale_color_manual("", values = col_detected)+
  ggtitle("all CTPs, detected interactions only")

df4 <- data.frame(table(
  summary_df_subs$detected[summary_df_subs$detected != "not detected"], 
  summary_df_subs$species[summary_df_subs$detected != "not detected"]))
df4

ggplot(df4, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "stack")+
  theme_classic()+
  ylab("Nr of detected interactions")+
  xlab("Species")+
  scale_fill_manual("", values = col_detected)+
  scale_color_manual("", values = col_detected)+
  ggtitle("shared CTPs, detected interactions only")

ggplot(df4, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "fill")+
  theme_classic()+
  ylab("% of detected interactions")+
  xlab("Species")+
  scale_fill_manual("", values = col_detected)+
  scale_color_manual("", values = col_detected)+
  ggtitle("shared CTPs, detected interactions only")
```

```{r}
df6 <-  data.frame(table(summary_df$direction, 
                         summary_df$species))
df6

ggplot(df6, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "stack")+
  theme_classic()+
  ylab("Nr of possible interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_direction)+
  scale_color_manual("Change with Age", values = col_direction)+
  ggtitle("all CTPs")

ggplot(df6, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "fill")+
  theme_classic()+
  ylab("% of possible interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_direction)+
  scale_color_manual("Change with Age",values =  col_direction)+
  ggtitle("all CTPs")


df5 <-  data.frame(table(summary_df_shared$direction, 
                         summary_df_shared$species))
df5

ggplot(df5, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "stack")+
  theme_classic()+
  ylab("Nr of shared interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_direction)+
  scale_color_manual("Change with Age", values = col_direction)+
  ggtitle("all CTPs, shared interactions only")

ggplot(df5, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "fill")+
  theme_classic()+
  ylab("% of shared interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_direction)+
  scale_color_manual("Change with Age", values = col_direction)+
  ggtitle("all CTPs, shared interactions only")

df7 <-  data.frame(table(summary_df_shared_subs$direction, 
                         summary_df_shared_subs$species))
df7

ggplot(df7, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "stack")+
  theme_classic()+
  ylab("Nr of shared interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_direction)+
  scale_color_manual("Change with Age", values = col_direction)+
  ggtitle("shared CTPs, shared interactions only")

ggplot(df7, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "fill")+
  theme_classic()+
  ylab("% of shared interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_direction)+
  scale_color_manual("Change with Age",values =  col_direction)+
  ggtitle("shared CTPs, shared interactions only")


```

```{r}
df6 <-  data.frame(table(summary_df$change_age, 
                         summary_df$species))
df6

ggplot(df6, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "stack")+
  theme_classic()+
  ylab("Nr of possible interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_change_age)+
  scale_color_manual("Change with Age", values = col_change_age)+
  ggtitle("all CTPs")

ggplot(df6, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "fill")+
  theme_classic()+
  ylab("% of possible interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_change_age)+
  scale_color_manual("Change with Age",values =  col_change_age)+
  ggtitle("all CTPs")


df5 <-  data.frame(table(summary_df_shared$change_age, 
                         summary_df_shared$species))
df5

ggplot(df5, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "stack")+
  theme_classic()+
  ylab("Nr of shared interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_change_age)+
  scale_color_manual("Change with Age", values = col_change_age)+
  ggtitle("all CTPs, shared interactions only")

ggplot(df5, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "fill")+
  theme_classic()+
  ylab("% of shared interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_change_age)+
  scale_color_manual("Change with Age", values = col_change_age)+
  ggtitle("all CTPs, shared interactions only")

df7 <-  data.frame(table(summary_df_shared_subs$change_age, 
                         summary_df_shared_subs$species))
df7

ggplot(df7, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "stack")+
  theme_classic()+
  ylab("Nr of shared interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_change_age)+
  scale_color_manual("Change with Age", values = col_change_age)+
  ggtitle("shared CTPs, shared interactions only")

ggplot(df7, aes(x = Var2, y = Freq, color = Var1, fill = Var1))+
  geom_col(position = "fill")+
  theme_classic()+
  ylab("% of shared interactions")+
  xlab("Species")+
  scale_fill_manual("Change with Age", values = col_change_age)+
  scale_color_manual("Change with Age",values =  col_change_age)+
  ggtitle("shared CTPs, shared interactions only")


```

# Score Deltas

## All

```{r}
print(length(which(is.na(summary_df$score_delta))))
```

```{r}
ggplot(summary_df, aes(x = species, y = score_delta, color = shared))+
  geom_jitter(alpha = 0.3)+
  theme_classic()+
  scale_color_manual(values = c("TRUE" = "orange", "FALSE" = "black"))
```

```{r}
ggplot(summary_df_shared, 
       aes(x = species, y = score_delta, color = direction))+
  geom_jitter(alpha = 0.3)+
  theme_classic()+
  scale_color_manual("significant change", values = c("TRUE" = "orange", "FALSE" = "grey70"))+
  ggtitle("shared interactions only")

ggplot(summary_df_shared, 
       aes(x = species, y = score_delta))+
  geom_violin(fill = "grey85", color = "grey85")+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared interactions only")

ggplot(summary_df_shared, 
       aes(x = direction, y = score_delta, color = direction, fill = direction))+
  ggbeeswarm::geom_quasirandom(size = 0.01, alpha = 0.2)+
  geom_boxplot(alpha = 0, color= "black")+
  theme_classic()+
  ggtitle("shared interactions only")+
  facet_grid(cols = vars(summary_df_shared$species))+
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_color_manual("Change with Age", values = col_direction)

ggplot(summary_df_shared, 
       aes(x = species, y = abs(score_delta)))+
  geom_violin(fill = "grey85", color = "grey85")+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared interactions only")+
  stat_compare_means(test = 'kruskal.test', p.adjust.method = "BH", label.y = 0.9)+
  stat_compare_means(
    comparisons = list(c("mmus", "mcas"), c("mmus", "mspr"), c("mmus", "mcar"),
                       c("mcas", "mspr"), c("mcas", "mcar"), c("mspr", "mcar")),
    test = 'dunn_test', p.adjust.method = "BH", hide.ns = TRUE, aes(label = after_stat(p.signif)))

ggplot(summary_df_shared[summary_df_shared$direction == "shared",], 
       aes(x = species, y = abs(score_delta)))+
  geom_violin(fill = "grey85", color = "grey85")+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared significant interactions only")+
  stat_compare_means(test = 'kruskal.test', p.adjust.method = "BH", label.y = 0.9)+
  stat_compare_means(
    comparisons = list(c("mmus", "mcas"), c("mmus", "mspr"), c("mmus", "mcar"),
                       c("mcas", "mspr"), c("mcas", "mcar"), c("mspr", "mcar")),
    test = 'dunn_test', p.adjust.method = "BH", hide.ns = TRUE, aes(label = after_stat(p.signif)))

ggplot(summary_df_shared, 
       aes(x = direction, y = abs(score_delta), color = direction))+
  ggbeeswarm::geom_quasirandom(size = 0.01, alpha = 0.2)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  ggtitle("shared significant interactions only")+
  facet_grid(cols = vars(summary_df_shared$species))+
  scale_color_manual("Change with Age", values = col_direction)+
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90))
```

## Per cell type

```{r}
ggplot(summary_df_shared, 
       aes(x = emitter, y = score_delta, color = emitter))+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared interactions only")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_color_manual("Emitter", values = col_cts_emi)+
  facet_grid(cols = vars(summary_df_shared$species))

ggplot(summary_df_shared, 
       aes(x = emitter, y = score_delta, color = direction))+
  geom_jitter(alpha = 0.3)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  ggtitle("shared interactions only")+
  scale_color_manual(values = col_direction)+
  theme(axis.text.x = element_text(angle = 90))+
  facet_grid(cols = vars(summary_df_shared$species))

ggplot(summary_df_sig, 
       aes(x = emitter, y = abs(score_delta), color = emitter))+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared interactions only, significant")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_color_manual("Emitter", values = col_cts_emi)+
  facet_grid(cols = vars(summary_df_sig$species))

ggplot(summary_df_shared, 
       aes(x = species, y = score_delta, color = emitter))+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared interactions only")+
  theme(axis.text.x = element_text(angle = 90),
        strip.text.x = element_text(angle = 90))+
  scale_color_manual("Emitter", values = col_cts_emi)+
  facet_grid(cols = vars(summary_df_shared$emitter))

ggplot(summary_df_shared, 
       aes(x = species, y = score_delta, color = direction))+
  geom_jitter(alpha = 0.3)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  ggtitle("shared interactions only")+
  scale_color_manual(values = col_direction)+
  theme(axis.text.x = element_text(angle = 90),
        strip.text.x = element_text(angle = 90))+
  facet_grid(cols = vars(summary_df_shared$emitter))

ggplot(summary_df_sig, 
       aes(x = species, y = abs(score_delta), color = emitter))+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared interactions only, significant")+
  theme(axis.text.x = element_text(angle = 90),
        strip.text.x = element_text(angle = 90))+
  scale_color_manual("Emitter", values = col_cts_emi)+
  facet_grid(cols = vars(summary_df_sig$emitter))

```

```{r}
ggplot(summary_df_shared, 
       aes(x = receiver, y = score_delta, color = receiver))+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared interactions only")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_color_manual("Receiver", values = col_cts_rec)+
  facet_grid(cols = vars(summary_df_shared$species))

ggplot(summary_df_shared, 
       aes(x = receiver, y = score_delta, color = direction))+
  geom_jitter(alpha = 0.3)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  ggtitle("shared interactions only")+
  scale_color_manual(values = col_direction)+
  theme(axis.text.x = element_text(angle = 90))+
  facet_grid(cols = vars(summary_df_shared$species))

ggplot(summary_df_sig, 
       aes(x = receiver, y = abs(score_delta), color = receiver))+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared interactions only, significant")+
  theme(axis.text.x = element_text(angle = 90))+
  scale_color_manual("Receiver", values = col_cts_rec)+
  facet_grid(cols = vars(summary_df_sig$species))

ggplot(summary_df_shared, 
       aes(x = species, y = score_delta, color = receiver))+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared interactions only")+
  theme(axis.text.x = element_text(angle = 90),
        strip.text.x = element_text(angle = 90))+
  scale_color_manual("Receiver", values = col_cts_rec)+
  facet_grid(cols = vars(summary_df_shared$receiver))

ggplot(summary_df_shared, 
       aes(x = species, y = score_delta, color = direction))+
  geom_jitter(alpha = 0.3)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  ggtitle("shared interactions only")+
  scale_color_manual(values = col_direction)+
  theme(axis.text.x = element_text(angle = 90),
        strip.text.x = element_text(angle = 90))+
  facet_grid(cols = vars(summary_df_shared$receiver))

ggplot(summary_df_sig, 
       aes(x = species, y = abs(score_delta), color = receiver))+
  geom_boxplot(alpha = 0)+
  theme_classic()+
  ggtitle("shared interactions only, significant")+
  theme(axis.text.x = element_text(angle = 90),
        strip.text.x = element_text(angle = 90))+
  scale_color_manual("Receiver", values = col_cts_rec)+
  facet_grid(cols = vars(summary_df_sig$receiver))

```

# Understand structure 

Volcano plot, but:

 - p val cannot be smaller than 1/iterations
 - p vals of exactly 0 are inf
 
This is more to get an idea what the data loosk like, 
not really for presentation

```{r}
ggplot(summary_df_shared, aes(x = score_delta, y = -log10(p_adj)))+
  geom_point()+
  geom_hline(yintercept = -log10(0.05), color = "dodgerblue")+
  geom_vline(xintercept = 0, color = "dodgerblue")+
  theme_classic()

ggplot(summary_df_shared, aes(x = score_delta, y = -log10(p_adj), color = direction))+
  geom_point()+
  geom_hline(yintercept = -log10(0.05), color = "dodgerblue")+
  geom_vline(xintercept = 0, color = "dodgerblue")+
  theme_classic()+
  scale_color_manual(values = col_direction)
```

```{r}
summary_df_shared <- summary_df_shared[sample(1:nrow(summary_df_shared), nrow(summary_df_shared)),]

ggplot(summary_df_shared, aes(y = perm_scores_delta_median, x = score_delta))+
  geom_point()+
  theme_classic()+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))

ggscatter(summary_df_shared, x = "score_delta", y = "perm_scores_delta_median",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Delta score", 
          ylab = "Median of permuted delta scores",
          add.params = list(color = "orange",
                            fill = "lightgray"))+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))

ggplot(summary_df_shared, aes(y = perm_scores_delta_median, x = score_delta, 
                              color = species))+
  geom_point()+
  theme_classic()+
  scale_color_manual(values = col_spc)+
  facet_grid(cols = vars(summary_df_shared$species))+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))

ggscatter(summary_df_shared, x = "score_delta", y = "perm_scores_delta_median",
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Delta score", 
          ylab = "Median of permuted delta scores",
          add.params = list(color = "orange",
                            fill = "lightgray"))+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))+
  facet_grid(cols = vars(summary_df_shared$species))

ggplot(summary_df_shared, aes(y = perm_scores_delta_median, x = score_delta,
                              color = direction))+
  geom_point()+
  theme_classic()+
  scale_color_manual(values = col_direction)+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))

for(i in unique(summary_df_shared$emitter)){
  
  summary_df_shared_temp <- summary_df_shared[summary_df_shared$emitter == i,]
  
  plot1 <- ggscatter(summary_df_shared, x = "score_delta", 
                     y = "perm_scores_delta_median",
                     add = "reg.line", conf.int = TRUE, 
                     cor.coef = TRUE, cor.method = "pearson",
                     xlab = "Delta score", 
                     ylab = "Median of permuted delta scores",
                     add.params = list(color = "orange",
                                       fill = "lightgray"))+
    ylim(c(-0.7, 0.7))+
    xlim(c(-0.7, 0.7))+
    facet_grid(cols = vars(summary_df_shared$species))+
    ggtitle(i)
  
  print(plot1)
}

for(i in unique(summary_df_shared$receiver)){
  
  summary_df_shared_temp <- summary_df_shared[summary_df_shared$receiver == i,]
  
  plot1 <- ggscatter(summary_df_shared, x = "score_delta", 
                     y = "perm_scores_delta_median",
                     add = "reg.line", conf.int = TRUE, 
                     cor.coef = TRUE, cor.method = "pearson",
                     xlab = "Delta score", 
                     ylab = "Median of permuted delta scores",
                     add.params = list(color = "orange",
                                       fill = "lightgray"))+
    ylim(c(-0.7, 0.7))+
    xlim(c(-0.7, 0.7))+
    facet_grid(cols = vars(summary_df_shared$species))+
    ggtitle(i)
  
  print(plot1)
}

ggplot(summary_df_shared, aes(y = perm_scores_delta_median, x = score_delta,
                              color = emitter))+
  geom_point(size = 0.3)+
  theme_classic()+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))+
  scale_color_manual(values = col_cts_emi)

ggplot(summary_df_shared, aes(y = perm_scores_delta_median, x = score_delta,
                              color = receiver))+
  geom_point(size = 0.3)+
  theme_classic()+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))+
  scale_color_manual(values = col_cts_rec)

ggplot(summary_df_shared, aes(y = perm_scores_delta_median, x = p_val_shapiro,
                              color = receiver))+
  geom_point(size = 0.3)+
  theme_classic()+
  scale_color_manual(values = col_cts_rec)

```

```{r}
ggplot(summary_df_shared, aes(y = perm_scores_delta_mean, x = score_delta))+
  geom_point()+
  theme_classic()+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))+
  stat_cor() 

ggplot(summary_df_shared, aes(y = perm_scores_delta_mean, x = score_delta, 
                              color = species))+
  geom_point()+
  theme_classic()+
  scale_color_manual(values = col_spc)+
  facet_grid(cols = vars(summary_df_shared$species))+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))

ggplot(summary_df_shared, aes(y = perm_scores_delta_mean, x = score_delta, color = direction))+
  geom_point()+
  theme_classic()+
  scale_color_manual(values = col_direction)+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))

ggplot(summary_df_shared, aes(y = perm_scores_delta_mean, x = score_delta, color = direction))+
  geom_point()+
  theme_classic()+
  scale_color_manual(values = col_direction)+
  ylim(c(-0.7, 0.7))+
  xlim(c(-0.7, 0.7))
```


There is a CLEAR bias --> the permuted median tends to be lower than in general.
WHY?

```{r}
ggplot(summary_df_shared, aes(x = score_yng, y = score_old, color = direction))+
  geom_point()+
  geom_hline(yintercept = 1, color = "dodgerblue")+
  geom_vline(xintercept = 1, color = "dodgerblue")+
  theme_classic()+
  scale_color_manual(values = col_direction)
```

```{r}
ggplot(summary_df_shared, aes(x = rank(score_delta), y = score_delta))+
  geom_point()+
  theme_classic()
```

```{r}
ggplot(summary_df_shared, aes(x = perm_scores_delta_length, y = score_delta))+
  geom_point()+
  theme_classic()
```

```{r}
sessionInfo()
```