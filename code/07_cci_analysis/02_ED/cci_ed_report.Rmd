---
title: "cci_ed_report"
author: "Lea WÃ¶lbert"
date: '2023-08-14'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Load objects

```{r seed,  message = FALSE}
set.seed(37)
```

```{r load,  message = FALSE}
library(tidyverse)
library(scran)
library(SingleCellExperiment)
library(pheatmap)
library(ggpubr)
```

```{r load_objects}
cci_dist <- readRDS(snakemake@input[["cci_dist_input"]])
cci <- readRDS(snakemake@input[["cci_input"]])
```

```{r colors, meassage = FALSE}
colors_path <- snakemake@params[["colors_path"]]
source(snakemake@params[["colors"]])

col_cts_emi <- col_cts_str[names(col_cts_str) %in% cci$Identities$emitter]
col_cts_rec <- col_cts_hsc[names(col_cts_hsc) %in% cci$Identities$receiver]
```

# Get distances between young and old corresponding CTP 

```{r}

dist_oy <- cci_dist[grep("yng", rownames(cci_dist)), 
                    grep("old", colnames(cci_dist))]

dist_oy <- rownames_to_column(dist_oy, var = "ct_pair_yng")

dist_oy_direct <- dist_oy %>%
  pivot_longer(cols = c(2:ncol(dist_oy)),
               names_to = "ct_pair_old",
               names_ptypes = list("ct_pair_old" = character()),
               values_to = "distance",
               values_ptypes = list("euclidian_distance" = numeric()),
  )

dist_oy_direct$species_old <- vector(length = nrow(dist_oy_direct))
dist_oy_direct$species_yng <- vector(length = nrow(dist_oy_direct))
for(i in 1:nrow(dist_oy_direct)){
  dist_oy_direct$species_old[i] <- str_split(dist_oy_direct$ct_pair_old[i], "_")[[1]][2]
  dist_oy_direct$species_yng[i] <- str_split(dist_oy_direct$ct_pair_yng[i], "_")[[1]][2]
}


dist_oy_direct$emitter_old <- gsub("[&][[:print:]]+", "", dist_oy_direct$ct_pair_old)
dist_oy_direct$receiver_old <- gsub("[[:print:]]+[&]", "", dist_oy_direct$ct_pair_old)
dist_oy_direct$receiver_old <- gsub("[_][[:print:]]+", "", dist_oy_direct$receiver_old)
dist_oy_direct$ct_pair_old <- gsub("[_][[:print:]]+", "", dist_oy_direct$ct_pair_old)

dist_oy_direct$emitter_yng <- gsub("[&][[:print:]]+", "", dist_oy_direct$ct_pair_yng)
dist_oy_direct$receiver_yng <- gsub("[[:print:]]+[&]", "", dist_oy_direct$ct_pair_yng)
dist_oy_direct$receiver_yng <- gsub("[_][[:print:]]+", "", dist_oy_direct$receiver_yng)
dist_oy_direct$ct_pair_yng <- gsub("[_][[:print:]]+", "", dist_oy_direct$ct_pair_yng)


dist_oy_direct$emitter_old <- factor(dist_oy_direct$emitter_old,
                                levels = names(col_cts_emi))
dist_oy_direct$emitter_yng <- factor(dist_oy_direct$emitter_yng,
                                levels = names(col_cts_emi))

dist_oy_direct$receiver_old <- factor(dist_oy_direct$receiver_old,
                                levels = names(col_cts_rec))
dist_oy_direct$receiver_yng <- factor(dist_oy_direct$receiver_yng,
                                levels = names(col_cts_rec))

dist_oy_direct$species_old <- factor(dist_oy_direct$species_old,
                                levels = names(col_spc))
dist_oy_direct$species_yng <- factor(dist_oy_direct$species_yng,
                                levels = names(col_spc))

dist_oy_direct_direct <- dist_oy_direct[dist_oy_direct$ct_pair_yng == dist_oy_direct$ct_pair_old,]
dist_oy_direct_direct <- dist_oy_direct_direct[dist_oy_direct_direct$species_old == dist_oy_direct_direct$species_yng,]
```

```{r fig.width = 4, fig.height = 4}
ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, color = species_old))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")+
  geom_boxplot()+
  ylab("ED (corresp. young&old cell type pairs)")+
  xlab("Species")+
  scale_color_manual("Species", values = col_spc)+
  stat_compare_means(test = 'kruskal.test', p.adjust.method = "BH", label.y = 16)+
  stat_compare_means(
    comparisons = list(c("mmus", "mcas"), c("mmus", "mspr"),
                       c("mmus", "mcar"), c("mcas", "mspr"),
                       c("mcas", "mcar"), c("mspr", "mcar")),
    test = 'dunn_test', p.adjust.method = "BH",
    hide.ns = TRUE, aes(label = after_stat(p.signif)))+
  ggtitle("Euclidian distances")

#knitr::knit_exit()
```

```{r fig.width = 4, fig.height = 4}
ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, fill = species_old))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")+
  geom_boxplot(color = "black", alpha = 0.8)+
  ylab("ED (corresp. young&old cell type pairs)")+
  xlab("Species")+
  scale_fill_manual("Species", values = col_spc)+
  stat_compare_means(test = 'kruskal.test', p.adjust.method = "BH", label.y = 16)+
  stat_compare_means(
    comparisons = list(c("mmus", "mcas"), c("mmus", "mspr"),
                       c("mmus", "mcar"), c("mcas", "mspr"),
                       c("mcas", "mcar"), c("mspr", "mcar")),
    test = 'dunn_test', p.adjust.method = "BH",
    hide.ns = TRUE, aes(label = after_stat(p.signif)))+
  ggtitle("Euclidian distances")

#knitr::knit_exit()
```

```{r fig.width = 4, fig.height = 4}
ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, fill = species_old))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 0),
        legend.position = "none")+
  geom_boxplot(color = "black", alpha = 0.8)+
  ylab("ED (corresp. young&old cell type pairs)")+
  xlab("Species")+
  scale_fill_manual("Species", values = col_spc)+
  stat_compare_means(test = 'kruskal.test', p.adjust.method = "BH", label.y = 16)+
  stat_compare_means(
    comparisons = list(c("mmus", "mcas"), c("mmus", "mspr"),
                       c("mmus", "mcar"), c("mcas", "mspr"),
                       c("mcas", "mcar"), c("mspr", "mcar")),
    test = 'dunn_test', p.adjust.method = "BH",
    hide.ns = TRUE, aes(label = after_stat(p.signif)))+
  ggtitle("Euclidian distances")

#knitr::knit_exit()
```

```{r}

ggplot(dist_oy_direct_direct, 
       aes(x = emitter_old, y = distance, color = emitter_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("emitter", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  ylab("ED young/old")+
  xlab("Emitters")

ggplot(dist_oy_direct_direct, 
       aes(x = emitter_old, y = distance, color = receiver_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("receiver", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  ylab("ED young/old")+
  xlab("Emitters")

ggplot(dist_oy_direct_direct, 
       aes(x = emitter_old, y = distance, color = species_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("age", values = col_spc)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  ylab("ED young/old")+
  xlab("Emitters")

ggplot(dist_oy_direct_direct, 
       aes(x = receiver_old, y = distance, color = receiver_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("receiver", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  ylab("ED young/old")+
  xlab("Receivers")

ggplot(dist_oy_direct_direct, 
       aes(x = receiver_old, y = distance, color = emitter_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("emitter", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  ylab("ED young/old")+
  xlab("Receivers")

ggplot(dist_oy_direct_direct, 
       aes(x = receiver_old, y = distance, color = species_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  ylab("ED young/old")+
  xlab("Receivers")
```

```{r}
ggplot(dist_oy_direct_direct, 
       aes(x = emitter_old, y = distance, color = emitter_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("emitter", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$species_old))+
  ylab("ED young/old")+
  xlab("Emitters")

ggplot(dist_oy_direct_direct, 
       aes(x = emitter_old, y = distance, color = receiver_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("receiver", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$species_old))+
  ylab("ED young/old")+
  xlab("Emitters")

ggplot(dist_oy_direct_direct, 
       aes(x = emitter_old, y = distance, color = species_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("age", values = col_spc)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$species_old))+
  ylab("ED young/old")+
  xlab("Emitters")

ggplot(dist_oy_direct_direct, 
       aes(x = receiver_old, y = distance, color = receiver_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("receiver", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$species_old))+
  ylab("ED young/old")+
  xlab("Receivers")

ggplot(dist_oy_direct_direct, 
       aes(x = receiver_old, y = distance, color = emitter_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("emitter", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$species_old))+
  ylab("ED young/old")+
  xlab("Receivers")

ggplot(dist_oy_direct_direct, 
       aes(x = receiver_old, y = distance, color = species_yng))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$species_old))+
  ylab("ED young/old")+
  xlab("Receivers")
```

```{r}
ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, color = emitter_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("emitter", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$emitter_old))+
  theme(strip.text.x = element_text(angle = 90))+
  ylab("ED young/old")+
  xlab("Species")

ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, color = receiver_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("receiver", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$emitter_old))+
  theme(strip.text.x = element_text(angle = 90))+
  ylab("ED young/old")+
  xlab("Species")

ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, color = species_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$emitter_old))+
  theme(strip.text.x = element_text(angle = 90))+
  ylab("ED young/old")+
  xlab("Species")

ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, color = receiver_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("receiver", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$receiver_old))+
  theme(strip.text.x = element_text(angle = 90))+
  ylab("ED young/old")+
  xlab("Species")

ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, color = emitter_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("emitter", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$receiver_old))+
  theme(strip.text.x = element_text(angle = 90))+
  ylab("ED young/old")+
  xlab("Species")

ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, color = species_yng))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  facet_grid(cols = vars(dist_oy_direct_direct$receiver_old))+
  theme(strip.text.x = element_text(angle = 90))+
  ylab("ED young/old")+
  xlab("Species")
```

```{r}
ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, color = emitter_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("emitter", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  ylab("ED young/old")+
  xlab("Species")

ggplot(dist_oy_direct_direct, 
       aes(x = species_old, y = distance, color = receiver_old))+
  ggbeeswarm::geom_quasirandom()+
  theme_classic()+
  scale_color_manual("receiver", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  geom_boxplot(color = "grey50", alpha = 0)+
  ylab("ED young/old")+
  xlab("Species")
```

# Get distances within young and old corresponding CTP interactomes

Subset the distance matrix into one for distances only within old interactions
and for for only distances within young interactomes.

We are not interested in direct distances between young and old ctps, so they
can be removed.

```{r}
cci_dist_old <- cci_dist[
  grep("old", colnames(cci_dist)),
  grep("old", rownames(cci_dist))]

cci_dist_old <- cci_dist_old[
  order(rownames(cci_dist_old)),order(colnames(cci_dist_old))]

cci_dist_yng <- cci_dist[
  grep("yng", colnames(cci_dist)),
  grep("yng", rownames(cci_dist))]

cci_dist_yng <- cci_dist_yng[
  order(rownames(cci_dist_yng)),order(colnames(cci_dist_yng))]
```

Reformat both distance matrices so they only contain ctps found in both
age groups.
Since the rownames and colnames contain info on the species, it will be taken
into account that one species may have ctps that another doesn't have.

```{r}

rownames(cci_dist_yng) <- gsub(paste0("_yng"), "", rownames(cci_dist_yng))
colnames(cci_dist_yng) <- gsub(paste0("_yng"), "", colnames(cci_dist_yng))

rownames(cci_dist_old) <- gsub(paste0("_old"), "", rownames(cci_dist_old))
colnames(cci_dist_old) <- gsub(paste0("_old"), "", colnames(cci_dist_old))

rownames_shared <- intersect(rownames(cci_dist_old), rownames(cci_dist_yng))
colnames_shared <- intersect(colnames(cci_dist_old), colnames(cci_dist_yng))
identical(rownames_shared, colnames_shared)

cci_dist_old <- cci_dist_old[rownames(cci_dist_old) %in% rownames_shared,
                             colnames(cci_dist_old) %in% rownames_shared,]
cci_dist_yng <- cci_dist_yng[rownames(cci_dist_yng) %in% rownames_shared,
                             colnames(cci_dist_yng) %in% rownames_shared,]

```

Reformat both distance matrices into two long data frames.
This makes it possible to add metadata on each cell type pair.

ctp 1 is the cell type pair originally found in the rownames.
ctp 2 is the cell type pair originally found in the colnames.

instead of a direct distance matrix, each distance between two cell tyoe oaur
will now have one row, with all required information on both cell type pairs
in the same row.
Therefore, info on ctp1 is stored in age1, species1, emitter1, receiver1.

```{r}

dist_df_old <- rownames_to_column(cci_dist_old, var = "ct_pair1")
dist_df_yng <- rownames_to_column(cci_dist_yng, var = "ct_pair1")

dist_df_old_long <- dist_df_old %>%
  pivot_longer(cols = c(2:ncol(dist_df_old)),
               names_to = "ct_pair2",
               names_ptypes = list("ct_pair2" = character()),
               values_to = "distance",
               values_ptypes = list("euclidian_distance" = numeric())
  )

dist_df_yng_long <- dist_df_yng %>%
  pivot_longer(cols = c(2:ncol(dist_df_yng)),
               names_to = "ct_pair2",
               names_ptypes = list("ct_pair2" = character()),
               values_to = "distance",
               values_ptypes = list("euclidian_distance" = numeric())
  )


dist_df_old_long$emitter1 <- gsub("[&][[:print:]]+", "", dist_df_old_long$ct_pair1)
dist_df_old_long$receiver1 <- gsub("[[:print:]]+[&]+", "", dist_df_old_long$ct_pair1)
dist_df_old_long$receiver1 <- gsub("[_][[:print:]]+", "", dist_df_old_long$receiver1)

dist_df_old_long$emitter2 <- gsub("[&][[:print:]]+", "", dist_df_old_long$ct_pair2)
dist_df_old_long$receiver2 <- gsub("[[:print:]]+[&]+", "", dist_df_old_long$ct_pair2)
dist_df_old_long$receiver2 <- gsub("[_][[:print:]]+", "", dist_df_old_long$receiver2)

dist_df_old_long$species1 <- gsub("[[:print:]]+[_]", "", dist_df_old_long$ct_pair1)
dist_df_old_long$species2 <- gsub("[[:print:]]+[_]", "", dist_df_old_long$ct_pair2)

# I already subset so that both age groups must be old, etc.
dist_df_old_long$age1 <- "old"
dist_df_old_long$age2 <- "old"


dist_df_yng_long$emitter1 <- gsub("[&][[:print:]]+", "", dist_df_yng_long$ct_pair1)
dist_df_yng_long$receiver1 <- gsub("[[:print:]]+[&]+", "", dist_df_yng_long$ct_pair1)
dist_df_yng_long$receiver1 <- gsub("[_][[:print:]]+", "", dist_df_yng_long$receiver1)

dist_df_yng_long$emitter2 <- gsub("[&][[:print:]]+", "", dist_df_yng_long$ct_pair2)
dist_df_yng_long$receiver2 <- gsub("[[:print:]]+[&]+", "", dist_df_yng_long$ct_pair2)
dist_df_yng_long$receiver2 <- gsub("[_][[:print:]]+", "", dist_df_yng_long$receiver2)

dist_df_yng_long$species1 <- gsub("[[:print:]]+[_]", "", dist_df_yng_long$ct_pair1)
dist_df_yng_long$species2 <- gsub("[[:print:]]+[_]", "", dist_df_yng_long$ct_pair2)

dist_df_yng_long$age1 <- "young"
dist_df_yng_long$age2 <- "young"

```

Since we're only interested in distances within interactomes, all distances
between ctps of different species can be removed right away.

```{r}

dist_df_old_long <- dist_df_old_long[dist_df_old_long$species1 == dist_df_old_long$species2,]
dist_df_yng_long <- dist_df_yng_long[dist_df_yng_long$species1 == dist_df_yng_long$species2,]

```

Distances between a cell type pair and itself can also be removed, as this
carries no interesting information for this analysis and will just bias the
median distance between two cell type pairs to 0.

```{r}

dist_df_old_long <- dist_df_old_long[dist_df_old_long$ct_pair1 != dist_df_old_long$ct_pair2,]
dist_df_yng_long <- dist_df_yng_long[dist_df_yng_long$ct_pair1 != dist_df_yng_long$ct_pair2,]

```

Now we have distances only within species, and ages, but we want to subset to
distances only within cell type pairs.

This means for instance all distances between HSC ctps within a species, 
and age.
For example:

- Distance (Adipo-CARs&HSCs -- Fibroblasts&HSCs)
- Distance (Adipo-CARs&HSCs -- Osteo&HSCs)
- Distance (Fibroblasts&HSCs -- Osteo&HSCs)
- Distance (Osteo&HSCs -- Fibroblasts&HSCs)

It should be noted that his means that the same distance values appear twice, 
one for distance A-B and one for distance B-A (for now)

and so on.
In short, all distances between cell type pairs that both contain HSCs.
This is just an example for better understanding:

```{r}

dist_df_old_long_hsc <- dist_df_old_long[dist_df_old_long$receiver1 == dist_df_old_long$receiver2,]
dist_df_old_long_hsc <- dist_df_old_long[dist_df_old_long$receiver1 == "HSCs",]

head(dist_df_old_long_hsc)

ggplot(dist_df_old_long_hsc, aes(x = species1, y = distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.4)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()

```

However, we are interested how the distances between two cell type pairs in a
cell type pair interactome increase or decrease with ageing.
Therefore, we construct a dataframe of the exact same make-up as the two
long data frames and fill them with the difference between the distances for
each cell type pair.

Delta_distance = distance(ctp1-ctp2)old - distance(ctp1-ctp2)yng

Therefore, a positive delta_distance indicates that the distance between two
cell type pairs increased with age.

```{r}

# excluding distance and age
dist_df_long <- dist_df_old_long[,c(1, 2, 4, 5, 6, 7, 8, 9)]

# make sure that the rows are ordered exactly the same before we substract
# the yong distance from the old distance
identical(dist_df_old_long$ct_pair1, dist_df_yng_long$ct_pair1)
identical(dist_df_old_long$ct_pair2, dist_df_yng_long$ct_pair2)

stopifnot(identical(dist_df_old_long$ct_pair1, dist_df_yng_long$ct_pair1))
stopifnot(identical(dist_df_old_long$ct_pair2, dist_df_yng_long$ct_pair2))

dist_df_long$delta_distance <- dist_df_old_long$distance - dist_df_yng_long$distance

```

Now further subset this data frame into one data frame for emitters and one 
for receivers.

This way, the data frame for emitters will contain info on pairs of cell type 
pairs where both emitters are the same (only emitter cell type interactomes)
and the data frame for receivers will contain info on pairs of cell type pairs
where both receivers are the same (as shown above with the example of HSCs),
but for all receivers for better visualisation.

Only within cell types

```{r}
dist_df_long_emi <- dist_df_long[
  dist_df_long$emitter1 == dist_df_long$emitter2,]

dist_df_long_rec <- dist_df_long[
  dist_df_long$receiver1 == dist_df_long$receiver2,]
```

Remove duplicates obtained by measuring distances between A-B and B-A
which will have the same value.

```{r}
table(duplicated(dist_df_long_emi$delta_distance))
stopifnot(duplicated(dist_df_long_emi$delta_distance)[1] == duplicated(dist_df_long_emi$delta_distance)[2])
dist_df_long_emi <- dist_df_long_emi[duplicated(dist_df_long_emi$delta_distance),]

table(duplicated(dist_df_long_rec$delta_distance))
stopifnot(duplicated(dist_df_long_rec$delta_distance)[1] == duplicated(dist_df_long_rec$delta_distance)[2])
dist_df_long_rec <- dist_df_long_rec[duplicated(dist_df_long_rec$delta_distance),]
```

Factor metadata for nicer visualisation.

```{r}

dist_df_long_emi$emitter1 <- factor(dist_df_long_emi$emitter1, 
                                    levels = names(col_cts_emi))
dist_df_long_emi$emitter2 <- factor(dist_df_long_emi$emitter2, 
                                    levels = names(col_cts_emi))

dist_df_long_emi$receiver1 <- factor(dist_df_long_emi$receiver1, 
                                    levels = names(col_cts_rec))
dist_df_long_emi$receiver2 <- factor(dist_df_long_emi$receiver2, 
                                    levels = names(col_cts_rec))

dist_df_long_emi$species1 <- factor(dist_df_long_emi$species1, 
                                    levels = names(col_spc))
dist_df_long_emi$species2 <- factor(dist_df_long_emi$species2, 
                                    levels = names(col_spc))


dist_df_long_rec$emitter1 <- factor(dist_df_long_rec$emitter1, 
                                    levels = names(col_cts_emi))
dist_df_long_rec$emitter2 <- factor(dist_df_long_rec$emitter2, 
                                    levels = names(col_cts_emi))

dist_df_long_rec$receiver1 <- factor(dist_df_long_rec$receiver1, 
                                    levels = names(col_cts_rec))
dist_df_long_rec$receiver2 <- factor(dist_df_long_rec$receiver2, 
                                    levels = names(col_cts_rec))

dist_df_long_rec$species1 <- factor(dist_df_long_rec$species1, 
                                    levels = names(col_spc))
dist_df_long_rec$species2 <- factor(dist_df_long_rec$species2, 
                                    levels = names(col_spc))
```

Now visualise!

### Emitters

```{r, fig.height = 9}
ggplot(dist_df_long_emi,
                  aes(x = emitter1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(rows = vars(species1))+
  scale_color_manual("Emitter1", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = emitter1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(rows = vars(species1))+
  scale_color_manual("Receiver1", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  ylim(c(-8.5, 8.5))
```

```{r}
ggplot(dist_df_long_emi,
                  aes(x = emitter1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Emitter1", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = emitter1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Receiver1", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = emitter1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.text.x = element_text(angle = 90))+
  ylim(c(-8.5, 8.5))
```


```{r}

ggplot(dist_df_long_emi,
                  aes(x = species1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(emitter1))+
  scale_color_manual("Species", values = col_spc)+
  theme(strip.text.x = element_text(angle = 90),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = species1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(emitter1))+
  scale_color_manual("Receiver1", values = col_cts_rec)+
  theme(strip.text.x = element_text(angle = 90),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = emitter1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(species1))+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = emitter1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(species1))+
  scale_color_manual("Receiver", values = col_cts_rec)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = species1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.4)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Species", values = col_spc)+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = species1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 0.4)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Emitters", values = col_cts_emi)+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = species1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 0.4)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Receiver1", values = col_cts_rec)+
  ylim(c(-8.5, 8.5))
```

```{r}
ggplot(dist_df_long_emi,
                  aes(x = receiver1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(species1))+
  scale_color_manual("Receiver1", values = col_cts_rec)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = species1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(receiver1))+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = receiver1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))
```

### Receivers

```{r, fig.height = 9}
ggplot(dist_df_long_rec,
                  aes(x = receiver1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(rows = vars(species1))+
  scale_color_manual("Receiver1", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = receiver1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(rows = vars(species1))+
  scale_color_manual("Emitter1", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  ylim(c(-8.5, 8.5))
```

```{r}
ggplot(dist_df_long_rec,
                  aes(x = receiver1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Receiver1", values = col_cts_rec)+
  theme(axis.text.x = element_text(angle = 90))+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = receiver1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Emitter1", values = col_cts_emi)+
  theme(axis.text.x = element_text(angle = 90))+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = receiver1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.text.x = element_text(angle = 90))+
  ylim(c(-8.5, 8.5))
```

```{r}

ggplot(dist_df_long_rec,
                  aes(x = species1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(receiver1))+
  scale_color_manual("Species", values = col_spc)+
  theme(strip.text.x = element_text(angle = 90),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = species1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(receiver1))+
  scale_color_manual("Emitter1", values = col_cts_emi)+
  theme(strip.text.x = element_text(angle = 90),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = receiver1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(species1))+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = receiver1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(species1))+
  scale_color_manual("Emitter1", values = col_cts_emi)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = species1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.4)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Species", values = col_spc)+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = species1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 0.4)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Emitters", values = col_cts_rec)+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = species1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 0.4)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Emitter1", values = col_cts_emi)+
  ylim(c(-8.5, 8.5))
```

```{r}
ggplot(dist_df_long_rec,
                  aes(x = emitter1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(species1))+
  #scale_color_manual("Emitter1", values = col_cts_emi)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = species1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  facet_grid(cols = vars(emitter1))+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = emitter1, y = delta_distance, color = species1))+
  ggbeeswarm::geom_quasirandom(size = 0.8)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))
```

```{r}
ggplot(dist_df_long_rec,
                  aes(x = ct_pair1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 2)+
  theme_classic()+
  facet_grid(cols = vars(dist_df_long_rec$species1))+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_rec,
                  aes(x = ct_pair1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 2)+
  theme_classic()+
  facet_grid(cols = vars(dist_df_long_rec$species1))+
  scale_color_manual("Species", values = col_spc)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = ct_pair1, y = delta_distance, color = receiver1))+
  ggbeeswarm::geom_quasirandom(size = 2)+
  theme_classic()+
  facet_grid(cols = vars(dist_df_long_emi$species1))+
  #scale_color_manual("Species", values = col_spc)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))

ggplot(dist_df_long_emi,
                  aes(x = ct_pair1, y = delta_distance, color = emitter1))+
  ggbeeswarm::geom_quasirandom(size = 2)+
  theme_classic()+
  facet_grid(cols = vars(dist_df_long_emi$species1))+
  #scale_color_manual("Species", values = col_spc)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  ylim(c(-8.5, 8.5))
```

```{r}
sessionInfo()
```