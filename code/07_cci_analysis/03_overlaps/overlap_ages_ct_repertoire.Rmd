---
title: "ct repertoire overlap ages"
author: "Lea WÃ¶lbert"
date: '2023-10-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Load objects

```{r seed,  message = FALSE}
set.seed(37)
```

```{r load,  message = FALSE}
library(tidyverse)
library(scran)
library(ggpubr)
library(ComplexUpset)
```

```{r colors, meassage = FALSE}
colors_path <- snakemake@params[["colors_path"]]
source(snakemake@params[["colors"]])
source(snakemake@params[["plotting"]])
```

```{r load_objects}
cci_met_path_ilrs_list <- snakemake@input[["cci_met_ilrs_paths"]]
sce_path_list <- snakemake@input[["sce_paths"]]
perc_df_path_list <- snakemake@input[["perc_df_paths"]]

species <- snakemake@params[["species"]]
age <- snakemake@params[["age"]]

cci_met_ilrs_list <- list()
sce_list <- list()
perc_list <- list()
for(s in species){
  for(a in age){
    cond <- as.character(paste0(s, "_", a))
    cci_met_path_ilrs <- cci_met_path_ilrs_list[[
      which(grepl(cond, cci_met_path_ilrs_list))]]
    sce_path <- sce_path_list[[which(grepl(cond, sce_path_list))]]
    perc_df_path <- perc_df_path_list[[which(grepl(cond, perc_df_path_list))]]
    cci_met_ilrs_list[[cond]] <- readRDS(cci_met_path_ilrs)
    sce_list[[s]][[a]] <- readRDS(sce_path)
    perc_list[[s]][[a]] <- readRDS(perc_df_path)
  }
}

sce_hsc <- readRDS(snakemake@input[["sce_hsc"]])
sce_str <- readRDS(snakemake@input[["sce_str"]])
```

# Prepare data

## Nr_df

```{r}
# for each species, get the overlap and young and old only ligand/receptor genes
# sort list by species and then age
# also remove cell types that are not detected in both ages
cci_met_cts_list_ages <- list()

for(s in species){
  
  cci_met_s <- cci_met_ilrs_list[which(grepl(s, names(cci_met_ilrs_list)))]
  cts_preserved <- intersect(names(cci_met_s[[1]]), names(cci_met_s[[2]]))

  cci_met_s[[1]] <- cci_met_s[[1]][
    which(names(cci_met_s[[1]]) %in% cts_preserved)]
  cci_met_s[[2]] <- cci_met_s[[2]][
    which(names(cci_met_s[[2]]) %in% cts_preserved)]
  
  for(a in age){
    cci_met_cts_list_ages[[s]][[a]] <- cci_met_s[[
      which(grepl(a, names(cci_met_s)))]]
  }
}
print(names(cci_met_cts_list_ages))
print(names(cci_met_cts_list_ages$mspr))
print(names(cci_met_cts_list_ages[[1]][[2]]))
```

```{r}
# within species, extract the list of genes that are preserved,
# young_only, and old_only, as well as handy data frames for each cell type
overlap_lists <- lapply(cci_met_cts_list_ages, function(cci_met_age){
  
  cci_met_yng_list <- cci_met_age[["yng"]]
  cci_met_old_list <- cci_met_age[["old"]]
  
  cts_all <- unique(c(names(cci_met_yng_list), names(cci_met_old_list)))
  cts_all_list <- as.list(cts_all)
  
  overlap <- lapply(cts_all, function(ct){
    
    cci_met_yng <- cci_met_yng_list[[ct]]
    cci_met_old <- cci_met_old_list[[ct]]
    
    preserved <- intersect(unique(cci_met_yng$sigmol), 
                        unique(cci_met_old$sigmol))

    yng_only <- unique(cci_met_yng$sigmol[
      which(!cci_met_yng$sigmol %in% preserved)])
    old_only <- unique(cci_met_old$sigmol[
      which(!cci_met_old$sigmol %in% preserved)])
  
    # make sure the vectors are correct
    stopifnot(!yng_only %in% preserved)
    stopifnot(!old_only %in% preserved)
        
    stopifnot(!yng_only %in% cci_met_old$sigmol)
    stopifnot(!old_only %in% cci_met_yng$sigmol)
  
    stopifnot(preserved %in% cci_met_yng$sigmol)
    stopifnot(preserved %in% cci_met_old$sigmol)
      
    # count the length of each cell type entry  
    return_df <- data.frame(
      "mode" = c("preserved", "yng_only", "old_only"),
      "nr" = c(length(preserved), length(yng_only), length(old_only)),
      "cell_type" = rep(ct, 3),
      # within species, so species will be the same in each list item
      "species" = rep(cci_met_old_list[[1]]$species[1], 3)
      
    )
    
    return(list("preserved" = preserved,
                "yng_only" = yng_only,
                "old_only" = old_only,
                "nr_df" = return_df))
  })
  names(overlap) <- cts_all
  return(overlap)
})
names(overlap_lists) <- names(cci_met_cts_list_ages)
```

```{r}
# extract only the nr_dfs for now
nr_df_all <- data.frame()
for(i in 1:length(overlap_lists)){
  for(j in 1:length(overlap_lists[[i]])){
    
    nr_df_add <- overlap_lists[[i]][[j]]$nr_df
    nr_df_add$proportion <- nr_df_add$nr/sum(nr_df_add$nr)
    nr_df_add$norm <- nr_df_add$nr/nr_df_add$nr[nr_df_add$mode == "preserved"]
      
    nr_df_all <- rbind(nr_df_all, nr_df_add)
    
  }
}

head(nr_df_all)
```

```{r}
nr_df_all$mode <- factor(nr_df_all$mode,
                         levels = c("old_only" ,"yng_only", "preserved"))
nr_df_all$mode_rev <- factor(nr_df_all$mode, 
                             levels = rev(c( "old_only" ,"yng_only", "preserved")))
nr_df_all$cell_type <- factor(nr_df_all$cell_type,
                              levels = c(names(col_cts_hsc), 
                                         names(col_cts_str)))
nr_df_all$cell_type_rev <- factor(nr_df_all$cell_type,
                                  levels = rev(c(names(col_cts_hsc),
                                                 names(col_cts_str))))
nr_df_all$species <- factor(nr_df_all$species, levels = names(col_spc))
nr_df_all$species_rev <- factor(nr_df_all$species, levels = rev(names(col_spc)))

col_mode <- c("old_only" = "grey60", "yng_only" = "black", "preserved" = "orange2")
```

## Upset 

```{r}
large_df <- bind_rows(cci_met_cts_list_ages$mmus$yng)
large_df <- rbind(large_df, bind_rows(cci_met_cts_list_ages$mmus$old))
large_df <- rbind(large_df, bind_rows(cci_met_cts_list_ages$mcas$yng))
large_df <- rbind(large_df, bind_rows(cci_met_cts_list_ages$mcas$old))
large_df <- rbind(large_df, bind_rows(cci_met_cts_list_ages$mspr$yng))
large_df <- rbind(large_df, bind_rows(cci_met_cts_list_ages$mspr$old))
large_df <- rbind(large_df, bind_rows(cci_met_cts_list_ages$mcar$yng))
large_df <- rbind(large_df, bind_rows(cci_met_cts_list_ages$mcar$old))

large_df$mode <- vector(length = nrow(large_df))

cts <- c(names(col_cts_hsc), names(col_cts_str))

for(s in species){
  for(c in cts){
    
    pos <- which(large_df$species == s & large_df$identity == c)
    
    large_df[pos,]$mode[large_df[
      pos,]$sigmol %in% overlap_lists[[s]][[c]]$preserved] <- "preserved"
    large_df[pos,]$mode[large_df[
      pos,]$sigmol %in% overlap_lists[[s]][[c]]$yng_only] <- "yng_only"
    large_df[pos,]$mode[large_df[
      pos,]$sigmol %in% overlap_lists[[s]][[c]]$old_only] <- "old_only"

  }
}

table(large_df$mode)
```

```{r}

large_df_upset <- large_df
large_df_upset_old <- large_df_upset[large_df_upset$mode == "old_only",]
large_df_upset_yng <- large_df_upset[large_df_upset$mode == "yng_only",]
large_df_upset_shr <- large_df_upset[large_df_upset$mode == "preserved",]

for(s in species){
  
  print(s)
  
  large_df_upset_old$add <- vector(length = nrow(large_df_upset_old))
  large_df_upset_yng$add <- vector(length = nrow(large_df_upset_yng))
  large_df_upset_shr$add <- vector(length = nrow(large_df_upset_shr))

  all_ints_of_species_old <- unique(
    large_df_upset_old$sigmol[large_df_upset_old$species == s])
  all_ints_of_species_yng <- unique(
    large_df_upset_yng$sigmol[large_df_upset_yng$species == s])
  all_ints_of_species_shr <- unique(
    large_df_upset_shr$sigmol[large_df_upset_shr$species == s])
  
  large_df_upset_old$add[
    large_df_upset_old$sigmol %in% all_ints_of_species_old] <- TRUE
  large_df_upset_yng$add[
    large_df_upset_yng$sigmol %in% all_ints_of_species_yng] <- TRUE
  large_df_upset_shr$add[
    large_df_upset_shr$sigmol %in% all_ints_of_species_shr] <- TRUE
  
  colnames(large_df_upset_old)[colnames(large_df_upset_old) == "add"] <- s
  colnames(large_df_upset_yng)[colnames(large_df_upset_yng) == "add"] <- s
  colnames(large_df_upset_shr)[colnames(large_df_upset_shr) == "add"] <- s
  
}

large_df_upset_old_short <- large_df_upset_old[!duplicated(
  large_df_upset_old$sigmol),]
large_df_upset_yng_short <- large_df_upset_yng[!duplicated(
  large_df_upset_yng$sigmol),]
large_df_upset_shr_short <- large_df_upset_shr[!duplicated(
  large_df_upset_shr$sigmol),]
```

# Important Plots

Visualise the proportions of overlap of repertoire between young and old.

```{r fig.width= 10, fig.height = 5}

ggplot(nr_df_all, aes(y = cell_type_rev, x = nr, fill = mode))+
  geom_col(position = "stack")+
  theme_classic()+
  facet_grid(cols = vars(species))+
  scale_fill_manual("Detection", values = col_mode)+
  xlab("Nr of ligand/receptor genes per cell type")+
  theme(axis.text.x = element_text(angle = 90))+
  ylab("Cell type")

ggplot(nr_df_all, aes(y = cell_type_rev, x = nr, fill = mode))+
  geom_col(position = "fill")+
  theme_classic()+
  facet_grid(cols = vars(species))+
  scale_fill_manual("Detection", values = col_mode)+
  xlab("Proportions of ligand/receptor genes per cell type")+
  theme(axis.text.x = element_text(angle = 90))+
  ylab("Cell type")
```

```{r, fig.width = 4, fig.height = 4}
ggplot(nr_df_all, aes(x = species, y = proportion, color = mode))+
  geom_boxplot()+
  ylab("Proportion of ligand/receptor genes per cell type")+
  theme_classic()+
  scale_color_manual("", values = col_mode)+
  facet_grid(cols = vars(mode_rev))+
  xlab("Species")+
  theme(axis.text.x = element_text(angle = 90))

ggplot(nr_df_all, aes(x = mode_rev, y = proportion, color = mode))+
  geom_boxplot()+
  ylab("Proportion of ligand/receptor genes per cell type")+
  theme_classic()+
  scale_color_manual("", values = col_mode)+
  facet_grid(cols = vars(species))+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank())
```

```{r, fig.width = 5, fig.height = 7}

upset(large_df_upset_old_short, intersect = c("mmus", "mcas", "mspr",  "mcar"),
      base_annotations=list(
        'Intersection size'=intersection_size(mapping=aes(fill='bars_color'))+
          scale_fill_manual(values=c('bars_color'= col_age[["old"]]), 
                            guide='none')))+
  xlab("")

upset(large_df_upset_yng_short, intersect = c("mmus", "mcas", "mspr",  "mcar"),
      base_annotations=list(
        'Intersection size'=intersection_size(mapping=aes(fill='bars_color'))+
          scale_fill_manual(values=c('bars_color'= col_age[["yng"]]), 
                            guide='none')))+
  xlab("")

upset(large_df_upset_shr_short, intersect = c("mmus", "mcas", "mspr",  "mcar"),
      base_annotations=list(
        'Intersection size'=intersection_size(mapping=aes(fill='bars_color'))+
          scale_fill_manual(values=c('bars_color'= "orange"), 
                            guide='none')))+
  xlab("")
```

```{r fig.height = 15, fig.width = 6}
large_df_upset_old$species <- factor(large_df_upset_old$species,
                                     levels = names(col_spc))

large_df_upset_old$detection <- vector(length = nrow(large_df_upset_old))
large_df_upset_old$detection[
  which(large_df_upset_old$mmus == "TRUE" &
          large_df_upset_old$mcas == "TRUE" &
          large_df_upset_old$mspr == "TRUE" &
          large_df_upset_old$mcar == "TRUE")] <- TRUE 

large_df_upset_old$detection[
  large_df_upset_old$detection == "FALSE"] <- unfactor(large_df_upset_old$species[
    large_df_upset_old$detection == "FALSE"])

large_df_upset_old$species_pos <- vector(length = nrow(large_df_upset_old))
large_df_upset_old$species_pos[large_df_upset_old$species == "mmus"] <- 4
large_df_upset_old$species_pos[large_df_upset_old$species == "mcas"] <- 3
large_df_upset_old$species_pos[large_df_upset_old$species == "mspr"] <- 2
large_df_upset_old$species_pos[large_df_upset_old$species == "mcar"] <- 1
large_df_upset_old$species_pos[large_df_upset_old$detection == "TRUE"] <- 5
```

```{r fig.height = 15, fig.width = 6}
ggplot(large_df_upset_old[
  large_df_upset_old$assignment == "emitter",], 
       aes(y = reorder(sigmol, species_pos), fill = detection))+
  geom_bar()+
  facet_grid(cols = vars(species))+
  scale_fill_manual(values = c(col_spc, "TRUE" = "orange"))+
  ylab("Old-specific Ligands")+
  xlab("Nr of cell types")
```

```{r fig.height = 13, fig.width = 6}
ggplot(large_df_upset_old[
  large_df_upset_old$assignment == "receiver",], 
       aes(y = reorder(sigmol, species_pos), fill = detection))+
  geom_bar()+
  facet_grid(cols = vars(species))+
  scale_fill_manual(values = c(col_spc, "TRUE" = "orange"))+
  ylab("Old-specific receptors")+
  xlab("Nr of cell types")
```

```{r fig.height = 10, fig.width = 6}
large_df_upset_yng$species <- factor(large_df_upset_yng$species,
                                     levels = names(col_spc))

large_df_upset_yng$detection <- vector(length = nrow(large_df_upset_yng))
large_df_upset_yng$detection[
  which(large_df_upset_yng$mmus == "TRUE" &
          large_df_upset_yng$mcas == "TRUE" &
          large_df_upset_yng$mspr == "TRUE" &
          large_df_upset_yng$mcar == "TRUE")] <- TRUE 

large_df_upset_yng$detection[
  large_df_upset_yng$detection == "FALSE"] <- unfactor(large_df_upset_yng$species[
    large_df_upset_yng$detection == "FALSE"])

large_df_upset_yng$species_pos <- vector(length = nrow(large_df_upset_yng))
large_df_upset_yng$species_pos[large_df_upset_yng$species == "mmus"] <- 4
large_df_upset_yng$species_pos[large_df_upset_yng$species == "mcas"] <- 3
large_df_upset_yng$species_pos[large_df_upset_yng$species == "mspr"] <- 2
large_df_upset_yng$species_pos[large_df_upset_yng$species == "mcar"] <- 1
large_df_upset_yng$species_pos[large_df_upset_yng$detection == "TRUE"] <- 5
```

```{r fig.height = 14, fig.width = 6}
ggplot(large_df_upset_yng[large_df_upset_yng$assignment == "emitter",],
       aes(y = reorder(sigmol, species_pos), fill = detection))+
  geom_bar()+
  facet_grid(cols = vars(species))+
  scale_fill_manual(values = c(col_spc, "TRUE" = "orange"))+
  ylab("Young-specific ligands")+
  xlab("Nr of cell types")
```

```{r fig.height = 12, fig.width = 6}
ggplot(large_df_upset_yng[large_df_upset_yng$assignment == "receiver",],
       aes(y = reorder(sigmol, species_pos), 
           fill = detection))+
  geom_bar()+
  facet_grid(cols = vars(species))+
  scale_fill_manual(values = c(col_spc, "TRUE" = "orange"))+
  ylab("Young-specific receptors")+
  xlab("Nr of cell types")
```


```{r fig.height = 25, fig.width = 6}
large_df_upset_shr$species <- factor(large_df_upset_shr$species,
                                     levels = names(col_spc))

large_df_upset_shr$detection <- vector(length = nrow(large_df_upset_shr))
large_df_upset_shr$detection[
  which(large_df_upset_shr$mmus == "TRUE" &
          large_df_upset_shr$mcas == "TRUE" &
          large_df_upset_shr$mspr == "TRUE" &
          large_df_upset_shr$mcar == "TRUE")] <- TRUE 

large_df_upset_shr$detection[
  large_df_upset_shr$detection == "FALSE"] <- unfactor(large_df_upset_shr$species[
    large_df_upset_shr$detection == "FALSE"])

large_df_upset_shr$species_pos <- vector(length = nrow(large_df_upset_shr))
large_df_upset_shr$species_pos[large_df_upset_shr$species == "mmus"] <- 4
large_df_upset_shr$species_pos[large_df_upset_shr$species == "mcas"] <- 3
large_df_upset_shr$species_pos[large_df_upset_shr$species == "mspr"] <- 2
large_df_upset_shr$species_pos[large_df_upset_shr$species == "mcar"] <- 1
large_df_upset_shr$species_pos[large_df_upset_shr$detection == "TRUE"] <- 5

```

```{r fig.height = 25, fig.width = 6}
ggplot(large_df_upset_shr[large_df_upset_shr$assignment == "emitter",], 
       aes(y = reorder(sigmol, species_pos), fill = detection))+
  geom_bar()+
  facet_grid(cols = vars(species))+
  scale_fill_manual(values = c(col_spc, "TRUE" = "orange"))+
  ylab("Preserved ligands")+
  xlab("Nr of cell types")
```

```{r fig.height = 15, fig.width = 6}
ggplot(large_df_upset_shr[large_df_upset_shr$assignment == "receiver",], 
       aes(y = reorder(sigmol, species_pos), fill = detection))+
  geom_bar()+
  facet_grid(cols = vars(species))+
  scale_fill_manual(values = c(col_spc, "TRUE" = "orange"))+
  ylab("Preserved receptors")+
  xlab("Nr of cell types")
```

```{r fig.height = 40, fig.width = 6}

large_df_upset$species <- factor(large_df_upset$species,
                                     levels = names(col_spc))

large_df_upset$detection <- vector(length = nrow(large_df_upset))
large_df_upset$detection[
  which(large_df_upset$mmus == "TRUE" &
          large_df_upset$mcas == "TRUE" &
          large_df_upset$mspr == "TRUE" &
          large_df_upset$mcar == "TRUE")] <- TRUE 

large_df_upset$detection[
  large_df_upset$detection == "FALSE"] <- unfactor(large_df_upset$species[
    large_df_upset$detection == "FALSE"])

large_df_upset$species_pos <- vector(length = nrow(large_df_upset))
large_df_upset$species_pos[large_df_upset$species == "mmus"] <- 4
large_df_upset$species_pos[large_df_upset$species == "mcas"] <- 3
large_df_upset$species_pos[large_df_upset$species == "mspr"] <- 2
large_df_upset$species_pos[large_df_upset$species == "mcar"] <- 1
large_df_upset$species_pos[large_df_upset$detection == "TRUE"] <- 5


ggplot(large_df_upset, 
       aes(y = reorder(sigmol, species_pos), fill = mode))+
  geom_bar()+
  facet_grid(cols = vars(species))+
  ylab("Ligand/Receptor genes")+
  scale_fill_manual(values = col_mode)+
  xlab("Nr of cell types")
```
# QC Plots

## Overlaps

```{r fig.width = 10, fig.height = 12}
ggplot(nr_df_all, aes(y = cell_type_rev, x = nr, fill = mode))+
  geom_col(position = "stack")+
  theme_classic()+
  facet_grid(cols = vars(mode_rev), rows = vars(species))+
  scale_fill_manual("Detection", values = col_mode)+
  xlab("Nr of detected ligand/receptor genes per cell type")+
  theme(axis.text.x = element_text(angle = 90))+
  ylab("Cell type")

ggplot(nr_df_all, aes(y = cell_type_rev, x = proportion, fill = mode))+
  geom_col(position = "stack")+
  theme_classic()+
  facet_grid(cols = vars(mode_rev), rows = vars(species))+
  scale_fill_manual("Detection", values = col_mode)+
  xlab("Nr of detected ligand/receptor genes per cell type")+
  theme(axis.text.x = element_text(angle = 90))+
  ylab("Cell type")
```

```{r}
ggplot(nr_df_all, aes(y= cell_type_rev, x = nr, color = mode))+
  geom_boxplot()+
  theme_classic()+
  facet_grid(cols = vars(mode_rev))+
  scale_color_manual("Detection", values = col_mode)+
  xlab("Nr of detected ligand/receptor genes per cell type")+
  theme(axis.text.x = element_text(angle = 90))+
  ylab("Cell type")
```

```{r}
ggplot(nr_df_all, aes(y = species_rev, x = proportion, color = mode))+
  geom_boxplot()+
  xlab("Proportions of detected ligand/receptor genes per cell type")+
  theme_classic()+
  scale_color_manual("Detection", values = col_mode)+
  ylab("Species")

ggplot(nr_df_all, aes(y = species_rev, x = norm, color = mode))+
  geom_boxplot()+
  xlab("Normalized Nr of detected ligand/receptor genes per cell type")+
  theme_classic()+
  scale_color_manual("Detection", values = col_mode)+
  ylab("Species")
```

```{r}
ggplot(nr_df_all, aes(x = mode_rev, y = proportion, color = mode))+
  geom_boxplot()+
  ylab("Proportion of detected ligand/receptor genes per cell type")+
  theme_classic()+
  scale_color_manual("Detection", values = col_mode)+
  facet_grid(cols = vars(cell_type))+
  theme(axis.text.x = element_blank(),
        strip.text.x = element_text(angle = 90))+
  xlab("Detection")
```

```{r, fig.width = 10, fig.height = 12}
ggplot(nr_df_all, aes(y= species_rev, x = nr, fill = species))+
  geom_col(position = "dodge")+
  theme_classic()+
  facet_grid(rows = vars(cell_type),
             cols = vars(mode_rev))+
  scale_fill_manual("species", values = col_spc)+
  xlab("Nr of detected ligand/receptor genes per cell type")+
  theme(axis.text.x = element_text(angle = 90),
        strip.text.y = element_text(angle = 0))+
  ylab("Species")

ggplot(nr_df_all, aes(y= species_rev, x = proportion, fill = species))+
  geom_col(position = "dodge")+
  theme_classic()+
  facet_grid(rows = vars(cell_type),
             cols = vars(mode_rev))+
  scale_fill_manual("species", values = col_spc)+
  xlab("Proportion of detected ligand/receptor genes per cell type")+
  theme(axis.text.x = element_text(angle = 90),
        strip.text.y = element_text(angle = 0))+
  ylab("Species")
```

## Gene expression

```{r}
species_list <- as.list(species)
ggdf_list_list <- lapply(species_list, function(s){ 
  
  overlap <- overlap_lists[[s]]
  cts_all <- as.list(names(overlap))
  
  ggdf_list <- lapply(cts_all, function(ct){

    if(length(grep(0, overlap[[ct]]$nr_df$nr)) <= 1){
    
      gene_df_ct <- data.frame(
        sigmols = unique(c(overlap[[ct]]$preserved,
                           overlap[[ct]]$yng_only, 
                           overlap[[ct]]$old_only))
      )

      gene_df_ct$mode <- vector(length = nrow(gene_df_ct))
      gene_df_ct$mode[
        gene_df_ct$sigmols %in% overlap[[ct]]$preserved] <- "preserved"
      gene_df_ct$mode[
        gene_df_ct$sigmols %in% overlap[[ct]]$yng_only] <- "yng_only"
      gene_df_ct$mode[
        gene_df_ct$sigmols %in% overlap[[ct]]$old_only] <- "old_only"
      gene_df_ct$species <- rep(s, nrow(gene_df_ct))
      gene_df_ct$cell_type <- rep(ct, nrow(gene_df_ct))
    
      sce_old <- sce_list[[s]]$old
      sce_yng <- sce_list[[s]]$yng
      
      ds_old <- assays(sce_old)$downsampled
      ds_old <- ds_old[match(gene_df_ct$sigmols, rownames(ds_old)),]
      ds_old <- as.data.frame(as.matrix(ds_old))
      ds_old <- ds_old[,sce_old$Identity == ct]
      
      ds_yng <- assays(sce_yng)$downsampled
      ds_yng <- ds_yng[match(gene_df_ct$sigmols, rownames(ds_yng)),]
      ds_yng <- as.data.frame(as.matrix(ds_yng))
      ds_yng <- ds_yng[,sce_yng$Identity == ct]
      
      gene_df_ct$average_downsampled_old <- rowMeans(ds_old)
      gene_df_ct$average_downsampled_yng <- rowMeans(ds_yng)
      gene_df_ct$median_downsampled_old <- rowMedians(as.matrix(ds_old))
      gene_df_ct$median_downsampled_yng <- rowMedians(as.matrix(ds_yng))
      
      lc_old <- assays(sce_old)$logcounts
      lc_old <- lc_old[match(gene_df_ct$sigmols, rownames(lc_old)),]
      lc_old <- as.data.frame(as.matrix(lc_old))
      lc_old <- lc_old[,sce_old$Identity == ct]
    
      lc_yng <- assays(sce_yng)$logcounts
      lc_yng <- lc_yng[match(gene_df_ct$sigmols, rownames(lc_yng)),]
      lc_yng <- as.data.frame(as.matrix(lc_yng))
      lc_yng <- lc_yng[,sce_yng$Identity == ct]

      stopifnot(!identical(lc_yng, lc_old))
      stopifnot(!identical(ds_old, ds_yng))
      
      gene_df_ct$average_logcounts_old <- rowMeans(lc_old)
      gene_df_ct$average_logcounts_yng <- rowMeans(lc_yng)
      
      gene_df_ct$median_logcounts_old <- rowMedians(as.matrix(lc_old))
      gene_df_ct$median_logcounts_yng <- rowMedians(as.matrix(lc_yng))
      
      return(gene_df_ct)
    }
  })
  return(ggdf_list)
})

ggdf_large <- bind_rows(ggdf_list_list)
ggdf_large$mode2 <- ggdf_large$mode
ggdf_large$mode2[ggdf_large$mode2 == "yng_only"] <- "age_specific"
ggdf_large$mode2[ggdf_large$mode2 == "old_only"] <- "age_specific"
```

```{r}
ggdf_large$species <- factor(ggdf_large$species, levels = names(col_spc))
ggdf_large$age <- factor(ggdf_large$species, levels = names(col_age))
ggdf_large$cell_type <- factor(ggdf_large$cell_type, 
                               levels = c(names(col_cts_hsc), 
                                          names(col_cts_str)))
print(head(ggdf_large))
```

```{r}
ggplot(ggdf_large, aes(x = mode, y = average_downsampled_old, color = mode))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-0.01, 35))+
  scale_color_manual(values = col_mode)+
  ggtitle("Expression in old")

ggplot(ggdf_large, aes(x = mode, y = average_downsampled_yng, color = mode))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-0.01, 35))+
  scale_color_manual(values = col_mode)+
  ggtitle("Expression in young")

ggplot(ggdf_large, aes(x = mode, y = average_logcounts_old, color = mode))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-0.01, 7))+
  scale_color_manual(values = col_mode)+
  ggtitle("Expression in old")

ggplot(ggdf_large, aes(x = mode, y = average_logcounts_yng, color = mode))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-0.01, 7))+
  scale_color_manual(values = col_mode)+
  ggtitle("Expression in young")
```

```{r}
ggplot(ggdf_large, aes(x = mode, y = log(average_downsampled_old), 
                       color = mode))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-5,3.5))+
  scale_color_manual(values = col_mode)+
  ggtitle("Expression in old")

ggplot(ggdf_large, aes(x = mode, y = log(average_downsampled_yng), 
                       color = mode))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-5,3.5))+
  scale_color_manual(values = col_mode)+
  ggtitle("Expression in young")
```

```{r}
ggplot(ggdf_large, aes(x = mode2, y = average_downsampled_old,
                       color = mode2))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-0.01, 35))+
  scale_color_manual(values = c("preserved" = "orange",
                                "age_specific" = "dodgerblue3"))+
  ggtitle("Expression in old")

ggplot(ggdf_large, aes(x = mode2, y = average_downsampled_yng, color = mode2))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-0.01, 35))+
  scale_color_manual(values = c("preserved" = "orange",
                                "age_specific" = "dodgerblue3"))+
  ggtitle("Expression in young")

ggplot(ggdf_large, aes(x = mode2, y = average_logcounts_old, color = mode2))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-0.01, 7))+
  scale_color_manual(values = c("preserved" = "orange",
                                "age_specific" = "dodgerblue3"))+
  ggtitle("Expression in old")

ggplot(ggdf_large, aes(x = mode2, y = average_logcounts_yng, color = mode2))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-0.01, 7))+
  scale_color_manual(values = c("preserved" = "orange",
                                "age_specific" = "dodgerblue3"))+
  ggtitle("Expression in young")
```

```{r}
ggplot(ggdf_large, aes(x = mode2, y = log(average_downsampled_old),
                       color = mode2))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-5,3.5))+
  scale_color_manual(values = c("preserved" = "orange",
                                "age_specific" = "dodgerblue3"))+
  ggtitle("Expression in old")

ggplot(ggdf_large, aes(x = mode2, y = log(average_downsampled_yng),
                       color = mode2))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  #ylim(c(-5,3.5))+
  scale_color_manual(values = c("preserved" = "orange",
                                "age_specific" = "dodgerblue3"))+
  ggtitle("Expression in young")
```

```{r}
ggplot(ggdf_large, aes(x = mode, y = median_downsampled_old, color = mode))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  ggtitle("Expression in old")

ggplot(ggdf_large, aes(x = mode, y = median_downsampled_yng, color = mode))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  ggtitle("Expression in young")

ggplot(ggdf_large, aes(x = mode, y = median_logcounts_old, color = mode))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  ggtitle("Expression in old")

ggplot(ggdf_large, aes(x = mode, y = median_logcounts_yng, color = mode))+
  ggbeeswarm::geom_quasirandom(size = 0.6)+
  geom_boxplot(alpha = 0, color = "black")+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  ggtitle("Expression in young")
```

```{r}
ggdf_large_long <- pivot_longer(ggdf_large, 
                                cols = c("average_downsampled_old", 
                                         "average_downsampled_yng", 
                                         "average_logcounts_old",
                                         "average_logcounts_yng"), 
                                names_to = "expression")

ggdf_large_long$age <- vector(length = nrow(ggdf_large_long))
ggdf_large_long$age[grep("old", ggdf_large_long$expression)] <- "old"
ggdf_large_long$age[grep("yng", ggdf_large_long$expression)] <- "yng"

ggdf_large_long_lc <- ggdf_large_long[grep("logcounts",
                                           ggdf_large_long$expression),]
ggdf_large_long_ds <- ggdf_large_long[grep("downsampled",
                                           ggdf_large_long$expression),]

print(head(ggdf_large))
print(head(ggdf_large_long_lc))
#knitr::knit_exit()

print(head(ggdf_list_list[[1]][[2]]))

```

```{r}
ggplot(ggdf_large_long_lc, aes(x = age, y = value, color = mode))+
  geom_boxplot()+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(species))+
  ylab("average logcount expression")

ggplot(ggdf_large_long_ds, aes(x = age, y = value, color = mode))+
  geom_boxplot()+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(species))+
  ylab("average downsampled expression")
```

## Percentage of cells

Add showing percentage of cells that express said genes.

```{r}
# prepare perc_df
perc_list_long <- list()
for(s in species){
  for(a in age){
   
    perc_list[[s]][[a]]$species <- s
    perc_list[[s]][[a]]$age <- a
    
    perc_list[[s]][[a]] <- rownames_to_column(perc_list[[s]][[a]],
                                              var = "gene_ID")
    
    perc_list_long[["blob"]] <- perc_list[[s]][[a]]
    names(perc_list_long)[names(perc_list_long) == "blob"] <- paste0(s, "_", a)
  }
}

perc_df <- bind_rows(perc_list_long)
perc_df_long <- pivot_longer(
  perc_df,
  cols = which(colnames(perc_df) %in% c(names(col_cts_hsc), 
                                        names(col_cts_str))),
  names_to = "cell_type")
```

```{r}

ggdf_large_long_lc$identifier <- paste0(ggdf_large_long_lc$species, "_", 
                                        ggdf_large_long_lc$age, "_", 
                                        ggdf_large_long_lc$cell_type, "_",
                                        ggdf_large_long_lc$sigmols)
perc_df_long$identifier <- paste0(perc_df_long$species, "_", 
                                  perc_df_long$age, "_",
                                  perc_df_long$cell_type, "_",
                                  perc_df_long$gene_symbol)

table(duplicated(ggdf_large_long_lc$identifier))
table(duplicated(perc_df_long$identifier))

ggdf_large_long_lc$perc_expressed <- perc_df_long$value[
  match(ggdf_large_long_lc$identifier, perc_df_long$identifier)]
ggdf_large_long_lc$control <- perc_df_long$identifier[
  match(ggdf_large_long_lc$identifier, perc_df_long$identifier)]
```

```{r}

ggdf_large_long_ds$identifier <- paste0(ggdf_large_long_ds$species, "_",
                                        ggdf_large_long_ds$age, "_",
                                        ggdf_large_long_ds$cell_type, "_",
                                        ggdf_large_long_ds$sigmols)
perc_df_long$identifier <- paste0(perc_df_long$species, "_", 
                                  perc_df_long$age, "_", 
                                  perc_df_long$cell_type, "_", 
                                  perc_df_long$gene_symbol)

table(duplicated(ggdf_large_long_ds$identifier))
table(duplicated(perc_df_long$identifier))

ggdf_large_long_ds$perc_expressed <- perc_df_long$value[
  match(ggdf_large_long_ds$identifier, perc_df_long$identifier)]
ggdf_large_long_ds$control <- perc_df_long$identifier[
  match(ggdf_large_long_ds$identifier, perc_df_long$identifier)]
```

```{r}
ggplot(ggdf_large_long_lc, aes(x = age, y = perc_expressed, color = mode))+
  geom_boxplot()+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(species))+
  ylab("% of cells/cell type expressing a gene")+
  geom_hline(yintercept = 0.05, color = "dodgerblue3")
```

```{r}
ggplot(ggdf_large_long_ds, aes(x = age, y = perc_expressed, color = mode))+
  geom_boxplot()+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(species))+
  ylab("% of cells/cell type expressing a gene")+
  geom_hline(yintercept = 0.05, color = "dodgerblue3")
```

```{r}
ggdf_large_long_lc$mode <- factor(ggdf_large_long_lc$mode, 
                                  levels = c("preserved", "yng_only", "old_only"))
ggdf_large_long_lc_mmus <- ggdf_large_long_lc[
  ggdf_large_long_lc$species == "mmus",]
ggplot(ggdf_large_long_lc_mmus,
       aes(x = value, y = perc_expressed, color = mode))+
  geom_point(size = 0.3)+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(mode),
             rows = vars(age))+
  ylab("% of cells/cell type expressing a gene")+
  xlab("average logcounts/cell type")+
  geom_hline(yintercept = 0.05, color = "dodgerblue3")+
  ggtitle("mmus")+
  ylim(c(0, 1))+
  xlim(c(0, 9))

ggdf_large_long_lc_mcas <- ggdf_large_long_lc[
  ggdf_large_long_lc$species == "mcas",]
ggplot(ggdf_large_long_lc_mcas,
       aes(x = value, y = perc_expressed, color = mode))+
  geom_point(size = 0.3)+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(mode),
             rows = vars(age))+
  ylab("% of cells/cell type expressing a gene")+
  xlab("average logcounts/cell type")+
  geom_hline(yintercept = 0.05, color = "dodgerblue3")+
  ggtitle("mcas")+
  ylim(c(0, 1))+
  xlim(c(0, 9))

ggdf_large_long_lc_mspr <- ggdf_large_long_lc[
  ggdf_large_long_lc$species == "mspr",]
ggplot(ggdf_large_long_lc_mspr,
       aes(x = value, y = perc_expressed, color = mode))+
  geom_point(size = 0.3)+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(mode),
             rows = vars(age))+
  ylab("% of cells/cell type expressing a gene")+
  xlab("average logcounts/cell type")+
  geom_hline(yintercept = 0.05, color = "dodgerblue3")+
  ggtitle("mspr")+
  ylim(c(0, 1))+
  xlim(c(0, 9))

ggdf_large_long_lc_mcar <- ggdf_large_long_lc[
  ggdf_large_long_lc$species == "mcar",]
ggplot(ggdf_large_long_lc_mcar, 
       aes(x = value, y = perc_expressed, color = mode))+
  geom_point(size = 0.3)+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(mode),
             rows = vars(age))+
  ylab("% of cells/cell type expressing a gene")+
  xlab("average logcounts/cell type")+
  geom_hline(yintercept = 0.05, color = "dodgerblue3")+
  ggtitle("mcar")+
  ylim(c(0, 1))+
  xlim(c(0, 9))

```

```{r}
ggdf_large_long_ds$mode <- factor(ggdf_large_long_ds$mode, 
                                  levels = c("preserved", "yng_only", "old_only"))
ggdf_large_long_ds_mmus <- ggdf_large_long_ds[
  ggdf_large_long_ds$species == "mmus",]
ggplot(ggdf_large_long_ds_mmus, 
       aes(x = value, y = perc_expressed, color = mode))+
  geom_point(size = 0.3)+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(mode),
             rows = vars(age))+
  ylab("% of cells/cell type expressing a gene")+
  xlab("average downsampled counts/cell type")+
  geom_hline(yintercept = 0.05, color = "dodgerblue3")+
  ggtitle("mmus")
  
ggdf_large_long_ds_mcas <- ggdf_large_long_ds[
  ggdf_large_long_ds$species == "mcas",]
ggplot(ggdf_large_long_ds_mcas,
       aes(x = value, y = perc_expressed, color = mode))+
  geom_point(size = 0.3)+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(mode),
             rows = vars(age))+
  ylab("% of cells/cell type expressing a gene")+
  xlab("average downsampled counts/cell type")+
  geom_hline(yintercept = 0.05, color = "dodgerblue3")+
  ggtitle("mcas")

ggdf_large_long_ds_mspr <- ggdf_large_long_ds[
  ggdf_large_long_ds$species == "mspr",]
ggplot(ggdf_large_long_ds_mspr,
       aes(x = value, y = perc_expressed, color = mode))+
  geom_point(size = 0.3)+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(mode),
             rows = vars(age))+
  ylab("% of cells/cell type expressing a gene")+
  xlab("average downsampled counts/cell type")+
  geom_hline(yintercept = 0.05, color = "dodgerblue3")+
  ggtitle("mspr")

ggdf_large_long_ds_mcar <- ggdf_large_long_ds[
  ggdf_large_long_ds$species == "mcar",]
ggplot(ggdf_large_long_ds_mcar,
       aes(x = value, y = perc_expressed, color = mode))+
  geom_point(size = 0.3)+
  theme_classic()+
  scale_color_manual(values = col_mode)+
  facet_grid(cols = vars(mode),
             rows = vars(age))+
  ylab("% of cells/cell type expressing a gene")+
  xlab("average downsampled counts/cell type")+
  geom_hline(yintercept = 0.05, color = "dodgerblue3")+
  ggtitle("mcar")

ggdf_large_long_ds_mcar <- ggdf_large_long_ds_mcar[
  order(ggdf_large_long_ds_mcar$value, decreasing = TRUE),]
```

## Look at genes

### Conserved

```{r}
ggdf_cons <- pivot_wider(ggdf_large[,c(1, 2, 3, 4)], 
                         names_from = "species", values_from = "mode")
    
# there are NAs because not every gene is even detected in each species
ggdf_cons[is.na(ggdf_cons$sigmols),]
head(ggdf_cons[is.na(ggdf_cons$mmus),])
head(ggdf_cons[is.na(ggdf_cons$mcar),])
```

Genes that are preserved, old_only or yng_only in all species per cell type.
Genes in a cell type that are preserved in all four species are the "core" 
repertoire of that cell type. 
They are detected in all ages, and all species in that cell type.

```{r}

cts <- unique(c(names(col_cts_hsc), names(col_cts_str)))
ct_cons_gene_list <- lapply(as.list(cts), function(ct){
  
  ggdf_cons_ct <- ggdf_cons[ggdf_cons$cell_type == ct,]
  
  preserved_temp <- filter(ggdf_cons_ct, mmus == "preserved", mcar == "preserved",
                        mspr == "preserved", mcas == "preserved")
  old_temp <- filter(ggdf_cons_ct, mmus == "old_only", mcar == "old_only",
                     mspr == "old_only", mcas == "old_only")
  yng_temp <- filter(ggdf_cons_ct, mmus == "yng_only", mcar == "yng_only",
                     mspr == "yng_only", mcas == "yng_only")
    
  preserved_cons <- sort(preserved_temp$sigmols)
  old_cons <- sort(old_temp$sigmols)
  yng_cons <- sort(yng_temp$sigmols)
  
  return_list <- list("preserved_cons" = preserved_cons,
                      "old_cons" = old_cons,
                      "yng_cons" = yng_cons)
  return(return_list)
})
names(ct_cons_gene_list) <- cts
ct_cons_gene_list
```

Get the core set of fully preserved genes, that are detected in every HSC or STR
cell type in both ages.

```{r}
full_preserved_hsc <- ct_cons_gene_list$HSCs$preserved_cons
for(c in names(col_cts_hsc)){
 if(length(ct_cons_gene_list[[c]]$preserved_cons) > 0){
    print(c)
    print(ct_cons_gene_list[[c]]$preserved_cons %in% full_preserved_hsc)
     full_preserved_hsc <- intersect(ct_cons_gene_list[[c]]$preserved_cons, full_preserved_hsc)
  }
}
full_preserved_hsc

full_preserved_str <- ct_cons_gene_list$Osteo$preserved_cons
for(c in names(col_cts_str)){
 if(length(ct_cons_gene_list[[c]]$preserved_cons) > 0){
    print(c)
    print(ct_cons_gene_list[[c]]$preserved_cons %in% full_preserved_str)
     full_preserved_str <- intersect(ct_cons_gene_list[[c]]$preserved_cons, full_preserved_str)
  }
}
full_preserved_str
```

Get lists of all genes that are old_only per species, then get the overlap
between all species.

```{r}

mmus_old_only <- ggdf_cons[which(ggdf_cons$mmus == "old_only"),]$sigmols
mcas_old_only <- ggdf_cons[which(ggdf_cons$mcas == "old_only"),]$sigmols
mspr_old_only <- ggdf_cons[which(ggdf_cons$mspr == "old_only"),]$sigmols
mcar_old_only <- ggdf_cons[which(ggdf_cons$mcar == "old_only"),]$sigmols

sort(table(mmus_old_only), decreasing = TRUE)
sort(table(mcas_old_only), decreasing = TRUE)
sort(table(mspr_old_only), decreasing = TRUE)
sort(table(mcar_old_only), decreasing = TRUE)

old_multi <- intersect(mmus_old_only, 
                       intersect(mcas_old_only,
                                 intersect(mspr_old_only, mcar_old_only)))
sort(old_multi)

ggdf_cons[ggdf_cons$sigmols %in% old_multi,]
```

Same for young.

```{r}
mmus_yng_only <- ggdf_cons[which(ggdf_cons$mmus == "yng_only"),]$sigmols
mcas_yng_only <- ggdf_cons[which(ggdf_cons$mcas == "yng_only"),]$sigmols
mspr_yng_only <- ggdf_cons[which(ggdf_cons$mspr == "yng_only"),]$sigmols
mcar_yng_only <- ggdf_cons[which(ggdf_cons$mcar == "yng_only"),]$sigmols

sort(table(mmus_yng_only), decreasing = TRUE)
sort(table(mcas_yng_only), decreasing = TRUE)
sort(table(mspr_yng_only), decreasing = TRUE)
sort(table(mcar_yng_only), decreasing = TRUE)

yng_multi <- intersect(mmus_yng_only, 
                       intersect(mcas_yng_only,
                                 intersect(mspr_yng_only, mcar_yng_only)))
sort(yng_multi)

ggdf_cons[ggdf_cons$sigmols %in% yng_multi,]
```

Make another table to be able to find genes that are preserved in only two or
three species per cell type, to be less stringent.

```{r}
ggdf_cons$preserved_in <- vector(length = nrow(ggdf_cons), mode = "character")
ggdf_cons$old_only_in <- vector(length = nrow(ggdf_cons), mode = "character")
ggdf_cons$yng_only_in <- vector(length = nrow(ggdf_cons), mode = "character")

for(i in 1:nrow(ggdf_cons)){
  
  preserved_pos <- which(ggdf_cons[i,] == "preserved") 
  ggdf_cons[i,]$preserved_in <- paste(c(colnames(ggdf_cons)[preserved_pos]),
                                   collapse = "_")
  
  old_only_pos <- which(ggdf_cons[i,] == "old_only") 
  ggdf_cons[i,]$old_only_in <- paste(c(colnames(ggdf_cons)[old_only_pos]), 
                                     collapse = "_")
  
  yng_only_pos <- which(ggdf_cons[i,] == "yng_only") 
  ggdf_cons[i,]$yng_only_in <- paste(c(colnames(ggdf_cons)[yng_only_pos]), 
                                     collapse = "_")
  
}  
ggdf_cons

ggdf_opart <- ggdf_cons[which(grepl( "_", ggdf_cons$old_only_in) & ggdf_cons$yng_only_in == ""),]
sort(table(ggdf_opart$sigmols), decreasing = TRUE)

genes_old_three_species <- unique(c(ggdf_opart[grep("_mcas_", ggdf_opart$old_only_in),]$sigmols,
                                    ggdf_opart[grep("_mspr_", ggdf_opart$old_only_in),]$sigmols))
ct_old_three_species <- unique(c(unfactor(ggdf_opart[grep("_mcas_", ggdf_opart$old_only_in),]$cell_type),
                                    unfactor(ggdf_opart[grep("_mspr_", ggdf_opart$old_only_in),]$cell_type)))
sort(genes_old_three_species)
ct_old_three_species
```

```{r}
ggdf_ypart <- ggdf_cons[which(grepl( "_", ggdf_cons$yng_only_in) & ggdf_cons$old_only_in == ""),]
sort(table(ggdf_ypart$sigmols), decreasing = TRUE)

genes_yng_three_species <- unique(c(ggdf_ypart[grep("_mcas_", ggdf_ypart$old_only_in),]$sigmols,
                                    ggdf_ypart[grep("_mspr_", ggdf_ypart$old_only_in),]$sigmols))
ct_yng_three_species <- unique(c(unfactor(ggdf_ypart[grep("_mcas_", ggdf_ypart$old_only_in),]$cell_type),
                                    unfactor(ggdf_ypart[grep("_mspr_", ggdf_ypart$old_only_in),]$cell_type)))
sort(genes_yng_three_species)
ct_yng_three_species
```

```{r}
sessionInfo()
```