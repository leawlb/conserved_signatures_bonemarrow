---
title: "Figure 1"
date: '2024-08-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Generate Figure 1, current title:
"Single-cell RNA-seq is able to identify expected bone marrow cell types".

#### Load objects

```{r seed, message = FALSE}
set.seed(37)
base::RNGkind(kind = "L'Ecuyer-CMRG")
```

```{r load, message = FALSE}
library(tidyverse, quietly = TRUE)
library(SingleCellExperiment, quietly = TRUE)
library(ggpubr, quietly = TRUE)
library(scuttle, quietly = TRUE)
```

```{r load_manual, eval = FALSE, include = FALSE}

# load data for manual use here

base_path <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data/"

sce_hsc <- base::readRDS(base::paste0(
  base_path, 
  "/scRNAseq/main_analysis/sce_objects/02_sce_anno/10_anns/sce_hsc-10"))
sce_str <- base::readRDS(base::paste0(
  base_path, 
  "/scRNAseq/main_analysis/sce_objects/02_sce_anno/10_anns/sce_str-10"))

colors_path <- base::paste0(
  base_path, 
  "/metadata/colors/colors.txt")

source("../source/colors.R")

gene_list_dtplt <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data/metadata/scRNAseq/02_sce_anno/gene_list_dotplot.txt"

gene_df <- utils::read.csv(gene_list_dtplt, 
  header = TRUE, 
  sep = ";", 
  check.names=FALSE, 
  stringsAsFactors=FALSE, 
  as.is=TRUE, 
  colClasses = "character")

```

```{r load_snakemake}

# annotated SCE objects
sce_input_list_path <- snakemake@input[["sce_input_list"]] 
sce_hsc <- base::readRDS(sce_input_list_path[[
  base::grep("hsc", sce_input_list_path)]])
sce_str <- base::readRDS(sce_input_list_path[[
  base::grep("str", sce_input_list_path)]])

# gene list for dotplot 
gene_list_dtplt <- snakemake@input[["gene_list_dtplt"]] 

gene_df <- utils::read.csv(gene_list_dtplt, 
  header = TRUE, 
  sep = ";", 
  check.names=FALSE, 
  stringsAsFactors=FALSE, 
  as.is=TRUE, 
  colClasses = "character")

# colors
colors_path <- snakemake@params[["colors_path"]]
colors_source <- snakemake@params[["colors"]]
source(colors_source)

print(sce_input_list_path)
print(colors_path)
print(colors_source)

#knitr::knit_exit()
```

```{r colors}


```

```{r params}
# determine params that may be changed 

umap_point_size <- 0.3
umap_point_alpha <- 1
umap_legend_point_size <- 3
umap_legend_point_alpha <- 1

legend_title_face <- "plain"
legend_title_size <- 16
legend_title_color <- "black"

legend_text_face <- "plain"
legend_text_size <- 14
legend_text_color <- "black"

ct_hsc <- "HSCs"
ct_str <- "Adipo/CARs"

axis_title_face <- "plain"
axis_title_size <- 16
axis_title_color <- "black"

axis_text_face <- "plain"
axis_text_size <- 14
axus_text_color <- "black"
axis_text_size_small <- 10

max_size_dotplots <- 4
```

## A

A: Model of experimental design. HSPCs were extracted by flushing and Niche 
cells were extracted by crushing and digesting the bone followed by FACS 
sorting and sequencing.

## B

HSPCs (left) and Niche cells (right) clustered in UMAP space, 
colored by cell type.

#### Plot Components

```{r b_prep}
hsc_umap <- base::as.data.frame(
  SingleCellExperiment::reducedDim(
    sce_hsc, type = "UMAP"))
hsc_umap$color_by <- sce_hsc$celltypes
hsc_umap <- hsc_umap[base::sample(
  1:nrow(hsc_umap),
  nrow(hsc_umap),
  replace = FALSE),]

str_umap <- base::as.data.frame(
  SingleCellExperiment::reducedDim(
    sce_str, type = "UMAP"))
str_umap$color_by <- sce_str$celltypes
str_umap <- str_umap[base::sample(
  1:nrow(str_umap),
  nrow(str_umap),
  replace = FALSE),]
```

```{r b_base_plot_left}
b_base_plot_left <- ggplot2::ggplot(
  hsc_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_point_size,
    alpha = umap_point_alpha)+
  ggplot2::xlim(c(base::min(hsc_umap$X1)-1, base::max(hsc_umap$X1))+1)+
  ggplot2::ylim(c(base::min(hsc_umap$X2)-1, base::max(hsc_umap$X2))+1)+
  ggplot2::scale_color_manual("Cell type", values = col_cts_hsc)
```

```{r b_base_plot_left_theme}
b_theme_plot_left <- b_base_plot_left+
  cowplot::theme_nothing()
```

```{r b_base_plot_right}
b_base_plot_right <- ggplot2::ggplot(
  str_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_point_size,
    alpha = umap_point_alpha)+
  ggplot2::xlim(c(base::min(str_umap$X1)-1, base::max(str_umap$X1))+1)+
  ggplot2::ylim(c(base::min(str_umap$X2)-1, base::max(str_umap$X2))+1)+
  ggplot2::scale_color_manual("Cell type", values = col_cts_str)
```

```{r b_base_plot_right_theme}
b_theme_plot_right <- b_base_plot_right+
  cowplot::theme_nothing()
```

#### Legend

```{r b_legend_plot_left}
b_legend_plot_left <- ggplot2::ggplot(
  hsc_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_legend_point_size,
    alpha = umap_legend_point_alpha)+
  ggplot2::scale_color_manual("Cell type", values = col_cts_hsc)
```

```{r b_legend_plot_right}
b_legend_plot_right <- ggplot2::ggplot(
  str_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_legend_point_size,
    alpha = umap_legend_point_alpha)+
  ggplot2::scale_color_manual("Cell type", values = col_cts_str)
```

```{r b_legend_plot_left_theme}
b_legend_theme_plot_left <- b_legend_plot_left+
  ggplot2::theme_minimal()+
  ggplot2::theme(
    legend.title = element_blank(),
    legend.text = element_text(
      face = legend_text_face,
      size = legend_text_size,
      color = legend_text_color),
    legend.key.height = unit(0.3, "lines")
  )
b_legend_left <- ggpubr::get_legend(b_legend_theme_plot_left)
```

```{r b_legend_plot_right_theme}
b_legend_theme_plot_right <- b_legend_plot_right+
  ggplot2::theme_minimal()+
  ggplot2::theme(
    legend.title = element_blank(),
    legend.text = element_text(
      face = legend_text_face,
      size = legend_text_size,
      color = legend_text_color),
    legend.key.height = unit(0.3, "lines")
  )
b_legend_right <- ggpubr::get_legend(b_legend_theme_plot_right)
```

#### Construct

```{r b_theme_plot, fig.width = 14, fig.height = 6}
b_theme_plot <- ggpubr::ggarrange(
  b_theme_plot_left, 
  b_theme_plot_right)

b_theme_plot
```

```{r b_theme_legend, fig.height = 6, fig.width = 4}
b_theme_legend <- ggpubr::ggarrange(
  ncol = 1,
  align = "v",
  b_legend_left,
  b_legend_right)

b_theme_legend
```

## C

HSPCs (left) and Niche cells (right) clustered in UMAP space, 
colored by mouse species

#### Plot Components

```{r c_prep}
# TODO: change Species_ID once abbreviation for species was decided and 
# use that
hsc_umap <- base::as.data.frame(
  SingleCellExperiment::reducedDim(
    sce_hsc, type = "UMAP"))
hsc_umap$color_by <- sce_hsc$Species_ID 
hsc_umap <- hsc_umap[base::sample(
  1:nrow(hsc_umap),
  nrow(hsc_umap),
  replace = FALSE),]
hsc_umap$color_by <- factor(
  hsc_umap$color_by,
  levels = names(col_spc)
)

str_umap <- base::as.data.frame(
  SingleCellExperiment::reducedDim(
    sce_str, type = "UMAP"))
str_umap$color_by <- sce_str$Species_ID
str_umap <- str_umap[base::sample(
  1:nrow(str_umap),
  nrow(str_umap),
  replace = FALSE),]
str_umap$color_by <- factor(
  str_umap$color_by,
  levels = names(col_spc)
)
```

```{r c_base_plot_left}
c_base_plot_left <- ggplot2::ggplot(
  hsc_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_point_size,
    alpha = umap_point_alpha)+
  ggplot2::xlim(c(base::min(hsc_umap$X1)-1, base::max(hsc_umap$X1))+1)+
  ggplot2::ylim(c(base::min(hsc_umap$X2)-1, base::max(hsc_umap$X2))+1)+
  ggplot2::scale_color_manual("Mouse species", values = col_spc)
```

```{r c_theme_plot_left}
c_theme_plot_left <- c_base_plot_left+
  cowplot::theme_nothing()
```

```{r c_base_plot_right}
c_base_plot_right <- ggplot2::ggplot(
  str_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_point_size,
    alpha = umap_point_alpha)+
  ggplot2::xlim(c(base::min(str_umap$X1)-1, base::max(str_umap$X1))+1)+
  ggplot2::ylim(c(base::min(str_umap$X2)-1, base::max(str_umap$X2))+1)+
  ggplot2::scale_color_manual("Mouse species", values = col_spc)
```

```{r c_theme_plot_right}
c_theme_plot_right <- c_base_plot_right+
  cowplot::theme_nothing()
```

#### Legend

only one required

```{r c_legend_plot}
c_legend_plot <- ggplot2::ggplot(
  hsc_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_legend_point_size,
    alpha = umap_legend_point_alpha)+
  ggplot2::scale_color_manual("Mouse species", values = col_spc)
```

```{r c_legend_theme_plot}
c_legend_theme_plot <- c_legend_plot+
  ggplot2::theme_minimal()+
  ggplot2::theme(
    legend.title = element_blank(),
    legend.text = element_text(
      face = legend_text_face,
      size = legend_text_size,
      color = legend_text_color),
    legend.key.height = unit(0.3, "lines")
  )
c_legend <- ggpubr::get_legend(c_legend_theme_plot)
```

#### Construct

```{r c_theme_plot, fig.width = 7, fig.height = 3}
c_theme_plot <- ggpubr::ggarrange(
  c_theme_plot_left, 
  c_theme_plot_right)

c_theme_plot
```

```{r c_theme_legend, fig.height = 2, fig.width = 2}
c_theme_legend <- ggpubr::ggarrange(
  ncol = 1,
  align = "v",
  c_legend)

c_theme_legend
```

## D

Average gene expression of well-known marker genes that were not used for
cell type sub-clustering per species for HSCs (top left) and Adipo/CARs 
(top right) or per cell type for HSPC fraction (bottom left) or Niche fraction 
(bottom right).

#### Prepare

```{r d_prepare}
# get genes
gene_df_hsc <- gene_df[gene_df$fraction == "hsc",]
genes_hsc <- gene_df_hsc$gene

gene_df_str <- gene_df[which(gene_df$fraction == "str" & 
                               gene_df$use == "short"),]
genes_str <- gene_df_str$gene

# agrgegate across cell types, get average expression, use normalized counts
agg_hsc <- scuttle::aggregateAcrossCells(
  sce_hsc, 
  id=colData(sce_hsc)[,c("celltypes")], 
  statistics = "mean",
  use.assay.type = "logcounts")

agg_str <- scuttle::aggregateAcrossCells(
  sce_str, 
  id=colData(sce_str)[,c("celltypes")], 
  statistics = "mean",
  use.assay.type = "logcounts")

# make data frames for visualisation
vis_df_hsc <- base::as.data.frame(
  t(SummarizedExperiment::assays(agg_hsc)$logcounts[
    rownames(SummarizedExperiment::assays(agg_hsc)$logcounts) %in% genes_hsc,]))

vis_df_str <- base::as.data.frame(
  t(SummarizedExperiment::assays(agg_str)$logcounts[
    rownames(SummarizedExperiment::assays(agg_str)$logcounts) %in% genes_str,]))

# format data frames
vis_df_hsc <- tibble::rownames_to_column(vis_df_hsc, "celltypes")
vis_df_hsc <- tidyr::pivot_longer(
  vis_df_hsc, 
  cols = c(2:ncol(vis_df_hsc)), 
  values_to = "expression", 
  names_to = "gene")

vis_df_str <- tibble::rownames_to_column(vis_df_str, "celltypes")
vis_df_str <- tidyr::pivot_longer(
  vis_df_str, 
  cols = c(2:ncol(vis_df_str)), 
  values_to = "expression", 
  names_to = "gene")

# factor cell types for correct order
vis_df_hsc$celltypes <- factor(
  vis_df_hsc$celltypes, 
  levels = base::rev(names(col_cts_hsc)))

vis_df_str$celltypes <- factor(
  vis_df_str$celltypes, 
  levels = base::rev(names(col_cts_str)))

# factor genes for correct order
vis_df_hsc$gene <- factor(
  vis_df_hsc$gene, 
  levels = gene_df_hsc$gene)

vis_df_str$gene <- factor(
  vis_df_str$gene, 
  levels = gene_df_str$gene)
```

```{r d_function}
get_perc_expressed <- function(vis_df, sce){
  
  vis_df <- vis_df
  sce <- sce
  
  vis_df$percent_expressed <- vector(length = nrow(vis_df))
  
  cts <- base::unique(vis_df$celltypes)
  gs <- base::unique(vis_df$gene)
  
  for(ct in cts){
    
    # normalized (MultiBatchNorm)
    lc_temp <- SummarizedExperiment::assays(sce)$logcounts[,sce$celltypes == ct]
    
    for(g in gs){
      
      # the number of cells expressing g > 0 times / absolute cells * 100 per ct
      perc_expr <- length(which(lc_temp[
        rownames(lc_temp) == g,] > 0))/ncol(lc_temp)*100
      
      vis_df$percent_expressed[
        which(vis_df$celltypes == ct & vis_df$gene == g)] <- perc_expr
    }
  }
  return(vis_df)
}

vis_df_hsc <- get_perc_expressed(vis_df_hsc, sce_hsc)
vis_df_str <- get_perc_expressed(vis_df_str, sce_str)
```

```{r d_prepare_ct}
# aggregate
sce_hsc_ct <- sce_hsc[,sce_hsc$celltypes == ct_hsc]
agg_ct_hsc <- scuttle::aggregateAcrossCells(
  sce_hsc_ct,
  id=colData(sce_hsc_ct)[,c("Species_ID")], 
  statistics = "mean",
  use.assay.type = "logcounts")

sce_str_ct <- sce_str[,sce_str$celltypes == ct_str]
agg_ct_str <- scuttle::aggregateAcrossCells(
  sce_str_ct,
  id=colData(sce_str_ct)[,c("Species_ID")], 
  statistics = "mean",
  use.assay.type = "logcounts")

# make vis_dfs
vis_df_ct_hsc <- base::as.data.frame(
  t(SummarizedExperiment::assays(agg_ct_hsc)$logcounts[
    rownames(SummarizedExperiment::assays(agg_ct_hsc)$logcounts) %in% 
      genes_hsc,]))

vis_df_ct_str <- base::as.data.frame(
  t(SummarizedExperiment::assays(agg_ct_str)$logcounts[
    rownames(SummarizedExperiment::assays(agg_ct_str)$logcounts) %in% 
      genes_str,]))

# format
vis_df_ct_hsc <- tibble::rownames_to_column(vis_df_ct_hsc, "species")
vis_df_ct_hsc <- tidyr::pivot_longer(
  vis_df_ct_hsc,
  cols = c(2:ncol(vis_df_ct_hsc)), 
  values_to = "expression", 
  names_to = "gene")

vis_df_ct_str <- tibble::rownames_to_column(vis_df_ct_str, "species")
vis_df_ct_str <- tidyr::pivot_longer(
  vis_df_ct_str,
  cols = c(2:ncol(vis_df_ct_str)), 
  values_to = "expression", 
  names_to = "gene")

vis_df_ct_hsc$celltypes <- base::rep(ct_hsc, nrow(vis_df_ct_hsc))
vis_df_ct_str$celltypes <- base::rep(ct_str, nrow(vis_df_ct_str))

# factor
vis_df_ct_hsc$species <- factor(vis_df_ct_hsc$species, 
                                levels = base::rev(names(col_spc)))
vis_df_ct_hsc$gene <- factor(vis_df_ct_hsc$gene,
                             levels = gene_df_hsc$gene)

vis_df_ct_str$species <- factor(vis_df_ct_str$species, 
                              levels = base::rev(names(col_spc)))
vis_df_ct_str$gene <- factor(vis_df_ct_str$gene,
                             levels = gene_df_str$gene)

# perc expressed
vis_df_ct_hsc <- get_perc_expressed(vis_df_ct_hsc, sce_hsc)
vis_df_ct_str <- get_perc_expressed(vis_df_ct_str, sce_str)
```

#### Plots

```{r d_base_plot_top_left}

# make background grid
background_hsc <- data.frame(
  xmin = c(
    1,
    9,
    11,
    15,
    16,
    18,
    22,
    25,
    30,
    32,
    39),  # start of each segment (character values)
  xmax = c(
    8,
    10,
    14,
    15,
    17,
    21,
    24,
    29,
    31,
    38,
    41
  ),  # end of each segment (character values)
  ymin = -Inf,              # covers full height
  ymax = Inf,
  fill = c(
    "white",
    rep(c("grey80", "white"),  5))  # alternating colors
)

d_base_plot_top_left <- ggplot2::ggplot(
  vis_df_ct_hsc, 
  aes(x = gene,
      y = species,
      color = percent_expressed,
      size = expression))+
  ggplot2::geom_rect(
    data = background_hsc, 
    aes(xmin = xmin - 0.5,
        xmax = xmax + 0.5, 
        ymin = ymin,
        ymax = ymax),
    fill = background_hsc$fill,
    inherit.aes = FALSE, 
    alpha = 0.2)+
  ggplot2::geom_point()
```

```{r d_theme_plot_top_left}
d_theme_plot_top_left <- d_base_plot_top_left+
  ggplot2::theme_classic()+
  ggplot2::scale_x_discrete(position = "top")+
  ggplot2::theme(
    axis.title.y = element_text(
      face = axis_title_face,
      size = axis_title_size,
      color = axis_title_color),
    axis.title.x = element_text(
      face = axis_title_face,
      size = axis_title_size,
      color = axis_title_color),
    axis.text.x.top = element_text(
      hjust = 0,
      vjust = 0.5,
      face = axis_text_face,
      size = axis_text_size_small,
      color = axus_text_color,
      angle = 90),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axus_text_color),
    legend.position = "none")+
  ggplot2::ylab("Species")+
  ggplot2::xlab("Gene")+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_hsc$expression)))+
  ggplot2::scale_colour_gradientn(
     "% expressed",
     colors = mycolors_to100,
     limits = c(0, 100))
```

```{r d_base_plot_top_right}
# make background grid
background_str <- data.frame(
  xmin = c(
    1,
    4,
    7,
    12,
    16,
    18,
    21,
    24,
    30,
    34,
    38
    ),  # start of each segment (character values)
  xmax = c(
    3,
    6,
    11,
    15,
    17,
    20,
    23,
    29,
    33,
    37,
    42
  ),  # end of each segment (character values)
  ymin = -Inf,              # covers full height
  ymax = Inf,
  fill = c(
    "white",
    rep(c("grey80", "white"),  5))  # alternating colors
)

d_base_plot_top_right <- ggplot2::ggplot(
  vis_df_ct_str, 
  aes(x = gene,
      y = species,
      color = percent_expressed,
      size = expression))+
  ggplot2::geom_rect(
    data = background_str, 
    aes(xmin = xmin - 0.5,
        xmax = xmax + 0.5, 
        ymin = ymin,
        ymax = ymax),
    fill = background_str$fill,
    inherit.aes = FALSE, 
    alpha = 0.2)+
  ggplot2::scale_x_discrete(position = "top")+
  ggplot2::geom_point()
```

```{r d_theme_plot_top_right}
d_theme_plot_top_right <- d_base_plot_top_right+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_blank(),
    axis.title.x = element_text(
      face = axis_title_face,
      size = axis_title_size,
      color = axis_title_color),
    axis.text.x.top = element_text(
      hjust = 0,
      vjust = 0.5,
      face = axis_text_face,
      size = axis_text_size_small,
      color = axus_text_color,
      angle = 90),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axus_text_color),
    legend.position = "none")+
  ggplot2::xlab("Gene")+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_ct_str$expression)))+
  ggplot2::scale_colour_gradientn(
     "% expressed",
     colors = mycolors_to100,
     limits = c(0, 100)
  )
```

```{r d_base_plot_bottom_left}
d_base_plot_bottom_left <- ggplot2::ggplot(
  vis_df_hsc, 
  aes(x = gene,
      y = celltypes,
      color = percent_expressed,
      size = expression))+
  ggplot2::geom_rect(
    data = background_hsc, 
    aes(xmin = xmin - 0.5,
        xmax = xmax + 0.5, 
        ymin = ymin,
        ymax = ymax),
    fill = background_hsc$fill,
    inherit.aes = FALSE, 
    alpha = 0.2)+
  ggplot2::geom_point()
```

```{r d_theme_plot_bottom_left}
d_theme_plot_bottom_left <- d_base_plot_bottom_left+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_text(
      face = axis_title_face,
      size = axis_title_size,
      color = axis_title_color),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axus_text_color),
    legend.position = "none")+
  ggplot2::ylab("Cell type")+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_hsc$expression)))+
  ggplot2::scale_colour_gradientn(
     "% expressed",
     colors = mycolors_to100,
     limits = c(0, 100)
  )
```

```{r d_base_plot_bottom_right}
d_base_plot_bottom_right <- ggplot2::ggplot(
  vis_df_str, 
  aes(x = gene,
      y = celltypes,
      color = percent_expressed,
      size = expression))+
  ggplot2::geom_rect(
    data = background_str, 
    aes(xmin = xmin - 0.5,
        xmax = xmax + 0.5, 
        ymin = ymin,
        ymax = ymax),
    fill = background_str$fill,
    inherit.aes = FALSE, 
    alpha = 0.2)+
  ggplot2::geom_point()
```

```{r d_theme_plot_bottom_right}
d_theme_plot_bottom_right <- d_base_plot_bottom_right+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axus_text_color),
    legend.position = "none")+
  ggplot2::ylab("Cell type")+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_ct_str$expression)))+
  ggplot2::scale_colour_gradientn(
     "% expressed",
     colors = mycolors_to100,
     limits = c(0, 100)
  )
```

#### Legends

Since logcounts have different upper limits in HSPCs vs Niche, need two.

```{r d_legend_theme_plot_left}
d_legend_theme_plot_left <- d_base_plot_bottom_left+
  ggplot2::theme_classic()+
  ggplot2::theme(legend.title = element_text(
      face = legend_title_face,
      size = legend_title_size,
      color = legend_title_color),
      legend.title.position = "top",
      legend.text = element_text(
      face = legend_text_face,
      size = legend_text_size,
      color = legend_text_color),
      legend.box.just = "left",
      legend.position = "bottom",
      legend.box = "vertical", # Stack legends vertically
      legend.spacing.y = unit(0.5, 'cm'))+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_hsc$expression)))+
  ggplot2::scale_colour_gradientn(
     "% expressed",
      breaks = c(0, 50, 100),
      colors = mycolors_to100,
      limits = c(0, 100)
  )
d_legend_left <- ggpubr::get_legend(d_legend_theme_plot_left)
```

```{r d_legend_theme_plot_right}
d_legend_theme_plot_right <- d_base_plot_bottom_right+
  ggplot2::theme_classic()+
  ggplot2::theme(legend.title = element_text(
      face = legend_title_face,
      size = legend_title_size,
      color = legend_title_color),
      legend.title.position = "top",
      legend.text = element_text(
      face = legend_text_face,
      size = legend_text_size,
      color = legend_text_color),
      legend.box.just = "left",
      legend.position = "bottom",
      legend.box = "vertical", # Stack legends vertically
      legend.spacing.y = unit(0.5, 'cm'))+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_ct_str$expression)))+
  ggplot2::scale_colour_gradientn(
     "% expressed",
      breaks = c(0, 50, 100),
      colors = mycolors_to100,
      limits = c(0, 100)
  )
d_legend_right <- ggpubr::get_legend(d_legend_theme_plot_right)
```

#### Construct

```{r d_theme_plot, fig.width = 16, fig.height = 6}
d_theme_plot <- ggpubr::ggarrange(
  d_theme_plot_top_left, 
  d_theme_plot_top_right,
  d_theme_plot_bottom_left,
  d_theme_plot_bottom_right,
  heights = c(1,1.8),
  widths = c(1, 1.1),
  align = "v")

d_theme_plot
```

```{r d_theme_plot2, fig.width = 16, fig.height = 6}
d_theme_plot <- ggpubr::ggarrange(
  d_theme_plot_top_left + theme(plot.margin = margin(t = 5, r = 5, b = 20, l = 5)), 
  d_theme_plot_top_right + theme(plot.margin = margin(t = 5, r = 5, b = 20, l = 5)),
  d_theme_plot_bottom_left,
  d_theme_plot_bottom_right,
  heights = c(1,1.8),
  widths = c(1, 1.1))

d_theme_plot
```

```{r d_theme_legend_left, fig.width = 2, fig.height = 2}
d_theme_legend_left <- ggpubr::ggarrange(
  d_legend_left
  )

d_theme_legend_left
```

```{r d_theme_legend_right, fig.width = 2, fig.height = 2}
d_theme_legend_right <- ggpubr::ggarrange(
  d_legend_right
  )

d_theme_legend_right
```

```{r sessioninfo}
utils::sessionInfo()
```





