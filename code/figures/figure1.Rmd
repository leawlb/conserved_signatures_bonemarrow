---
title: "Figure 1"
date: '2024-08-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Generate Figure 1, current title:
""

#### Load objects

```{r seed, message = FALSE}
base::RNGkind(kind = "Mersenne-Twister")
set.seed(37)
```

```{r load, message = FALSE}
library(tidyverse, quietly = TRUE)
library(SingleCellExperiment, quietly = TRUE)
library(ggpubr, quietly = TRUE)
library(scuttle, quietly = TRUE)
```

```{r base_path}
base_path_input <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data/"
base_path_output_temp <- "/omics/odcf/analysis/OE0538_projects_temp/DO-0008/data_temp"
```

```{r base_path_snakemake, eval = FALSE, include = FALSE}
base_path_input <- snakemake@input[["base_path_input"]]
base_path_output_temp <- snakemake@params[["base_path_output_temp"]]
```

```{r load_manual}

# load data for manual use here

# fully annotated SCE objects
sce_hsc <- base::readRDS(base::paste0(
  base_path_input, 
  "/scRNAseq/main_analysis/sce_objects/02_sce_anno/10_anns/sce_hsc-10"))
sce_str <- base::readRDS(base::paste0(
  base_path_input, 
  "/scRNAseq/main_analysis/sce_objects/02_sce_anno/10_anns/sce_str-10"))

colors_path <- base::paste0(
  base_path_input, 
  "/metadata/colors/colors.txt")

source("../source/colors.R")

# gene list for dotplot 
gene_list_dtplt <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data/metadata/scRNAseq/02_sce_anno/gene_list_dotplot.txt"

gene_df <- utils::read.csv(gene_list_dtplt, 
  header = TRUE, 
  sep = ";", 
  check.names=FALSE, 
  stringsAsFactors=FALSE, 
  as.is=TRUE, 
  colClasses = "character")

# gene list for subclustering
gene_list_subclustering <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data/metadata/scRNAseq/02_sce_anno/gene_list_subclustering.txt"

subclustering_df <- utils::read.csv(gene_list_subclustering, 
  header = TRUE, 
  sep = ";", 
  check.names=FALSE, 
  stringsAsFactors=FALSE, 
  as.is=TRUE, 
  colClasses = "character")

```

```{r pdf_output}
# define output paths for pdf export
output_pdf_de <- base::paste0(
  base_path_output_temp,
  "/manuscript1/figures/figure1_de.pdf")
output_png_de <- base::paste0(
  base_path_output_temp,
  "/manuscript1/figures/figure1_de.png")

output_pdf_de_legend1 <- base::paste0(
  base_path_output_temp,
  "/manuscript1/figures/figure1_de_legend1.pdf")
output_pdf_de_legend2 <- base::paste0(
  base_path_output_temp,
  "/manuscript1/figures/figure1_de_legend2.pdf")

output_pdf_f <- base::paste0(
  base_path_output_temp,
  "/manuscript1/figures/figure1_f.pdf")
output_pdf_f_legend <- base::paste0(
  base_path_output_temp, 
  "/manuscript1/figures/figure1_f_legend.pdf")
```

```{r params}
# global params
source("determine_params.R")

# specific params
ct_hsc <- "HSCs"
ct_str <- "Adipo/CARs"
```

## Obtain data

Obtain data needed only for text, e.g. cell numbers.

```{r obtain_data}
# nr of cells
ncol(sce_hsc)
ncol(sce_str)

# median nr of UMIs per cell
# remove lots of unneccessary stuff to avoid overloading the environment
sce_hsc_met <- sce_hsc
sce_str_met <- sce_str
rowData(sce_hsc_met) <- rowData(sce_hsc_met)[,c(2, 3, 4)]
rowData(sce_str_met) <- rowData(sce_str_met)[,c(2, 3, 4)]

reducedDim(sce_hsc_met) <- NULL
reducedDim(sce_str_met) <- NULL

assays(sce_hsc_met) <- list(assays(sce_hsc_met)[["counts_before_BC"]])
names(assays(sce_hsc_met)) <- "counts_before_BC"
assays(sce_str_met) <- list(assays(sce_str_met)[["counts_before_BC"]])
names(assays(sce_str_met)) <- "counts_before_BC"

qc_df <- scuttle::perCellQCMetrics(cbind(sce_hsc_met, sce_str_met), assay.type = "counts_before_BC")
median(qc_df$sum)

rm(sce_hsc_met)
rm(sce_str_met)
gc()

# nr of subclustering genes, and which genes are subclustering genes
subclustering_df[subclustering_df$purpose == "subclustering",]

```


## A - C

A: Model of experimental design.
HSPCs were extracted by flushing and Niche 
cells were extracted by crushing and digesting the bone followed by FACS 
sorting and sequencing.

B: Species Evolutionary Tree

C: Cell type identification model

## D UMAPs integrated species

HSPCs (left) and Niche cells (right) clustered in UMAP space, 
colored by mouse species

#### Plot Components

```{r d_prep}
# change species names to currently used abbreviations
sce_hsc$species_pub <- vector(length = ncol(sce_hsc))
sce_hsc$species_pub[sce_hsc$Species_ID == "mmus"] <- "BL6"
sce_hsc$species_pub[sce_hsc$Species_ID == "mcas"] <- "CAST"
sce_hsc$species_pub[sce_hsc$Species_ID == "mspr"] <- "SPRETUS"
sce_hsc$species_pub[sce_hsc$Species_ID == "mcar"] <- "CAROLI"
sce_hsc$species_pub <- factor(sce_hsc$species_pub, 
                              levels = names(col_spc_pub))

sce_str$species_pub <- vector(length = ncol(sce_str))
sce_str$species_pub[sce_str$Species_ID == "mmus"] <- "BL6"
sce_str$species_pub[sce_str$Species_ID == "mcas"] <- "CAST"
sce_str$species_pub[sce_str$Species_ID == "mspr"] <- "SPRETUS"
sce_str$species_pub[sce_str$Species_ID == "mcar"] <- "CAROLI"
sce_str$species_pub <- factor(sce_str$species_pub, 
                              levels = names(col_spc_pub))

hsc_umap <- base::as.data.frame(
  SingleCellExperiment::reducedDim(
    sce_hsc, type = "UMAP"))
hsc_umap$color_by <- sce_hsc$species_pub 
hsc_umap <- hsc_umap[base::sample(
  1:nrow(hsc_umap),
  nrow(hsc_umap),
  replace = FALSE),]
hsc_umap$color_by <- factor(
  hsc_umap$color_by,
  levels = names(col_spc_pub)
)

str_umap <- base::as.data.frame(
  SingleCellExperiment::reducedDim(
    sce_str, type = "UMAP"))
str_umap$color_by <- sce_str$species_pub
str_umap <- str_umap[base::sample(
  1:nrow(str_umap),
  nrow(str_umap),
  replace = FALSE),]
str_umap$color_by <- factor(
  str_umap$color_by,
  levels = names(col_spc_pub)
)
```

```{r d_base_plot_left}
d_base_plot_left <- ggplot2::ggplot(
  hsc_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_point_size,
    alpha = umap_point_alpha)+
  ggplot2::xlim(c(base::min(hsc_umap$X1)-1, base::max(hsc_umap$X1))+1)+
  ggplot2::ylim(c(base::min(hsc_umap$X2)-1, base::max(hsc_umap$X2))+1)+
  ggplot2::scale_color_manual("Mouse species", values = col_spc_pub)
```

```{r d_theme_plot_left}
d_theme_plot_left <- d_base_plot_left+
  cowplot::theme_nothing()
```

```{r d_base_plot_right}
d_base_plot_right <- ggplot2::ggplot(
  str_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_point_size,
    alpha = umap_point_alpha)+
  ggplot2::xlim(c(base::min(str_umap$X1)-1, base::max(str_umap$X1))+1)+
  ggplot2::ylim(c(base::min(str_umap$X2)-1, base::max(str_umap$X2))+1)+
  ggplot2::scale_color_manual("Mouse species", values = col_spc_pub)
```

```{r d_theme_plot_right}
d_theme_plot_right <- d_base_plot_right+
  cowplot::theme_nothing()
```

#### Legend

only one required

```{r d_legend_plot}
d_legend_plot <- ggplot2::ggplot(
  hsc_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_legend_point_size,
    alpha = umap_legend_point_alpha)+
  ggplot2::scale_color_manual("Mouse species", values = col_spc_pub)
```

```{r d_legend_theme_plot}
d_legend_theme_plot <- d_legend_plot+
  theme_all+
  ggplot2::theme(legend.key.height = unit(0.3, "lines"))
d_theme_legend <- ggpubr::get_legend(d_legend_theme_plot)
d_legend <- ggpubr::ggarrange(d_theme_legend)

d_legend
```

## E UMAPs Cell Types

HSPCs (left) and Niche cells (right) clustered in UMAP space, 
colored by cell type.

#### Plot Components

```{r e_prep}
hsc_umap <- base::as.data.frame(
  SingleCellExperiment::reducedDim(
    sce_hsc, type = "UMAP"))
hsc_umap$color_by <- sce_hsc$celltypes
hsc_umap <- hsc_umap[base::sample(
  1:nrow(hsc_umap),
  nrow(hsc_umap),
  replace = FALSE),]

str_umap <- base::as.data.frame(
  SingleCellExperiment::reducedDim(
    sce_str, type = "UMAP"))
str_umap$color_by <- sce_str$celltypes
str_umap <- str_umap[base::sample(
  1:nrow(str_umap),
  nrow(str_umap),
  replace = FALSE),]
```

```{r e_base_plot_left}
e_base_plot_left <- ggplot2::ggplot(
  hsc_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_point_size,
    alpha = umap_point_alpha)+
  ggplot2::xlim(c(base::min(hsc_umap$X1)-1, base::max(hsc_umap$X1))+1)+
  ggplot2::ylim(c(base::min(hsc_umap$X2)-1, base::max(hsc_umap$X2))+1)+
  ggplot2::scale_color_manual("Cell type", values = col_cts_hsc)
```

```{r e_theme_plot_left}
e_theme_plot_left <- e_base_plot_left+
  cowplot::theme_nothing()
```

```{r e_base_plot_right}
e_base_plot_right <- ggplot2::ggplot(
  str_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_point_size,
    alpha = umap_point_alpha)+
  ggplot2::xlim(c(base::min(str_umap$X1)-1, base::max(str_umap$X1))+1)+
  ggplot2::ylim(c(base::min(str_umap$X2)-1, base::max(str_umap$X2))+1)+
  ggplot2::scale_color_manual("Cell type", values = col_cts_str)
```

```{r e_theme_plot_right}
e_theme_plot_right <- e_base_plot_right+
  cowplot::theme_nothing()
```

#### Legend

```{r e_legend_plot_left}
e_legend_plot_left <- ggplot2::ggplot(
  hsc_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_legend_point_size,
    alpha = umap_legend_point_alpha)+
  ggplot2::scale_color_manual("Cell type", values = col_cts_hsc)
```

```{r e_legend_plot_right}
e_legend_plot_right <- ggplot2::ggplot(
  str_umap, 
  aes(x = X1,
      y = X2,
      color = color_by))+
  ggplot2::geom_point(
    size = umap_legend_point_size,
    alpha = umap_legend_point_alpha)+
  ggplot2::scale_color_manual("Cell type", values = col_cts_str)
```

```{r e_theme_legend_plot_left}
e_theme_legend_plot_left <- e_legend_plot_left+
  theme_all+
  ggplot2::theme(legend.key.height = unit(0.3, "lines"))
e_legend_left <- ggpubr::get_legend(e_theme_legend_plot_left)
```

```{r e_theme_legend_plot_right}
e_theme_legend_plot_right <- e_legend_plot_right+
  theme_all+
  ggplot2::theme(
    legend.title = element_blank(),
    legend.key.height = unit(0.3, "lines")
  )
e_legend_right <- ggpubr::get_legend(e_theme_legend_plot_right)
```

```{r e_theme_legend, fig.height = 6, fig.width = 4}
e_theme_legend <- ggpubr::ggarrange(
  ncol = 1,
  align = "v",
  e_legend_left,
  e_legend_right)

e_theme_legend
```

## DE together

```{r bc_construct, fig.width = 13, fig.height = 13}
de_plot_top <- ggpubr::ggarrange(
  align = "hv",
  d_theme_plot_left,
  d_theme_plot_right,
  ncol = 2
)

de_plot_bottom <- ggpubr::ggarrange(
  align = "hv",
  e_theme_plot_left,
  e_theme_plot_right,  
  ncol = 2
)

de_plot <- ggpubr::ggarrange(
  align = "hv",
  de_plot_top,
  de_plot_bottom,
  ncol = 1
)
de_plot
```

```{r export_bc_plot}
png(output_png_de, width = 13*100, height = 13*100)
de_plot
dev.off()
```

```{r export_bc_plot_pdf}
pdf(output_pdf_de, width = 13, height = 13)
de_plot
dev.off()
```

```{r bc_assemble_legends, fig.width = 3, fig.height = 5.1}

d_legend

de_legend_2 <- ggpubr::ggarrange(
  align = "hv",
  e_legend_left,
  e_legend_right,
  ncol = 1)

de_legend_2
```

```{r export_bc_legend1}
pdf(output_pdf_de_legend1, width = 3, height = 2)
d_legend
dev.off()
```

```{r export_bc_legend2}
pdf(output_pdf_de_legend2, width = 3, height = 5.1)
de_legend_2
dev.off()
```

## F DOTPLOT

Average gene expression of well-known marker genes that were not used for
cell type sub-clustering per species for HSCs (top left) and Adipo/CARs 
(top right) or per cell type for HSPC fraction (bottom left) or Niche fraction 
(bottom right).

#### Prepare

```{r f_prepare}
# get genes
gene_df_hsc <- gene_df[gene_df$fraction == "hsc",]
genes_hsc <- gene_df_hsc$gene

gene_df_str <- gene_df[which(gene_df$fraction == "str" & 
                               gene_df$use == "short"),]
genes_str <- gene_df_str$gene

# agrgegate across cell types, get average expression, use normalized counts
agg_hsc <- scuttle::aggregateAcrossCells(
  sce_hsc, 
  id=colData(sce_hsc)[,c("celltypes")], 
  statistics = "mean",
  use.assay.type = "logcounts")

agg_str <- scuttle::aggregateAcrossCells(
  sce_str, 
  id=colData(sce_str)[,c("celltypes")], 
  statistics = "mean",
  use.assay.type = "logcounts")

# make data frames for visualisation
vis_df_hsc <- base::as.data.frame(
  t(SummarizedExperiment::assays(agg_hsc)$logcounts[
    rownames(SummarizedExperiment::assays(agg_hsc)$logcounts) %in% genes_hsc,]))

vis_df_str <- base::as.data.frame(
  t(SummarizedExperiment::assays(agg_str)$logcounts[
    rownames(SummarizedExperiment::assays(agg_str)$logcounts) %in% genes_str,]))

# format data frames
vis_df_hsc <- tibble::rownames_to_column(vis_df_hsc, "celltypes")
vis_df_hsc <- tidyr::pivot_longer(
  vis_df_hsc, 
  cols = c(2:ncol(vis_df_hsc)), 
  values_to = "expression", 
  names_to = "gene")

vis_df_str <- tibble::rownames_to_column(vis_df_str, "celltypes")
vis_df_str <- tidyr::pivot_longer(
  vis_df_str, 
  cols = c(2:ncol(vis_df_str)), 
  values_to = "expression", 
  names_to = "gene")

# factor cell types for correct order
vis_df_hsc$celltypes <- factor(
  vis_df_hsc$celltypes, 
  levels = base::rev(names(col_cts_hsc)))

vis_df_str$celltypes <- factor(
  vis_df_str$celltypes, 
  levels = base::rev(names(col_cts_str)))

# factor genes for correct order
vis_df_hsc$gene <- factor(
  vis_df_hsc$gene, 
  levels = gene_df_hsc$gene)

vis_df_str$gene <- factor(
  vis_df_str$gene, 
  levels = gene_df_str$gene)
```

```{r f_function}
get_perc_expressed <- function(vis_df, sce){
  
  vis_df <- vis_df
  sce <- sce
  
  vis_df$percent_expressed <- vector(length = nrow(vis_df))
  
  cts <- base::unique(vis_df$celltypes)
  gs <- base::unique(vis_df$gene)
  
  for(ct in cts){
    
    # normalized (MultiBatchNorm)
    lc_temp <- SummarizedExperiment::assays(sce)$logcounts[,sce$celltypes == ct]
    
    for(g in gs){
      
      # the number of cells expressing g > 0 times / absolute cells * 100 per ct
      perc_expr <- length(which(lc_temp[
        rownames(lc_temp) == g,] > 0))/ncol(lc_temp)*100
      
      vis_df$percent_expressed[
        which(vis_df$celltypes == ct & vis_df$gene == g)] <- perc_expr
    }
  }
  return(vis_df)
}

vis_df_hsc <- get_perc_expressed(vis_df_hsc, sce_hsc)
vis_df_str <- get_perc_expressed(vis_df_str, sce_str)
```

```{r f_prepare_ct}
# aggregate
sce_hsc_ct <- sce_hsc[,sce_hsc$celltypes == ct_hsc]
agg_ct_hsc <- scuttle::aggregateAcrossCells(
  sce_hsc_ct,
  id=colData(sce_hsc_ct)[,c("species_pub")], 
  statistics = "mean",
  use.assay.type = "logcounts")

sce_str_ct <- sce_str[,sce_str$celltypes == ct_str]
agg_ct_str <- scuttle::aggregateAcrossCells(
  sce_str_ct,
  id=colData(sce_str_ct)[,c("species_pub")], 
  statistics = "mean",
  use.assay.type = "logcounts")

# make vis_dfs
vis_df_ct_hsc <- base::as.data.frame(
  t(SummarizedExperiment::assays(agg_ct_hsc)$logcounts[
    rownames(SummarizedExperiment::assays(agg_ct_hsc)$logcounts) %in% 
      genes_hsc,]))

vis_df_ct_str <- base::as.data.frame(
  t(SummarizedExperiment::assays(agg_ct_str)$logcounts[
    rownames(SummarizedExperiment::assays(agg_ct_str)$logcounts) %in% 
      genes_str,]))

# format
vis_df_ct_hsc <- tibble::rownames_to_column(vis_df_ct_hsc, "species")
vis_df_ct_hsc <- tidyr::pivot_longer(
  vis_df_ct_hsc,
  cols = c(2:ncol(vis_df_ct_hsc)), 
  values_to = "expression", 
  names_to = "gene")

vis_df_ct_str <- tibble::rownames_to_column(vis_df_ct_str, "species")
vis_df_ct_str <- tidyr::pivot_longer(
  vis_df_ct_str,
  cols = c(2:ncol(vis_df_ct_str)), 
  values_to = "expression", 
  names_to = "gene")

vis_df_ct_hsc$celltypes <- base::rep(ct_hsc, nrow(vis_df_ct_hsc))
vis_df_ct_str$celltypes <- base::rep(ct_str, nrow(vis_df_ct_str))

# factor
vis_df_ct_hsc$species <- factor(vis_df_ct_hsc$species, 
                                levels = base::rev(names(col_spc_pub)))
vis_df_ct_hsc$gene <- factor(vis_df_ct_hsc$gene,
                             levels = gene_df_hsc$gene)

vis_df_ct_str$species <- factor(vis_df_ct_str$species, 
                              levels = base::rev(names(col_spc_pub)))
vis_df_ct_str$gene <- factor(vis_df_ct_str$gene,
                             levels = gene_df_str$gene)

# perc expressed
vis_df_ct_hsc <- get_perc_expressed(vis_df_ct_hsc, sce_hsc)
vis_df_ct_str <- get_perc_expressed(vis_df_ct_str, sce_str)
```

#### Plots

```{r f_base_plot_top_left}

# make background grid
background_hsc <- data.frame(
  xmin = c(
    "Mecom",
    "Adgrl4",
    "Dctpp1",
    "Cebpa",
    "Irf8",
    "Cebpe",
    "Flt3",
    "Hdc",
    "Gata2",
    "Gata1",
    "Klf1",
    "Mki67"),  # start of each segment (character values)
  xmax = c(
    "Meis1",
    "Cd34",
    "Hells",
    "Cebpa",
    "Ccr2",
    "S100a8",
    "Dntt",
    "Cpa3",
    "Pf4",
    "Car2",
    "Hba-a1",
    "Lockd"
  ),  # end of each segment (character values)
  ymin = -Inf,              # covers full height
  ymax = Inf,
  fill = c(
    "grey80",
    rep(c("white", "grey80"), 5),
    "white")  # alternating colors
)

background_hsc$xmin <- base::match(background_hsc$xmin, 
                                   levels(vis_df_ct_hsc$gene))
background_hsc$xmax <- base::match(background_hsc$xmax, 
                                   levels(vis_df_ct_hsc$gene))

f_base_plot_top_left <- ggplot2::ggplot(
  vis_df_ct_hsc, 
  aes(x = gene,
      y = species,
      color = percent_expressed,
      size = expression))+
  ggplot2::geom_rect(
    data = background_hsc, 
    aes(xmin = xmin - 0.5,
        xmax = xmax + 0.5, 
        ymin = ymin,
        ymax = ymax),
    fill = background_hsc$fill,
    inherit.aes = FALSE, 
    alpha = 0.2)+
  ggplot2::geom_point()
```

```{r f_theme_plot_top_left}
f_theme_plot_top_left <- f_base_plot_top_left+
  theme_all+
  ggplot2::scale_x_discrete(position = "top")+
  ggplot2::theme(
    axis.title = element_blank(),
    axis.text.x.top = element_text(
      hjust = 0,
      vjust = 0.5,
      angle = 90),
    axis.text.y = element_text(
      hjust = 0),
    legend.position = "none")+
  ggplot2::ylab("Species")+
  ggplot2::xlab("Gene")+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_hsc$expression)))+
  ggplot2::scale_colour_gradientn(
     "% expressed",
     colors = mycolors_to100,
     limits = c(0, 100))
```

```{r f_base_plot_top_right}
# make background grid
background_str <- data.frame(
  xmin = c(
    "Cxcl12",
    "Spp1",
    "Comp",
    "S100a10",
    "Cdh5",
    "Ly6a",
    "Car4",
    "Vwf",
    "Tfpi",
    "Lyve1",
    "Tagln"
    ),  
  xmax = c(
    "Lepr",
    "Bglap",
    "Fmod",
    "Thy1",
    "Pecam1",
    "Efnb2",
    "Timp4",
    "Lrg1",
    "Flt4",
    "Prox1",
    "Steap4"
  ), 
  ymin = -Inf,             
  ymax = Inf,
  fill = c(
    "grey80",
    rep(c("white", "grey80"),  5)) 
)

background_str$xmin <- base::match(background_str$xmin,
                                   levels(vis_df_ct_str$gene))
background_str$xmax <- base::match(background_str$xmax,
                                   levels(vis_df_ct_str$gene))

f_base_plot_top_right <- ggplot2::ggplot(
  vis_df_ct_str, 
  aes(x = gene,
      y = species,
      color = percent_expressed,
      size = expression))+
  ggplot2::geom_rect(
    data = background_str, 
    aes(xmin = xmin - 0.5,
        xmax = xmax + 0.5, 
        ymin = ymin,
        ymax = ymax),
    fill = background_str$fill,
    inherit.aes = FALSE, 
    alpha = 0.2)+
  ggplot2::scale_x_discrete(position = "top")+
  ggplot2::geom_point()
```

```{r f_theme_plot_top_right}
f_theme_plot_top_right <- f_base_plot_top_right+
  theme_all+
  ggplot2::theme(
    axis.title = element_blank(),
    axis.text.x.top = element_text(
      hjust = 0,
      vjust = 0.5,
      angle = 90),
    axis.text.y = element_blank(),
    legend.position = "none")+
  ggplot2::xlab("Gene")+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_ct_str$expression)))+
  ggplot2::scale_colour_gradientn(
     "% expressed",
     colors = mycolors_to100,
     limits = c(0, 100)
  )
```

```{r f_base_plot_bottom_left}
f_base_plot_bottom_left <- ggplot2::ggplot(
  vis_df_hsc, 
  aes(x = gene,
      y = celltypes,
      color = percent_expressed,
      size = expression))+
  ggplot2::geom_rect(
    data = background_hsc, 
    aes(xmin = xmin - 0.5,
        xmax = xmax + 0.5, 
        ymin = ymin,
        ymax = ymax),
    fill = background_hsc$fill,
    inherit.aes = FALSE, 
    alpha = 0.2)+
  ggplot2::geom_point()
```

```{r f_theme_plot_bottom_left}
f_theme_plot_bottom_left <- f_base_plot_bottom_left+
  theme_all+
  ggplot2::theme(
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_text(
      hjust = 0),
    legend.position = "none")+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_hsc$expression)))+
  ggplot2::scale_colour_gradientn(
     "% expressed",
     colors = mycolors_to100,
     limits = c(0, 100)
  )
```

```{r f_base_plot_bottom_right}
f_base_plot_bottom_right <- ggplot2::ggplot(
  vis_df_str, 
  aes(x = gene,
      y = celltypes,
      color = percent_expressed,
      size = expression))+
  ggplot2::geom_rect(
    data = background_str, 
    aes(xmin = xmin - 0.5,
        xmax = xmax + 0.5, 
        ymin = ymin,
        ymax = ymax),
    fill = background_str$fill,
    inherit.aes = FALSE, 
    alpha = 0.2)+
  ggplot2::geom_point()
```

```{r f_theme_plot_bottom_right}
f_theme_plot_bottom_right <- f_base_plot_bottom_right+
  theme_all+
  ggplot2::theme(
    axis.title = element_blank(),
    axis.text.y = element_text(
      hjust = 0),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none")+
  ggplot2::ylab("Cell type")+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_ct_str$expression)))+
  ggplot2::scale_colour_gradientn(
     "% expressed",
     colors = mycolors_to100,
     limits = c(0, 100)
  )
```

#### Legends

Since logcounts have different upper limits in HSPCs vs Niche, need two.

```{r f_legend_base_plot_left}
f_legend_base_plot_left <- ggplot2::ggplot(
  vis_df_hsc, 
  aes(x = gene,
      y = celltypes,
      size = expression))+
  ggplot2::geom_point()
```

```{r f_legend_theme_plot_left}
f_legend_theme_plot_left <- f_legend_base_plot_left+
  theme_all+
  ggplot2::theme(
    legend.title.position = "top",
    legend.box.just = "left",
    legend.position = "bottom",
    legend.box = "vertical", # Stack legends vertically
    legend.spacing.y = unit(0.5, 'cm'))+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_hsc$expression)))
f_legend_left <- ggpubr::get_legend(f_legend_theme_plot_left)
```

```{r f_legend_base_plot_middle}
f_legend_base_plot_middle <- ggplot2::ggplot(
  vis_df_str, 
  aes(x = gene,
      y = celltypes,
      color = percent_expressed))+
  ggplot2::geom_point()
```

```{r f_legend_theme_plot_middle}
f_legend_theme_plot_middle <- f_legend_base_plot_middle+
  theme_all+
  ggplot2::theme(
    legend.title.position = "top",
    legend.box.just = "left",
    legend.position = "bottom",
    legend.box = "vertical", # Stack legends vertically
    legend.spacing.y = unit(0.5, 'cm'))+
  ggplot2::scale_colour_gradientn(
    "% expressed",
    breaks = c(0, 50, 100),
    colors = mycolors_to100,
    limits = c(0, 100)
  )
f_legend_middle <- ggpubr::get_legend(f_legend_theme_plot_middle)
```

```{r f_legend_base_plot_right}
f_legend_base_plot_right <- ggplot2::ggplot(
  vis_df_str, 
  aes(x = gene,
      y = celltypes,
      size = expression))+
  ggplot2::geom_point()
```

```{r f_legend_theme_plot_right}
f_legend_theme_plot_right <- f_legend_base_plot_right+
  theme_all+
  ggplot2::theme(
    legend.title.position = "top",
    legend.box.just = "left",
    legend.position = "bottom",
    legend.box = "vertical", # Stack legends vertically
    legend.spacing.y = unit(0.5, 'cm'))+
  ggplot2::scale_size_area(
    "logcounts",
    max_size = max_size_dotplots,
    limits = c(0, base::max(vis_df_ct_str$expression)))
f_legend_right <- ggpubr::get_legend(f_legend_theme_plot_right)
```

#### Assemble

```{r f_theme_plot, fig.width = 16, fig.height = 6}
f_theme_plot <- ggpubr::ggarrange(
  f_theme_plot_top_left, 
  f_theme_plot_top_right,
  f_theme_plot_bottom_left,
  f_theme_plot_bottom_right,
  heights = c(1,1.8),
  widths = c(1, 1.1),
  align = "v")

f_theme_plot
```

```{r f_theme_plot2, fig.width = 16, fig.height = 6}
f_theme_plot2 <- ggpubr::ggarrange(
  f_theme_plot_top_left + theme(
    plot.margin = margin(t = 10, r = 5, b = 20, l = 5, unit = "pt")), 
  f_theme_plot_top_right + theme(
    plot.margin = margin(t = 5, r = 5, b = 20, l = 5, unit = "pt")),
  f_theme_plot_bottom_left,
  f_theme_plot_bottom_right,
  heights = c(1,1.8),
  widths = c(1, 1.1))

f_theme_plot2
```

```{r f_theme_legends, fig.width = 7, fig.height = 1}
f_theme_legends <- ggpubr::ggarrange(
  nrow = 1,
  f_legend_left,
  f_legend_middle,
  f_legend_right
  )

f_theme_legends
```

```{r f_theme_legend_right, fig.width = 4, fig.height = 2}
f_theme_legend_right <- ggpubr::ggarrange(
  f_legend_right
  )

f_theme_legend_right
```

```{r export_f}
pdf(output_pdf_f, width = 16, height = 6)
f_theme_plot2
dev.off()
```

```{r export_f_legend}
pdf(output_pdf_f_legend, width = 7, height = 1)
f_theme_legends
dev.off()
```

```{r sessioninfo}
utils::sessionInfo()
```
