---
title: "Figure 3"
date: '2024-09-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Generate Figure 3

#### Load objects

```{r seed, message = FALSE}
base::RNGkind(kind = "Mersenne-Twister")
set.seed(37)
```

```{r load_packages, message = FALSE}
library(SingleCellExperiment, quietly = TRUE)
library(ggpubr, quietly = TRUE)
library(tidyverse, quietly = TRUE)
library(ggpattern, quietly = TRUE) 
library(Seurat, quietly = TRUE) 
```

```{r load_manual_basepath}
base_path <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data"
```

```{r load_manual}
#-------------------------------------------------------------------------------
#### OWN DATASET (HSPCs)

# SCE with reclustering vectors for each gene set
sce_hsc_recl <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/03_recl/sce_hsc"))

# dataframe of re-clustering scores for each gene set
score_df_hsc <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/04_rcls/score_df_hsc"))

# dataframes of re-clustering scores after background permutation

# signature vs random
psdf_hsc_sign_rand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_psig/perm_score_df_hsc"))

# conserved markers vs random
psdf_hsc_mark_rand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_pmrk/perm_score_df_hsc"))

# BL6 markers vs random
psdf_hsc_mmms_rand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_pmmm/perm_score_df_hsc"))
```

```{r load_manual_other1}
#-------------------------------------------------------------------------------
#### OTHER MOUSE DATASET 1 (HSPC)
#### MUS_TM_BONEMARROW

dataset_o1 <- "mus_tm_bonemarrow"

# list of seurat objects with reclustering vectors for each gene set and resolution
seu_hsc_recl_list_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/03_recl/reclustered_mus_tm_bonemarrow_list"))

# CALIBRATION list of objects, to make sure that clusterings are identical
# after re-run (testing clusterings instead of whole objects because seurat
# documents time of running each command, and those will differ)
seu_hsc_recl_list_o1_CAL <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other_CALIBRATE/03_recl/reclustered_mus_tm_bonemarrow_list"))
stopifnot(identical(seu_hsc_recl_list_o1_CAL$seu_sign[[1]]$seurat_clusters,
                seu_hsc_recl_list_o1$seu_sign[[1]]$seurat_clusters))

# list of dataframes of re-clustering scores for each gene set and resolution
score_df_hsc_list_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/04_rcls/score_df_mus_tm_bonemarrow_list"))


# dataframes of re-clustering scores after permutation comparing to background
psdf_hsc_sign_rand_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_psig/perm_score_df_mus_tm_bonemarrow"))

psdf_hsc_mmms_rand_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_pmms/perm_score_df_mus_tm_bonemarrow"))

# dataframes of re-clustering scores after permutation comparing gene sets
# BL6 markers vs signature + random
psdf_hsc_mmms_signrand_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_perg/perm_score_df_mmms_mus_tm_bonemarrow"))
```

```{r load_manual_remaining}
#-------------------------------------------------------------------------------
#### REMAINING

# list of gene sets for HSPCs (conserved signature, conserved markers, etc.)
geneset_list_hsc <-base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/01_gens/geneset_list_hsc"))

# data frame containing the correct resolutions for other datasets as visually determined
resolution_df_path <- base::paste0(
  base_path,
  "/metadata/scRNAseq/03_sce_analysis/reclustering_bm/reclustering_other_resolution.txt")

resolution_df <- utils::read.csv(file = resolution_df_path, 
                               header = TRUE, 
                               sep = ";", 
                               check.names=FALSE, 
                               stringsAsFactors=FALSE, 
                               as.is=TRUE, 
                               colClasses = "character")

# corrected p values (can only load after all p values have been calculated and corrected)
# corr_pval_df <-  readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/09_crpv/all_corrected_pval"))

colors_path <- base::paste0(
  base_path,
  "/metadata/colors/colors.txt")

source("../source/colors.R")
source("../source/plotting.R")
```

```{r params}
# global params
source("determine_params.R")

point_plot_size <- 4

pattern_fill_color <- "black"
pattern_line_colour <- "black"
pattern_density_val <- 0.09
pattern_spacing_val <- 0.09


color_hline_background <- "grey95"

score2 <- "variation_information"
score1 <- "adjusted_rand_index"
score3 <- "mean_prop_cells_cluster"

score2_long <- "Variation of\nInformation"
score1_long <- "Adjusted Rand\nIndex"
score3_long <- "Mean\nProportion"

nr_genes_title <- "#genes\n "
```

```{r density_plot_function}
make_pattern_density_plot <- function(
  score_df,
  perm_score_df,
  color_cons,
  ylabel
  ){

  # make temp plot to extract maximum y value
  p_temp <- ggplot2::ggplot(
    perm_score_df,
    aes(x = value))+
    geom_density_pattern()
  
  # calculate the maximum y value (density at its peak)
  density_data <- ggplot2::ggplot_build(p_temp)$data[[1]]
  max_y <- max(density_data$y)
  
  # define the y value for the point as 125% of the maximum y value
  y_value <- 1.25 * max_y
  
  # define the y limits for a nicer plot + y value to place the break/label
  y_lim_low <- -0.25 * max_y
  y_lim_high <- 1.5 * max_y
  y_lim_break <- (y_lim_low + y_lim_high)/2 
  
  # add to score DF
  score_df$y_value <- y_value
  
  # plot
  p_return <- ggplot2::ggplot(
    perm_score_df,
    aes(x = value))+
    geom_density(
       fill = color_cons,
       color = color_cons
    )+
    geom_vline(
      color = "grey60",
      xintercept = score_df$value,
      linetype = "dashed"
    )+
    geom_point(
      inherit.aes = FALSE, 
      shape = 23,
      fill = color_cons,
      data = score_df,
      aes(x = value, y = y_value),
      size = 7,
      color = color_cons)+
    scale_y_continuous(
      limits = c(y_lim_low, y_lim_high),
      breaks = y_lim_break, 
      labels = ylabel)
  
  return(p_return)
}
```

```{r export_paths}

output_pdf_heatmap_own_plot <- base::paste0(
   base_path, "/manuscript1/figure3/figure3_heatmap_own.pdf")
output_pdf_heatmap_own_legend <- base::paste0(
  base_path, "/manuscript1/figure3/figure3_heatmap_legend.pdf")

output_pdf_own_perm_plot <-  base::paste0(
   base_path, "/manuscript1/figure3/figure3_own_perm.pdf")
output_pdf_o1_perm_plot <-  base::paste0(
   base_path, "/manuscript1/figure3/figure3_other_perm.pdf")
output_pdf_mmms_sign_plot <-  base::paste0(
   base_path, "/manuscript1/figure3/figure3_mmms_signrand_perm.pdf")

output_pdf_heatmaps_others_plot <- base::paste0(
   base_path, "/manuscript1/figure3/figure3_heatmaps_others.pdf")

export_signature_table_path <- base::paste0(
   base_path, "/manuscript1/hsc_signature_table.csv")
```

# Obtain data for text

```{r obtain_data}
print(sce_hsc_recl$cluster_signt_genes_used[1])
print(sce_hsc_recl$cluster_consm_genes_used[1])
print(sce_hsc_recl$cluster_mmusm_genes_used[1])

BL6_genes <- vector()
signature_genes <- vector()
for(ct in names(geneset_list_hsc)){
  BL6_genes <- unique(
    c(BL6_genes,
      geneset_list_hsc[[ct]]$conserved_df$gene[!is.na(geneset_list_hsc[[ct]]$conserved_df$mmus)]))
  signature_genes <- unique(c(signature_genes, geneset_list_hsc[[ct]]$conserved_signature))
}

perc <- (length(BL6_genes)-length(signature_genes[signature_genes %in% BL6_genes]))/length(BL6_genes)
print(perc)
```

# Export Table 

Exporting a useful table containing all signature genes, their cell type(s) of
origin, and whether they were originally sub-clustering genes.

```{r export_table}

for(ct in names(geneset_list_hsc)){
  geneset_list_hsc[[ct]]$ct <- ct
}

make_export_df <- function(gene_set_list){
  
  genes_sub <- gene_set_list$genes_subclustering
  genes_sign <- gene_set_list$conserved_signature
  
  temp_df <- data.frame(
    "signature_gene" = genes_sign,
    "celltype" =  base::rep(gene_set_list$ct, length(genes_sign)),
    "subclustering_gene_for_ct" = vector(length = length(genes_sign))
  )
  
  # add info on whether a gene was a sub-clustering gene for the cell type
  temp_df$subclustering_gene_for_ct[which(temp_df$signature_gene %in% genes_sub)] <- TRUE
  return(temp_df)
}

export_df_list <- lapply(geneset_list_hsc, make_export_df)
export_df <- bind_rows(export_df_list)
export_df <- export_df[order(export_df$signature_gene, decreasing = FALSE),]
head(export_df)

readr::write_delim(export_df, export_signature_table_path, delim = ";", append = FALSE)
```

# PREP: Permutation Plots 

## PREP ALL SCORE DFs 

Separate score DFs per conservation level and type of score.
For uniform axis limits, do it for all score DFs.

### OWN 

```{r own_scoredf_1}
# get the score DF of original HSC reclustering scores
head(score_df_hsc)

# flip VI so that it follows the same direction as the other two scores
score_df_hsc$value[
  score_df_hsc$type == "variation_information"] <- 0-score_df_hsc$value[
    score_df_hsc$type == "variation_information"]
```

```{r own_scoredf_2}
# subset to one re-clustering gene set (conserved identity signature)
score_df_sign <- score_df_hsc[
  score_df_hsc$conservation_level == "conserved_signature",]
# add nicer looking conservation level annotation
score_df_sign$conservation_level_long <- "conserved identity signature"

# subset to each score
score_df_sign_score_1 <- score_df_sign[score_df_sign$type == score1,]
score_df_sign_score_2 <- score_df_sign[score_df_sign$type == score2,]
score_df_sign_score_3 <- score_df_sign[score_df_sign$type == score3,]
```

```{r own_scoredf_3}
score_df_mark <- score_df_hsc[
  score_df_hsc$conservation_level == "conserved_markers",]
score_df_mark$conservation_level_long <- "conserved markers"

score_df_mark_score_1 <- score_df_mark[score_df_mark$type == score1,]
score_df_mark_score_2 <- score_df_mark[score_df_mark$type == score2,]
score_df_mark_score_3 <- score_df_mark[score_df_mark$type == score3,]
```

```{r own_scoredf_4}
score_df_mmms <- score_df_hsc[
  score_df_hsc$conservation_level == "mmusall_markers",]
score_df_mmms$conservation_level_long <- "BL6 markers"

score_df_mmms_score_1 <- score_df_mmms[score_df_mmms$type == score1,]
score_df_mmms_score_2 <- score_df_mmms[score_df_mmms$type == score2,]
score_df_mmms_score_3 <- score_df_mmms[score_df_mmms$type == score3,]
```

```{r perm_score_df_rand1}
# get the required permutated score DFs

# comparing each signature to completely random background
head(psdf_hsc_sign_rand)
head(psdf_hsc_mark_rand)
head(psdf_hsc_mmms_rand) 

# flip VI for each of them
psdf_hsc_sign_rand$variation_information <- 0-
  psdf_hsc_sign_rand$variation_information
psdf_hsc_mark_rand$variation_information <- 0-
  psdf_hsc_mark_rand$variation_information
psdf_hsc_mmms_rand$variation_information <- 0-
  psdf_hsc_mmms_rand$variation_information
```

```{r perm_score_df_rand2}
# also separate permutated score dfs by conservation level/type of score.

psdf_sign_rand_long <- tidyr::pivot_longer(
  psdf_hsc_sign_rand, 
  c = 1:ncol(psdf_hsc_sign_rand),
  values_to = "value",
  names_to = "type")

psdf_sign_rand_long$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_sign_rand_long))

psdf_sign_rand_score_1 <- psdf_sign_rand_long[
  psdf_sign_rand_long$type == score1,]
psdf_sign_rand_score_2 <- psdf_sign_rand_long[
  psdf_sign_rand_long$type == score2,]
psdf_sign_rand_score_3 <- psdf_sign_rand_long[
  psdf_sign_rand_long$type == score3,]
```

```{r perm_score_df_rand3}
# mark_rand is not calculated yet

psdf_mark_rand_long <- tidyr::pivot_longer(
  psdf_hsc_mark_rand, 
  c = 1:ncol(psdf_hsc_mark_rand),
  values_to = "value",
  names_to = "type")

psdf_mark_rand_long$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_mark_rand_long))

psdf_mark_rand_score_1 <- psdf_mark_rand_long[
  psdf_mark_rand_long$type == score1,]
psdf_mark_rand_score_2 <- psdf_mark_rand_long[
  psdf_mark_rand_long$type == score2,]
psdf_mark_rand_score_3 <- psdf_mark_rand_long[
  psdf_mark_rand_long$type == score3,]
```

```{r perm_score_df_rand4}
# mmms_rand is not calculated yet

psdf_mmms_rand_long <- tidyr::pivot_longer(
  psdf_hsc_mmms_rand, 
  c = 1:ncol(psdf_hsc_mmms_rand),
  values_to = "value",
  names_to = "type")

psdf_mmms_rand_long$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_mmms_rand_long))

psdf_mmms_rand_score_1 <- psdf_mmms_rand_long[
  psdf_mmms_rand_long$type == score1,]
psdf_mmms_rand_score_2 <- psdf_mmms_rand_long[
  psdf_mmms_rand_long$type == score2,]
psdf_mmms_rand_score_3 <- psdf_mmms_rand_long[
  psdf_mmms_rand_long$type == score3,]
```

### OTHER 1 

```{r o1_scoredf_1}

# extract only the info on the object re-clustered with the chosen resolution
# this is also required for the heatmaps

# seurat object
resolution_df_o1 <- resolution_df[resolution_df$dataset == dataset_o1,]

selected_seu_list_o1 <- lapply(seu_hsc_recl_list_o1, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  resdf_temp <- resolution_df_o1[
    resolution_df_o1$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
})

# original score DF
selected_score_df_list_o1 <- lapply(score_df_hsc_list_o1, function(score_df_list){
  
  conslev_curr <- score_df_list[[1]]$conservation_level[1]
  resdf_temp <- resolution_df_o1[
    resolution_df_o1$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  score_df_return <- score_df_list[[res_curr]]
  return(score_df_return)
  
})
score_df_hsc_o1 <- dplyr::bind_rows(selected_score_df_list_o1)

# flip VI
score_df_hsc_o1$value[
  score_df_hsc_o1$type == "variation_information"] <- 0-score_df_hsc_o1$value[
    score_df_hsc_o1$type == "variation_information"]
```

```{r o1_scoredf_2}
# separate original score DF by gene set and by score type
score_df_sign_o1 <- score_df_hsc_o1[
  score_df_hsc_o1$conservation_level == "conserved_signature",]
score_df_sign_o1$conservation_level_long <- "conserved identity signature"

score_df_sign_score_1_o1 <- score_df_sign_o1[
  score_df_sign_o1$type == score1,]
score_df_sign_score_2_o1 <- score_df_sign_o1[
  score_df_sign_o1$type == score2,]
score_df_sign_score_3_o1 <- score_df_sign_o1[
  score_df_sign_o1$type == score3,]
```

```{r o1_scoredf_4}
score_df_mmms_o1  <- score_df_hsc_o1[
  score_df_hsc_o1$conservation_level == "mmusall_markers",]
score_df_mmms_o1$conservation_level_long <- "BL6 markers"

score_df_mmms_score_1_o1 <- score_df_mmms_o1[
  score_df_mmms_o1$type == score1,]
score_df_mmms_score_2_o1 <- score_df_mmms_o1[
  score_df_mmms_o1$type == score2,]
score_df_mmms_score_3_o1 <- score_df_mmms_o1[
  score_df_mmms_o1$type == score3,]
```

```{r o1_scoredf_5}

# same for permutation gene sets

# vs background
head(psdf_hsc_sign_rand_o1)
head(psdf_hsc_mmms_rand_o1)

psdf_hsc_sign_rand_o1$variation_information <- 0-
  psdf_hsc_sign_rand_o1$variation_information
psdf_hsc_mmms_rand_o1$variation_information <- 0-
  psdf_hsc_mmms_rand_o1$variation_information

# vs signature + background
head(psdf_hsc_mmms_signrand_o1)

psdf_hsc_mmms_signrand_o1$variation_information <- 0-
  psdf_hsc_mmms_signrand_o1$variation_information
```

```{r o1_scoredf_6}

# also separate permutated score dfs by conservation level/type of score.
# sign
psdf_sign_rand_long_o1 <- tidyr::pivot_longer(
  psdf_hsc_sign_rand_o1, 
  c = c("mean_prop_cells_cluster", "adjusted_rand_index", "variation_information"),
  values_to = "value",
  names_to = "type")

psdf_sign_rand_long_o1$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_sign_rand_long_o1))

psdf_sign_rand_score_1_o1 <- psdf_sign_rand_long_o1[
  psdf_sign_rand_long_o1$type == score1,]
psdf_sign_rand_score_2_o1 <- psdf_sign_rand_long_o1[
  psdf_sign_rand_long_o1$type == score2,]
psdf_sign_rand_score_3_o1 <- psdf_sign_rand_long_o1[
  psdf_sign_rand_long_o1$type == score3,]
```

```{r o1_scoredf_8}
# mmms
psdf_mmms_rand_long_o1 <- tidyr::pivot_longer(
  psdf_hsc_mmms_rand_o1, 
  c = c("mean_prop_cells_cluster", "adjusted_rand_index", "variation_information"),
  values_to = "value",
  names_to = "type")

psdf_mmms_rand_long_o1$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_mmms_rand_long_o1))

psdf_mmms_rand_score_1_o1 <- psdf_mmms_rand_long_o1[
  psdf_mmms_rand_long_o1$type == score1,]
psdf_mmms_rand_score_2_o1 <- psdf_mmms_rand_long_o1[
  psdf_mmms_rand_long_o1$type == score2,]
psdf_mmms_rand_score_3_o1 <- psdf_mmms_rand_long_o1[
  psdf_mmms_rand_long_o1$type == score3,]
```

```{r o1_scoredf_9}
# mmms_vs_signrand
psdf_mmms_signrand_long_o1 <- tidyr::pivot_longer(
  psdf_hsc_mmms_signrand_o1, 
  c = c("mean_prop_cells_cluster", "adjusted_rand_index", "variation_information"),
  values_to = "value",
  names_to = "type")

psdf_mmms_signrand_long_o1$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_mmms_signrand_long_o1))

psdf_mmms_signrand_score_1_o1 <- psdf_mmms_signrand_long_o1[
  psdf_mmms_signrand_long_o1$type == score1,]
psdf_mmms_signrand_score_2_o1 <- psdf_mmms_signrand_long_o1[
  psdf_mmms_signrand_long_o1$type == score2,]
psdf_mmms_signrand_score_3_o1 <- psdf_mmms_signrand_long_o1[
  psdf_mmms_signrand_long_o1$type == score3,]
```

## Prep Boxplot Numbers

Prep all gene number boxplots etc.

### OWN

```{r own_numberdf_1}
# get the number of genes used for each gene set

# actual re-clustering
nr_sign_used_own <- sce_hsc_recl$cluster_signt_genes_used[1]
nr_mark_used_own <- sce_hsc_recl$cluster_consm_genes_used[1]
nr_mmms_used_own <- sce_hsc_recl$cluster_mmusm_genes_used[1]

# re-clustering permutation random genes used
# this is also a sanity check
nr_sign_rand_own <- psdf_hsc_sign_rand$nr_genes_used[1]
nr_mark_rand_own <- psdf_hsc_mark_rand$nr_genes_used[1]
nr_mmms_rand_own <- psdf_hsc_mmms_rand$nr_genes_used[1]
  
# for gene sets, get left-over random gene number and also gene number of 
# gene sets that are not cons sign
nr_mark_left_own <- nr_mark_used_own - nr_sign_used_own
nr_mmms_left_own <- nr_mmms_used_own - nr_sign_used_own

print(nr_sign_used_own)
print(nr_mark_used_own)
print(nr_mmms_used_own)
```

make dfs for visualisation of gene numbers with boxplots.

```{r own_numberdf_2}
vis_df_sign_rand_own <- base::data.frame(
  type_y = c(
    "conserved identity signature",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used_own,
    nr_sign_rand_own))

# factor for plot
vis_df_sign_rand_own$type_y <- factor(
  vis_df_sign_rand_own$type_y, levels = base::rev(c(
  "conserved identity signature",
  "permutation gene set")))

vis_df_sign_rand_own$type_fill <- factor(
  vis_df_sign_rand_own$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "random genes")))
```

```{r own_numberdf_3}
vis_df_mark_rand_own <- base::data.frame(
  type_y = c(
    "conserved markers",
    "conserved markers",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "conserved markers",
    "random genes"),
  number = c(
    nr_sign_used_own,
    nr_mark_left_own,
    nr_mark_rand_own))

# factor for plot
vis_df_mark_rand_own$type_fill <- factor(
  vis_df_mark_rand_own$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "conserved markers",
  "random genes")))
vis_df_mark_rand_own$type_y <- factor(
  vis_df_mark_rand_own$type_y, levels = base::rev(c(
  "conserved markers",
  "permutation gene set")))
```

```{r own_numberdf_4}
vis_df_mmms_rand_own <- base::data.frame(
  type_y = c(
    "BL6 markers",
    "BL6 markers",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "BL6 markers",
    "random genes"),
  number = c(
    nr_sign_used_own,
    nr_mmms_left_own,
    nr_mmms_rand_own))

vis_df_mmms_rand_own$type_fill <- factor(
  vis_df_mmms_rand_own$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "BL6 markers",
  "random genes")))
vis_df_mmms_rand_own$type_y <- factor(
  vis_df_mmms_rand_own$type_y, levels = base::rev(c(
  "BL6 markers",
  "permutation gene set")))
```

## Other 1

```{r o1_numberdf_1}

# get the number of genes used for each gene set
nr_sign_used_o1 <- selected_score_df_list_o1$seu_sign$nr_genes_used[1]
nr_sign_rand_o1 <- psdf_hsc_sign_rand_o1$nr_genes_used[1]
  
nr_mmms_used_o1 <- selected_score_df_list_o1$seu_mmms$nr_genes_used[1]
nr_mmms_perm_o1 <- psdf_hsc_mmms_rand_o1$nr_genes_used[1]

nr_mmms_left_o1 <- nr_mmms_perm_o1 - nr_sign_used_o1
nr_mmms_rand_o1 <- nr_mmms_left_o1

print(nr_sign_used_o1)
print(nr_mmms_used_o1)
```

```{r o1_numberdf_2}
vis_df_sign_rand_o1 <- base::data.frame(
  type_y = c(
    "conserved identity signature",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used_o1,
    nr_sign_rand_o1))

# factor for plot
vis_df_sign_rand_o1$type_y <- factor(
  vis_df_sign_rand_o1$type_y, levels = base::rev(c(
  "conserved identity signature",
  "permutation gene set")))

vis_df_sign_rand_o1$type_fill <- factor(
  vis_df_sign_rand_o1$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "random genes")))
```

```{r o1_numberdf_4}
vis_df_mmms_rand_o1 <- base::data.frame(
  type_y = c(
    "BL6 markers",
    "BL6 markers",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "BL6 markers",
    "random genes"),
  number = c(
    nr_sign_used_o1,
    nr_mmms_left_o1,
    nr_mmms_perm_o1))

vis_df_mmms_rand_o1$type_fill <- factor(
  vis_df_mmms_rand_o1$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "BL6 markers",
  "random genes")))
vis_df_mmms_rand_o1$type_y <- factor(
  vis_df_mmms_rand_o1$type_y, levels = base::rev(c(
  "BL6 markers",
  "permutation gene set")))
```

```{r o1_numberdf_5}
vis_df_mmms_signrand_o1 <- base::data.frame(
  type_y = c(
    "BL6 markers",
    "BL6 markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "BL6 markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used_o1,
    nr_mmms_left_o1,
    nr_sign_used_o1,
    nr_mmms_rand_o1))

vis_df_mmms_signrand_o1$type_fill <- factor(
  vis_df_mmms_signrand_o1$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "BL6 markers",
  "random genes")))
vis_df_mmms_signrand_o1$type_y <- factor(
  vis_df_mmms_signrand_o1$type_y, levels = base::rev(c(
  "BL6 markers",
  "permutation gene set")))
```

## Mins and Maxs

```{r minmax}

# think exactly about which value is even part of the data!!
all_vi <- c(
  
  # actual scores OWN
  score_df_hsc$value[score_df_hsc$type == "variation_information"],
  
  # permuted background scores  OWN
  psdf_hsc_sign_rand$variation_information,
  psdf_hsc_mark_rand$variation_information,
  psdf_hsc_mmms_rand$variation_information,
  
  # other dataset 1
  score_df_hsc_o1$value[score_df_hsc_o1$type == "variation_information"],
  
  psdf_hsc_sign_rand_o1$variation_information,
  psdf_hsc_mmms_rand_o1$variation_information,
  psdf_hsc_mmms_signrand_o1$variation_information#,
)

all_meanprop <- c(
  
  # actual scores
  score_df_hsc$value[score_df_hsc$type == "mean_prop_cells_cluster"],
  
  # permuted background scores for conserved signature
  psdf_hsc_sign_rand$mean_prop_cells_cluster,
  psdf_hsc_mark_rand$mean_prop_cells_cluster,
  psdf_hsc_mmms_rand$mean_prop_cells_cluster,

  # other dataset 1
  score_df_hsc_o1$value[score_df_hsc_o1$type == "mean_prop_cells_cluster"],
  
  psdf_hsc_sign_rand_o1$mean_prop_cells_cluster,
  psdf_hsc_mmms_rand_o1$mean_prop_cells_cluster,
  psdf_hsc_mmms_signrand_o1$mean_prop_cells_cluster#,
)

stopifnot(all_vi <= 0)
min_vi <- base::min(all_vi- 0.5)

min_mp <- 0
max_mp <- base::max(all_meanprop + 0.1)

all_nr_genes_BL6_markers <- c(
  nr_mmms_used_own,
  nr_mmms_used_o1
)

max_genes <- base::max(all_nr_genes_BL6_markers)

print(score1)
print(score2)
print(score3)
score1_min <- 0
score1_max <- 1

score2_min <- min_vi
score2_max <- 0

score3_min <- min_mp
score3_max <- max_mp
```

## Plots: Comparing OWN scores to random background

For Figure 3c.

#### Boxplots

```{r base_plot_bp1_own}
base_plot_bp1_own <- ggplot2::ggplot(
  vis_df_mmms_rand_own,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  geom_col()+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "BL6 markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp1_own
```

```{r theme_plot_bp1_own}
theme_plot_bp1_own<- base_plot_bp1_own+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size),
    axis.title.y = element_blank(),
    axis.text.y = element_blank())+
  xlab(nr_genes_title)
```

```{r base_plot_bp2_own}
base_plot_bp2_own <- ggplot2::ggplot(
  vis_df_mark_rand_own,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  geom_col()+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "conserved markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp2_own
```

```{r theme_plot_bp2_own}
theme_plot_bp2_own <- base_plot_bp2_own+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank())
```

```{r base_plot_bp3_own}
base_plot_bp3_own <- ggplot2::ggplot(
  vis_df_sign_rand_own,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  geom_col()+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "random genes" = 1)
  )
base_plot_bp3_own
```

```{r theme_plot_bp3_own}
theme_plot_bp3_own <- base_plot_bp3_own+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "bottom", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x= element_blank())+
  ggplot2::xlab(nr_genes_title)
```

#### Adjusted Rand index (Score 1)

```{r base_plot_ai1_own}
base_plot_ai1_own <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1,
  perm_score_df = psdf_mmms_rand_score_1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_ai1_own
```

```{r theme_plot_ai1_own}
theme_plot_ai1_own <- base_plot_ai1_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    #axis.line.x = element_blank(),
    #axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))+
  xlab(score1_long)
```

```{r base_plot_ai2_own}
base_plot_ai2_own <- make_pattern_density_plot(
  score_df = score_df_mark_score_1,
  perm_score_df = psdf_mark_rand_score_1,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "Conserved markers"
)
base_plot_ai2_own
```

```{r theme_plot_ai2_own}
theme_plot_ai2_own <- base_plot_ai2_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))+
  ggplot2::ggtitle(score1_long) 
```

```{r base_plot_ai3_own}
base_plot_ai3_own <- make_pattern_density_plot(
  score_df = score_df_sign_score_1,
  perm_score_df = psdf_sign_rand_score_1,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_ai3_own
```

```{r theme_plot_ai3_own}
theme_plot_ai3_own <- base_plot_ai3_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "bottom", 
    limits = c(score1_min, score1_max))+
  ggplot2::xlab(score1_long) 
```

#### Variation information (Score 2)

```{r base_plot_vi1_own}
base_plot_vi1_own <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2,
  perm_score_df = psdf_mmms_rand_score_2,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_vi1_own
```

```{r theme_plot_vi1_own}
theme_plot_vi1_own <- base_plot_vi1_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    #axis.line.x = element_blank(),
    #axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))+
  xlab(score2_long)
```

```{r base_plot_vi2_own}
base_plot_vi2_own <- make_pattern_density_plot(
  score_df = score_df_mark_score_2,
  perm_score_df = psdf_mark_rand_score_2,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "Conserved markers"
)
base_plot_vi2_own
```

```{r theme_plot_vi2_own}
theme_plot_vi2_own <- base_plot_vi2_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))+
  ggplot2::ggtitle(score2_long) 
```

```{r base_plot_vi3_own}
base_plot_vi3_own <- make_pattern_density_plot(
  score_df = score_df_sign_score_2,
  perm_score_df = psdf_sign_rand_score_2,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_vi3_own
```

```{r theme_plot_vi3_own}
theme_plot_vi3_own <- base_plot_vi3_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks.x = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "bottom", 
    limits = c(score2_min, score2_max))+
  ggplot2::xlab(score2_long) 
```

#### Mean prop (Score 3)

```{r base_plot_mp1_own}
base_plot_mp1_own <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3,
  perm_score_df = psdf_mmms_rand_score_3,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_mp1_own
```

```{r theme_plot_mp1_own}
theme_plot_mp1_own <- base_plot_mp1_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.title.y = element_blank()
    )+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))+
  xlab(score3_long)
```

```{r base_plot_mp2_own}
base_plot_mp2_own <- make_pattern_density_plot(
  score_df = score_df_mark_score_3,
  perm_score_df = psdf_mark_rand_score_3,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "Conserved markers"
)
base_plot_mp2_own
```

```{r theme_plot_mp2_own}
theme_plot_mp2_own <- base_plot_mp2_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))+
  ggplot2::ggtitle(score3_long) 
```

```{r base_plot_mp3_own}
head(psdf_sign_rand_score_3)
min(psdf_sign_rand_score_3$value)
max(psdf_sign_rand_score_3$value)
summary(psdf_sign_rand_score_3$value)

base_plot_mp3_own <- make_pattern_density_plot(
  score_df = score_df_sign_score_3,
  perm_score_df = psdf_sign_rand_score_3,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_mp3_own
print(summary(psdf_sign_rand_score_3$value))
```

```{r theme_plot_mp3_own}
theme_plot_mp3_own <- base_plot_mp3_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "bottom", 
    limits = c(score3_min, score3_max))
  ggplot2::xlab(score3_long) 
```

### Assemble

```{r assemble_bigplot_own, fig.width = 12, fig.height = 10}

b_plot_bp_own <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.5, 1, 1),
  align = "v",
  theme_plot_bp1_own,
  theme_plot_bp2_own,
  theme_plot_bp3_own
)

b_plot_ai_own <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.5, 1, 1),
  align = "v",
  theme_plot_ai1_own,
  theme_plot_ai2_own,
  theme_plot_ai3_own
)

b_plot_vi_own <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.5, 1, 1),
  align = "v",
  theme_plot_vi1_own,
  theme_plot_vi2_own,
  theme_plot_vi3_own
)

b_plot_mp_own <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.5, 1, 1),
  align = "v",
  theme_plot_mp1_own,
  theme_plot_mp2_own,
  theme_plot_mp3_own
)

```

```{r fig.width = 9, fig.height = 6.2}
b_plot <- ggpubr::ggarrange(
  ncol = 4,
  align = "hv",
  b_plot_bp_own,
  b_plot_ai_own,
  b_plot_vi_own,
  b_plot_mp_own, 
  widths = c(1, 1, 1, 1)
)
b_plot
```

### Export

```{r big_plot_own_export}
pdf(output_pdf_own_perm_plot, width = 9, height = 6.2)
b_plot
dev.off()
```

## Plots: Comparing OTHER 1 scores to random background

For Figure 3e.

#### Boxplots

```{r base_plot_bp1_o1}
base_plot_bp1_o1 <- ggplot2::ggplot(
  vis_df_mmms_rand_o1,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  geom_col()+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "BL6 markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp1_o1
```

```{r theme_plot_bp1_o1}
theme_plot_bp1_o1 <- base_plot_bp1_o1+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    plot.title = element_blank(),
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_blank())+
  ggplot2::xlab(nr_genes_title) 
```

```{r base_plot_bp3_o1}
base_plot_bp3_o1 <- ggplot2::ggplot(
  vis_df_sign_rand_o1,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  geom_col()+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "random genes" = 1)
  )
base_plot_bp3_o1
```

```{r theme_plot_bp3_o1}
theme_plot_bp3_o1 <- base_plot_bp3_o1+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x = element_blank())
```

#### Adjusted Rand index (Score 1)

```{r base_plot_ai1_o1}
base_plot_ai1_o1 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1_o1,
  perm_score_df = psdf_mmms_rand_score_1_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_ai1_o1
```

```{r theme_plot_ai1_o1}
theme_plot_ai1_o1 <- base_plot_ai1_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))+
  ggplot2::xlab(score1_long) 
```

```{r base_plot_ai3_o1}
base_plot_ai3_o1 <- make_pattern_density_plot(
  score_df = score_df_sign_score_1_o1,
  perm_score_df = psdf_sign_rand_score_1_o1,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_ai3_o1
```

```{r theme_plot_ai3_o1}
theme_plot_ai3_o1 <- base_plot_ai3_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    #axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "bottom", 
    limits = c(score1_min, score1_max))+
  ggplot2::ggtitle(score1_long) 
```

#### Variation information (Score 2)

```{r base_plot_vi1_o1}
base_plot_vi1_o1 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2_o1,
  perm_score_df = psdf_mmms_rand_score_2_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_vi1_o1
```

```{r theme_plot_vi1_o1}
theme_plot_vi1_o1 <- base_plot_vi1_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))+
  ggplot2::xlab(score2_long) 
```

```{r base_plot_vi3_o1}
base_plot_vi3_o1 <- make_pattern_density_plot(
  score_df = score_df_sign_score_2_o1,
  perm_score_df = psdf_sign_rand_score_2_o1,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_vi3_o1
```

```{r theme_plot_vi3_o1}
theme_plot_vi3_o1 <- base_plot_vi3_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    #axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "bottom", 
    limits = c(score2_min, score2_max))+
  ggplot2::ggtitle(score2_long) 
```

#### Mean prop (Score 3)

```{r base_plot_mp1_o1}
base_plot_mp1_o1 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3_o1,
  perm_score_df = psdf_mmms_rand_score_3_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_mp1_o1
```

```{r theme_plot_mp1_o1}
theme_plot_mp1_o1 <- base_plot_mp1_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))+
  ggplot2::xlab(score3_long) 
```

```{r base_plot_mp3_o1}
base_plot_mp3_o1 <- make_pattern_density_plot(
  score_df = score_df_sign_score_3_o1,
  perm_score_df = psdf_sign_rand_score_3_o1,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_mp3_o1
```

```{r theme_plot_mp3_o1}
theme_plot_mp3_o1 <- base_plot_mp3_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    #axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "bottom", 
    limits = c(score3_min, score3_max))+
  ggplot2::ggtitle(score3_long) 
```

### Assemble

```{r bigplot_assemble_o1, fig.width = 10, fig.height = 4}

plot_bp_o1 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.5, 1),
  align = "v",
  theme_plot_bp1_o1,
  theme_plot_bp3_o1
)

plot_ai_o1 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.5, 1),
  align = "v",
  theme_plot_ai1_o1,
  theme_plot_ai3_o1
)

plot_vi_o1 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.5, 1),
  align = "v",
  theme_plot_vi1_o1,
  theme_plot_vi3_o1
)

plot_mp_o1 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.5, 1),
  align = "v",
  theme_plot_mp1_o1,
  theme_plot_mp3_o1
)

```

```{r fig.width = 9, fig.height = 4}
big_plot_o1 <- ggpubr::ggarrange(
  nrow = 1,
  align = "hv",
  plot_bp_o1,
  plot_ai_o1,
  plot_vi_o1,
  plot_mp_o1, 
  widths = c(1, 1, 1, 1)
)
big_plot_o1
```

### Export

```{r big_plot_other_export}
pdf(output_pdf_o1_perm_plot, width = 9, height = 4.5)
big_plot_o1
dev.off()
```

## Plots: Compariong OTHER scores to signature + random background

For Figure 3f.

#### Boxplots 

```{r base_plot_bp1_o1_signrand}
base_plot_bp1_o1_signrand <- ggplot2::ggplot(
  vis_df_mmms_signrand_o1,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  geom_col()+
  # ggpattern::geom_col_pattern(
  #   #color = NA, 
  #   pattern_angle = 110,
  #   pattern_fill = pattern_fill_color,
  #   pattern_colour = pattern_line_colour,
  #   pattern_density = pattern_density_val,
  #   pattern_spacing = pattern_spacing_val
  # )+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "BL6 markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp1_o1_signrand
```

```{r theme_plot_bp1_o1_signrand}
theme_plot_bp1_o1_signrand <- base_plot_bp1_o1_signrand+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0, 400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    plot.title = element_blank(),
    legend.position = "none",
    axis.title = element_blank(),
    axis.text.y = element_blank())
```

#### Adjusted Rand index

```{r base_plot_ai1_o1_signrand}
base_plot_ai1_o1_signrand <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1_o1, # the actual score is the same as before
  perm_score_df = psdf_mmms_signrand_score_1_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_ai1_o1_signrand
```

```{r theme_plot_ai1_o1_signrand}
theme_plot_ai1_o1_signrand <- base_plot_ai1_o1_signrand+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))
```

#### Variation information

```{r base_plot_vi1_o1_signrand}
base_plot_vi1_o1_signrand <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2_o1,
  perm_score_df = psdf_mmms_signrand_score_2_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_vi1_o1_signrand
```

```{r theme_plot_vi1_o1_signrand}
theme_plot_vi1_o1_signrand <- base_plot_vi1_o1_signrand+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    #axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))
```

#### Mean prop (Score 3)

```{r base_plot_mp1_o1_signrand}
base_plot_mp1_o1_signrand <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3_o1,
  perm_score_df = psdf_mmms_signrand_score_3_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_mp1_o1_signrand
```

```{r theme_plot_mp1_o1_signrand}
theme_plot_mp1_o1_signrand <- base_plot_mp1_o1_signrand+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    #axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))
```

### Assemble

```{r big_plot_signrand, fig.width = 9, fig.height = 1.85}
big_plot_signrand <- ggpubr::ggarrange(
  ncol = 4,
  align = "h",
  theme_plot_bp1_o1_signrand,
  theme_plot_ai1_o1_signrand,
  theme_plot_vi1_o1_signrand,
  theme_plot_mp1_o1_signrand, 
  widths = c(1, 1, 1, 1)
)
big_plot_signrand
```

### Export

```{r big_plot_ALL_export}
pdf(output_pdf_mmms_sign_plot, width = 9, height = 2)
big_plot_signrand
dev.off()
```

# Own Heatmaps

Heatmaps of own re-clustered HSPC mouse data using signature genes/
conserved markers/BL6 markers/nDGEs.
For Figure 3b.

### Prep

```{r mat_sign}
mat_sign <- base::table(
  sce_hsc_recl$celltypes, 
  sce_hsc_recl$cluster_signt)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign)){
  mat_sign[,i] <- mat_sign[,i]/base::sum(mat_sign[,i])
}
sign_df <- base::as.data.frame(mat_sign)

# manually factorise clusters for nice order
sign_df$Var2 <- factor(
  sign_df$Var2,
  levels = base::rev(c(5, 4, 3, 2, 6, 8, 7, 1)))
```

```{r mat_mark}
mat_mark <- base::table(
  sce_hsc_recl$celltypes, 
  sce_hsc_recl$cluster_consm)

for(i in 1:ncol(mat_mark)){
  mat_mark[,i] <- mat_mark[,i]/base::sum(mat_mark[,i])
}
mark_df <- base::as.data.frame(mat_mark)

mark_df$Var2 <- factor(
  mark_df$Var2,
  levels = base::rev(c(7, 5, 10, 4, 2, 3, 9, 6, 8, 11, 1)))
```

```{r mat_mmms}
mat_mmms <- base::table(
  sce_hsc_recl$celltypes, 
  sce_hsc_recl$cluster_mmusm)

for(i in 1:ncol(mat_mmms)){
  mat_mmms[,i] <- mat_mmms[,i]/base::sum(mat_mmms[,i])
}
mmms_df <- base::as.data.frame(mat_mmms)

mmms_df$Var2 <- factor(
  mmms_df$Var2,
  levels = base::rev(c(12, 9, 6, 5, 4, 3, 2, 8, 7, 11, 10, 13, 1)))
```

### Plot Components

```{r heatmap_own_sign_base_plot}
heatmap_own_sign_base_plot <- ggplot2::ggplot(
  sign_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r heatmap_own_mark_base_plot}
heatmap_own_mark_base_plot <- ggplot2::ggplot(
  mark_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r heatmap_own_mmms_base_plot}
heatmap_own_mmms_base_plot <- ggplot2::ggplot(
  mmms_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r heatmap_own_mmms_theme_plot}
heatmap_own_mmms_theme_plot <- heatmap_own_mmms_base_plot+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank(),
    axis.ticks.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("BL6 markers")
```

```{r heatmap_own_mark_theme_plot}
heatmap_own_mark_theme_plot <- heatmap_own_mark_base_plot+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("Conserved markers")
```

```{r heatmap_own_sign_theme_plot}
heatmap_own_sign_theme_plot <- heatmap_own_sign_base_plot+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_text(
      margin = margin(t = 0.3, unit = "cm")),
    axis.text.x = element_text(
      angle = 90,
      hjust = 1,
      vjust = 0.5),
    plot.title = element_blank())+
  ggplot2::xlab("Reference cell types")+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("Conserved identity signature")
```

```{r heatmap_own_legend_theme_plot}
heatmap_own_legend_plot <- heatmap_own_mmms_base_plot+
  theme_all+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::theme(
    legend.title = element_text(
      margin = margin(r = 10),
      vjust = 0.85),
    legend.position = "bottom",
  )
heatmap_own_legend_theme <- ggpubr::get_legend(heatmap_own_legend_plot)
```

### Assemble

```{r heatmap_own_assemble, fig.height = 7.8, fig.width = 3}

heatmap_own_theme_plot <- ggpubr::ggarrange(
  ncol = 1,
  heatmap_own_mmms_theme_plot,
  heatmap_own_mark_theme_plot,
  heatmap_own_sign_theme_plot,
  align = "v",
  heights = c(1, 1, 2.5)
)

heatmap_own_theme_plot
```

### Legend

```{r heatmap_own_construct_legend, fig.width = 6, fig.height = 1}
heatmap_own_legend <- ggpubr::ggarrange(heatmap_own_legend_theme)
heatmap_own_legend
```

### Export

```{r heatmap_own_plot_export}
pdf(output_pdf_heatmap_own_plot, width = 4.13, height = 7.8)
heatmap_own_theme_plot
dev.off()
```

```{r heatmap_own_legend_export}
pdf(output_pdf_heatmap_own_legend, width = 6, height = 1)
heatmap_own_legend
dev.off()
```

# Other Heatmaps

For Figure 3d.

### Prep Other 1

```{r prep_cts}

levels(selected_seu_list_o1$seu_mmms$cell_type)
selected_seu_list_o1$seu_mmms$cell_type <- unfactor(selected_seu_list_o1$seu_mmms$cell_type)

selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "Slamf1-positive multipotent progenitor cell"] <- "Slamf1+ MPP"
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "Slamf1-negative multipotent progenitor cell"] <- "Slamf1- MPP."
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "granulocyte monocyte progenitor cell"] <- "granu-mono prog"
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "granulocytopoietic cell"] <- "granulocytopoietic"
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "hematopoietic precursor cell"] <- "hematopoietic precursor"
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "common lymphoid progenitor"] <- "common lymphoid pro"
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type ==  "megakaryocyte-erythroid progenitor cell"] <-  "mk-ery prog"


selected_seu_list_o1$seu_mmms$cell_type <- factor(
  selected_seu_list_o1$seu_mmms$cell_type,
  levels = c(
    "Slamf1+ MPP",
    "Slamf1- MPP",
    "hematopoietic precursor",
    "granulocytopoietic",
    "granu-mono prog",
    "mk-ery prog",
    "common lymphoid prog",
    "immature B cell"
  ))

```

```{r prep_cts_sign}

levels(selected_seu_list_o1$seu_sign$cell_type)
selected_seu_list_o1$seu_sign$cell_type <- unfactor(selected_seu_list_o1$seu_sign$cell_type)

selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "Slamf1-positive multipotent progenitor cell"] <- "Slamf1+ MPP"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "Slamf1-negative multipotent progenitor cell"] <- "Slamf1- MPP"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "granulocyte monocyte progenitor cell"] <- "granu-mono prog"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "granulocytopoietic cell"] <- "granulocytopoietic"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "hematopoietic precursor cell"] <- "hematopoietic precursor"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "common lymphoid progenitor"] <- "common lymphoid prog"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type ==  "megakaryocyte-erythroid progenitor cell"] <-  "mk-ery prog"


selected_seu_list_o1$seu_sign$cell_type <- factor(
  selected_seu_list_o1$seu_sign$cell_type,
  levels = c(
    "Slamf1+ MPP",
    "Slamf1- MPP",
    "hematopoietic precursor",
    "granulocytopoietic",
    "granu-mono prog",
    "mk-ery prog",
    "common lymphoid prog",
    "immature B cell"
  ))

```

```{r mat_mmms_o1}
mat_mmms_o1 <- base::table(selected_seu_list_o1$seu_mmms$cell_type, 
                           selected_seu_list_o1$seu_mmms$seurat_clusters)

for(i in 1:ncol(mat_mmms_o1)){
  mat_mmms_o1[,i] <- mat_mmms_o1[,i]/base::sum(mat_mmms_o1[,i])
}
mmms_df_o1 <- base::as.data.frame(mat_mmms_o1)

mmms_df_o1$Var2 <- factor(
  mmms_df_o1$Var2,
  levels = base::rev(c(1, 0, 4, 3, 5, 6, 2, 7)))
```

```{r mat_sign_o1}
mat_sign_o1 <- base::table(selected_seu_list_o1$seu_sign$cell_type, 
                           selected_seu_list_o1$seu_sign$seurat_clusters)

for(i in 1:ncol(mat_sign_o1)){
  mat_sign_o1[,i] <- mat_sign_o1[,i]/base::sum(mat_sign_o1[,i])
}
sign_df_o1 <- base::as.data.frame(mat_sign_o1)

sign_df_o1$Var2 <- factor(
  sign_df_o1$Var2,
  levels = base::rev(c(1, 0, 4, 9, 8, 6, 5, 7, 3, 2)))
```

### Plot Components Other 1

```{r mmms_base_plot_o1}
mmms_base_plot_o1 <- ggplot2::ggplot(
  mmms_df_o1, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
mmms_base_plot_o1
```

```{r sign_base_plot_o1}
sign_base_plot_o1 <- ggplot2::ggplot(
  sign_df_o1, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
sign_base_plot_o1
```

```{r mmms_theme_plot_o1}
mmms_theme_plot_o1 <- mmms_base_plot_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ylab("Reclustered")
```

```{r sign_theme_plot_o1}
sign_theme_plot_o1 <- sign_base_plot_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 90,
      hjust = 1,
      vjust = 0.5),
    axis.title = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::xlab("Reference cell types")+
  ggplot2::ylab("Reclustered")
```

### Assemble

```{r heatmaps_others_plot_construct, fig.width = 3, fig.height = 6.5}

d_theme_plot <- ggpubr::ggarrange(
  ncol = 1,
  mmms_theme_plot_o1,
  sign_theme_plot_o1,
  align = "v",
  heights = c(1, 2.8)
)

d_theme_plot
```

### Export

```{r heatmaps_others_plot_export}
pdf(output_pdf_heatmaps_others_plot, width = 4.13, height = 7)
d_theme_plot
dev.off()
```

# UTILS

```{r sessioninfo}
utils::sessionInfo()
```
