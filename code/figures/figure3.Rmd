---
title: "Figure 3"
date: '2024-09-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Generate Figure 3, current title:
"Mouse cell type signature genes alone are sufficient to identify cell types."

#### Load objects

```{r seed, message = FALSE}
base::RNGkind(kind = "Mersenne-Twister")
set.seed(37)
```

```{r load_packages, message = FALSE}
library(SingleCellExperiment, quietly = TRUE)
library(ggpubr, quietly = TRUE)
library(tidyverse, quietly = TRUE)
library(ggpattern, quietly = TRUE) # not in conda env
library(Seurat, quietly = TRUE) 
```

```{r load_manual_basepath}
base_path_input <- "/omics/odcf/analysis/OE0538_projects_temp/DO-0008/data_temp/micromamba_test_rerun/data"
```

```{r base_path_snakemake, eval = FALSE, include = FALSE}
base_path_input <- snakemake@input[["base_path_input"]]
base_path_output_temp <- snakemake@params[["base_path_output_temp"]]
```

```{r load_manual}
#-------------------------------------------------------------------------------
#### OWN DATASET (HSPCs)

# SCE with reclustering vectors for each gene set
sce_hsc_recl <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/03_recl/sce_hsc"))

# dataframe of re-clustering scores for each gene set
score_df_hsc <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/04_rcls/score_df_hsc"))

# dataframes of re-clustering scores after background permutation

# signature vs random
psdf_hsc_sign_rand <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_psig/perm_score_df_hsc"))

# conserved markers vs random
psdf_hsc_mark_rand <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_pmrk/perm_score_df_hsc"))

# BL6 markers vs random
psdf_hsc_mmms_rand <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_pmmm/perm_score_df_hsc"))
```

```{r load_manual_other1}
#-------------------------------------------------------------------------------
#### OTHER MOUSE DATASET 1 (HSPC)
#### MUS_TM_BONEMARROW

dataset_o1 <- "mus_tm_bonemarrow"

# list of seurat objects with reclustering vectors for each gene set and resolution
seu_hsc_recl_list_o1 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/03_recl/reclustered_mus_tm_bonemarrow_list"))

# list of dataframes of re-clustering scores for each gene set and resolution
score_df_hsc_list_o1 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/04_rcls/score_df_mus_tm_bonemarrow_list"))


# dataframes of re-clustering scores after permutation comparing to background
psdf_hsc_sign_rand_o1 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_psig/perm_score_df_mus_tm_bonemarrow"))

psdf_hsc_mmms_rand_o1 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_pmms/perm_score_df_mus_tm_bonemarrow"))

# dataframes of re-clustering scores after permutation comparing gene sets
# BL6 markers vs signature + random
psdf_hsc_mmms_signrand_o1 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_perg/perm_score_df_mmms_mus_tm_bonemarrow"))
```

```{r load_manual_other2, include = FALSE, eval = FALSE}
#-------------------------------------------------------------------------------
#### OTHER MOUSE DATASET 2 (HSPC)
#### MUS_WEINREB_HSPC

dataset_o2 <- "mus_weinreb_hspc"

# list of seurat objects with reclustering vectors for each gene set and resolution
seu_hsc_recl_list_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/03_recl/reclustered_mus_weinreb_hspc_list"))

# list of dataframes of re-clustering scores for each gene set and resolution
score_df_hsc_list_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/04_rcls/score_df_mus_weinreb_hspc_list"))

# perm score DF from background permutation (SIGN)
psdf_hsc_sign_rand_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_psig/perm_score_df_mus_weinreb_hspc"))
psdf_hsc_mmms_rand_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_pmms/perm_score_df_mus_weinreb_hspc"))

# dataframes of re-clustering scores after permutation comparing gene sets
# BL6 markers vs signature + random

psdf_hsc_mmms_signrand_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_perg/perm_score_df_mmms_mus_weinreb_hspc"))
```

```{r load_manual_remaining}
#-------------------------------------------------------------------------------
#### REMAINING

# list of gene sets for HSPCs (conserved signature, conserved markers, etc.)
geneset_list_hsc <-base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/01_gens/geneset_list_hsc"))

# data frame containing the correct resolutions for other datasets as visually determined
resolution_df_path <- base::paste0(
  base_path_input,
  "/metadata/scRNAseq/03_sce_analysis/reclustering_bm/reclustering_other_resolution.txt")

resolution_df <- utils::read.csv(file = resolution_df_path, 
                               header = TRUE, 
                               sep = ";", 
                               check.names=FALSE, 
                               stringsAsFactors=FALSE, 
                               as.is=TRUE, 
                               colClasses = "character")

corr_pval_df <-  readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/09_crpv/all_corrected_pval"))

colors_path <- base::paste0(
  base_path_input,
  "/metadata/colors/colors.txt")

source("../source/colors.R")
source("../source/plotting.R")
source("../source/sce_functions_reclustering.R")
```

```{r params}
# global params
source("determine_params.R")

point_plot_size <- 4

pattern_fill_color <- "black"
pattern_line_colour <- "black"
pattern_density_val <- 0.09
pattern_spacing_val <- 0.09


color_hline_background <- "grey97"

## CHECK SCORE MAX!!
score2 <- "variation_information"
score1 <- "adjusted_rand_index"
score3 <- "mean_prop_cells_cluster"

score2_long <- "Variation of\ninformation"
score1_long <- "Adjusted Rand\nindex"
score3_long <- "Mean\nproportion"

nr_genes_title <- "#genes\n "
```

```{r density_plot_function}
make_pattern_density_plot <- function(
  score_df,
  perm_score_df,
  color_cons,
  ylabel
  ){

  # make temp plot to extract maximum y value
  p_temp <- ggplot2::ggplot(
    perm_score_df,
    aes(x = value))+
    geom_density_pattern()
  
  # calculate the maximum y value (density at its peak)
  density_data <- ggplot2::ggplot_build(p_temp)$data[[1]]
  max_y <- max(density_data$y)
  
  # define the y value for the point as 125% of the maximum y value
  y_value <- 1.25 * max_y
  
  # define the y limits for a nicer plot + y value to place the break/label
  y_lim_low <- -0.25 * max_y
  y_lim_high <- 1.5 * max_y
  y_lim_break <- (y_lim_low + y_lim_high)/2 
  
  # add to score DF
  score_df$y_value <- y_value
  
  # plot
  p_return <- ggplot2::ggplot(
    perm_score_df,
    aes(x = value))+
    geom_density_pattern(
      fill = color_cons,
      color = color_cons,
      pattern = "stripe",
      pattern_angle = 110,
      pattern_fill = pattern_fill_color,
      pattern_colour = pattern_line_colour,
      pattern_density =pattern_density_val,
      pattern_spacing = pattern_spacing_val)+
    geom_point(
      inherit.aes = FALSE, 
      shape = 23,
      fill = color_cons,
      data = score_df,
      aes(x = value, y = y_value),
      size = point_plot_size,
      color = color_cons)+
    scale_y_continuous(
      limits = c(y_lim_low, y_lim_high),
      breaks = y_lim_break, 
      labels = ylabel)
  
  return(p_return)
  # TODO: add grey background if necessary
}

```

```{r export_paths}

output_pdf_heatmap_own_plot <- base::paste0(
   base_path_input, "/manuscript1/figure3/figure3_heatmap_own.pdf")
output_pdf_a_legend <- base::paste0(
  base_path_input, "/manuscript1/figure3/figure3_a_legend.pdf")

output_pdf_own_perm_plot <-  base::paste0(
   base_path_input, "/manuscript1/figure3/figure3_own_perm.pdf")
output_pdf_o1_perm_plot <-  base::paste0(
   base_path_input, "/manuscript1/figure3/figure3_o1_perm.pdf")
output_pdf_mmms_sign_plot <-  base::paste0(
   base_path_input, "/manuscript1/figure3/figure3_mmms_sign.pdf")

output_pdf_heatmaps_others_plot <- base::paste0(
   base_path_input, "/manuscript1/figure3/figure3_heatmaps_others.pdf")

output_pdf_ALL_plot <- base::paste0(
   base_path_input, "/manuscript1/figure3/figure3_all_dist_plots.pdf")
```

# Obtain data for text

```{r obtain_data}
print(sce_hsc_recl$cluster_signt_genes_used[1])
print(sce_hsc_recl$cluster_consm_genes_used[1])
print(sce_hsc_recl$cluster_mmusm_genes_used[1])
```


# Permutation Plots

## PREP ALL SCORE DFs 

Separate score DFs per conservation level and type of score.
For uniform axis limits, do it for all score DFs.

### OWN 

```{r own_scoredf_1}
# get the score DF of original HSC reclustering scores
head(score_df_hsc)

# flip VI so that it follows the same direction as the other two scores
score_df_hsc$value[
  score_df_hsc$type == "variation_information"] <- 0-score_df_hsc$value[
    score_df_hsc$type == "variation_information"]
```

```{r own_scoredf_2}
# subset to one re-clustering gene set (conserved identity signature)
score_df_sign <- score_df_hsc[
  score_df_hsc$conservation_level == "conserved_signature",]
# add nicer looking conservation level annotation
score_df_sign$conservation_level_long <- "conserved identity signature"

# subset to each score
score_df_sign_score_1 <- score_df_sign[score_df_sign$type == score1,]
score_df_sign_score_2 <- score_df_sign[score_df_sign$type == score2,]
score_df_sign_score_3 <- score_df_sign[score_df_sign$type == score3,]
```

```{r own_scoredf_3}
score_df_mark <- score_df_hsc[
  score_df_hsc$conservation_level == "conserved_markers",]
score_df_mark$conservation_level_long <- "conserved markers"

score_df_mark_score_1 <- score_df_mark[score_df_mark$type == score1,]
score_df_mark_score_2 <- score_df_mark[score_df_mark$type == score2,]
score_df_mark_score_3 <- score_df_mark[score_df_mark$type == score3,]
```

```{r own_scoredf_4}
score_df_mmms <- score_df_hsc[
  score_df_hsc$conservation_level == "mmusall_markers",]
score_df_mmms$conservation_level_long <- "BL6 markers"

score_df_mmms_score_1 <- score_df_mmms[score_df_mmms$type == score1,]
score_df_mmms_score_2 <- score_df_mmms[score_df_mmms$type == score2,]
score_df_mmms_score_3 <- score_df_mmms[score_df_mmms$type == score3,]
```

```{r perm_score_df_rand1}
# get the required permutated score DFs

# comparing each signature to completely random background
head(psdf_hsc_sign_rand)
head(psdf_hsc_mark_rand)
head(psdf_hsc_mmms_rand) 

# flip VI for each of them
psdf_hsc_sign_rand$variation_information <- 0-
  psdf_hsc_sign_rand$variation_information
psdf_hsc_mark_rand$variation_information <- 0-
  psdf_hsc_mark_rand$variation_information
psdf_hsc_mmms_rand$variation_information <- 0-
  psdf_hsc_mmms_rand$variation_information
```

```{r perm_score_df_rand2}
# also separate permutated score dfs by conservation level/type of score.

psdf_sign_rand_long <- tidyr::pivot_longer(
  psdf_hsc_sign_rand, 
  c = 1:ncol(psdf_hsc_sign_rand),
  values_to = "value",
  names_to = "type")

psdf_sign_rand_long$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_sign_rand_long))

psdf_sign_rand_score_1 <- psdf_sign_rand_long[
  psdf_sign_rand_long$type == score1,]
psdf_sign_rand_score_2 <- psdf_sign_rand_long[
  psdf_sign_rand_long$type == score2,]
psdf_sign_rand_score_3 <- psdf_sign_rand_long[
  psdf_sign_rand_long$type == score3,]
```

```{r perm_score_df_rand3}
# mark_rand is not calculated yet

psdf_mark_rand_long <- tidyr::pivot_longer(
  psdf_hsc_mark_rand, 
  c = 1:ncol(psdf_hsc_mark_rand),
  values_to = "value",
  names_to = "type")

psdf_mark_rand_long$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_mark_rand_long))

psdf_mark_rand_score_1 <- psdf_mark_rand_long[
  psdf_mark_rand_long$type == score1,]
psdf_mark_rand_score_2 <- psdf_mark_rand_long[
  psdf_mark_rand_long$type == score2,]
psdf_mark_rand_score_3 <- psdf_mark_rand_long[
  psdf_mark_rand_long$type == score3,]
```

```{r perm_score_df_rand4}
# mmms_rand is not calculated yet

psdf_mmms_rand_long <- tidyr::pivot_longer(
  psdf_hsc_mmms_rand, 
  c = 1:ncol(psdf_hsc_mmms_rand),
  values_to = "value",
  names_to = "type")

psdf_mmms_rand_long$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_mmms_rand_long))

psdf_mmms_rand_score_1 <- psdf_mmms_rand_long[
  psdf_mmms_rand_long$type == score1,]
psdf_mmms_rand_score_2 <- psdf_mmms_rand_long[
  psdf_mmms_rand_long$type == score2,]
psdf_mmms_rand_score_3 <- psdf_mmms_rand_long[
  psdf_mmms_rand_long$type == score3,]
```

```{r perm_score_df_sign1, include = FALSE, eval = FALSE}
# get the required permutated score DFs

# comparing two larger signatures to conserved identity signature
# head(psdf_hsc_mark_signrand)
# head(psdf_hsc_mmms_signrand) 
# 
# # flip VI for each of them
# psdf_hsc_mark_signrand$variation_information <- 0-
#   psdf_hsc_mark_signrand$variation_information
# psdf_hsc_mmms_signrand$variation_information <- 0-
#   psdf_hsc_mmms_signrand$variation_information
```

```{r perm_score_df_sign2, include = FALSE, eval = FALSE}
# psdf_mark_signrand_long <- tidyr::pivot_longer(
#   psdf_hsc_mark_signrand, 
#   c = 1:ncol(psdf_hsc_mark_signrand),
#   values_to = "value",
#   names_to = "type")
# 
# psdf_mark_signrand_long$conservation_level_long = base::rep(
#   "conserved markers", nrow(psdf_mark_signrand_long))
# 
# psdf_mark_signrand_score_1 <- psdf_mark_signrand_long[
#   psdf_mark_signrand_long$type == score1,]
# psdf_mark_signrand_score_2 <- psdf_mark_signrand_long[
#   psdf_mark_signrand_long$type == score2,]
# psdf_mark_signrand_score_3 <- psdf_mark_signrand_long[
#   psdf_mark_signrand_long$type == score3,]
```

```{r perm_score_df_sign3, include = FALSE, eval = FALSE}

# psdf_mmms_signrand_long <- tidyr::pivot_longer(
#   psdf_hsc_mmms_signrand, 
#   c = 1:ncol(psdf_hsc_mmms_signrand),
#   values_to = "value",
#   names_to = "type")
# 
# psdf_mmms_signrand_long$conservation_level_long = base::rep(
#   "BL6 markers", nrow(psdf_mmms_signrand_long))
# 
# psdf_mmms_signrand_score_1 <- psdf_mmms_signrand_long[
#   psdf_mmms_signrand_long$type == score1,]
# psdf_mmms_signrand_score_2 <- psdf_mmms_signrand_long[
#   psdf_mmms_signrand_long$type == score2,]
# psdf_mmms_signrand_score_3 <- psdf_mmms_signrand_long[
#   psdf_mmms_signrand_long$type == score3,]
```

### OTHER 1 

```{r o1_scoredf_1}

# extract only the info on the object re-clustered with the chosen resolution
# this is also required for the heatmaps

# seurat object
resolution_df_o1 <- resolution_df[resolution_df$dataset == dataset_o1,]

selected_seu_list_o1 <- lapply(seu_hsc_recl_list_o1, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  resdf_temp <- resolution_df_o1[
    resolution_df_o1$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
})

# original score DF
selected_score_df_list_o1 <- lapply(score_df_hsc_list_o1, function(score_df_list){
  
  conslev_curr <- score_df_list[[1]]$conservation_level[1]
  resdf_temp <- resolution_df_o1[
    resolution_df_o1$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  score_df_return <- score_df_list[[res_curr]]
  return(score_df_return)
  
})
score_df_hsc_o1 <- dplyr::bind_rows(selected_score_df_list_o1)

# flip VI
score_df_hsc_o1$value[
  score_df_hsc_o1$type == "variation_information"] <- 0-score_df_hsc_o1$value[
    score_df_hsc_o1$type == "variation_information"]
```

```{r o1_scoredf_2}
# separate original score DF by gene set and by score type
score_df_sign_o1 <- score_df_hsc_o1[
  score_df_hsc_o1$conservation_level == "conserved_signature",]
score_df_sign_o1$conservation_level_long <- "conserved identity signature"

score_df_sign_score_1_o1 <- score_df_sign_o1[
  score_df_sign_o1$type == score1,]
score_df_sign_score_2_o1 <- score_df_sign_o1[
  score_df_sign_o1$type == score2,]
score_df_sign_score_3_o1 <- score_df_sign_o1[
  score_df_sign_o1$type == score3,]
```

```{r o1_scoredf_3, eval = FALSE, include = FALSE}
# score_df_mark_o1 <- score_df_hsc_o1[
#   score_df_hsc_o1$conservation_level == "conserved_markers",]
# score_df_mark_o1$conservation_level_long <- "conserved markers"
# 
# score_df_mark_score_1_o1 <- score_df_mark_o1[
#   score_df_mark_o1$type == score1,]
# score_df_mark_score_2_o1 <- score_df_mark_o1[
#   score_df_mark_o1$type == score2,]
# score_df_mark_score_3_o1 <- score_df_mark_o1[
#   score_df_mark_o1$type == score3,]
```

```{r o1_scoredf_4}
score_df_mmms_o1  <- score_df_hsc_o1[
  score_df_hsc_o1$conservation_level == "mmusall_markers",]
score_df_mmms_o1$conservation_level_long <- "BL6 markers"

score_df_mmms_score_1_o1 <- score_df_mmms_o1[
  score_df_mmms_o1$type == score1,]
score_df_mmms_score_2_o1 <- score_df_mmms_o1[
  score_df_mmms_o1$type == score2,]
score_df_mmms_score_3_o1 <- score_df_mmms_o1[
  score_df_mmms_o1$type == score3,]
```

```{r o1_scoredf_5}

# same for permutation gene sets

# vs background
head(psdf_hsc_sign_rand_o1)
head(psdf_hsc_mmms_rand_o1)

psdf_hsc_sign_rand_o1$variation_information <- 0-
  psdf_hsc_sign_rand_o1$variation_information
psdf_hsc_mmms_rand_o1$variation_information <- 0-
  psdf_hsc_mmms_rand_o1$variation_information

# vs signature + background
head(psdf_hsc_mmms_signrand_o1)

psdf_hsc_mmms_signrand_o1$variation_information <- 0-
  psdf_hsc_mmms_signrand_o1$variation_information
```

```{r o1_scoredf_6}

# also separate permutated score dfs by conservation level/type of score.
# sign
psdf_sign_rand_long_o1 <- tidyr::pivot_longer(
  psdf_hsc_sign_rand_o1, 
  c = c("mean_prop_cells_cluster", "adjusted_rand_index", "variation_information"),
  values_to = "value",
  names_to = "type")

psdf_sign_rand_long_o1$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_sign_rand_long_o1))

psdf_sign_rand_score_1_o1 <- psdf_sign_rand_long_o1[
  psdf_sign_rand_long_o1$type == score1,]
psdf_sign_rand_score_2_o1 <- psdf_sign_rand_long_o1[
  psdf_sign_rand_long_o1$type == score2,]
psdf_sign_rand_score_3_o1 <- psdf_sign_rand_long_o1[
  psdf_sign_rand_long_o1$type == score3,]
```

```{r o1_scoredf_8}
# mmms
psdf_mmms_rand_long_o1 <- tidyr::pivot_longer(
  psdf_hsc_mmms_rand_o1, 
  c = c("mean_prop_cells_cluster", "adjusted_rand_index", "variation_information"),
  values_to = "value",
  names_to = "type")

psdf_mmms_rand_long_o1$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_mmms_rand_long_o1))

psdf_mmms_rand_score_1_o1 <- psdf_mmms_rand_long_o1[
  psdf_mmms_rand_long_o1$type == score1,]
psdf_mmms_rand_score_2_o1 <- psdf_mmms_rand_long_o1[
  psdf_mmms_rand_long_o1$type == score2,]
psdf_mmms_rand_score_3_o1 <- psdf_mmms_rand_long_o1[
  psdf_mmms_rand_long_o1$type == score3,]
```

```{r o1_scoredf_7, include = FALSE, eval = FALSE}

# psdf_mark_signrand_long_o1 <- tidyr::pivot_longer(
#   psdf_hsc_mark_signrand_o1, 
#   c = 1:ncol(psdf_hsc_mark_signrand_o1),
#   values_to = "value",
#   names_to = "type")
# psdf_mark_signrand_long_o1$conservation_level_long = base::rep(
#   "conserved markers", nrow(psdf_mark_signrand_long_o1))
# 
# psdf_mark_signrand_score_1_o1 <- psdf_mark_signrand_long_o1[
#   psdf_mark_signrand_long_o1$type == score1,]
# psdf_mark_signrand_score_2_o1 <- psdf_mark_signrand_long_o1[
#   psdf_mark_signrand_long_o1$type == score2,]
# psdf_mark_signrand_score_3_o1 <- psdf_mark_signrand_long_o1[
#   psdf_mark_signrand_long_o1$type == score3,]
```

```{r o1_scoredf_8}
# mmms_vs_signrand
psdf_mmms_signrand_long_o1 <- tidyr::pivot_longer(
  psdf_hsc_mmms_signrand_o1, 
  c = c("mean_prop_cells_cluster", "adjusted_rand_index", "variation_information"),
  values_to = "value",
  names_to = "type")

psdf_mmms_signrand_long_o1$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_mmms_signrand_long_o1))

psdf_mmms_signrand_score_1_o1 <- psdf_mmms_signrand_long_o1[
  psdf_mmms_signrand_long_o1$type == score1,]
psdf_mmms_signrand_score_2_o1 <- psdf_mmms_signrand_long_o1[
  psdf_mmms_signrand_long_o1$type == score2,]
psdf_mmms_signrand_score_3_o1 <- psdf_mmms_signrand_long_o1[
  psdf_mmms_signrand_long_o1$type == score3,]
```

### OTHER 2 

```{r o2_scoredf_1, include = FALSE, eval = FALSE}

resolution_df_o2 <- resolution_df[resolution_df$dataset == dataset_o2,]

selected_seu_list_o2 <- lapply(seu_hsc_recl_list_o2, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  resdf_temp <- resolution_df_o2[resolution_df_o2$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
})

selected_score_df_list_o2 <- lapply(score_df_hsc_list_o2, function(score_df_list){
  
  conslev_curr <- score_df_list[[1]]$conservation_level[1]
  resdf_temp <- resolution_df_o2[
    resolution_df_o2$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  score_df_return <- score_df_list[[res_curr]]
  return(score_df_return)
})
score_df_hsc_o2 <- dplyr::bind_rows(selected_score_df_list_o2)

# flip VI
score_df_hsc_o2$value[
  score_df_hsc_o2$type == "variation_information"] <- 0-score_df_hsc_o2$value[
    score_df_hsc_o2$type == "variation_information"]
```

```{r o2_scoredf_2, include = FALSE, eval = FALSE}
score_df_sign_o2 <- score_df_hsc_o2[
  score_df_hsc_o2$conservation_level == "conserved_signature",]
score_df_sign_o2$conservation_level_long <- "conserved identity signature"

score_df_sign_score_1_o2 <- score_df_sign_o2[
  score_df_sign_o2$type == score1,]
score_df_sign_score_2_o2 <- score_df_sign_o2[
  score_df_sign_o2$type == score2,]
score_df_sign_score_3_o2 <- score_df_sign_o2[
  score_df_sign_o2$type == score3,]
```

```{r o2_scoredf_3, include = FALSE, eval = FALSE}
# score_df_mark_o2 <- score_df_hsc_o2[
#   score_df_hsc_o2$conservation_level == "conserved_markers",]
# score_df_mark_o2$conservation_level_long <- "conserved markers"
# 
# score_df_mark_score_1_o2 <- score_df_mark_o2[
#   score_df_mark_o2$type == score1,]
# score_df_mark_score_2_o2 <- score_df_mark_o2[
#   score_df_mark_o2$type == score2,]
# score_df_mark_score_3_o2 <- score_df_mark_o2[
#   score_df_mark_o2$type == score3,]
```

```{r o2_scoredf_4, include = FALSE, eval = FALSE}
score_df_mmms_o2  <- score_df_hsc_o2[
  score_df_hsc_o2$conservation_level == "mmusall_markers",]
score_df_mmms_o2$conservation_level_long <- "BL6 markers"

score_df_mmms_score_1_o2 <- score_df_mmms_o2[
  score_df_mmms_o2$type == score1,]
score_df_mmms_score_2_o2 <- score_df_mmms_o2[
  score_df_mmms_o2$type == score2,]
score_df_mmms_score_3_o2 <- score_df_mmms_o2[
  score_df_mmms_o2$type == score3,]
```

```{r o2_scoredf_5, include = FALSE, eval = FALSE}

head(psdf_hsc_sign_rand_o2)
head(psdf_hsc_mmms_rand_o2)
psdf_hsc_sign_rand_o2$variation_information <- 0-
  psdf_hsc_sign_rand_o2$variation_information
psdf_hsc_mmms_rand_o2$variation_information <- 0-
  psdf_hsc_mmms_rand_o2$variation_information

head(psdf_hsc_mmms_signrand_o2)
psdf_hsc_mmms_signrand_o2$variation_information <- 0-
  psdf_hsc_mmms_signrand_o2$variation_information

```

```{r o2_scoredf_6, include = FALSE, eval = FALSE}
# sign
psdf_sign_rand_long_o2 <- tidyr::pivot_longer(
  psdf_hsc_sign_rand_o2, 
  c = c("mean_prop_cells_cluster", "adjusted_rand_index", "variation_information"),
  values_to = "value",
  names_to = "type")

psdf_sign_rand_long_o2$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_sign_rand_long_o2))

psdf_sign_rand_score_1_o2 <- psdf_sign_rand_long_o2[
  psdf_sign_rand_long_o2$type == score1,]
psdf_sign_rand_score_2_o2 <- psdf_sign_rand_long_o2[
  psdf_sign_rand_long_o2$type == score2,]
psdf_sign_rand_score_3_o2 <- psdf_sign_rand_long_o2[
  psdf_sign_rand_long_o2$type == score3,]
```

```{r o2_scoredf_7, include = FALSE, eval = FALSE}
# mmms
psdf_mmms_rand_long_o2 <- tidyr::pivot_longer(
  psdf_hsc_mmms_rand_o2, 
  c = c("mean_prop_cells_cluster", "adjusted_rand_index", "variation_information"),
  values_to = "value",
  names_to = "type")

psdf_mmms_rand_long_o2$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_mmms_rand_long_o2))

psdf_mmms_rand_score_1_o2 <- psdf_mmms_rand_long_o2[
  psdf_mmms_rand_long_o2$type == score1,]
psdf_mmms_rand_score_2_o2 <- psdf_mmms_rand_long_o2[
  psdf_mmms_rand_long_o2$type == score2,]
psdf_mmms_rand_score_3_o2 <- psdf_mmms_rand_long_o2[
  psdf_mmms_rand_long_o2$type == score3,]
```

```{r o2_scoredf_8, include = FALSE, eval = FALSE}

psdf_mmms_signrand_long_o2 <- tidyr::pivot_longer(
  psdf_hsc_mmms_signrand_o2,
  c = 1:ncol(psdf_hsc_mmms_signrand_o2),
  values_to = "value",
  names_to = "type")
psdf_mmms_signrand_long_o2$conservation_level_long = base::rep(
  "BL6 markers", nrow(psdf_mmms_signrand_long_o2))

psdf_mmms_signrand_score_1_o2 <- psdf_mmms_signrand_long_o2[
  psdf_mmms_signrand_long_o2$type == score1,]
psdf_mmms_signrand_score_2_o2 <- psdf_mmms_signrand_long_o2[
  psdf_mmms_signrand_long_o2$type == score2,]
psdf_mmms_signrand_score_3_o2 <- psdf_mmms_signrand_long_o2[
  psdf_mmms_signrand_long_o2$type  == score3,]
```

```{r o2_scoredf_9, include = FALSE, eval = FALSE}
# 
# psdf_mark_signrand_long_o2 <- pivot_longer(
#   psdf_hsc_mark_signrand_o2, 
#   c = 1:ncol(psdf_hsc_mark_signrand_o2),
#   values_to = "value",
#   names_to = "type")
# psdf_mark_signrand_long_o2$conservation_level_long = base::rep(
#   "conserved markers", nrow(psdf_mark_signrand_long_o2))
# 
# psdf_mark_signrand_score_1_o2 <- psdf_mark_signrand_long_o2[
#   psdf_mark_signrand_long_o2$type == score1,]
# psdf_mark_signrand_score_2_o2 <- psdf_mark_signrand_long_o2[
#   psdf_mark_signrand_long_o2$type == score2,]
# psdf_mark_signrand_score_3_o2 <- psdf_mark_signrand_long_o2[
#   psdf_mark_signrand_long_o2$type == score3,]
```

## Prep Boxplot Numbers

Prep all gene number boxplots etc.

### OWN

```{r own_numberdf_1}
# get the number of genes used for each gene set

# actual re-clustering
nr_sign_used_own <- sce_hsc_recl$cluster_signt_genes_used[1]
nr_mark_used_own <- sce_hsc_recl$cluster_consm_genes_used[1]
nr_mmms_used_own <- sce_hsc_recl$cluster_mmusm_genes_used[1]

# re-clustering permutation random genes used
# this is also a sanity check
nr_sign_rand_own <- psdf_hsc_sign_rand$nr_genes_used[1]
nr_mark_rand_own <- psdf_hsc_mark_rand$nr_genes_used[1]
nr_mmms_rand_own <- psdf_hsc_mmms_rand$nr_genes_used[1]
  
# for gene sets, get left-over random gene number and also gene number of 
# gene sets that are not cons sign
nr_mark_left_own <- nr_mark_used_own - nr_sign_used_own
nr_mmms_left_own <- nr_mmms_used_own - nr_sign_used_own

print(nr_sign_used_own)
print(nr_mark_used_own)
print(nr_mmms_used_own)
```

make dfs for visualisation of gene numbers with boxplots.

```{r own_numberdf_2}
vis_df_sign_rand_own <- base::data.frame(
  type_y = c(
    "conserved identity signature",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used_own,
    nr_sign_rand_own))

# factor for plot
vis_df_sign_rand_own$type_y <- factor(
  vis_df_sign_rand_own$type_y, levels = base::rev(c(
  "conserved identity signature",
  "permutation gene set")))

vis_df_sign_rand_own$type_fill <- factor(
  vis_df_sign_rand_own$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "random genes")))
```

```{r own_numberdf_3}
vis_df_mark_rand_own <- base::data.frame(
  type_y = c(
    "conserved markers",
    "conserved markers",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "conserved markers",
    "random genes"),
  number = c(
    nr_sign_used_own,
    nr_mark_left_own,
    nr_mark_rand_own))

# factor for plot
vis_df_mark_rand_own$type_fill <- factor(
  vis_df_mark_rand_own$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "conserved markers",
  "random genes")))
vis_df_mark_rand_own$type_y <- factor(
  vis_df_mark_rand_own$type_y, levels = base::rev(c(
  "conserved markers",
  "permutation gene set")))
```

```{r own_numberdf_3_old, include = FALSE, eval = FALSE}
# vis_df_mark_own <- base::data.frame(
#   type_y = c(
#     "conserved markers",
#     "conserved markers",
#     "permutation gene set",
#     "permutation gene set"),
#   type_fill = c(
#     "conserved identity signature",
#     "conserved markers",
#     "conserved identity signature",
#     "random genes"),
#   number = c(
#     nr_sign_used_own,
#     nr_mark_left_own,
#     nr_sign_used_own,
#     nr_mark_left_own)
# )

# vis_df_mark_own$type_fill <- factor(
#   vis_df_mark_own$type_fill, levels = base::rev(c(
#   "conserved identity signature",
#   "conserved markers",
#   "random genes"
# )))
# vis_df_mark_own$type_y <- factor(
#   vis_df_mark_own$type_y, levels = base::rev(c(
#   "conserved markers",
#   "permutation gene set"
# )))


```

```{r own_numberdf_4}
vis_df_mmms_rand_own <- base::data.frame(
  type_y = c(
    "BL6 markers",
    "BL6 markers",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "BL6 markers",
    "random genes"),
  number = c(
    nr_sign_used_own,
    nr_mmms_left_own,
    nr_mmms_rand_own))

vis_df_mmms_rand_own$type_fill <- factor(
  vis_df_mmms_rand_own$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "BL6 markers",
  "random genes")))
vis_df_mmms_rand_own$type_y <- factor(
  vis_df_mmms_rand_own$type_y, levels = base::rev(c(
  "BL6 markers",
  "permutation gene set")))
```

```{r own_numberdf_4_old, include = FALSE, eval = FALSE}
# 
# vis_df_mmms_own <- base::data.frame(
#   type_y = c(
#     "BL6 markers",
#     "BL6 markers",
#     "permutation gene set",
#     "permutation gene set"),
#   type_fill = c(
#     "conserved identity signature",
#     "BL6 markers",
#     "conserved identity signature",
#     "random genes"),
#   number = c(
#     nr_sign_used_own,
#     nr_mmms_left_own,
#     nr_sign_used_own,
#     nr_mmms_left_own)
# )

# vis_df_mmms_own$type_fill <- factor(
#   vis_df_mmms_own$type_fill, levels = base::rev(c(
#   "conserved identity signature",
#   "BL6 markers",
#   "random genes"
# )))
# vis_df_mmms_own$type_y <- factor(
#   vis_df_mmms_own$type_y, levels = base::rev(c(
#   "BL6 markers",
#   "permutation gene set"
# )))

```

## Other 1

```{r o1_numberdf_1}

# get the number of genes used for each gene set
nr_sign_used_o1 <- selected_score_df_list_o1$seu_sign$nr_genes_used[1]
nr_sign_rand_o1 <- psdf_hsc_sign_rand_o1$nr_genes_used[1]
  
nr_mmms_used_o1 <- selected_score_df_list_o1$seu_mmms$nr_genes_used[1]
nr_mmms_perm_o1 <- psdf_hsc_mmms_rand_o1$nr_genes_used[1]

nr_mmms_left_o1 <- nr_mmms_perm_o1 - nr_sign_used_o1
nr_mmms_rand_o1 <- nr_mmms_left_o1

print(nr_sign_used_o1)
print(nr_mmms_used_o1)
```

```{r o1_numberdf_2}
vis_df_sign_rand_o1 <- base::data.frame(
  type_y = c(
    "conserved identity signature",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used_o1,
    nr_sign_rand_o1))

# factor for plot
vis_df_sign_rand_o1$type_y <- factor(
  vis_df_sign_rand_o1$type_y, levels = base::rev(c(
  "conserved identity signature",
  "permutation gene set")))

vis_df_sign_rand_o1$type_fill <- factor(
  vis_df_sign_rand_o1$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "random genes")))
```

```{r o1_numberdf_3, include = FALSE, eval = FALSE}
# vis_df_mark_o1 <- base::data.frame(
#   type_y = c(
#     "conserved markers",
#     "conserved markers",
#     "permutation gene set",
#     "permutation gene set"),
#   type_fill = c(
#     "conserved identity signature",
#     "conserved markers",
#     "conserved identity signature",
#     "random genes"),
#   number = c(
#     nr_sign_used_o1,
#     nr_mark_left_o1,
#     nr_sign_used_o1,
#     nr_mark_rand_o1)
# )
# 
# # factor for plot
# vis_df_mark_o1$type_fill <- factor(vis_df_mark_o1$type_fill, 
#                                    levels = base::rev(c(
#   "conserved identity signature",
#   "conserved markers",
#   "random genes"
# )))
# vis_df_mark_o1$type_y <- factor(vis_df_mark_o1$type_y, 
#                                 levels = base::rev(c(
#   "conserved markers",
#   "permutation gene set"
# )))
```

```{r o1_numberdf_4}
vis_df_mmms_rand_o1 <- base::data.frame(
  type_y = c(
    "BL6 markers",
    "BL6 markers",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "BL6 markers",
    "random genes"),
  number = c(
    nr_sign_used_o1,
    nr_mmms_left_o1,
    nr_mmms_perm_o1))

vis_df_mmms_rand_o1$type_fill <- factor(
  vis_df_mmms_rand_o1$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "BL6 markers",
  "random genes")))
vis_df_mmms_rand_o1$type_y <- factor(
  vis_df_mmms_rand_o1$type_y, levels = base::rev(c(
  "BL6 markers",
  "permutation gene set")))
```

```{r o1_numberdf_5}
vis_df_mmms_signrand_o1 <- base::data.frame(
  type_y = c(
    "BL6 markers",
    "BL6 markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "BL6 markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used_o1,
    nr_mmms_left_o1,
    nr_sign_used_o1,
    nr_mmms_rand_o1))

vis_df_mmms_signrand_o1$type_fill <- factor(
  vis_df_mmms_signrand_o1$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "BL6 markers",
  "random genes")))
vis_df_mmms_signrand_o1$type_y <- factor(
  vis_df_mmms_signrand_o1$type_y, levels = base::rev(c(
  "BL6 markers",
  "permutation gene set")))
```

```{r o1_numberdf_4_old, include = FALSE, eval = FALSE}
# vis_df_mmms_o1 <- base::data.frame(
#   type_y = c(
#     "BL6 markers",
#     "BL6 markers",
#     "permutation gene set",
#     "permutation gene set"),
#   type_fill = c(
#     "conserved identity signature",
#     "BL6 markers",
#     "conserved identity signature",
#     "random genes"),
#   number = c(
#     nr_sign_used_o1,
#     nr_mmms_left_o1,
#     nr_sign_used_o1,
#     nr_mmms_rand_o1)
# )

# vis_df_mmms_o1$type_fill <- factor(vis_df_mmms_o1$type_fill, 
#                                    levels = base::rev(c(
#   "conserved identity signature",
#   "BL6 markers",
#   "random genes"
# )))
# vis_df_mmms_o1$type_y <- factor(vis_df_mmms_o1$type_y, 
#                                 levels = base::rev(c(
#   "BL6 markers",
#   "permutation gene set"
# )))
```

## Other 2

```{r o2_numberdf_1, include = FALSE, eval = FALSE}

# get the number of genes used for each gene set
nr_sign_used_o2 <- selected_score_df_list_o2$seu_sign$nr_genes_used[1]
nr_sign_rand_o2 <- psdf_hsc_sign_rand_o2$nr_genes_used[1]

nr_mmms_used_o2 <- selected_score_df_list_o2$seu_mmms$nr_genes_used[1]
nr_mmms_perm_o2 <- psdf_hsc_mmms_rand_o2$nr_genes_used[1]

nr_mmms_left_o2 <- nr_mmms_used_o2 - nr_sign_used_o2
nr_mmms_rand_o2 <- nr_mmms_left_o2

print(nr_sign_used_o2)
print(nr_mmms_used_o2)
```

```{r o2_numberdf_2, include = FALSE, eval = FALSE}
vis_df_sign_rand_o2 <- base::data.frame(
  type_y = c(
    "conserved identity signature",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used_o2,
    nr_sign_rand_o2))

vis_df_sign_rand_o2$type_y <- factor(
  vis_df_sign_rand_o2$type_y, levels = base::rev(c(
  "conserved identity signature",
  "permutation gene set")))
vis_df_sign_rand_o2$type_fill <- factor(
  vis_df_sign_rand_o2$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "random genes")))
```

```{r o2_numberdf_3, eval = FALSE, include = FALSE}
# vis_df_mark_o2 <- base::data.frame(
#   type_y = c(
#     "conserved markers",
#     "conserved markers",
#     "permutation gene set",
#     "permutation gene set"),
#   type_fill = c(
#     "conserved identity signature",
#     "conserved markers",
#     "conserved identity signature",
#     "random genes"),
#   number = c(
#     nr_sign_used_o2,
#     nr_mark_left_o2,
#     nr_sign_used_o2,
#     nr_mark_rand_o2)
# )
# 
# # factor for plot
# vis_df_mark_o2$type_fill <- factor(vis_df_mark_o2$type_fill, 
#                                    levels = base::rev(c(
#   "conserved identity signature",
#   "conserved markers",
#   "random genes"
# )))
# vis_df_mark_o2$type_y <- factor(vis_df_mark_o2$type_y,
#                                 levels = base::rev(c(
#   "conserved markers",
#   "permutation gene set"
# )))
```

```{r o2_numberdf_4, include = FALSE, eval = FALSE}

vis_df_mmms_rand_o2 <- base::data.frame(
  type_y = c(
    "BL6 markers",
    "BL6 markers",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "BL6 markers",
    "random genes"),
  number = c(
    nr_sign_used_o2,
    nr_mmms_left_o2,
    nr_mmms_perm_o2))

vis_df_mmms_rand_o2$type_fill <- factor(
  vis_df_mmms_rand_o2$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "BL6 markers",
  "random genes")))
vis_df_mmms_rand_o2$type_y <- factor(
  vis_df_mmms_rand_o2$type_y, levels = base::rev(c(
  "BL6 markers",
  "permutation gene set")))
```

```{r o2_numberdf_5, include = FALSE, eval = FALSE}

vis_df_mmms_signrand_o2 <- base::data.frame(
  type_y = c(
    "BL6 markers",
    "BL6 markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "BL6 markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used_o2,
    nr_mmms_left_o2,
    nr_sign_used_o2,
    nr_mmms_rand_o2))

vis_df_mmms_signrand_o2$type_fill <- factor(
  vis_df_mmms_signrand_o2$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "BL6 markers",
  "random genes")))
vis_df_mmms_signrand_o2$type_y <- factor(
  vis_df_mmms_signrand_o2$type_y, levels = base::rev(c(
  "BL6 markers",
  "permutation gene set")))
```

```{r o2_numberdf_4_old, include = FALSE, eval = FALSE}
# vis_df_mmms_o2 <- base::data.frame(
#   type_y = c(
#     "BL6 markers",
#     "BL6 markers",
#     "permutation gene set",
#     "permutation gene set"),
#   type_fill = c(
#     "conserved identity signature",
#     "BL6 markers",
#     "conserved identity signature",
#     "random genes"),
#   number = c(
#     nr_sign_used_o2,
#     nr_mmms_left_o2,
#     nr_sign_used_o2,
#     nr_mmms_rand_o2)
# )
# 
# vis_df_mmms_o2$type_fill <- factor(vis_df_mmms_o2$type_fill,
#                                    levels = base::rev(c(
#   "conserved identity signature",
#   "BL6 markers",
#   "random genes"
# )))
# vis_df_mmms_o2$type_y <- factor(vis_df_mmms_o2$type_y,
#                                 levels = base::rev(c(
#   "BL6 markers",
#   "permutation gene set"
# )))
```

Make DF with gene numbers also for conserved signature background permutation.

```{r c_prep2, include = FALSE, eval = FALSE}
# 
# # not sure what this is good for
# vis_df_sign_rand <- base::data.frame(
#   type_y = c(
#     "conserved identity signature",
#     "permutation gene set"),
#   type_fill = c(
#     "conserved identity signature",
#     "random genes"),
#   number = c(
#     nr_sign_used,
#     nr_sign_used))
# 
# vis_df_sign_rand$type_fill <- factor(
#   vis_df_sign_rand$type_fill,
#   levels = base::rev(c(
#     "conserved identity signature",
#     "random genes")))
# 
# vis_df_sign_rand$type_y <- factor(
#   vis_df_sign_rand$type_y, 
#   levels = base::rev(c(
#     "conserved identity signature",
#     "permutation gene set")))
```

## Mins and Maxs

```{r minmax}

# think exactly about which value is even part of the data!!
all_vi <- c(
  
  # actual scores OWN
  score_df_hsc$value[score_df_hsc$type == "variation_information"],
  
  # permuted background scores  OWN
  psdf_hsc_sign_rand$variation_information,
  psdf_hsc_mark_rand$variation_information,
  psdf_hsc_mmms_rand$variation_information,
  
  # other dataset 1
  score_df_hsc_o1$value[score_df_hsc_o1$type == "variation_information"],
  
  psdf_hsc_sign_rand_o1$variation_information,
  psdf_hsc_mmms_rand_o1$variation_information,
  psdf_hsc_mmms_signrand_o1$variation_information#,

  # other dataset 2
  # score_df_hsc_o2$value[score_df_hsc_o2$type == "variation_information"],
  # 
  # psdf_hsc_sign_rand_o2$variation_information,
  # psdf_hsc_mmms_rand_o2$variation_information,
  # psdf_hsc_mmms_signrand_o2$variation_information
)

all_meanprop <- c(
  
  # actual scores
  score_df_hsc$value[score_df_hsc$type == "mean_prop_cells_cluster"],
  
  # permuted background scores for conserved signature
  psdf_hsc_sign_rand$mean_prop_cells_cluster,
  psdf_hsc_mark_rand$mean_prop_cells_cluster,
  psdf_hsc_mmms_rand$mean_prop_cells_cluster,

  # other dataset 1
  score_df_hsc_o1$value[score_df_hsc_o1$type == "mean_prop_cells_cluster"],
  
  psdf_hsc_sign_rand_o1$mean_prop_cells_cluster,
  psdf_hsc_mmms_rand_o1$mean_prop_cells_cluster,
  psdf_hsc_mmms_signrand_o1$mean_prop_cells_cluster#,

  # other dataset 2
  # score_df_hsc_o2$value[score_df_hsc_o2$type == "mean_prop_cells_cluster"],
  # 
  # psdf_hsc_sign_rand_o2$mean_prop_cells_cluster,
  # psdf_hsc_mmms_rand_o2$mean_prop_cells_cluster,
  # psdf_hsc_mmms_signrand_o2$mean_prop_cells_cluster
)

stopifnot(all_vi <= 0)
min_vi <- base::min(all_vi- 0.5)

min_mp <- 0
max_mp <- base::max(all_meanprop + 0.1)

all_nr_genes_BL6_markers <- c(
  nr_mmms_used_own,
  nr_mmms_used_o1#,
  #nr_mmms_used_o2
)

max_genes <- base::max(all_nr_genes_BL6_markers)

print(score1)
print(score2)
print(score3)
score1_min <- 0
score1_max <- 1

score2_min <- min_vi
score2_max <- 0

score3_min <- min_mp
score3_max <- max_mp
```

## Plots: Comparing OWN scores to random background

#### Boxplots

```{r base_plot_bp1_own}
base_plot_bp1_own <- ggplot2::ggplot(
  vis_df_mmms_rand_own,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  ggpattern::geom_col_pattern(
    #color = NA, 
    pattern_angle = 110,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density = pattern_density_val,
    pattern_spacing = pattern_spacing_val
  )+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "BL6 markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp1_own
```

```{r theme_plot_bp1_own}
theme_plot_bp1_own<- base_plot_bp1_own+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank())
```

```{r base_plot_bp2_own}
base_plot_bp2_own <- ggplot2::ggplot(
  vis_df_mark_rand_own,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  ggpattern::geom_col_pattern(
    #color = NA, 
    pattern_angle = 110,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density = pattern_density_val,
    pattern_spacing = pattern_spacing_val
  )+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "conserved markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp2_own
```

```{r theme_plot_bp2_own}
theme_plot_bp2_own <- base_plot_bp2_own+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank())
```

```{r base_plot_bp3_own}
base_plot_bp3_own <- ggplot2::ggplot(
  vis_df_sign_rand_own,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  ggpattern::geom_col_pattern(
    #color = NA, 
    pattern_angle = 110,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density = pattern_density_val,
    pattern_spacing = pattern_spacing_val)+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "random genes" = 1)
  )
base_plot_bp3_own
```

```{r theme_plot_bp3_own}
theme_plot_bp3_own <- base_plot_bp3_own+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "bottom", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.text.x = element_text(hjust = 0.5))+
  ggplot2::xlab(nr_genes_title)
```

#### Adjusted Rand index (Score 1)

```{r base_plot_ai1_own}
base_plot_ai1_own <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1,
  perm_score_df = psdf_mmms_rand_score_1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_ai1_own
```

```{r theme_plot_ai1_own}
theme_plot_ai1_own <- base_plot_ai1_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))
```

```{r base_plot_ai2_own}
base_plot_ai2_own <- make_pattern_density_plot(
  score_df = score_df_mark_score_1,
  perm_score_df = psdf_mark_rand_score_1,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "Conserved markers"
)
base_plot_ai2_own
```

```{r theme_plot_ai2_own}
theme_plot_ai2_own <- base_plot_ai2_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))+
  ggplot2::ggtitle(score1_long) 
```

```{r base_plot_ai3_own}
base_plot_ai3_own <- make_pattern_density_plot(
  score_df = score_df_sign_score_1,
  perm_score_df = psdf_sign_rand_score_1,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_ai3_own
```

```{r theme_plot_ai3_own}
theme_plot_ai3_own <- base_plot_ai3_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "bottom", 
    limits = c(score1_min, score1_max))+
  ggplot2::xlab(score1_long) 
```

#### Variation information (Score 2)

```{r base_plot_vi1_own}
base_plot_vi1_own <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2,
  perm_score_df = psdf_mmms_rand_score_2,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_vi1_own
```

```{r theme_plot_vi1_own}
theme_plot_vi1_own <- base_plot_vi1_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))
```

```{r base_plot_vi2_own}
base_plot_vi2_own <- make_pattern_density_plot(
  score_df = score_df_mark_score_2,
  perm_score_df = psdf_mark_rand_score_2,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "Conserved markers"
)
base_plot_vi2_own
```

```{r theme_plot_vi2_own}
theme_plot_vi2_own <- base_plot_vi2_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))+
  ggplot2::ggtitle(score2_long) 
```

```{r base_plot_vi3_own}
base_plot_vi3_own <- make_pattern_density_plot(
  score_df = score_df_sign_score_2,
  perm_score_df = psdf_sign_rand_score_2,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_vi3_own
```

```{r theme_plot_vi3_own}
theme_plot_vi3_own <- base_plot_vi3_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.text.x = element_text(
      hjust = 0.5),
    axis.title.y = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "bottom", 
    limits = c(score2_min, score2_max))+
  ggplot2::xlab(score2_long) 
```

#### Mean prop (Score 3)

```{r base_plot_mp1_own}
base_plot_mp1_own <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3,
  perm_score_df = psdf_mmms_rand_score_3,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_mp1_own
```

```{r theme_plot_mp1_own}
theme_plot_mp1_own <- base_plot_mp1_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))
```

```{r base_plot_mp2_own}
base_plot_mp2_own <- make_pattern_density_plot(
  score_df = score_df_mark_score_3,
  perm_score_df = psdf_mark_rand_score_3,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "Conserved markers"
)
base_plot_mp2_own
```

```{r theme_plot_mp2_own}
theme_plot_mp2_own <- base_plot_mp2_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))+
  ggplot2::ggtitle(score3_long) 
```

```{r base_plot_mp3_own}
base_plot_mp3_own <- make_pattern_density_plot(
  score_df = score_df_sign_score_3,
  perm_score_df = psdf_sign_rand_score_3,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_mp3_own
print(summary(psdf_sign_rand_score_3$value))
```

```{r theme_plot_mp3_own}
theme_plot_mp3_own <- base_plot_mp3_own+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.text.x = element_text(
      hjust = 0.5),
    axis.title.y = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "bottom", 
    limits = c(score3_min, score3_max))+
  ggplot2::xlab(score3_long) 
```

### Assemble

```{r assemble_bigplot_own, fig.width = 12, fig.height = 10}

b_plot_bp_own <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1, 1, 1.7),
  align = "v",
  theme_plot_bp1_own,
  theme_plot_bp2_own,
  theme_plot_bp3_own
)

b_plot_ai_own <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1, 1, 1.7),
  align = "v",
  theme_plot_ai1_own,
  theme_plot_ai2_own,
  theme_plot_ai3_own
)

b_plot_vi_own <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1, 1, 1.7),
  align = "v",
  theme_plot_vi1_own,
  theme_plot_vi2_own,
  theme_plot_vi3_own
)

b_plot_mp_own <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1, 1, 1.7),
  align = "v",
  theme_plot_mp1_own,
  theme_plot_mp2_own,
  theme_plot_mp3_own
)

```

```{r fig.width = 9, fig.height = 6.2}
b_plot <- ggpubr::ggarrange(
  ncol = 4,
  align = "hv",
  b_plot_bp_own,
  b_plot_ai_own,
  b_plot_vi_own,
  b_plot_mp_own, 
  widths = c(1, 1, 1, 1)
)
b_plot
```

```{r big_plot_ALL_export}
pdf(output_pdf_own_perm_plot, width = 9, height = 6.2)
b_plot
dev.off()
```

```{r assemble_bigplot_own_poster, fig.width = 12, fig.height = 10, eval = FALSE, include = FALSE}

b_plot_bp_own_poster <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.6, 1),
  align = "v",
  theme_plot_bp1_own,
  theme_plot_bp3_own
)

b_plot_ai_own_poster <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.6, 1),
  align = "v",
  theme_plot_ai1_own,
  theme_plot_ai3_own
)

b_plot_vi_own_poster <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.6, 1),
  align = "v",
  theme_plot_vi1_own,
  theme_plot_vi3_own
)


```

```{r fig.width = 9, fig.height = 3.5, eval = FALSE, include = FALSE}
b_plot_poster <- ggpubr::ggarrange(
  ncol = 3,
  align = "v",
  b_plot_bp_own_poster,
  b_plot_ai_own_poster,
  b_plot_vi_own_poster, 
  widths = c(2.3, 1, 1)
)
b_plot_poster
```

## Plots: Comparing OTHER 1 scores to random background

#### Boxplots

```{r base_plot_bp1_o1}
base_plot_bp1_o1 <- ggplot2::ggplot(
  vis_df_mmms_rand_o1,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  ggpattern::geom_col_pattern(
    #color = NA, 
    pattern_angle = 110,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density = pattern_density_val,
    pattern_spacing = pattern_spacing_val
  )+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "BL6 markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp1_o1
```

```{r theme_plot_bp1_o1}
theme_plot_bp1_o1 <- base_plot_bp1_o1+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    plot.title = element_blank(),
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank())
```

```{r base_plot_bp3_o1}
base_plot_bp3_o1 <- ggplot2::ggplot(
  vis_df_sign_rand_o1,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  ggpattern::geom_col_pattern(
    #color = NA, 
    pattern_angle = 110,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density = pattern_density_val,
    pattern_spacing = pattern_spacing_val
  )+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "random genes" = 1)
  )
base_plot_bp3_o1
```

```{r theme_plot_bp3_o1}
theme_plot_bp3_o1 <- base_plot_bp3_o1+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x = element_blank())
```

```{r a_legend_export}
# pdf(output_pdf_bp_legend_poster, width = 4, height = 3)
# legend_bp_all_poster
# dev.off()
```

#### Adjusted Rand index (Score 1)

```{r base_plot_ai1_o1}
base_plot_ai1_o1 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1_o1,
  perm_score_df = psdf_mmms_rand_score_1_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_ai1_o1
```

```{r theme_plot_ai1_o1}
theme_plot_ai1_o1 <- base_plot_ai1_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))
```

```{r base_plot_ai3_o1}
base_plot_ai3_o1 <- make_pattern_density_plot(
  score_df = score_df_sign_score_1_o1,
  perm_score_df = psdf_sign_rand_score_1_o1,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_ai3_o1
```

```{r theme_plot_ai3_o1}
theme_plot_ai3_o1 <- base_plot_ai3_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))+
  ggplot2::ggtitle(score1_long) 
```

#### Variation information (Score 2)

```{r base_plot_vi1_o1}
base_plot_vi1_o1 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2_o1,
  perm_score_df = psdf_mmms_rand_score_2_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_vi1_o1
```

```{r theme_plot_vi1_o1}
theme_plot_vi1_o1 <- base_plot_vi1_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))
```

```{r base_plot_vi3_o1}
base_plot_vi3_o1 <- make_pattern_density_plot(
  score_df = score_df_sign_score_2_o1,
  perm_score_df = psdf_sign_rand_score_2_o1,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_vi3_o1
```

```{r theme_plot_vi3_o1}
theme_plot_vi3_o1 <- base_plot_vi3_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))+
  ggplot2::ggtitle(score2_long) 
```

#### Mean prop (Score 3)

```{r base_plot_mp1_o1}
base_plot_mp1_o1 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3_o1,
  perm_score_df = psdf_mmms_rand_score_3_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_mp1_o1
```

```{r theme_plot_mp1_o1}
theme_plot_mp1_o1 <- base_plot_mp1_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))
```

```{r base_plot_mp3_o1}
base_plot_mp3_o1 <- make_pattern_density_plot(
  score_df = score_df_sign_score_3_o1,
  perm_score_df = psdf_sign_rand_score_3_o1,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_mp3_o1
```

```{r theme_plot_mp3_o1}
theme_plot_mp3_o1 <- base_plot_mp3_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))+
  ggplot2::ggtitle(score3_long) 
```


### Assemble

```{r bigplot_assemble_o1, fig.width = 10, fig.height = 4}

plot_bp_o1 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1, 1),
  align = "v",
  theme_plot_bp1_o1,
  theme_plot_bp3_o1
)

plot_ai_o1 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1, 1),
  align = "v",
  theme_plot_ai1_o1,
  theme_plot_ai3_o1
)

plot_vi_o1 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1, 1),
  align = "v",
  theme_plot_vi1_o1,
  theme_plot_vi3_o1
)

plot_mp_o1 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1, 1),
  align = "v",
  theme_plot_mp1_o1,
  theme_plot_mp3_o1
)

```

```{r fig.width = 9, fig.height = 3.5}
big_plot_o1 <- ggpubr::ggarrange(
  nrow = 1,
  align = "hv",
  plot_bp_o1,
  plot_ai_o1,
  plot_vi_o1,
  plot_mp_o1, 
  widths = c(1, 1, 1, 1)
)
big_plot_o1
```

```{r big_plot_ALL_export}
pdf(output_pdf_o1_perm_plot, width = 9, height = 3.5)
big_plot_o1
dev.off()
```

## Plots: Comparing OTHER 2 scores to random background

#### Boxplots

```{r base_plot_bp1_o2, eval = FALSE, include = FALSE}
base_plot_bp1_o2 <- ggplot2::ggplot(
  vis_df_mmms_rand_o2,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  ggpattern::geom_col_pattern(
    #color = NA, 
    pattern_angle = 110,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density = pattern_density_val,
    pattern_spacing = pattern_spacing_val
  )+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "BL6 markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp1_o2
```

```{r theme_plot_bp1_o2, eval = FALSE, include = FALSE}
theme_plot_bp1_o2<- base_plot_bp1_o2+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size),
    axis.title = element_blank(),
    axis.text.y = element_text(
      hjust = 0))+
  ggplot2::ggtitle(nr_genes_title)
```

```{r base_plot_bp3_o2, eval = FALSE, include = FALSE}
base_plot_bp3_o2 <- ggplot2::ggplot(
  vis_df_sign_rand_o2,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      pattern = type_fill,
      color = type_fill,
      pattern_alpha = type_fill))+
  ggpattern::geom_col_pattern(
   # color = NA, 
    pattern_angle = 110,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density = pattern_density_val,
    pattern_spacing = pattern_spacing_val
  )+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "random genes" = 1)
  )
base_plot_bp3_o2
```

```{r theme_plot_bp3_o2, eval = FALSE, include = FALSE}
theme_plot_bp3_o2 <- base_plot_bp3_o2+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x = element_blank(),
    axis.text.y = element_text(
      hjust = 0))
```

#### MMMS vs SIGNRAND boxplots

```{r base_plot_bp1_o2_signrand, eval = FALSE, include = FALSE}
base_plot_bp1_o2_signrand <- ggplot2::ggplot(
  vis_df_mmms_signrand_o2,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  ggpattern::geom_col_pattern(
    #color = NA, 
    pattern_angle = 110,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density = pattern_density_val,
    pattern_spacing = pattern_spacing_val
  )+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "BL6 markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp1_o2_signrand
```

```{r theme_plot_bp1_o2_signrand, fig.width = 4, fig.height = 2, eval = FALSE, include = FALSE}
theme_plot_bp1_o2_signrand <- base_plot_bp1_o2_signrand+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0,  400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    legend.position = "none",
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size),
    axis.title = element_blank(),
    axis.text.y = element_text(
      hjust = 0))+
  ggplot2::ggtitle(nr_genes_title)
```

#### Adjusted Rand index (Score 1)

```{r base_plot_ai1_o2, eval = FALSE, include = FALSE}
base_plot_ai1_o2 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1_o2,
  perm_score_df = psdf_mmms_rand_score_1_o2,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_ai1_o2
```

```{r theme_plot_ai1_o2, eval = FALSE, include = FALSE}
theme_plot_ai1_o2 <- base_plot_ai1_o2+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size))+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))+
  ggplot2::ggtitle(score1_long) 
```

```{r base_plot_ai3_o2, eval = FALSE, include = FALSE}
base_plot_ai3_o2 <- make_pattern_density_plot(
  score_df = score_df_sign_score_1_o2,
  perm_score_df = psdf_sign_rand_score_1_o2,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_ai3_o2
```

```{r theme_plot_ai3_o2, eval = FALSE, include = FALSE}
theme_plot_ai3_o2 <- base_plot_ai3_o2+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))+
  ggplot2::ggtitle(score1_long) 
```

#### Variation information (Score 2)

```{r base_plot_vi1_o2, eval = FALSE, include = FALSE}
base_plot_vi1_o2 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2_o2,
  perm_score_df = psdf_mmms_rand_score_2_o2,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_vi1_o2
```

```{r theme_plot_vi1_o2, eval = FALSE, include = FALSE}
theme_plot_vi1_o2 <- base_plot_vi1_o2+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size))+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))+
  ggplot2::ggtitle(base::paste0("0-", score2_long))
```

```{r base_plot_vi3_o2, eval = FALSE, include = FALSE}
base_plot_vi3_o2 <- make_pattern_density_plot(
  score_df = score_df_sign_score_2_o2,
  perm_score_df = psdf_sign_rand_score_2_o2,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_vi3_o2
```

```{r theme_plot_vi3_o2, eval = FALSE, include = FALSE}
theme_plot_vi3_o2 <- base_plot_vi3_o2+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))+
  ggplot2::ggtitle(score2_long) 
```

#### Mean prop (Score 3)

```{r base_plot_mp1_o2, eval = FALSE, include = FALSE}
base_plot_mp1_o2 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3_o2,
  perm_score_df = psdf_mmms_rand_score_3_o2,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_mp1_o2
```

```{r theme_plot_mp1_o2, eval = FALSE, include = FALSE}
theme_plot_mp1_o2 <- base_plot_mp1_o2+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size))+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))+
  ggplot2::ggtitle(score3_long) 
```

```{r base_plot_mp3_o2, eval = FALSE, include = FALSE}
base_plot_mp3_o2 <- make_pattern_density_plot(
  score_df = score_df_sign_score_3_o2,
  perm_score_df = psdf_sign_rand_score_3_o2,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "Conserved identity signature"
)
base_plot_mp3_o2
```

```{r theme_plot_mp3_o2, eval = FALSE, include = FALSE}
theme_plot_mp3_o2 <- base_plot_mp3_o2+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))+
  ggplot2::ggtitle(score3_long) 
```

### Assemble

```{r bigplot_assemble_o2, eval = FALSE, include = FALSE}

plot_bp_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1),
  align = "v",
  theme_plot_bp1_o2,
  theme_plot_bp3_o2
)

plot_ai_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1),
  align = "v",
  theme_plot_ai1_o2,
  theme_plot_ai3_o2
)

plot_vi_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1),
  align = "v",
  theme_plot_vi1_o2,
  theme_plot_vi3_o2
)

plot_mp_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1),
  align = "v",
  theme_plot_mp1_o2,
  theme_plot_mp3_o2
)

```

```{r big_plot_o2, fig.width = 12, fig.height = 3, eval = FALSE, include = FALSE}
big_plot_o2 <- ggpubr::ggarrange(
  ncol = 4,
  align = "hv",
  plot_bp_o2,
  plot_ai_o2,
  plot_vi_o2,
  plot_mp_o2, 
  widths = c(2, 1, 1, 1)
)
big_plot_o2
```

## Assemble Other alternative

```{r assemble_bigplot_others_alt, eval = FALSE, include = FALSE}

plot_bp_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1, 1, 1),
  align = "v",
  theme_plot_bp1_o1,
  theme_plot_bp1_o2+theme(plot.title = element_blank(),
                          axis.text.x = element_blank(),
                          axis.line.x = element_blank(),
                          axis.ticks.x = element_blank(),
                          axis.title.x = element_blank()),
  theme_plot_bp3_o1,
  theme_plot_bp3_o2
)

plot_ai_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1, 1, 1),
  align = "v",
  theme_plot_ai1_o1,
  theme_plot_ai1_o2+theme(plot.title = element_blank(),
                          axis.text.x = element_blank(),
                          axis.line.x = element_blank(),
                          axis.ticks.x = element_blank(),
                          axis.title.x = element_blank()),
  theme_plot_ai3_o1,
  theme_plot_ai3_o2
)

plot_vi_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1, 1, 1),
  align = "v",
  theme_plot_vi1_o1,
  theme_plot_vi1_o2+theme(plot.title = element_blank(),
                          axis.text.x = element_blank(),
                          axis.line.x = element_blank(),
                          axis.ticks.x = element_blank(),
                          axis.title.x = element_blank()),
  theme_plot_vi3_o1,
  theme_plot_vi3_o2
)

plot_mp_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1, 1, 1),
  align = "v",
  theme_plot_mp1_o1,
  theme_plot_mp1_o2+theme(plot.title = element_blank(),
                          axis.text.x = element_blank(),
                          axis.line.x = element_blank(),
                          axis.ticks.x = element_blank(),
                          axis.title.x = element_blank()),
  theme_plot_mp3_o1,
  theme_plot_mp3_o2
)

```

```{r big_plot_o1o2, fig.width = 12, fig.height = 5, eval = FALSE, include = FALSE}
big_plot_o2 <- ggpubr::ggarrange(
  ncol = 4,
  align = "hv",
  plot_bp_o2,
  plot_ai_o2,
  plot_vi_o2,
  plot_mp_o2, 
  widths = c(2, 1, 1, 1)
)
big_plot_o2
```

```{r theme_big_plot_o1o2_ow, eval = FALSE, include = FALSE}

plot_bp_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1, 1, 1),
  align = "v",
  theme_plot_bp1_o1,
  theme_plot_bp3_o1,
  theme_plot_bp1_o2+theme(plot.title = element_blank(),
                          axis.text.x = element_blank(),
                          axis.line.x = element_blank(),
                          axis.ticks.x = element_blank(),
                          axis.title.x = element_blank()),
  theme_plot_bp3_o2
)

plot_ai_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1, 1, 1),
  align = "v",
  theme_plot_ai1_o1,
  theme_plot_ai3_o1,
  theme_plot_ai1_o2+theme(plot.title = element_blank(),
                          axis.text.x = element_blank(),
                          axis.line.x = element_blank(),
                          axis.ticks.x = element_blank(),
                          axis.title.x = element_blank()),
  theme_plot_ai3_o2
)

plot_vi_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1, 1, 1),
  align = "v",
  theme_plot_vi1_o1,
  theme_plot_vi3_o1,
  theme_plot_vi1_o2+theme(plot.title = element_blank(),
                          axis.text.x = element_blank(),
                          axis.line.x = element_blank(),
                          axis.ticks.x = element_blank(),
                          axis.title.x = element_blank()),
  theme_plot_vi3_o2
)

plot_mp_o2 <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1, 1, 1),
  align = "v",
  theme_plot_mp1_o1,
  theme_plot_mp3_o1,
  theme_plot_mp1_o2+theme(plot.title = element_blank(),
                          axis.text.x = element_blank(),
                          axis.line.x = element_blank(),
                          axis.ticks.x = element_blank(),
                          axis.title.x = element_blank()),
  theme_plot_mp3_o2
)

```

```{r big_plot_o1o2_ow, fig.width = 12, fig.height = 5, eval = FALSE, include = FALSE}
big_plot_o1o2_ow <- ggpubr::ggarrange(
  ncol = 4,
  align = "hv",
  plot_bp_o2,
  plot_ai_o2,
  plot_vi_o2,
  plot_mp_o2, 
  widths = c(2, 1, 1, 1)
)
big_plot_o2
```


## Plots: Compariong OTHER scores to signature + random background

#### Boxplots 

```{r base_plot_bp1_o1_signrand}
base_plot_bp1_o1_signrand <- ggplot2::ggplot(
  vis_df_mmms_signrand_o1,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  ggpattern::geom_col_pattern(
    #color = NA, 
    pattern_angle = 110,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density = pattern_density_val,
    pattern_spacing = pattern_spacing_val
  )+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "BL6 markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp1_o1_signrand
```

```{r theme_plot_bp1_o1_signrand}
theme_plot_bp1_o1_signrand <- base_plot_bp1_o1_signrand+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0, 400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    plot.title = element_blank(),
    legend.position = "none",
    axis.title = element_blank(),
    axis.text.y = element_blank())
```

```{r base_plot_bp2_o2_signrand, eval = FALSE, include = FALSE}
base_plot_bp2_o2_signrand <- ggplot2::ggplot(
  vis_df_mmms_signrand_o2,
  aes(y = type_y, 
      x =  number,
      fill = type_fill,
      color = type_fill,
      pattern = type_fill,
      pattern_alpha = type_fill))+
  ggpattern::geom_col_pattern(
    #color = NA, 
    pattern_angle = 110,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density = pattern_density_val,
    pattern_spacing = pattern_spacing_val
  )+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::scale_color_manual(values = col_cons_long)+
  ggpattern::scale_pattern_alpha_manual(
    values = c("conserved identity signature" = 0,
               "BL6 markers" = 0, 
               "random genes" = 1)
  )
base_plot_bp2_o2_signrand
```

```{r theme_plot_bp2_o2_signrand, eval = FALSE, include = FALSE}
theme_plot_bp2_o2_signrand <- base_plot_bp2_o2_signrand+
  theme_all+
  ggplot2::scale_x_continuous(
    breaks=c(0, 400, 800),
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::theme(
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size),
    legend.position = "none",
    axis.title = element_blank(),
    axis.text.y = element_text(
      hjust = 0))+
  ggplot2::ggtitle(nr_genes_title)
```

#### Adjusted Rand index

```{r base_plot_ai1_o1_signrand}
base_plot_ai1_o1_signrand <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1_o1, # the actual score is the same as before
  perm_score_df = psdf_mmms_signrand_score_1_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_ai1_o1_signrand
```

```{r theme_plot_ai1_o1_signrand}
theme_plot_ai1_o1_signrand <- base_plot_ai1_o1_signrand+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))
```

```{r base_plot_ai2_o2_signrand, eval = FALSE, include = FALSE}
base_plot_ai2_o2_signrand <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1_o2, # the actual score is the same as before
  perm_score_df = psdf_mmms_signrand_score_1_o2,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_ai2_o2_signrand
```

```{r theme_plot_ai2_o2_signrand, eval = FALSE, include = FALSE}
theme_plot_ai2_o2_signrand <- base_plot_ai2_o2_signrand+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size))+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.5, 1),
    position = "top", 
    limits = c(score1_min, score1_max))+
  ggplot2::ggtitle(score1_long) 
```

#### Variation information

```{r base_plot_vi1_o1_signrand}
base_plot_vi1_o1_signrand <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2_o1,
  perm_score_df = psdf_mmms_signrand_score_2_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_vi1_o1_signrand
```

```{r theme_plot_vi1_o1_signrand}
theme_plot_vi1_o1_signrand <- base_plot_vi1_o1_signrand+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))
```

```{r base_plot_vi2_o2_signrand, eval = FALSE, include = FALSE}
base_plot_vi2_o2_signrand <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2_o2,
  perm_score_df = psdf_mmms_signrand_score_2_o2,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_vi2_o2_signrand
```

```{r theme_plot_vi2_o2_signrand, eval = FALSE, include = FALSE}
theme_plot_vi2_o2_signrand <- base_plot_vi2_o2_signrand+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size))+
  ggplot2::scale_x_continuous(
    breaks=c(-5, -2.5, 0),
    position = "top", 
    limits = c(score2_min, score2_max))+
  ggplot2::ggtitle(base::paste0("0-", score2_long))
```

#### Mean prop (Score 3)

```{r base_plot_mp1_o1_signrand}
base_plot_mp1_o1_signrand <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3_o1,
  perm_score_df = psdf_mmms_signrand_score_3_o1,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_mp1_o1_signrand
```

```{r theme_plot_mp1_o1_signrand}
theme_plot_mp1_o1_signrand <- base_plot_mp1_o1_signrand+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank())+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))
```

```{r base_plot_mp2_o2_signrand, eval = FALSE, include = FALSE}
base_plot_mp2_o2_signrand <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3_o2,
  perm_score_df = psdf_mmms_signrand_score_3_o2,
  color_cons = col_cons_long["BL6 markers"],
  ylabel = "BL6 markers"
)
base_plot_mp2_o2_signrand
```

```{r theme_plot_mp1_o1_signrand, eval = FALSE, include = FALSE}
theme_plot_mp2_o2_signrand <- base_plot_mp2_o2_signrand+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      hjust = 0.5,
      size = axis_title_size))+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.2, 0.4),
    position = "top", 
    limits = c(score3_min, score3_max))+
  ggplot2::ggtitle(score3_long) 
```

### Assemble

```{r assemble_signrand, eval = FALSE, include = FALSE}

plot_bp_signrand <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1),
  align = "v",
  theme_plot_bp1_o1_signrand,
  theme_plot_bp2_o2_signrand+ggplot2::theme(
    plot.title = element_blank(),
    axis.text.x = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank())
)

plot_ai_signrand <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1),
  align = "v",
  theme_plot_ai1_o1_signrand,
  theme_plot_ai2_o2_signrand+ggplot2::theme(
    plot.title = element_blank(),
    axis.text.x = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank())
)

plot_vi_signrand <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1),
  align = "v",
  theme_plot_vi1_o1_signrand,
  theme_plot_vi2_o2_signrand+ggplot2::theme(
    plot.title = element_blank(),
    axis.text.x = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank())
)

plot_mp_signrand <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(1.8, 1),
  align = "v",
  theme_plot_mp1_o1_signrand,
  theme_plot_mp2_o2_signrand+ggplot2::theme(
    plot.title = element_blank(),
    axis.text.x = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank())
)

```

```{r big_plot_signrand, fig.width = 9, fig.height = 1.85}
big_plot_signrand <- ggpubr::ggarrange(
  ncol = 4,
  align = "h",
  theme_plot_bp1_o1_signrand,
  theme_plot_ai1_o1_signrand,
  theme_plot_vi1_o1_signrand,
  theme_plot_mp1_o1_signrand, 
  widths = c(1, 1, 1, 1)
)
big_plot_signrand
```


```{r big_plot_ALL_export}
pdf(output_pdf_mmms_sign_plot, width = 9, height = 1.85)
big_plot_signrand
dev.off()
```

## Assemble ALL

```{r assemble_signrand, fig.height = 20, fig.width = 5}

other_than_1 <- 1.87

plot_bp_all <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(other_than_1, 1, 1, other_than_1, 1, other_than_1, 1),
  align = "v",
  theme_plot_bp1_own,
  theme_plot_bp2_own,
  theme_plot_bp3_own,  
  theme_plot_bp1_o1,
  # theme_plot_bp1_o2+ggplot2::theme(
  #   plot.title = element_blank(),
  #   axis.text.x = element_blank(),
  #   axis.line.x = element_blank(),
  #   axis.ticks.x = element_blank(),
  #   axis.title.x = element_blank()),
  theme_plot_bp3_o1,
  # theme_plot_bp3_o2,
  theme_plot_bp1_o1_signrand#,
  # theme_plot_bp2_o2_signrand+ggplot2::theme(
  #   plot.title = element_blank(),
  #   axis.text.x = element_blank(),
  #   axis.line.x = element_blank(),
  #   axis.ticks.x = element_blank(),
  #   axis.title.x = element_blank())
)

plot_ai_all <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(other_than_1, 1, 1, other_than_1, 1,  other_than_1),
  align = "v",
  theme_plot_ai1_own,
  theme_plot_ai2_own,
  theme_plot_ai3_own,  
  theme_plot_ai1_o1,
  # theme_plot_ai1_o2+ggplot2::theme(
  #   plot.title = element_blank(),
  #   axis.text.x = element_blank(),
  #   axis.line.x = element_blank(),
  #   axis.ticks.x = element_blank(),
  #   axis.title.x = element_blank()),
  theme_plot_ai3_o1,
  #theme_plot_ai3_o2,
  theme_plot_ai1_o1_signrand#,
  # theme_plot_ai2_o2_signrand+ggplot2::theme(
  #   plot.title = element_blank(),
  #   axis.text.x = element_blank(),
  #   axis.line.x = element_blank(),
  #   axis.ticks.x = element_blank(),
  #   axis.title.x = element_blank())
)

plot_vi_all <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(other_than_1, 1, 1, other_than_1, 1,   other_than_1),
  align = "v",
  theme_plot_vi1_own,
  theme_plot_vi2_own,
  theme_plot_vi3_own,  
  theme_plot_vi1_o1,
  # theme_plot_vi1_o2+ggplot2::theme(
  #   plot.title = element_blank(),
  #   axis.text.x = element_blank(),
  #   axis.line.x = element_blank(),
  #   axis.ticks.x = element_blank(),
  #   axis.title.x = element_blank()),
  theme_plot_vi3_o1,
  #theme_plot_vi3_o2,
  theme_plot_vi1_o1_signrand#,
  # theme_plot_vi2_o2_signrand+ggplot2::theme(
  #   plot.title = element_blank(),
  #   axis.text.x = element_blank(),
  #   axis.line.x = element_blank(),
  #   axis.ticks.x = element_blank(),
  #   axis.title.x = element_blank())
)

plot_mp_all <- ggpubr::ggarrange(
  ncol = 1,
  heights = c(other_than_1, 1, 1, other_than_1, 1,  other_than_1, 1),
  align = "v",
  theme_plot_mp1_own,
  theme_plot_mp2_own,
  theme_plot_mp3_own,  
  theme_plot_mp1_o1,
  # theme_plot_mp1_o2+ggplot2::theme(
  #   plot.title = element_blank(),
  #   axis.text.x = element_blank(),
  #   axis.line.x = element_blank(),
  #   axis.ticks.x = element_blank(),
  #   axis.title.x = element_blank()),
  theme_plot_mp3_o1,
  #theme_plot_mp3_o2,
  theme_plot_mp1_o1_signrand#,
  # theme_plot_mp2_o2_signrand+ggplot2::theme(
  #   plot.title = element_blank(),
  #   axis.text.x = element_blank(),
  #   axis.line.x = element_blank(),
  #   axis.ticks.x = element_blank(),
  #   axis.title.x = element_blank())
)
```

```{r big_plot_ALL, fig.width = 12, fig.height = 8}
big_plot_ALL <- ggpubr::ggarrange(
  ncol = 4,
  align = "hv",
  plot_bp_all,
  plot_ai_all,
  plot_vi_all,
  plot_mp_all, 
  widths = c(2, 1, 1, 1)
)
big_plot_ALL
```

```{r big_plot_ALL_export}
# pdf(output_pdf_ALL_plot, width = 12, height = 8)
# big_plot_ALL
# dev.off()
```

# Own Heatmaps

Heatmaps of own re-clustered HSPC mouse data using signature genes/
conserved markers/BL6 markers/nDGEs.

### Prep

```{r mat_sign}
mat_sign <- base::table(
  sce_hsc_recl$celltypes, 
  sce_hsc_recl$cluster_signt)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign)){
  mat_sign[,i] <- mat_sign[,i]/base::sum(mat_sign[,i])
}
sign_df <- base::as.data.frame(mat_sign)

# manually factorise clusters for nice order
sign_df$Var2 <- factor(
  sign_df$Var2,
  levels = base::rev(c(5, 4, 3, 2, 6, 8, 7, 1)))
```

```{r mat_mark}
mat_mark <- base::table(
  sce_hsc_recl$celltypes, 
  sce_hsc_recl$cluster_consm)

for(i in 1:ncol(mat_mark)){
  mat_mark[,i] <- mat_mark[,i]/base::sum(mat_mark[,i])
}
mark_df <- base::as.data.frame(mat_mark)

mark_df$Var2 <- factor(
  mark_df$Var2,
  levels = base::rev(c(7, 5, 10, 4, 2, 3, 9, 6, 8, 11, 1)))
a_mmms_base_plot
```

```{r mat_mmms}
mat_mmms <- base::table(
  sce_hsc_recl$celltypes, 
  sce_hsc_recl$cluster_mmusm)

for(i in 1:ncol(mat_mmms)){
  mat_mmms[,i] <- mat_mmms[,i]/base::sum(mat_mmms[,i])
}
mmms_df <- base::as.data.frame(mat_mmms)

mmms_df$Var2 <- factor(
  mmms_df$Var2,
  levels = base::rev(c(12, 9, 6, 5, 4, 3, 2, 8, 7, 11, 10, 13, 1)))
```

### Plot Components

```{r a_sign_base_plot}
a_sign_base_plot <- ggplot2::ggplot(
  sign_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r a_mark_base_plot}
a_mark_base_plot <- ggplot2::ggplot(
  mark_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r a_mmms_base_plot}
a_mmms_base_plot <- ggplot2::ggplot(
  mmms_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r a_mmms_theme_plot}
a_mmms_theme_plot <- a_mmms_base_plot+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.title = element_blank(),
    axis.ticks.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("BL6 markers")
```

```{r a_mark_theme_plot}
a_mark_theme_plot <- a_mark_base_plot+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_blank())+
 # ggplot2::ylab("New clusters")+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("Conserved markers")
```

```{r a_sign_theme_plot}
a_sign_theme_plot <- a_sign_base_plot+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_text(
      margin = margin(t = 0.3, unit = "cm")),
    axis.text.x = element_text(
      angle = 90,
      hjust = 1,
      vjust = 0.5),
    plot.title = element_blank())+
  ggplot2::xlab("Original cell types")+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("Conserved identity signature")
```

```{r a_legend_theme_plot}
a_legend_plot <- a_mmms_base_plot+
  theme_all+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::theme(
    legend.title = element_text(
      margin = margin(r = 10),
      vjust = 0.85),
    legend.position = "bottom",
  )
a_legend_theme <- ggpubr::get_legend(a_legend_plot)
```

### Assemble

```{r a_assemble, fig.height = 7.8, fig.width = 3}

a_theme_plot <- ggpubr::ggarrange(
  ncol = 1,
  a_mmms_theme_plot,
  a_mark_theme_plot,
  a_sign_theme_plot,
  align = "v",
  heights = c(1, 1, 2.5)
)

a_theme_plot
```

```{r a_assemble, fig.height = 7, fig.width = 3, eval = FALSE, include = FALSE}

# a_theme_plot_poster <- ggpubr::ggarrange(
#   ncol = 1,
#   a_mmms_theme_plot,
#   a_sign_theme_plot+
#   ggplot2::theme(
#     axis.text.x = element_text(
#       angle = 90,
#       hjust = 0,
#       vjust = 0.5)),
#   align = "v",
#   heights = c(1, 1.9)
# )
# 
# a_theme_plot_poster
```

```{r a_construct_legend, fig.width = 6, fig.height = 1}
a_legend <- ggpubr::ggarrange(a_legend_theme)
a_legend
```

```{r a_plot_export}
pdf(output_pdf_heatmap_own_plot, width = 3, height = 7.8)
a_theme_plot
dev.off()
```

```{r a_legend_export}
pdf(output_pdf_a_legend, width = 6, height = 1)
a_legend
dev.off()
```

```{r a_plot_export_poster}
# pdf(output_pdf_a_plot_poster, width = 3, height = 7)
# a_theme_plot_poster
# dev.off()
```

# Other Heatmaps

### Prep Other 1

```{r prep_cts}

levels(selected_seu_list_o1$seu_mmms$cell_type)
selected_seu_list_o1$seu_mmms$cell_type <- unfactor(selected_seu_list_o1$seu_mmms$cell_type)

selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "Slamf1-positive multipotent progenitor cell"] <- "Slamf1+ MPP"
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "Slamf1-negative multipotent progenitor cell"] <- "Slamf1- MPP."
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "granulocyte monocyte progenitor cell"] <- "granu-mono prog"
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "granulocytopoietic cell"] <- "granulocytopoietic"
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "hematopoietic precursor cell"] <- "hematopoietic precursor"
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type == "common lymphoid progenitor"] <- "common lymphoid pro"
selected_seu_list_o1$seu_mmms$cell_type[
  selected_seu_list_o1$seu_mmms$cell_type ==  "megakaryocyte-erythroid progenitor cell"] <-  "mk-ery prog"


selected_seu_list_o1$seu_mmms$cell_type <- factor(
  selected_seu_list_o1$seu_mmms$cell_type,
  levels = c(
    "Slamf1+ MPP",
    "Slamf1- MPP",
    "hematopoietic precursor",
    "granulocytopoietic",
    "granu-mono prog",
    "mk-ery prog",
    "common lymphoid prog",
    "immature B cell"
  ))

```

```{r prep_cts_sign}

levels(selected_seu_list_o1$seu_sign$cell_type)
selected_seu_list_o1$seu_sign$cell_type <- unfactor(selected_seu_list_o1$seu_sign$cell_type)

selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "Slamf1-positive multipotent progenitor cell"] <- "Slamf1+ MPP"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "Slamf1-negative multipotent progenitor cell"] <- "Slamf1- MPP"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "granulocyte monocyte progenitor cell"] <- "granu-mono prog"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "granulocytopoietic cell"] <- "granulocytopoietic"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "hematopoietic precursor cell"] <- "hematopoietic precursor"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type == "common lymphoid progenitor"] <- "common lymphoid prog"
selected_seu_list_o1$seu_sign$cell_type[
  selected_seu_list_o1$seu_sign$cell_type ==  "megakaryocyte-erythroid progenitor cell"] <-  "mk-ery prog"


selected_seu_list_o1$seu_sign$cell_type <- factor(
  selected_seu_list_o1$seu_sign$cell_type,
  levels = c(
    "Slamf1+ MPP",
    "Slamf1- MPP",
    "hematopoietic precursor",
    "granulocytopoietic",
    "granu-mono prog",
    "mk-ery prog",
    "common lymphoid prog",
    "immature B cell"
  ))

```

```{r mat_mmms_o1}
mat_mmms_o1 <- base::table(selected_seu_list_o1$seu_mmms$cell_type, 
                           selected_seu_list_o1$seu_mmms$seurat_clusters)

for(i in 1:ncol(mat_mmms_o1)){
  mat_mmms_o1[,i] <- mat_mmms_o1[,i]/base::sum(mat_mmms_o1[,i])
}
mmms_df_o1 <- base::as.data.frame(mat_mmms_o1)

mmms_df_o1$Var2 <- factor(
  mmms_df_o1$Var2,
  levels = base::rev(c(1, 4, 0, 3, 5, 2, 6)))
```

```{r mat_sign_o1}
mat_sign_o1 <- base::table(selected_seu_list_o1$seu_sign$cell_type, 
                           selected_seu_list_o1$seu_sign$seurat_clusters)

for(i in 1:ncol(mat_sign_o1)){
  mat_sign_o1[,i] <- mat_sign_o1[,i]/base::sum(mat_sign_o1[,i])
}
sign_df_o1 <- base::as.data.frame(mat_sign_o1)

sign_df_o1$Var2 <- factor(
  sign_df_o1$Var2,
  levels = base::rev(c(1, 0, 4, 8, 5, 6, 7, 3, 2)))
```

### Plot Components Other 1

```{r mmms_base_plot_o1}
mmms_base_plot_o1 <- ggplot2::ggplot(
  mmms_df_o1, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
mmms_base_plot_o1
```

```{r sign_base_plot_o1}
sign_base_plot_o1 <- ggplot2::ggplot(
  sign_df_o1, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
sign_base_plot_o1
```

```{r mmms_theme_plot_o1}
mmms_theme_plot_o1 <- mmms_base_plot_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ylab("Reclustered")
```

```{r sign_theme_plot_o1}
sign_theme_plot_o1 <- sign_base_plot_o1+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 90,
      hjust = 1,
      vjust = 0.5),
    axis.title = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::xlab("Original cell types")+
  ggplot2::ylab("Reclustered")
```

### Assemble

```{r de_construct, fig.width = 4.5, fig.height = 4, eval = FALSE, include = FALSE}

mmms_plots_title <- annotate_figure(
  mmms_theme_plot_o1,
  top = ggpubr::text_grob(
    "BL6 markers", 
    color = col_cons_long["BL6 markers"], 
    face = plot_title_face,
    size = plot_title_size))

sign_plots_title <- annotate_figure(
  sign_theme_plot_o1,
  top = ggpubr::text_grob(
    "Conserved identity signature", 
    color = col_cons_long["conserved identity signature"], 
    face = plot_title_face,
    size = plot_title_size),
  bottom = ggpubr::text_grob(
    "Original cell types",
    color = axis_title_color,
    size = axis_title_size,
    face = axis_title_face))

```

```{r d_construct, fig.width = 3, fig.height = 6.5}

d_theme_plot <- ggpubr::ggarrange(
  ncol = 1,
  mmms_theme_plot_o1,
  sign_theme_plot_o1,
  align = "v",
  heights = c(1, 2.8)
)

d_theme_plot
```

```{r a_plot_export}
pdf(output_pdf_heatmaps_others_plot, width = 3, height = 6.5)
d_theme_plot
dev.off()
```

### Prep Other 2

```{r mat_mmms_o2, eval = FALSE, include = FALSE}
mat_mmms_o2 <- base::table(selected_seu_list_o2$seu_mmms$cell_type, 
                          selected_seu_list_o2$seu_mmms$seurat_clusters)

for(i in 1:ncol(mat_mmms_o2)){
  mat_mmms_o2[,i] <- mat_mmms_o2[,i]/base::sum(mat_mmms_o2[,i])
}
mmms_df_o2 <- base::as.data.frame(mat_mmms_o2)

mmms_df_o2$Var2 <- factor(
  mmms_df_o2$Var2,
  levels = base::rev(c(2, 15, 14, 3, 6, 9, 11, 5, 4, 7, 10, 13, 12, 8, 1, 0)))
```

```{r mat_sign_o2, eval = FALSE, include = FALSE}
mat_sign_o2 <- base::table(selected_seu_list_o2$seu_sign$cell_type, 
                           selected_seu_list_o2$seu_sign$seurat_clusters)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign_o2)){
  mat_sign_o2[,i] <- mat_sign_o2[,i]/base::sum(mat_sign_o2[,i])
}
sign_df_o2 <- base::as.data.frame(mat_sign_o2)

# manually factorise clusters
sign_df_o2$Var2 <- factor(
  sign_df_o2$Var2,
  levels = base::rev(c(3, 4, 6, 8, 9, 7, 5, 2, 11, 10, 1, 0)))
```

### Plot Other 2

```{r mmms_base_plot_o2, eval = FALSE, include = FALSE}
mmms_base_plot_o2 <- ggplot2::ggplot(
  mmms_df_o2, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
mmms_base_plot_o2
```

```{r sign_base_plot_o2, eval = FALSE, include = FALSE}
sign_base_plot_o2 <- ggplot2::ggplot(
  sign_df_o2, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
sign_base_plot_o2
```

```{r mmms_theme_plot_o2, eval = FALSE, include = FALSE}
mmms_theme_plot_o2 <- mmms_base_plot_o2+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))
```

```{r f_mmms_theme_plot, eval = FALSE, include = FALS}
sign_theme_plot_o2 <- mmms_base_plot_o2+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5),
    axis.title = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::xlab("Original cell types")
```

### Assemble

```{r f_assemble, fig.width = 3.2, fig.height = 6, eval = FALSE, include = FALSE}

f_theme_plot <- ggpubr::ggarrange(
  ncol = 1,
  mmms_theme_plot_o2,
  sign_theme_plot_o2,
  align = "v",
  heights = c(1, 1.5)
)

f_theme_plot
```

### Construct both together

```{r de_construct, fig.width = 4.5, fig.height = 4, eval = FALSE, include = FALSE}

mmms_plots <- ggpubr::ggarrange(
  ncol = 2,
  mmms_theme_plot_o1,
  mmms_theme_plot_o2)

mmms_plots_title <- annotate_figure(
  mmms_plots,
  top = ggpubr::text_grob(
    "BL6 markers", 
    color = col_cons_long["BL6 markers"], 
    face = plot_title_face,
    size = plot_title_size))

sign_plots <- ggpubr::ggarrange(
  ncol = 2,
  align = "hv",
  sign_theme_plot_o1,
  sign_theme_plot_o2)

sign_plots_title <- annotate_figure(
  sign_plots,
  top = ggpubr::text_grob(
    "Conserved identity signature", 
    color = col_cons_long["conserved identity signature"], 
    face = plot_title_face,
    size = plot_title_size),
  bottom = ggpubr::text_grob(
    "Original cell types",
    color = axis_title_color,
    size = axis_title_size,
    face = axis_title_face))

```

```{r de_construct2, fig.width = 4, fig.height = 8, eval = FALSE, include = FALSE}
de_plot <- ggpubr::ggarrange(
  mmms_plots_title,
  sign_plots_title,
  nrow = 2,
  align = "hv",
  heights = c(1, 3)
)

de_plot
```

```{r output_pdf_heatmaps_others_plot}
# pdf(output_pdf_heatmaps_others_plot, width = 4, height = 8)
# de_plot
# dev.off()
```

```{r check_corr_pval_df}
corr_pval_df[
  corr_pval_df$conservation_level == "mmusall_markers" &
    corr_pval_df$condition == "mus_tm_bonemarrow" &
    corr_pval_df$comparison == "mmms-vs-signrand",]
```


# Corrected Pval Plot

### Prep

```{r pval_general, eval = FALSE, include = FALSE}

# add more columns for nicer visualisation
# corr_pval_df$color_id <- vector(length = nrow(corr_pval_df))
# corr_pval_df$color_id[corr_pval_df$pval_corrected < 0.05] <- "pval adj. < 0.05"
# corr_pval_df$color_id[corr_pval_df$pval_corrected == 0] <- "pval adj. = 0"
# corr_pval_df$color_id[corr_pval_df$pval_corrected >= 0.05] <- "non-significant"
# 
# corr_pval_df$cons_level_long <- vector(length = nrow(corr_pval_df))
# corr_pval_df$cons_level_long[
#   corr_pval_df$conservation_level == "conserved_signature"] <- "conserved identity signature"
# corr_pval_df$cons_level_long[
#   corr_pval_df$conservation_level == "conserved_markers"] <- "conserved markers"
# corr_pval_df$cons_level_long[
#   corr_pval_df$conservation_level == "mmusall_markers"] <- "BL6 markers"
# 
# corr_pval_df$score_long <- vector(length = nrow(corr_pval_df))
# corr_pval_df$score_long[
#   corr_pval_df$type == "adjusted_rand_index"] <- "Adjusted Rand index"
# corr_pval_df$score_long[
#   corr_pval_df$type == "variation_information"] <- "Variation of information"
# corr_pval_df$score_long[
#   corr_pval_df$type == "mean_prop_cells_cluster"] <- "Mean prop. cells/cluster"
# 
# corr_pval_df$cons_level_long <- factor(
#   corr_pval_df$cons_level_long, levels = c(
#     "conserved identity signature",
#     "conserved markers",
#     "BL6 markers"))
# 
# corr_pval_df$cons_level_long_rev <- corr_pval_df$cons_level_long
# corr_pval_df$cons_level_long_rev <- factor(
#   corr_pval_df$cons_level_long_rev, levels = rev(c(
#     "conserved identity signature",
#     "conserved markers",
#     "BL6 markers")))
# 
# corr_pval_df$score_long <- factor(
#   corr_pval_df$score_long, levels = c(
#     "Adjusted Rand index",
#     "Variation of information",
#     "Mean prop. cells/cluster"))
# 
# corr_pval_df$color_id <- factor(
#   corr_pval_df$color_id, levels = rev(c(
#     "non-significant",
#     "pval adj. < 0.05",
#     "pval adj. = 0")))
# 
# color_significance <- c("non-significant" = "grey70",
#                         "pval adj. < 0.05" = "black", 
#                         "pval adj. = 0" = "blue")
```

### OWN

```{r pval_own1, eval = FALSE, include = FALSE}
# corr_pval_df_sub <- corr_pval_df[corr_pval_df$condition == "hsc",]
```

```{r pval_own2, eval = FALSE, include = FALSE}
# corr_pval_df_sub
```

```{r pval_base_plot_owm, fig.width = 10, fig.height= 3l, eval = FALSE, include = FALSE} 
# pval_base_plot_owm <- ggplot2::ggplot(
#   corr_pval_df_sub,
#   aes(y = cons_level_long, 
#       x = nr_genes_used,
#       color = color_id, 
#       size = 10^-pval_corrected))+
#   ggplot2::geom_point(alpha = 1)+
#   ggplot2::facet_grid(cols = vars(corr_pval_df_sub$score_long),
#                       switch = "y")
```

```{r pval_theme_plot_own, fig.width = 9, fig.height = 2l, eval = FALSE, include = FALSE} 
# pval_theme_plot_own <- pval_base_plot_owm+
#   theme_all+
#   ggplot2::scale_x_continuous(
#     position = "bottom",
#     limits = c(0, max_genes),
#     breaks = c(0,  400, 800))+
#   ggplot2::scale_color_manual(values = color_significance)+
#   ggplot2::theme(
#     axis.text.y = element_text(
#       hjust = 0),
#     strip.text.x = element_text(
#       size = axis_title_size,
#       color = axis_title_color,
#       face = axis_title_face),
#     strip.background = element_blank(),
#     axis.title.y = element_blank(),
#     strip.placement = "outside",
#     legend.position = "none")+
#   ggplot2::xlab("# re-clustering genes")
# pval_theme_plot_own
```

### OTHERS

#### VS RAND

```{r pval_othersl, eval = FALSE, include = FALSE}
# 
# corr_pval_df_others <- corr_pval_df[
#   corr_pval_df$condition %in%
#     c("mus_weinreb_hspc", "mus_tm_bonemarrow"),]
# 
# corr_pval_df_others <- corr_pval_df_others[
#   corr_pval_df_others$conservation_level != "conserved_markers",]
# 
# corr_pval_df_others <- corr_pval_df_others[
#   corr_pval_df_others$comparison != "mmms-vs-signrand",]
# 
# corr_pval_df_others$condition_long <- vector(length = nrow(corr_pval_df_others))
# corr_pval_df_others$condition_long[
#   corr_pval_df_others$condition == "mus_weinreb_hspc"] <- "Weinreb et al."
# corr_pval_df_others$condition_long[
#   corr_pval_df_others$condition == "mus_tm_bonemarrow"] <- "tabula muris"
# 
# corr_pval_df_others$condition_long <- factor(
#   corr_pval_df_others$condition_long, levels = rev(c(
#     "tabula muris",
#     "Weinreb et al.")))
```

```{r pval_base_plot_others, fig.width = 10, fig.height= 3l, eval = FALSE, include = FALSE} 
# pval_base_plot_others <- ggplot2::ggplot(
#   corr_pval_df_others,
#   aes(y = condition_long, 
#       x = nr_genes_used,
#       color = color_id, 
#       size = 10^-pval_corrected))+
#   ggplot2::geom_point(alpha = 1)+
#   ggplot2::facet_grid(cols = vars(corr_pval_df_others$score_long),
#                       switch = "y",
#                       rows = vars(corr_pval_df_others$cons_level_long_rev))
```

```{r pval_theme_plot_others, fig.width = 10, fig.height = 2l, eval = FALSE, include = FALSE} 
# pval_theme_plot_others <- pval_base_plot_others+
#   theme_all+
#   ggplot2::scale_x_continuous(
#     position = "bottom",
#     limits = c(0, max_genes),
#     breaks = c(0,  400, 800))+
#   ggplot2::scale_color_manual(values = color_significance)+
#   ggplot2::theme(
#     axis.text.y = element_text(
#       hjust = 0),
#     strip.text.x = element_text(
#       size = axis_title_size,
#       color = axis_title_color,
#       face = axis_title_face),
#     strip.text.y.left = element_text(
#       size = axis_text_size,
#       color = axis_text_color,
#       face = axis_title_face,
#       angle = 0,
#       hjust = 0),
#     strip.background = element_blank(),
#     axis.title.y = element_blank(),
#     strip.placement = "outside",
#     legend.position = "none")+
#   ggplot2::xlab("# re-clustering genes")
# pval_theme_plot_others
```

#### VS SIGN-RAND

```{r pval_others2l, eval = FALSE, include = FALSE}

# corr_pval_df_others2 <- corr_pval_df[
#   corr_pval_df$condition %in%
#     c("mus_weinreb_hspc", "mus_tm_bonemarrow"),]
# 
# corr_pval_df_others2 <- corr_pval_df_others2[
#   corr_pval_df_others$conservation_level != "conserved_markers",]
# 
# corr_pval_df_others2 <- corr_pval_df_others2[
#   corr_pval_df_others2$comparison == "mmms-vs-signrand",]
# 
# corr_pval_df_others2$condition_long <- vector(length = nrow(corr_pval_df_others2))
# corr_pval_df_others2$condition_long[
#   corr_pval_df_others2$condition == "mus_weinreb_hspc"] <- "Weinreb et al."
# corr_pval_df_others2$condition_long[
#   corr_pval_df_others2$condition == "mus_tm_bonemarrow"] <- "tabula muris"
# 
# corr_pval_df_others2$condition_long <- factor(
#   corr_pval_df_others2$condition_long, levels = rev(c(
#     "tabula muris",
#     "Weinreb et al.")))
```

```{r pval_base_plot_others2, fig.width = 10, fig.height= 3l, eval = FALSE, include = FALSE} 
# pval_base_plot_others2 <- ggplot2::ggplot(
#   corr_pval_df_others2,
#   aes(y = condition_long, 
#       x = nr_genes_used,
#       color = color_id, 
#       size = 10^-pval_corrected))+
#   ggplot2::geom_point(alpha = 1)+
#   ggplot2::facet_grid(cols = vars(corr_pval_df_others2$score_long),
#                       switch = "y")
```

```{r pval_theme_plot_others2, fig.width = 8, fig.height = 2l, eval = FALSE, include = FALSE} 
# pval_theme_plot_others2 <- pval_base_plot_others2+
#   theme_all+
#   ggplot2::scale_x_continuous(
#     position = "bottom",
#     limits = c(0, max_genes),
#     breaks = c(0,  400, 800))+
#   ggplot2::scale_color_manual(values = color_significance)+
#   ggplot2::theme(
#     axis.text.y = element_text(
#       hjust = 0),
#     strip.text.x = element_text(
#       size = axis_title_size,
#       color = axis_title_color,
#       face = axis_title_face),
#     strip.text.y.left = element_text(
#       size = axis_text_size,
#       color = axis_text_color,
#       face = axis_title_face,
#       angle = 0,
#       hjust = 0),
#     strip.background = element_blank(),
#     axis.title.y = element_blank(),
#     strip.placement = "outside",
#     legend.position = "none")+
#   ggplot2::xlab("# re-clustering genes")
# pval_theme_plot_others2
```

```{r pval_legend_base_plotl, eval = FALSE, include = FALSE}
# pval_legend_base_plot <- ggplot2::ggplot(
#   corr_pval_df,
#   aes(y = condition, 
#       x = nr_genes_used,
#       color = color_id, 
#       size = 10^-pval_corrected))+
#   ggplot2::geom_point(alpha = 1)+
#   ggplot2::facet_grid(cols = vars(corr_pval_df$score_long),
#                       switch = "y",
#                       rows = vars(corr_pval_df$cons_level_long))
```

```{r pval_legend_theme_plot, fig.width = 4, fig.height= 4l, eval = FALSE, include = FALSE}
# pval_legend_theme_plot <- pval_legend_base_plot+
#   theme_all+
#   ggplot2::scale_color_manual("", values = color_significance)+
#   ggplot2::scale_size_continuous("10 adjusted p val")
# 
# pval_legend_theme <- ggpubr::get_legend(pval_legend_theme_plot)
# 
# pval_legend <- ggpubr::ggarrange(pval_legend_theme)
# pval_legend
```

# UTILS

```{r sessioninfo}
utils::sessionInfo()
```
