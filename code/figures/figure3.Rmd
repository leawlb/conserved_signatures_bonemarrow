---
title: "Figure 3"
date: '2024-09-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Generate Figure 3, current title:
"Mouse cell type signature genes alone are sufficient to identify cell types."

#### Load objects

```{r seed, message = FALSE}
base::RNGkind(kind = "Mersenne-Twister")
set.seed(37)
```

```{r load_packages, message = FALSE}
library(SingleCellExperiment, quietly = TRUE)
library(ggpubr, quietly = TRUE)
library(tidyverse, quietly = TRUE)
#library(gghalves, quietly = TRUE) # not in conda env
library(ggpattern, quietly = TRUE) # not in conda env
library(Seurat, quietly = TRUE) 
```

```{r load_manual_basepath}
base_path <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data"
```

```{r load_manual}
#-------------------------------------------------------------------------------
#### OWN DATASET (HSPCs)

# SCE with reclustering vectors for each gene set
sce_hsc_recl <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/03_recl/sce_hsc"))

# dataframe of re-clustering scores for each gene set
score_df_hsc <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/04_rcls/score_df_hsc"))

# dataframes of re-clustering scores after permutation comparing gene sets
psdf_hsc_mark_signrand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_perg/perm_score_df_mark_hsc"))
psdf_hsc_mmms_signrand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_perg/perm_score_df_mmms_hsc"))

# dataframes of re-clustering scores after background permutation
psdf_hsc_sign_rand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/06_psig/perm_score_df_hsc"))
```

```{r load_manual_other1}
#-------------------------------------------------------------------------------
#### OTHER MOUSE DATASET 1 (HSPC)
#### MUS_TM_BONEMARROW

dataset_1 <- "mus_tm_bonemarrow"

# list of seurat objects with reclustering vectors for each gene set and resolution
seu_hsc_recl_list_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/03_recl/reclustered_mus_tm_bonemarrow_list"))

# list of dataframes of re-clustering scores for each gene set and resolution
score_df_hsc_list_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/04_rcls/score_df_mus_tm_bonemarrow_list"))

# dataframes of re-clustering scores after permutation comparing gene sets
psdf_hsc_mark_signrand_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mark_mus_tm_bonemarrow"))
psdf_hsc_mmms_signrand_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mmms_mus_tm_bonemarrow"))
psdf_hsc_mmms_markrand_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mmms_mark_mus_tm_bonemarrow"))

# perm score DF from background permutation (SIGN)
psdf_hsc_sign_rand_o1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/06_psig/perm_score_df_mus_tm_bonemarrow"))

# perm score DF from background permutation (MARK)
# psdf_hsc_mark_rand_o1 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_pmrk/perm_score_df_li_all_stromal"))
```

```{r load_manual_other2}
#-------------------------------------------------------------------------------
#### OTHER MOUSE DATASET 2 (HSPC)
#### MUS_WEINREB_HSPC

dataset_2 <- "mus_weinreb_hspc"

# list of seurat objects with reclustering vectors for each gene set and resolution
seu_hsc_recl_list_o2 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/03_recl/reclustered_mus_weinreb_hspc_list"))

# list of dataframes of re-clustering scores for each gene set and resolution
score_df_hsc_list_o2 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/04_rcls/score_df_mus_weinreb_hspc_list"))

# dataframes of re-clustering scores after permutation comparing gene sets
psdf_hsc_mark_signrand_o2 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mark_mus_weinreb_hspc"))
psdf_hsc_mmms_signrand_o2 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mmms_mus_weinreb_hspc"))
psdf_hsc_mmms_markrand_o2 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mmms_mark_mus_weinreb_hspc"))

# perm score DF from background permutation (SIGN)
psdf_hsc_sign_rand_o2 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/06_psig/perm_score_df_mus_weinreb_hspc"))

# perm score DF from background permutation (MARK)
# psdf_hsc_mark_rand_o1 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_pmrk/perm_score_df_li_all_stromal"))
```

```{r load_manual_remaining}
#-------------------------------------------------------------------------------
#### REMAINING

# list of gene sets for HSPCs (conserved signature, conserved markers, etc.)
geneset_list_hsc <-base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/01_gens/geneset_list_hsc"))

# data frame containing the correct resolutions for other datasets as visually determined
resolution_df_path <- base::paste0(
  base_path,
  "/metadata/scRNAseq/03_sce_analysis/reclustering_bm/reclustering_other_resolution.txt")

resolution_df <- utils::read.csv(file = resolution_df_path, 
                               header = TRUE, 
                               sep = ";", 
                               check.names=FALSE, 
                               stringsAsFactors=FALSE, 
                               as.is=TRUE, 
                               colClasses = "character")

corr_pval_df <-  readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/09_crpv/all_corrected_pval"))

colors_path <- base::paste0(
  base_path,
  "/metadata/colors/colors.txt")

source("../source/colors.R")
source("../source/plotting.R")
source("../source/sce_functions_reclustering.R")
```

```{r load_snakemake, eval = FALSE, include = FALSE}

#-------------------------------------------------------------------------------
#### OWN DATASET (HSPCs)

# SCE with reclustering vectors for each gene set
sce_hsc_recl <- base::readRDS(snakemake@input[["sce_hsc_recl"]])
  
# dataframe of re-clustering scores for each gene set
score_df_hsc <- base::readRDS(snakemake@input[["score_df_hsc"]])

# dataframes of re-clustering scores after permutation comparing gene sets
psdf_hsc_mark_signrand <- base::readRDS(snakemake@input[["psdf_hsc_mark_signrand"]])
psdf_hsc_mmms_signrand <- base::readRDS(snakemake@input[["psdf_hsc_mmms_signrand"]])

# dataframe of re-clustering scores after background permutation
psdf_hsc_sign_rand <- base::readRDS(snakemake@input[["psdf_hsc_sign_rand"]])


#-------------------------------------------------------------------------------
#### OTHER (HSPC) MOUSE DATASET 1 

# list of seurat objects with reclustering vectors for each gene set
seu_hsc_recl_list_o1 <- base::readRDS(snakemake@input[["seu_hsc_recl_list_o1"]])

# list of dataframes of re-clustering scores for each gene set and resolution
score_df_hsc_list_o1 <- base::readRDS(snakemake@input[["score_df_hsc_list_o1"]])

# dataframes of re-clustering scores after permutation comparing gene sets
psdf_hsc_mark_signrand_o1 <- base::readRDS(snakemake@input[["psdf_hsc_mark_signrand_o1"]])
psdf_hsc_mmms_signrand_o1 <- base::readRDS(snakemake@input[["psdf_hsc_mmms_signrand_o1"]])
psdf_hsc_mmms_markrand_o1 <- base::readRDS(snakemake@input[["psdf_hsc_mmms_markrand_o1"]])

# dataframes of re-clustering scores after background permutation
psdf_hsc_sign_rand_o1 <- base::readRDS(snakemake@input[["psdf_hsc_sign_rand_o1"]])
psdf_hsc_mark_rand_o1 <- base::readRDS(snakemake@input[["psdf_hsc_mark_rand_o1"]])

#-------------------------------------------------------------------------------
#### REMAINING

# list of gene sets for HSPCs (conserved signature, conserved markers, etc.)
geneset_list_hsc <- base::readRDS(snakemake@input[["geneset_list_hsc"]])

# data frame containing the correct resolutions for other datasets as visually determined
resolution_df_path <- snakemake@input[["resolution_df_path"]]

resolution_df <- utils::read.csv(file = resolution_df_path, 
                               header = TRUE, 
                               sep = ";", 
                               check.names=FALSE, 
                               stringsAsFactors=FALSE, 
                               as.is=TRUE, 
                               colClasses = "character")

# colors
colors_path <- snakemake@params[["colors_path"]]
colors_source <- snakemake@params[["colors"]]
source(colors_source)

```

```{r params}
# global params
source("determine_params.R")

col_cons <- c("conserved_signature" = "#db5b00ff",
              "conserved_markers" = "#eb9523ff",
              "mmusall_markers" = "#a7c5a3ff",
              "ndges" = "#ea91adff",
              "random_features" = "grey80")

col_cons_long <- c(
  "conserved identity signature" = "#db5b00ff",
  "conserved markers" = "#eb9523ff",
  "total BL6 markers" = "#a7c5a3ff",
  "ndges" = "#ea91adff",
  "random genes" = "grey80")

point_plot_size <- 4

pattern_fill_color <- "white"
pattern_line_colour <- "white"
pattern_density_val <- 0.4
pattern_spacing_val <- 0.1


color_hline_background <- "grey97"

## CHECK SCORE MAX!!
score2 <- "variation_information"
score1 <- "adjusted_rand_index"
score3 <- "mean_prop_cells_cluster"

score2_long <- "Variation of information"
score1_long <- "Adjusted rand index"
score3_long <- "Mean prop. cells/cluster"

axis_ticks_color <- "black"
# specify one theme for all, customize elements per plot
theme_all <- ggplot2::theme(
  axis.text = element_text(
    size = axis_text_size,
    face = axis_text_face,
    color = axis_text_color),
  axis.title = element_text(
    size = axis_title_size,
    face = axis_title_face,
    color = axis_title_color),
  plot.title = element_text(
    size = plot_title_size,
    face = plot_title_face,
    color = plot_title_color),
  legend.text = element_text(
    size = legend_text_size,
    face = legend_text_face,
    color = legend_text_color),
  legend.title = element_text(
    size = legend_title_size,
    face = legend_title_face,
    color = legend_title_color),
  axis.ticks = element_line(
    color = axis_ticks_color))
```

```{r density_plot_function}
make_pattern_density_plot <- function(
  score_df,
  perm_score_df,
  color_cons,
  ylabel
  ){

  # make temp plot to extract maximum y value
  p_temp <- ggplot2::ggplot(
    perm_score_df,
    aes(x = value))+
    geom_density_pattern()
  
  # calculate the maximum y value (density at its peak)
  density_data <- ggplot2::ggplot_build(p_temp)$data[[1]]
  max_y <- max(density_data$y)
  
  # define the y value for the point as 125% of the maximum y value
  y_value <- 1.25 * max_y
  
  # define the y limits for a nicer plot + y value to place the break/label
  y_lim_low <- -0.25 * max_y
  y_lim_high <- 1.5 * max_y
  y_lim_break <- (y_lim_low + y_lim_high)/2 
  
  # add to score DF
  score_df$y_value <- y_value
  
  # plot
  p_return <- ggplot2::ggplot(
    perm_score_df,
    aes(x = value))+
    geom_density_pattern(
      fill = color_cons,
      color = color_cons,
      pattern = "circle",
      pattern_fill = pattern_fill_color,
      pattern_colour = pattern_line_colour,
      pattern_density =pattern_density_val,
      pattern_spacing = pattern_spacing_val)+
    geom_point(
      inherit.aes = FALSE, 
      data = score_df,
      aes(x = value, y = y_value),
      size = point_plot_size,
      color = color_cons)+
    scale_y_continuous(
      limits = c(y_lim_low, y_lim_high),
      breaks = y_lim_break, 
      labels = ylabel)
  
  return(p_return)
  # TODO: add grey background
}

```

```{r export_paths}
output_pdf_a_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_a.pdf")
output_pdf_a_legend <- base::paste0(
  base_path, "/manuscript1/figures/figure3_a_legend.pdf")
output_pdf_b_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_b.pdf")
output_pdf_b_legend <- base::paste0(
  base_path, "/manuscript1/figures/figure3_b_legend.pdf")
output_pdf_c_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_c.pdf")
output_pdf_d_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_d.pdf")
output_pdf_e_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_e.pdf")
output_pdf_f_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_f.pdf")
output_pdf_g_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_g.pdf")
output_pdf_de_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_de.pdf")
output_pdf_f_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_f.pdf")
output_pdf_g_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_g.pdf")
output_pdf_h_plot <- base::paste0(
  base_path, "/manuscript1/figures/figure3_h.pdf")
output_pdf_h_legend <- base::paste0(
  base_path, "/manuscript1/figures/figure3_h_legend.pdf")
```

# A

Heatmaps of own re-clustered HSPC mouse data using signature genes/
conserved markers/BL6 markers/nDGEs.

#### Prep

```{r a_prep_conserved_signature}
mat_sign <- base::table(
  sce_hsc_recl$celltypes, 
  sce_hsc_recl$cluster_signt)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign)){
  mat_sign[,i] <- mat_sign[,i]/base::sum(mat_sign[,i])
}
sign_df <- base::as.data.frame(mat_sign)

# manually factorise clusters for nice order
sign_df$Var2 <- factor(
  sign_df$Var2,
  levels = base::rev(c(1, 3, 2, 5, 8, 4, 6, 7)))
```

```{r a_prep_conserved_markers}
mat_mark <- base::table(
  sce_hsc_recl$celltypes, 
  sce_hsc_recl$cluster_consm)

for(i in 1:ncol(mat_mark)){
  mat_mark[,i] <- mat_mark[,i]/base::sum(mat_mark[,i])
}
mark_df <- base::as.data.frame(mat_mark)

mark_df$Var2 <- factor(
  mark_df$Var2,
  levels = base::rev(c(1, 3, 8, 10, 5, 2, 11, 4, 6, 7, 12, 9)))
```

```{r a_prep_all_bl6_markers}
mat_mmms <- base::table(
  sce_hsc_recl$celltypes, 
  sce_hsc_recl$cluster_mmusm)

for(i in 1:ncol(mat_mmms)){
  mat_mmms[,i] <- mat_mmms[,i]/base::sum(mat_mmms[,i])
}
mmms_df <- base::as.data.frame(mat_mmms)

mmms_df$Var2 <- factor(
  mmms_df$Var2,
  levels = base::rev(c(1, 3, 10, 11, 12, 5, 2, 9, 4, 6, 14, 13, 8, 7)))
```

#### Plot Components

```{r a_sign_base_plot}
a_sign_base_plot <- ggplot2::ggplot(
  sign_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r a_mark_base_plot}
a_mark_base_plot <- ggplot2::ggplot(
  mark_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r a_mmms_base_plot}
a_mmms_base_plot <- ggplot2::ggplot(
  mmms_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r a_sign_theme_plot}
a_sign_theme_plot <- a_sign_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      hjust = 0.5,
      color = col_cons_long["conserved identity signature"]))+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("Conserved identity signature")
```

```{r a_mark_theme_plot}
a_mark_theme_plot <- a_mark_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_text(
      size = axis_title_size,
      color = axis_title_color,
      face = axis_title_face),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      hjust = 0.5,
      color = col_cons_long["conserved markers"]))+
  ggplot2::ylab("New clusters")+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("Conserved markers")
```

```{r a_mmms_theme_plot}
a_mmms_theme_plot <- a_mmms_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_text(
      size = axis_title_size,
      color = axis_title_color,
      face = axis_title_face,
      margin = margin(t = 0.3, unit = "cm")),
    axis.text.x = element_text(
      size = axis_text_size,
      color = axis_text_color,
      face = axis_text_face,
      angle = 90,
      hjust = 0,
      vjust = 0.5),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      hjust = 0.5,
      color = col_cons_long["total BL6 markers"]))+
  ggplot2::xlab("Original cell types")+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("total BL6 markers")
```

```{r a_legend_theme_plot}
a_legend_plot <- a_mmms_base_plot+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::theme(
    legend.title = element_text(
      face = legend_title_face,
      size = legend_title_size,
      color = legend_title_color,
      margin = margin(r = 10),
      vjust = 0.85),
    legend.text = element_text(
      face = legend_text_face,
      size = legend_text_size,
      color = legend_text_color),
    legend.position = "bottom",
  )
a_legend_theme <- ggpubr::get_legend(a_legend_plot)
```

#### Construct

```{r a_construct, fig.height = 7, fig.width = 3.2}

a_theme_plot <- ggpubr::ggarrange(
  ncol = 1,
  a_sign_theme_plot,
  a_mark_theme_plot,
  a_mmms_theme_plot+
  ggplot2::theme(
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 90,
      hjust = 0,
      vjust = 0.5)),
  align = "v",
  heights = c(1, 1, 2.1)
)

a_theme_plot
```

```{r a_construct_legend, fig.width = 6, fig.height = 1}
a_legend <- ggpubr::ggarrange(a_legend_theme)
```

```{r a_plot_export}
pdf(output_pdf_a_plot, width = 3.2, height = 7)
a_theme_plot
dev.off()
```

```{r a_legend_export}
pdf(output_pdf_a_legend, width = 6, height = 1)
a_legend
dev.off()
```

## B

(Re-) clustering metrics to compare re-clustering of own dataset with signature
genes, conserved markers or all BL6 markers, permuted with different sets of
random genes as indicated (signature + random_conserved_markers,
signature + conserved markers + random_bl6_markers). 

#### Prep

Separate score DFs per conservation level and type of score.

```{r b_prep1}
score_df_sign <- score_df_hsc[
  score_df_hsc$conservation_level == "conserved_signature",]
# add nicer looking conservation level annotation
score_df_sign$conservation_level_long <- "conserved identity signature"

score_df_sign_score_1 <- score_df_sign[score_df_sign$type == score1,]
score_df_sign_score_2 <- score_df_sign[score_df_sign$type == score2,]
score_df_sign_score_3 <- score_df_sign[score_df_sign$type == score3,]
```

```{r b_prep2}
score_df_mark <- score_df_hsc[
  score_df_hsc$conservation_level == "conserved_markers",]
score_df_mark$conservation_level_long <- "conserved markers"

score_df_mark_score_1 <- score_df_mark[score_df_mark$type == score1,]
score_df_mark_score_2 <- score_df_mark[score_df_mark$type == score2,]
score_df_mark_score_3 <- score_df_mark[score_df_mark$type == score3,]
```

```{r b_prep3}
score_df_mmms <- score_df_hsc[
  score_df_hsc$conservation_level == "mmusall_markers",]
score_df_mmms$conservation_level_long <- "total BL6 markers"

score_df_mmms_score_1 <- score_df_mmms[score_df_mmms$type == score1,]
score_df_mmms_score_2 <- score_df_mmms[score_df_mmms$type == score2,]
score_df_mmms_score_3 <- score_df_mmms[score_df_mmms$type == score3,]
```

Also separate the permutation score dfs by conservation level and type of score.

```{r b_prep4}
psdf_mark_signrand_long <- pivot_longer(
  psdf_hsc_mark_signrand, 
  c = 1:ncol(psdf_hsc_mark_signrand),
  values_to = "value",
  names_to = "type")

psdf_mark_signrand_long$conservation_level_long = base::rep(
  "conserved markers", nrow(psdf_mark_signrand_long))

psdf_mark_signrand_score_1 <- psdf_mark_signrand_long[
  psdf_mark_signrand_long$type == score1,]
psdf_mark_signrand_score_2 <- psdf_mark_signrand_long[
  psdf_mark_signrand_long$type == score2,]
psdf_mark_signrand_score_3 <- psdf_mark_signrand_long[
  psdf_mark_signrand_long$type == score3,]
```

```{r b_prep5}
psdf_mmms_signrand_long <- pivot_longer(
  psdf_hsc_mmms_signrand, 
  c = 1:ncol(psdf_hsc_mmms_signrand),
  values_to = "value",
  names_to = "type")

psdf_mmms_signrand_long$conservation_level_long = base::rep(
  "total BL6 markers", nrow(psdf_mmms_signrand_long))

psdf_mmms_signrand_score_1 <- psdf_mmms_signrand_long[
  psdf_mmms_signrand_long$type == score1,]
psdf_mmms_signrand_score_2 <- psdf_mmms_signrand_long[
  psdf_mmms_signrand_long$type == score2,]
psdf_mmms_signrand_score_3 <- psdf_mmms_signrand_long[
  psdf_mmms_signrand_long$type == score3,]
```

get the maximum number of variation of information scores for plot limits

```{r max_vi}
max_vi <- base::max(c(
  
  # actual scores
  score_df_hsc$value[score_df_hsc$type == "variation_information"],
  
  # permuted background scores for conserved signature
  psdf_hsc_sign_rand$variation_information,
  
  # pemruted gene set scores
  psdf_hsc_mmms_signrand$variation_information,
  psdf_hsc_mark_signrand$variation_information)) + 0.5

print(score1)
print(score2)
print(score3)

#TODO: generate max_vi for entire figure
score2_max <- max_vi
score1_max <- 1
score3_max <- 1
```

##### box plots

```{r b_prep6}
# get the number of genes used for each gene set
nr_sign_used <- sce_hsc_recl$cluster_signt_genes_used[1]
nr_mark_used <- sce_hsc_recl$cluster_consm_genes_used[1]
nr_mmms_used <- sce_hsc_recl$cluster_mmusm_genes_used[1]

nr_mark_left <- nr_mark_used - nr_sign_used
nr_mark_rand <- nr_mark_left # same number but keep for tracking purpose

nr_mmms_left <- nr_mmms_used - nr_sign_used
nr_mmms_rand <- nr_mmms_left

max_genes <- nr_mmms_used
```

make dfs for visualisation of gene numbers with boxplots.

```{r b_prep7}
vis_df_sign <- base::data.frame(
  type_y = "conserved identity signature",
  type_fill = "conserved identity signature",
  number = nr_sign_used
)
```

```{r b_prep8}
vis_df_mark <- base::data.frame(
  type_y = c(
    "conserved markers",
    "conserved markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "conserved markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used,
    nr_mark_left,
    nr_sign_used,
    nr_mark_rand)
)

# factor for plot
vis_df_mark$type_fill <- factor(vis_df_mark$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "conserved markers",
  "random genes"
)))
vis_df_mark$type_y <- factor(vis_df_mark$type_y, levels = base::rev(c(
  "conserved markers",
  "permutation gene set"
)))
```

```{r b_prep9}
vis_df_mmms <- base::data.frame(
  type_y = c(
    "total BL6 markers",
    "total BL6 markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "total BL6 markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used,
    nr_mmms_left,
    nr_sign_used,
    nr_mmms_rand)
)

vis_df_mmms$type_fill <- factor(vis_df_mmms$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "total BL6 markers",
  "random genes"
)))
vis_df_mmms$type_y <- factor(vis_df_mmms$type_y, levels = base::rev(c(
  "total BL6 markers",
  "permutation gene set"
)))
```

#### Plot Components

##### part left, score1: Adjusted Rand index

```{r b_base_plot_left1}
b_base_plot_left1 <- ggplot2::ggplot(
  score_df_sign_score_1,
  aes(y = conservation_level_long,
      x = value,
      color = conservation_level_long))+
  ggplot2::geom_vline(
    xintercept = 0.25,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_vline(
    xintercept = 0.75,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r b_theme_plot_left1}
b_theme_plot_left1 <- b_base_plot_left1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.title = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.25, 0.5, 0.75, 1),
    position = "top", 
    limits = c(0, score1_max))+
  ggplot2::ggtitle(score1_long) 
```

```{r b_base_plot_left2}
b_base_plot_left2 <- make_pattern_density_plot(
  score_df = score_df_mark_score_1,
  perm_score_df = psdf_mark_signrand_score_1,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "conserved markers"
)
```

```{r b_theme_plot_left2}
b_theme_plot_left2 <- b_base_plot_left2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score1_max))
```

```{r b_base_plot_left3}
b_base_plot_left3 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1,
  perm_score_df = psdf_mmms_signrand_score_1,
  color_cons = col_cons_long["total BL6 markers"],
  ylabel ="total BL6 markers"
)
```

```{r b_theme_plot_left3}
b_theme_plot_left3 <- b_base_plot_left3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score1_max))
```

```{r b_construct_a, fig.height = 2.8, fig.width = 5}
b_part_left <- ggpubr::ggarrange(
  ncol = 1, 
  b_theme_plot_left1,
  b_theme_plot_left2,
  b_theme_plot_left3,
  heights = c(1.05, 1, 1),
  align = "v"
)
b_part_left
```

##### part middle - left score2: Variation of Information

```{r b_base_plot_mleft1}
b_base_plot_mleft1 <- ggplot2::ggplot(
  score_df_sign_score_2,
  aes(y = conservation_level_long,
      x = value,
      color = conservation_level_long))+
  ggplot2::geom_vline(
    xintercept = 1.5,
      color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_vline(
    xintercept = 4.5,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r b_theme_plot_mleft1}
b_theme_plot_mleft1 <- b_base_plot_mleft1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top",
    limit = c(0, max_vi),
    breaks=c(0, 1, 2, 3, 4, 5))+
  ggplot2::ggtitle("Variation of information")
```

```{r b_base_plot_mleft2}
b_base_plot_mleft2 <- make_pattern_density_plot(
  score_df = score_df_mark_score_2,
  perm_score_df = psdf_mark_signrand_score_2,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "conserved markers"
)
```

```{r b_theme_plot_mleft2}
b_theme_plot_mleft2 <- b_base_plot_mleft2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score2_max))
```

```{r b_base_plot_mleft3}
b_base_plot_mleft3 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2,
  perm_score_df = psdf_mmms_signrand_score_2,
  color_cons = col_cons_long["total BL6 markers"],
  ylabel = "total BL6 markers"
)
```

```{r b_theme_plot_mleft3}
b_theme_plot_mleft3 <- b_base_plot_mleft3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score2_max))
```

```{r b_construct_mleft, fig.height = 2.8, fig.width = 2.8}
b_part_mleft <- ggpubr::ggarrange(
  ncol = 1, 
  b_theme_plot_mleft1,
  b_theme_plot_mleft2,
  b_theme_plot_mleft3,
  heights = c(1.05, 1, 1),
  align = "v"
)
b_part_mleft
```

##### part middle right, score 3 mean prop cells

```{r b_base_plot_mright1}
b_base_plot_mright1 <- ggplot2::ggplot(
  score_df_sign_score_3,
  aes(y = conservation_level_long,
      x = value,
      color = conservation_level_long))+
  ggplot2::geom_vline(
    xintercept = 0.25,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_vline(
    xintercept = 0.75,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r b_theme_plot_mright1}
b_theme_plot_mright1 <- b_base_plot_mright1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top", 
    limits = c(0, 1))+
  ggplot2::ggtitle("Mean prop. cells/cluster")
```

```{r b_base_plot_mright2}
b_base_plot_mright2 <- make_pattern_density_plot(
  score_df = score_df_mark_score_3,
  perm_score_df = psdf_mark_signrand_score_3,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "conserved markers"
)
```

```{r b_theme_plot_mright2}
b_theme_plot_mright2 <- b_base_plot_mright2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score3_max))
```

```{r b_base_plot_mright3}
b_base_plot_mright3 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3,
  perm_score_df = psdf_mmms_signrand_score_3,
  color_cons = col_cons_long["total BL6 markers"],
  ylabel = "total BL6 markers"
)
```

```{r b_theme_plot_mright3}
b_theme_plot_mright3 <- b_base_plot_mright3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score3_max))
```

```{r b_construct_c, fig.height = 2.8, fig.width = 2.8}
b_part_mright <- ggpubr::ggarrange(
  ncol = 1, 
  b_theme_plot_mright1,
  b_theme_plot_mright2,
  b_theme_plot_mright3,
  heights = c(1.05, 1, 1),
  align = "v"
)
b_part_mright
```

##### part right: boxplots

```{r b_base_plot_right1}
b_base_plot_right1 <- ggplot2::ggplot(
  vis_df_sign,
  aes(y = type_y,
      x = number, 
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())
```

```{r b_theme_plot_right1}
b_theme_plot_right1 <- b_base_plot_right1+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.text.x = element_text(
      size = axis_text_size,
      face = axis_text_face,
      color = axis_text_color),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::ggtitle("# re-clustering genes")+
  ggplot2::scale_fill_manual(values = col_cons_long)
```

```{r b_base_plot_right2}
b_base_plot_right2 <- ggplot2::ggplot(
  vis_df_mark,
  aes(y = type_y, 
      x=  number,
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = base::data.frame(
      "type_y" = base::rep("permutation gene set", nr_mark_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    position = position_dodge(preserve = "single"),
    pattern = "circle",
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val)
```

```{r b_theme_plot_right2}
b_theme_plot_right2 <- b_base_plot_right2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, max_genes))+
  ggplot2::xlab("Number of genes")+
  ggplot2::scale_fill_manual(values = col_cons_long)
```

```{r b_base_plot_right3}
b_base_plot_right3 <- ggplot2::ggplot(
  vis_df_mmms,
  aes(y = type_y,
      x = number, 
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = base::data.frame(
      "type_y" = base::rep("permutation gene set", nr_mmms_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    pattern = "circle",
    position = position_dodge(preserve = "single"),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val)
```

```{r b_theme_plot_right3}
b_theme_plot_right3 <- b_base_plot_right3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, max_genes))+
  ggplot2::xlab("Number of genes")+
  ggplot2::scale_fill_manual(values = col_cons_long)
```

```{r b_legend_plot}

vis_df_legend <- base::rbind(vis_df_mmms, vis_df_mark)
vis_df_legend$type_fill <- factor(
  vis_df_legend$type_fill,
  levels = c("conserved identity signature",
             "conserved markers",
             "total BL6 markers",
             "random genes")
)

b_legend_right_plot <- ggplot2::ggplot(
  vis_df_legend,
    aes(y = type_y,
      x = number, 
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = base::data.frame(
      "type_y" = base::rep("permutation gene set", nr_mmms_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    pattern = "circle",
    position = position_dodge(preserve = "single"),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val)+
  ggplot2::theme(
    legend.title = element_text(
      size = legend_title_size,
      face = legend_title_face,
      color = legend_title_color),
    legend.text = element_text(
      size = legend_text_size,
      face = legend_text_face,
      color = legend_text_color))+
  ggplot2::scale_fill_manual(
    "re-clustering gene sets",
    values = col_cons_long)

b_legend_right <- ggpubr::get_legend(b_legend_right_plot)
```

```{r b_legend, fig.width = 3, fig.height = 1.8}
b_legend <- ggpubr::ggarrange(b_legend_right)
b_legend
```

```{r b_construct_right, fig.height = 2.8, fig.width = 2.8}
b_part_right <- ggpubr::ggarrange(
  ncol = 1, 
  b_theme_plot_right1, # barplot width depends on plot size
  b_theme_plot_right2,
  b_theme_plot_right3,
  heights = c(1.05, 1, 1),
  align = "v"
)
b_part_right
```

```{r b_construct_all, fig.height = 3.5, fig.width = 13}

# the ratio between upper panel and lower two panels depends on the
# height of the entire plot

b_all_plot <- ggpubr::ggarrange(
  ncol = 4,
  b_part_left,
  b_part_mleft,
  b_part_mright,
  b_part_right,
  widths = c(3.8, 2, 2, 1.5),
  align = "v"
)
b_all_plot
```

```{r b_plot_export}
# pdf(output_pdf_b_plot, width = 12.7, height = 3.7)
# b_all_plot
# dev.off()
```

```{r b_legend_export}
# pdf(output_pdf_b_legend, width = 3, height = 1.8)
# b_legend
# dev.off()
```

## C

#### Prep

Can re-use conserved signature DFs generated for part B.
Make DFs for conserved signature permuted scores.

```{r c_prep1}
psdf_sign_rand_long <- tidyr::pivot_longer(
  psdf_hsc_sign_rand, 
  c = 1:ncol(psdf_hsc_sign_rand),
  values_to = "value",
  names_to = "type")

psdf_sign_rand_long$conservation_level_long <- base::rep(
  "conserved identity signature", nrow(psdf_sign_rand_long))

psdf_sign_rand_score_1 <- psdf_sign_rand_long[psdf_sign_rand_long$type %in% 
                                               c("adjusted_rand_index"),]
psdf_sign_rand_score_2 <- psdf_sign_rand_long[psdf_sign_rand_long$type %in% 
                                               c("variation_information"),]
psdf_sign_rand_score_3 <- psdf_sign_rand_long[psdf_sign_rand_long$type %in% 
                                               c("mean_prop_cells_cluster"),]
```

Make DF with gene numbers also for conserved signature background permutation.

```{r c_prep2}
vis_df_sign_rand <- base::data.frame(
  type_y = c(
    "conserved identity signature",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used,
    nr_sign_used))

vis_df_sign_rand$type_fill <- factor(
  vis_df_sign_rand$type_fill,
  levels = base::rev(c(
    "conserved identity signature",
    "random genes")))

vis_df_sign_rand$type_y <- factor(
  vis_df_sign_rand$type_y, 
  levels = base::rev(c(
    "conserved identity signature",
    "permutation gene set")))
```

##### part left: adjusted rand index

```{r c_base_plot_left}
c_base_plot_left <- make_pattern_density_plot(
  score_df = score_df_sign_score_1,
  perm_score_df = psdf_sign_rand_score_1,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "conserved identity signature"
)
```

```{r c_theme_plot_left}
c_theme_plot_left <- c_base_plot_left+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      color = axis_text_color,
      size = axis_text_size),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5),
    axis.text.y = element_text(
      face = axis_text_face,
      color = axis_text_color,
      size = axis_text_size),  
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score1_max), 
    position = "top")+
  ggplot2::ggtitle("Adjusted rand index")
```

##### part left middle: variation information

```{r c_base_plot_mleft}
c_base_plot_mleft <- make_pattern_density_plot(
  score_df = score_df_sign_score_2,
  perm_score_df = psdf_sign_rand_score_2,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "conserved identity signature"
)
```

```{r c_theme_plot_mleft}
c_theme_plot_mleft <- c_base_plot_mleft+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      color = axis_text_color,
      size = axis_text_size),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5),
    axis.text.y = element_blank(),  
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score2_max), 
    position = "top")+
  ggplot2::ggtitle("Variation of Information")
```

#### part middle right: prop cells/cluster

```{r c_base_plot_mright}
c_base_plot_mright <- make_pattern_density_plot(
  score_df = score_df_sign_score_3,
  perm_score_df = psdf_sign_rand_score_3,
  color_cons = col_cons_long["conserved identity signature"],
  ylabel = "conserved identity signature"
)
```

```{r c_theme_plot_mright}
c_theme_plot_mright <- c_base_plot_mright+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      color = axis_text_color,
      size = axis_text_size),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5),
    axis.text.y = element_blank(),  
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score3_max), 
    position = "top")+
  ggplot2::ggtitle("Mean prop. cells/cluster")
```

#### part right: barplots

```{r c_base_plot_right}
c_base_plot_right <- ggplot2::ggplot(
  vis_df_sign_rand,
  aes(y = type_y, 
        x = number, 
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = base::data.frame(
      "type_y" = base::rep("permutation gene set", nr_sign_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    position = position_dodge(preserve = "single"),
    pattern = "circle",
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val)
```

```{r c_theme_plot_right}
c_theme_plot_right <- c_base_plot_right+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(
      size = axis_text_size,
      face = axis_text_face,
      color = axis_text_color,
      hjust = 0.5),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    limits = c(0, max_genes),
    position = "top")+
  ggplot2::scale_fill_manual(values = col_cons_long)+
  ggplot2::ggtitle("# re-clustering genes")
```

#### Assemble

```{r c_assemble_plot, fig.width = 12.7, fig.height = 1.8}

c_theme_plot <- ggpubr::ggarrange(
  c_theme_plot_left,
  c_theme_plot_mleft,
  c_theme_plot_mright,
  c_theme_plot_right,
  nrow = 1,
  widths = c(3.8, 2, 2, 1.5)
)
c_theme_plot
```

```{r c_plot_export}
# pdf(output_pdf_c_plot, width = 12.7, height = 1.8)
# c_theme_plot
# dev.off()
```

## D 

#### Prep

```{r d_prep1}

resolution_df_o1 <- resolution_df[resolution_df$dataset == dataset_1,]

selected_seu_list <- lapply(seu_hsc_recl_list_o1, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  
  resdf_temp <- resolution_df_o1[resolution_df_o1$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
  
})
```

```{r d_prep_conserved_signature}
d_mat_sign <- base::table(selected_seu_list$seu_sign$cell_type, 
                          selected_seu_list$seu_sign$seurat_clusters)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(d_mat_sign)){
  d_mat_sign[,i] <- d_mat_sign[,i]/base::sum(d_mat_sign[,i])
}
d_sign_df <- base::as.data.frame(d_mat_sign)

# manually factorise clusters
d_sign_df$Var2 <- factor(
  d_sign_df$Var2,
  levels = base::rev(c(1, 0, 4, 8, 5, 6, 7, 3, 2)))
```

```{r d_prep_conserved_markers}
d_mat_mark <- base::table(selected_seu_list$seu_mark$cell_type, 
                          selected_seu_list$seu_mark$seurat_clusters)

for(i in 1:ncol(d_mat_mark)){
  d_mat_mark[,i] <- d_mat_mark[,i]/base::sum(d_mat_mark[,i])
  }
d_mark_df <- base::as.data.frame(d_mat_mark)

d_mark_df$Var2 <- factor(
  d_mark_df$Var2,
  levels = base::rev(c(1, 0, 3, 6, 4, 5, 2, 7)))
```

```{r d_prep_all_bl6_markers}
d_mat_mmms <- base::table(selected_seu_list$seu_mmms$cell_type, 
                          selected_seu_list$seu_mmms$seurat_clusters)

for(i in 1:ncol(d_mat_mmms)){
  d_mat_mmms[,i] <- d_mat_mmms[,i]/base::sum(d_mat_mmms[,i])
}
d_mmms_df <- base::as.data.frame(d_mat_mmms)

d_mmms_df$Var2 <- factor(
  d_mmms_df$Var2,
  levels = base::rev(c(1, 4, 0, 3, 5, 2, 6)))
```

#### Plot Components

```{r d_sign_base_plot}
d_sign_base_plot <- ggplot2::ggplot(
  d_sign_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r d_mark_base_plot}
d_mark_base_plot <- ggplot2::ggplot(
  d_mark_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r d_mmms_base_plot}
d_mmms_base_plot <- ggplot2::ggplot(
  d_mmms_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r d_sign_theme_plot}
d_sign_theme_plot <- d_sign_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      hjust = 0.5,
      color = col_cons_long["conserved identity signature"]))+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))
```

```{r d_mark_theme_plot}
d_mark_theme_plot <- d_mark_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_text(
      size = axis_title_size,
      face = axis_title_face,
      color = axis_title_color),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      hjust = 0.5,
      color = col_cons_long["conserved markers"]))+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ylab("New clusters")
```

```{r d_mmms_theme_plot}
d_mmms_theme_plot <- d_mmms_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      size = axis_text_size,
      face = axis_text_face,
      color = axis_text_color,
      angle = 90,
      hjust = 0,
      vjust = 0.5),
    axis.title.x = element_text(
      size = axis_title_size,
      face = axis_title_face,
      color = axis_title_color,
      margin = margin(t = 0.3, unit = "cm")),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      hjust = 0.5,
      color = col_cons_long["total BL6 markers"]))+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::xlab("Original cell types")
```

#### Construct

```{r d_construct, fig.width = 3.2, fig.height = 9.2}

d_theme_plot <- ggpubr::ggarrange(
  ncol = 1,
  d_sign_theme_plot,
  d_mark_theme_plot,
  d_mmms_theme_plot+
  ggplot2::theme(
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 90,
      hjust = 0,
      vjust = 0.5)),
  align = "v",
  heights = c(1, 1, 3.5)
)

d_theme_plot
```

```{r d_plot_export}
# pdf(output_pdf_d_plot, width = 3.2, height = 9.2)
# d_theme_plot
# dev.off()
```

## E

#### Prep

##### perm plots

```{r e_prep1}
selected_score_df_list_o1 <- lapply(score_df_hsc_list_o1, function(score_df_list){
  
  conslev_curr <- score_df_list[[1]]$conservation_level[1]
  
  resdf_temp <- resolution_df_o1[
    resolution_df_o1$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  score_df_return <- score_df_list[[res_curr]]
  return(score_df_return)
  
})
score_df_hsc_o1 <- dplyr::bind_rows(selected_score_df_list_o1)
```

```{r e_prep2}
score_df_sign_o1 <- score_df_hsc_o1[
  score_df_hsc_o1$conservation_level == "conserved_signature",]
score_df_sign_o1$conservation_level_long <- "conserved identity signature"

score_df_sign_score_1_o1 <- score_df_sign_o1[
  score_df_sign_o1$type == "adjusted_rand_index",]
score_df_sign_score_2_o1 <- score_df_sign_o1[
  score_df_sign_o1$type == "variation_information",]
score_df_sign_score_3_o1 <- score_df_sign_o1[
  score_df_sign_o1$type == "mean_prop_cells_cluster",]
```

```{r e_prep3}
score_df_mark_o1 <- score_df_hsc_o1[
  score_df_hsc_o1$conservation_level == "conserved_markers",]
score_df_mark_o1$conservation_level_long <- "conserved markers"

score_df_mark_score_1_o1 <- score_df_mark_o1[
  score_df_mark_o1$type == "adjusted_rand_index",]
score_df_mark_score_2_o1 <- score_df_mark_o1[
  score_df_mark_o1$type == "variation_information",]
score_df_mark_score_3_o1 <- score_df_mark_o1[
  score_df_mark_o1$type == "mean_prop_cells_cluster",]
```

```{r e_prep4}
psdf_mark_signrand_long_o1 <- pivot_longer(
  psdf_hsc_mark_signrand_o1, 
  c = 1:ncol(psdf_hsc_mark_signrand_o1),
  values_to = "value",
  names_to = "type")
psdf_mark_signrand_long_o1$conservation_level_long = base::rep(
  "conserved markers", nrow(psdf_mark_signrand_long_o1))

psdf_mark_signrand_score_1_o1 <- psdf_mark_signrand_long_o1[
  psdf_mark_signrand_long_o1$type %in% c("adjusted_rand_index"),]
psdf_mark_signrand_score_2_o1 <- psdf_mark_signrand_long_o1[
  psdf_mark_signrand_long_o1$type %in% c("variation_information"),]
psdf_mark_signrand_score_3_o1 <- psdf_mark_signrand_long_o1[
  psdf_mark_signrand_long_o1$type %in% c("mean_prop_cells_cluster"),]
```

```{r e_prep5}
score_df_mmms_o1  <- score_df_hsc_o1[
  score_df_hsc_o1$conservation_level == "mmusall_markers",]
score_df_mmms_o1$conservation_level_long <- "total BL6 markers"

score_df_mmms_score_1_o1 <- score_df_mmms_o1[
  score_df_mmms_o1$type == "adjusted_rand_index",]
score_df_mmms_score_2_o1 <- score_df_mmms_o1[
  score_df_mmms_o1$type == "variation_information",]
score_df_mmms_score_3_o1 <- score_df_mmms_o1[
  score_df_mmms_o1$type == "mean_prop_cells_cluster",]
```

```{r e_prep6}
psdf_mmms_signrand_long_o1 <- tidyr::pivot_longer(
  psdf_hsc_mmms_signrand_o1, 
  c = 1:ncol(psdf_hsc_mmms_signrand_o1),
  values_to = "value",
  names_to = "type")
psdf_mmms_signrand_long_o1$conservation_level_long = base::rep(
  "total BL6 markers", nrow(psdf_mmms_signrand_long_o1))

psdf_mmms_signrand_score_1_o1 <- psdf_mmms_signrand_long_o1[
  psdf_mmms_signrand_long_o1$type %in% c("adjusted_rand_index"),]
psdf_mmms_signrand_score_2_o1 <- psdf_mmms_signrand_long_o1[
  psdf_mmms_signrand_long_o1$type %in% c("variation_information"),]
psdf_mmms_signrand_score_3_o1 <- psdf_mmms_signrand_long_o1[
  psdf_mmms_signrand_long_o1$type %in% c("mean_prop_cells_cluster"),]
```

```{r e_prep7}

# get the number of genes used for each gene set
nr_sign_used <- selected_score_df_list_o1$seu_sign$nr_genes_used[1]

nr_mark_used <- selected_score_df_list_o1$seu_mark$nr_genes_used[1]
nr_mmms_used <- selected_score_df_list_o1$seu_mmms$nr_genes_used[1]

nr_mark_left <- nr_mark_used - nr_sign_used
nr_mark_rand <- nr_mark_left # same number but keep for tracking purpose

nr_mmms_left <- nr_mmms_used - nr_sign_used
nr_mmms_rand <- nr_mmms_left

max_genes <- nr_mmms_used
```

```{r e_prep8}
e_vis_df_sign <- base::data.frame(
  type_y = "conserved identity signature",
  type_fill = "conserved identity signature",
  number = nr_sign_used
)
```

```{r e_prep9}
e_vis_df_mark <- base::data.frame(
  type_y = c(
    "conserved markers",
    "conserved markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "conserved markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used,
    nr_mark_left,
    nr_sign_used,
    nr_mark_rand)
)

# factor for plot
e_vis_df_mark$type_fill <- factor(e_vis_df_mark$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "conserved markers",
  "random genes"
)))
e_vis_df_mark$type_y <- factor(e_vis_df_mark$type_y, levels = base::rev(c(
  "conserved markers",
  "permutation gene set"
)))
```

```{r e_prep10}
e_vis_df_mmms <- base::data.frame(
  type_y = c(
    "total BL6 markers",
    "total BL6 markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "total BL6 markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used,
    nr_mmms_left,
    nr_sign_used,
    nr_mmms_rand)
)

e_vis_df_mmms$type_fill <- factor(e_vis_df_mmms$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "total BL6 markers",
  "random genes"
)))
e_vis_df_mmms$type_y <- factor(e_vis_df_mmms$type_y, levels = base::rev(c(
  "total BL6 markers",
  "permutation gene set"
)))
```

#### Plot parts

##### part left, score1: Adjusted Rand index

```{r e_base_plot_left1}
e_base_plot_left1 <- ggplot2::ggplot(
  score_df_sign_score_1_o1,
  aes(y = conservation_level_long,
      x = value,
      color = conservation_level_long))+
  ggplot2::geom_vline(
    xintercept = 0.25,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_vline(
    xintercept = 0.75,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r e_theme_plot_left1}
e_theme_plot_left1 <- e_base_plot_left1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.title = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.25, 0.5, 0.75, 1),
    position = "top", 
    limits = c(0, score1_max))+
  ggplot2::ggtitle(score1_long) 
```

```{r e_base_plot_left2}
e_base_plot_left2 <- make_pattern_density_plot(
  score_df = score_df_mark_score_1_o1,
  perm_score_df = psdf_mark_signrand_score_1_o1,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "conserved markers"
)
```

```{r e_theme_plot_left2}
e_theme_plot_left2 <- e_base_plot_left2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score1_max))
```

```{r e_base_plot_left3}
e_base_plot_left3 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1_o1,
  perm_score_df = psdf_mmms_signrand_score_1_o1,
  color_cons = col_cons_long["total BL6 markers"],
  ylabel = "total BL6 markers"
)
```

```{r e_theme_plot_left3}
e_theme_plot_left3 <- e_base_plot_left3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score1_max))
```

```{r e_construct_left, fig.height = 2.8, fig.width = 5}
e_part_left <- ggpubr::ggarrange(
  ncol = 1, 
  e_theme_plot_left1+theme(plot.title = element_blank()),
  e_theme_plot_left2,
  e_theme_plot_left3,
  heights = c(1.05, 1, 1),
  align = "v"
)
e_part_left
```

##### part e middle - left score2: Variation of Information

```{r e_base_plot_mleft1}
e_base_plot_mleft1 <- ggplot2::ggplot(
  score_df_sign_score_2_o1,
  aes(y = conservation_level_long,
      x = value,
      color = conservation_level_long))+
  ggplot2::geom_vline(
    xintercept = 1.5,
      color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_vline(
    xintercept = 4.5,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r e_theme_plot_mleft1}
e_theme_plot_mleft1 <- e_base_plot_mleft1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top",
    limit = c(0, max_vi),
    breaks=c(0, 1, 2, 3, 4, 5))+
  ggplot2::ggtitle("Variation of information")
```

```{r e_base_plot_mleft2}
e_base_plot_mleft2 <- make_pattern_density_plot(
  score_df = score_df_mark_score_2_o1,
  perm_score_df = psdf_mark_signrand_score_2_o1,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "conserved markers"
)
```

```{r e_theme_plot_mleft2}
e_theme_plot_mleft2 <- e_base_plot_mleft2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score2_max))
```

```{r e_base_plot_mleft3}
e_base_plot_mleft3 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2_o1,
  perm_score_df = psdf_mmms_signrand_score_2_o1,
  color_cons = col_cons_long["total BL6 markers"],
  ylabel = "total BL6 markers"
)
```

```{r e_theme_plot_mleft3}
e_theme_plot_mleft3 <- e_base_plot_mleft3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score2_max))
```

```{r e_construct_mleft, fig.height = 2.8, fig.width = 2.8}
e_part_mleft <- ggpubr::ggarrange(
  ncol = 1, 
  e_theme_plot_mleft1+theme(plot.title = element_blank()),
  e_theme_plot_mleft2,
  e_theme_plot_mleft3,
  heights = c(1.05, 1, 1),
  align = "v"
)
e_part_mleft
```

##### part middle-right, score3, mean prop cells

```{r e_base_plot_mright1}
e_base_plot_mright1 <- ggplot2::ggplot(
  score_df_sign_score_3_o1,
  aes(y = conservation_level_long,
      x = value,
      color = conservation_level_long))+
  ggplot2::geom_vline(
    xintercept = 0.25,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_vline(
    xintercept = 0.75,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r e_theme_plot_mright1}
e_theme_plot_mright1 <- e_base_plot_mright1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top", 
    limits = c(0, 1))+
  ggplot2::ggtitle("Mean prop. cells/cluster")
```

```{r e_base_plot_mright2}
e_base_plot_mright2 <- make_pattern_density_plot(
  score_df = score_df_mark_score_3_o1,
  perm_score_df = psdf_mark_signrand_score_3_o1,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "conserved markers"
)
```

```{r e_theme_plot_mright2}
e_theme_plot_mright2 <- e_base_plot_mright2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score3_max))
```

```{r e_base_plot_mright3}
e_base_plot_mright3 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3_o1,
  perm_score_df = psdf_mmms_signrand_score_3_o1,
  color_cons = col_cons_long["total BL6 markers"],
  ylabel = "total BL6 markers"
)
```

```{r e_theme_plot_mright3}
e_theme_plot_mright3 <- e_base_plot_mright3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score3_max))
```

```{r e_construct_mright, fig.height = 2.8, fig.width = 2.8}
e_part_mright <- ggpubr::ggarrange(
  ncol = 1, 
  e_theme_plot_mright1+theme(plot.title = element_blank()),
  e_theme_plot_mright2,
  e_theme_plot_mright3,
  heights = c(1.05, 1, 1),
  align = "v"
)
e_part_mright
```

##### part right: boxplots

```{r e_base_plot_right1}
e_base_plot_right1 <- ggplot2::ggplot(
  e_vis_df_sign,
  aes(y = type_y,
      x = number, 
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())
```

```{r e_theme_plot_right1}
e_theme_plot_right1 <- e_base_plot_right1+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.text.x = element_text(
      size = axis_text_size,
      face = axis_text_face,
      color = axis_text_color),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::ggtitle("# re-clustering genes")+
  ggplot2::scale_fill_manual(values = col_cons_long)
```

```{r e_base_plot_right2}
e_base_plot_right2 <- ggplot2::ggplot(
  e_vis_df_mark,
  aes(y = type_y, 
      x=  number,
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = base::data.frame(
      "type_y" = base::rep("permutation gene set", nr_mark_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    position = position_dodge(preserve = "single"),
    pattern = "circle",
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val)
```

```{r e_theme_plot_right2}
e_theme_plot_right2 <- e_base_plot_right2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, max_genes))+
  ggplot2::xlab("Number of genes")+
  ggplot2::scale_fill_manual(values = col_cons_long)
```

```{r e_base_plot_right3}
e_base_plot_right3 <- ggplot2::ggplot(
  e_vis_df_mmms,
  aes(y = type_y,
      x = number, 
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = base::data.frame(
      "type_y" = base::rep("permutation gene set", nr_mmms_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    pattern = "circle",
    position = position_dodge(preserve = "single"),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val)
```

```{r e_theme_plot_right3}
e_theme_plot_right3 <- e_base_plot_right3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, max_genes))+
  ggplot2::xlab("Number of genes")+
  ggplot2::scale_fill_manual(values = col_cons_long)
```

```{r e_construct_right, fig.height = 2.8, fig.width = 2.8}
e_part_right <- ggpubr::ggarrange(
  ncol = 1, 
  e_theme_plot_right1+theme(plot.title = element_blank()), # barplot width depends on plot size
  e_theme_plot_right2,
  e_theme_plot_right3,
  heights = c(1.05, 1, 1),
  align = "v"
)
e_part_right
```

```{r e_construct_all, fig.height = 2.7, fig.width = 11.3}

# the ratio between upper panel and lower two panels depends on the
# height of the entire plot

e_all_plot <- ggpubr::ggarrange(
  ncol = 4,
  e_part_left,
  e_part_mleft,
  e_part_mright,
  e_part_right,
  widths = c(3.8, 2, 2, 1.7),
  align = "v"
)
e_all_plot
```

```{r f_plot_export}
# w <- round(11.3/2.53, digits = 1)
# h <- round(4/2.53, digits = 1)

w <- 11.3
h <- 2.7

pdf(output_pdf_f_plot, width = w, height = h)
e_all_plot
dev.off()
```

## F

#### Prep

```{r f_prep1}

resolution_df_o2 <- resolution_df[resolution_df$dataset == dataset_2,]

selected_seu_list_o2 <- lapply(seu_hsc_recl_list_o2, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  
  resdf_temp <- resolution_df_o2[resolution_df_o2$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
  
})
```

```{r f_prep_conserved_signature}
f_mat_sign <- base::table(selected_seu_list_o2$seu_sign$cell_type, 
                          selected_seu_list_o2$seu_sign$seurat_clusters)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(f_mat_sign)){
  f_mat_sign[,i] <- f_mat_sign[,i]/base::sum(f_mat_sign[,i])
}
f_sign_df <- base::as.data.frame(f_mat_sign)

# manually factorise clusters
f_sign_df$Var2 <- factor(
  f_sign_df$Var2,
  levels = base::rev(c(3, 4, 6, 8, 9, 7, 5, 2, 11, 10, 1, 0)))
```

```{r f_prep_conserved_markers}
f_mat_mark <- base::table(selected_seu_list_o2$seu_mark$cell_type, 
                          selected_seu_list_o2$seu_mark$seurat_clusters)

for(i in 1:ncol(f_mat_mark)){
  f_mat_mark[,i] <- f_mat_mark[,i]/base::sum(f_mat_mark[,i])
  }
f_mark_df <- base::as.data.frame(f_mat_mark)

f_mark_df$Var2 <- factor(
  f_mark_df$Var2,
  levels = base::rev(c(3, 2, 7, 8, 9, 5, 4, 6, 10, 12, 11, 1, 0)))
```

```{r f_prep_all_bl6_markers}
f_mat_mmms <- base::table(selected_seu_list_o2$seu_mmms$cell_type, 
                          selected_seu_list_o2$seu_mmms$seurat_clusters)

for(i in 1:ncol(f_mat_mmms)){
  f_mat_mmms[,i] <- f_mat_mmms[,i]/base::sum(f_mat_mmms[,i])
}
f_mmms_df <- base::as.data.frame(f_mat_mmms)

f_mmms_df$Var2 <- factor(
  f_mmms_df$Var2,
  levels = base::rev(c(2, 15, 14, 3, 6, 9, 11, 5, 4, 7, 10, 13, 12, 8, 1, 0)))
```

#### Plot Components

```{r f_sign_base_plot}
f_sign_base_plot <- ggplot2::ggplot(
  f_sign_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r f_mark_base_plot}
f_mark_base_plot <- ggplot2::ggplot(
  f_mark_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r f_mmms_base_plot}
f_mmms_base_plot <- ggplot2::ggplot(
  f_mmms_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r f_sign_theme_plot}
f_sign_theme_plot <- f_sign_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      hjust = 0.5,
      color = col_cons_long["conserved identity signature"]))+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))
```

```{r f_mark_theme_plot}
f_mark_theme_plot <- f_mark_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_text(
      size = axis_title_size,
      face = axis_title_face,
      color = axis_title_color),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      hjust = 0.5,
      color = col_cons_long["conserved markers"]))+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ylab("New clusters")
```

```{r f_mmms_theme_plot}
f_mmms_theme_plot <- f_mmms_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      size = axis_text_size,
      face = axis_text_face,
      color = axis_text_color,
      angle = 90,
      hjust = 0,
      vjust = 0.5),
    axis.title.x = element_text(
      size = axis_title_size,
      face = axis_title_face,
      color = axis_title_color,
      margin = margin(t = 0.3, unit = "cm")),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      hjust = 0.5,
      color = col_cons_long["total BL6 markers"]))+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::xlab("Original cell types")
```

#### Construct

```{r f_construct, fig.width = 3.2, fig.height = 9.2}

f_theme_plot <- ggpubr::ggarrange(
  ncol = 1,
  f_sign_theme_plot,
  f_mark_theme_plot,
  f_mmms_theme_plot+
  ggplot2::theme(
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 90,
      hjust = 0,
      vjust = 0.5)),
  align = "v",
  heights = c(1, 1, 2)
)

f_theme_plot
```

```{r de_construct, fig.width = 4.5, fig.height = 4}
sign_plots <- ggpubr::ggarrange(
  ncol = 2,
  d_sign_theme_plot,
  f_sign_theme_plot)

sign_plots_title <- annotate_figure(
  sign_plots,
  top = ggpubr::text_grob(
    "Conserved identity signature", 
    color = col_cons_long["conserved identity signature"], 
    face = plot_title_face,
    size = plot_title_size))

mark_plots <- ggpubr::ggarrange(
  ncol = 2,
  d_mark_theme_plot+theme(axis.title.y = element_blank()),
  f_mark_theme_plot+theme(axis.title.y = element_blank()))

mark_plots_title <- annotate_figure(
  mark_plots,
  top = ggpubr::text_grob(
    "Conserved markers", 
    color = col_cons_long["conserved markers"], 
    face = plot_title_face,
    size = plot_title_size))

mmms_plots <- ggpubr::ggarrange(
  ncol = 2,
  align = "hv",
  d_mmms_theme_plot,
  f_mmms_theme_plot)

mmms_plots_title <- annotate_figure(
  mmms_plots,
  top = ggpubr::text_grob(
    "total BL6 markers", 
    color = col_cons_long["total BL6 markers"], 
    face = plot_title_face,
    size = plot_title_size))
```

```{r de_construct2, fig.width = 4.5, fig.height = 9.2}
de_plot <- ggpubr::ggarrange(
  sign_plots_title,
  mark_plots_title,
  mmms_plots_title,
  nrow = 3,
  align = "hv",
  heights = c(1, 1, 3.5)
)

de_plot
```

```{r de_plot_export}

# w <- round(4.5/2.53, digits = 2)
# h <- round(9.5/2.53, digits = 2)

# w <- 4.5
# h <- 9.5
# the factor to go from R to affinity is 2.53 (approximately)
# then, the text sizes as WE WANT THEM EXACTLY can be added.
# but for now, keep like this

pdf(output_pdf_de_plot, width = w, height = h)
de_plot
dev.off()
#knitr::knit_exit()
```

## G

#### Prep

##### perm plots

```{r g_prep1}
selected_score_df_list_o2 <- lapply(score_df_hsc_list_o2, function(score_df_list){
  
  conslev_curr <- score_df_list[[1]]$conservation_level[1]
  
  resdf_temp <- resolution_df_o2[
    resolution_df_o2$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  score_df_return <- score_df_list[[res_curr]]
  return(score_df_return)
  
})
score_df_hsc_o2 <- dplyr::bind_rows(selected_score_df_list_o2)
```

```{r g_prep2}
score_df_sign_o2 <- score_df_hsc_o2[
  score_df_hsc_o2$conservation_level == "conserved_signature",]
score_df_sign_o2$conservation_level_long <- "conserved identity signature"

score_df_sign_score_1_o2 <- score_df_sign_o2[
  score_df_sign_o2$type == "adjusted_rand_index",]
score_df_sign_score_2_o2 <- score_df_sign_o2[
  score_df_sign_o2$type == "variation_information",]
score_df_sign_score_3_o2 <- score_df_sign_o2[
  score_df_sign_o2$type == "mean_prop_cells_cluster",]
```

```{r g_prep3}
score_df_mark_o2 <- score_df_hsc_o2[
  score_df_hsc_o2$conservation_level == "conserved_markers",]
score_df_mark_o2$conservation_level_long <- "conserved markers"

score_df_mark_score_1_o2 <- score_df_mark_o2[
  score_df_mark_o2$type == "adjusted_rand_index",]
score_df_mark_score_2_o2 <- score_df_mark_o2[
  score_df_mark_o2$type == "variation_information",]
score_df_mark_score_3_o2 <- score_df_mark_o2[
  score_df_mark_o2$type == "mean_prop_cells_cluster",]
```

```{r g_prep4}
psdf_mark_signrand_long_o2 <- pivot_longer(
  psdf_hsc_mark_signrand_o2, 
  c = 1:ncol(psdf_hsc_mark_signrand_o2),
  values_to = "value",
  names_to = "type")
psdf_mark_signrand_long_o2$conservation_level_long = base::rep(
  "conserved markers", nrow(psdf_mark_signrand_long_o2))

psdf_mark_signrand_score_1_o2 <- psdf_mark_signrand_long_o2[
  psdf_mark_signrand_long_o2$type %in% c("adjusted_rand_index"),]
psdf_mark_signrand_score_2_o2 <- psdf_mark_signrand_long_o2[
  psdf_mark_signrand_long_o2$type %in% c("variation_information"),]
psdf_mark_signrand_score_3_o2 <- psdf_mark_signrand_long_o2[
  psdf_mark_signrand_long_o2$type %in% c("mean_prop_cells_cluster"),]
```

```{r g_prep5}
score_df_mmms_o2  <- score_df_hsc_o2[
  score_df_hsc_o2$conservation_level == "mmusall_markers",]
score_df_mmms_o2$conservation_level_long <- "total BL6 markers"

score_df_mmms_score_1_o2 <- score_df_mmms_o2[
  score_df_mmms_o2$type == "adjusted_rand_index",]
score_df_mmms_score_2_o2 <- score_df_mmms_o2[
  score_df_mmms_o2$type == "variation_information",]
score_df_mmms_score_3_o2 <- score_df_mmms_o2[
  score_df_mmms_o2$type == "mean_prop_cells_cluster",]
```

```{r g_prep6}
psdf_mmms_signrand_long_o2 <- tidyr::pivot_longer(
  psdf_hsc_mmms_signrand_o2, 
  c = 1:ncol(psdf_hsc_mmms_signrand_o2),
  values_to = "value",
  names_to = "type")
psdf_mmms_signrand_long_o2$conservation_level_long = base::rep(
  "total BL6 markers", nrow(psdf_mmms_signrand_long_o2))

psdf_mmms_signrand_score_1_o2 <- psdf_mmms_signrand_long_o2[
  psdf_mmms_signrand_long_o2$type %in% c("adjusted_rand_index"),]
psdf_mmms_signrand_score_2_o2 <- psdf_mmms_signrand_long_o2[
  psdf_mmms_signrand_long_o2$type %in% c("variation_information"),]
psdf_mmms_signrand_score_3_o2 <- psdf_mmms_signrand_long_o2[
  psdf_mmms_signrand_long_o2$type %in% c("mean_prop_cells_cluster"),]
```

```{r g_prep7}

# get the number of genes used for each gene set
nr_sign_used <- selected_score_df_list_o2$seu_sign$nr_genes_used[1]

nr_mark_used <- selected_score_df_list_o2$seu_mark$nr_genes_used[1]
nr_mmms_used <- selected_score_df_list_o2$seu_mmms$nr_genes_used[1]

nr_mark_left <- nr_mark_used - nr_sign_used
nr_mark_rand <- nr_mark_left # same number but keep for tracking purpose

nr_mmms_left <- nr_mmms_used - nr_sign_used
nr_mmms_rand <- nr_mmms_left

max_genes <- nr_mmms_used
```

```{r g_prep8}
g_vis_df_sign <- base::data.frame(
  type_y = "conserved identity signature",
  type_fill = "conserved identity signature",
  number = nr_sign_used
)
```

```{r g_prep9}
g_vis_df_mark <- base::data.frame(
  type_y = c(
    "conserved markers",
    "conserved markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "conserved markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used,
    nr_mark_left,
    nr_sign_used,
    nr_mark_rand)
)

# factor for plot
g_vis_df_mark$type_fill <- factor(g_vis_df_mark$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "conserved markers",
  "random genes"
)))
g_vis_df_mark$type_y <- factor(g_vis_df_mark$type_y, levels = base::rev(c(
  "conserved markers",
  "permutation gene set"
)))
```

```{r g_prep10}
g_vis_df_mmms <- base::data.frame(
  type_y = c(
    "total BL6 markers",
    "total BL6 markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "total BL6 markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used,
    nr_mmms_left,
    nr_sign_used,
    nr_mmms_rand)
)

g_vis_df_mmms$type_fill <- factor(g_vis_df_mmms$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "total BL6 markers",
  "random genes"
)))
g_vis_df_mmms$type_y <- factor(g_vis_df_mmms$type_y, levels = base::rev(c(
  "total BL6 markers",
  "permutation gene set"
)))
```

#### Plot parts

##### part left, score1: Adjusted Rand index

```{r g_base_plot_left1}
g_base_plot_left1 <- ggplot2::ggplot(
  score_df_sign_score_1_o2,
  aes(y = conservation_level_long,
      x = value,
      color = conservation_level_long))+
  ggplot2::geom_vline(
    xintercept = 0.25,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_vline(
    xintercept = 0.75,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r g_theme_plot_left1}
g_theme_plot_left1 <- g_base_plot_left1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.title = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    breaks=c(0, 0.25, 0.5, 0.75, 1),
    position = "top", 
    limits = c(0, score1_max))+
  ggplot2::ggtitle(score1_long) 
```

```{r g_base_plot_left2}
g_base_plot_left2 <- make_pattern_density_plot(
  score_df = score_df_mark_score_1_o2,
  perm_score_df = psdf_mark_signrand_score_1_o2,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "conserved markers"
)
```

```{r g_theme_plot_left2}
g_theme_plot_left2 <- g_base_plot_left2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score1_max))
```

```{r g_base_plot_left3}
g_base_plot_left3 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_1_o2,
  perm_score_df = psdf_mmms_signrand_score_1_o2,
  color_cons = col_cons_long["total BL6 markers"],
  ylabel = "total BL6 markers"
)
```

```{r g_theme_plot_left3}
g_theme_plot_left3 <- g_base_plot_left3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score1_max))
```

```{r g_construct_left, fig.height = 2.8, fig.width = 5}
g_part_left <- ggpubr::ggarrange(
  ncol = 1, 
  g_theme_plot_left1+theme(plot.title = element_blank()),
  g_theme_plot_left2+theme(plot.title = element_blank()),
  g_theme_plot_left3+theme(plot.title = element_blank()),
  heights = c(1.05, 1, 1),
  align = "v"
)
g_part_left
```

##### part e middle - left score2: Variation of Information

```{r g_base_plot_mleft1}
g_base_plot_mleft1 <- ggplot2::ggplot(
  score_df_sign_score_2_o2,
  aes(y = conservation_level_long,
      x = value,
      color = conservation_level_long))+
  ggplot2::geom_vline(
    xintercept = 1.5,
      color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_vline(
    xintercept = 4.5,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r g_theme_plot_mleft1}
g_theme_plot_mleft1 <- g_base_plot_mleft1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top",
    limit = c(0, max_vi),
    breaks=c(0, 1, 2, 3, 4, 5))+
  ggplot2::ggtitle("Variation of information")
```

```{r g_base_plot_mleft2}
g_base_plot_mleft2 <- make_pattern_density_plot(
  score_df = score_df_mark_score_2_o2,
  perm_score_df = psdf_mark_signrand_score_2_o2,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "conserved markers"
)
```

```{r g_theme_plot_mleft2}
g_theme_plot_mleft2 <- g_base_plot_mleft2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score2_max))
```

```{r g_base_plot_mleft3}
g_base_plot_mleft3 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_2_o2,
  perm_score_df = psdf_mmms_signrand_score_2_o2,
  color_cons = col_cons_long["total BL6 markers"],
  ylabel = "total BL6 markers"
)
```

```{r g_theme_plot_mleft3}
g_theme_plot_mleft3 <- g_base_plot_mleft3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score2_max))
```

```{r g_construct_mleft, fig.height = 2.8, fig.width = 2.8}
g_part_mleft <- ggpubr::ggarrange(
  ncol = 1, 
  g_theme_plot_mleft1+theme(plot.title = element_blank()),
  g_theme_plot_mleft2+theme(plot.title = element_blank()),
  g_theme_plot_mleft3+theme(plot.title = element_blank()),
  heights = c(1.05, 1, 1),
  align = "v"
)
g_part_mleft
```

##### part middle-right, score3, mean prop cells

```{r g_base_plot_mright1}
g_base_plot_mright1 <- ggplot2::ggplot(
  score_df_sign_score_3_o2,
  aes(y = conservation_level_long,
      x = value,
      color = conservation_level_long))+
  ggplot2::geom_vline(
    xintercept = 0.25,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_vline(
    xintercept = 0.75,
    color = color_hline_background,
    linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r g_theme_plot_mright1}
g_theme_plot_mright1 <- g_base_plot_mright1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top", 
    limits = c(0, 1))+
  ggplot2::ggtitle("Mean prop. cells/cluster")
```

```{r g_base_plot_mright2}
g_base_plot_mright2 <- make_pattern_density_plot(
  score_df = score_df_mark_score_3_o2,
  perm_score_df = psdf_mark_signrand_score_3_o2,
  color_cons = col_cons_long["conserved markers"],
  ylabel = "conserved markers"
)
```

```{r g_theme_plot_mright2}
g_theme_plot_mright2 <- g_base_plot_mright2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score3_max))
```

```{r g_base_plot_mright3}
g_base_plot_mright3 <- make_pattern_density_plot(
  score_df = score_df_mmms_score_3_o2,
  perm_score_df = psdf_mmms_signrand_score_3_o2,
  color_cons = col_cons_long["total BL6 markers"],
  ylabel = "total BL6 markers"
)
```

```{r g_theme_plot_mright3}
g_theme_plot_mright3 <- g_base_plot_mright3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, score3_max))
```

```{r g_construct_mright, fig.height = 2.8, fig.width = 2.8}
g_part_mright <- ggpubr::ggarrange(
  ncol = 1, 
  g_theme_plot_mright1+theme(plot.title = element_blank()),
  g_theme_plot_mright2+theme(plot.title = element_blank()),
  g_theme_plot_mright3+theme(plot.title = element_blank()),
  heights = c(1.05, 1, 1),
  align = "v"
)
g_part_mright
```

##### part right: boxplots

```{r g_base_plot_right1}
g_base_plot_right1 <- ggplot2::ggplot(
  g_vis_df_sign,
  aes(y = type_y,
      x = number, 
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())
```

```{r g_theme_plot_right1}
g_theme_plot_right1 <- g_base_plot_right1+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.text.x = element_text(
      size = axis_text_size,
      face = axis_text_face,
      color = axis_text_color),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::ggtitle("# re-clustering genes")+
  ggplot2::scale_fill_manual(values = col_cons_long)
```

```{r g_base_plot_right2}
g_base_plot_right2 <- ggplot2::ggplot(
  g_vis_df_mark,
  aes(y = type_y, 
      x=  number,
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = base::data.frame(
      "type_y" = base::rep("permutation gene set", nr_mark_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    position = position_dodge(preserve = "single"),
    pattern = "circle",
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val)
```

```{r g_theme_plot_right2}
g_theme_plot_right2 <- g_base_plot_right2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, max_genes))+
  ggplot2::xlab("Number of genes")+
  ggplot2::scale_fill_manual(values = col_cons_long)
```

```{r g_base_plot_right3}
g_base_plot_right3 <- ggplot2::ggplot(
  g_vis_df_mmms,
  aes(y = type_y,
      x = number, 
      fill = type_fill))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = base::data.frame(
      "type_y" = base::rep("permutation gene set", nr_mmms_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    pattern = "circle",
    position = position_dodge(preserve = "single"),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val)
```

```{r g_theme_plot_right3}
g_theme_plot_right3 <- g_base_plot_right3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, max_genes))+
  ggplot2::xlab("Number of genes")+
  ggplot2::scale_fill_manual(values = col_cons_long)
```

```{r g_construct_right, fig.height = 2.8, fig.width = 2.8}
g_part_right <- ggpubr::ggarrange(
  ncol = 1, 
  g_theme_plot_right1+theme(plot.title = element_blank()), # barplot width depends on plot size
  g_theme_plot_right2+theme(plot.title = element_blank()),
  g_theme_plot_right3+theme(plot.title = element_blank()),
  heights = c(1.05, 1, 1),
  align = "v"
)
g_part_right
```

```{r g_construct_all, fig.height = 3, fig.width = 11.3}

# the ratio between upper panel and lower two panels depends on the
# height of the entire plot

g_all_plot <- ggpubr::ggarrange(
  ncol = 4,
  g_part_left,
  g_part_mleft,
  g_part_mright,
  g_part_right,
  widths = c(3.8, 2, 2, 1.5),
  align = "v"
)
g_all_plot
```

```{r g_plot_export}
pdf(output_pdf_g_plot, width = 11.3, height = 2.7)
g_all_plot
dev.off()
```

## G

pval plot

```{r h_prep1}

# add more columns for nicer visualisation
corr_pval_df$color_id <- vector(length = nrow(corr_pval_df))
corr_pval_df$color_id[corr_pval_df$pval_corrected < 0.05] <- "significant"
corr_pval_df$color_id[corr_pval_df$pval_corrected == 0] <- "is_null"
corr_pval_df$color_id[corr_pval_df$pval_corrected >= 0.05] <- "non_significant"

corr_pval_df$cons_level_long <- vector(length = nrow(corr_pval_df))
corr_pval_df$cons_level_long[
  corr_pval_df$conservation_level == "conserved_signature"] <- "conserved identity signature"
corr_pval_df$cons_level_long[
  corr_pval_df$conservation_level == "conserved_markers"] <- "conserved markers"
corr_pval_df$cons_level_long[
  corr_pval_df$conservation_level == "mmusall_markers"] <- "all BL6 markers"

corr_pval_df$score_long <- vector(length = nrow(corr_pval_df))
corr_pval_df$score_long[
  corr_pval_df$type == "adjusted_rand_index"] <- "Adjusted rand index"
corr_pval_df$score_long[
  corr_pval_df$type == "variation_information"] <- "Variation of information"
corr_pval_df$score_long[
  corr_pval_df$type == "mean_prop_cells_cluster"] <- "Mean prop. cells/cluster"

corr_pval_df$cons_level_long <- factor(
  corr_pval_df$cons_level_long, levels = c(
    "conserved identity signature",
    "conserved markers",
    "all BL6 markers"))

corr_pval_df$score_long <- factor(
  corr_pval_df$score_long, levels = c(
    "Adjusted rand index",
    "Variation of information",
    "Mean prop. cells/cluster"))

corr_pval_df$color_id <- factor(
  corr_pval_df$color_id, levels = rev(c(
    "non_significant",
    "significant",
    "is_null")))

color_significance <- c("non_significant" = "grey70",
                        "significant" = "black", 
                        "is_null" = "blue")
```

```{r h_prep2_subset}

corr_pval_df_sub <- corr_pval_df[corr_pval_df$condition %in% c(
  "hsc",
  "mus_tm_bonemarrow",
  "mus_weinreb_hspc"),]

corr_pval_df_sub$condition_long <- vector(length = nrow(corr_pval_df_sub))
corr_pval_df_sub$condition_long[
  corr_pval_df_sub$condition == "mus_tm_bonemarrow"] <- "tabula muris"
corr_pval_df_sub$condition_long[
  corr_pval_df_sub$condition == "mus_weinreb_hspc"] <- "Weinreb et al."
corr_pval_df_sub$condition_long[
  corr_pval_df_sub$condition == "hsc"] <- "HSPCs"

corr_pval_df_sub$condition_long <- factor(
  corr_pval_df_sub$condition_long, levels = rev(c(
    "HSPCs",
    "tabula muris",
    "Weinreb et al.")))
```

```{r h_base_plot, fig.width = 10, fig.height= 3} 
h_base_plot <- ggplot2::ggplot(
  corr_pval_df_sub,
  aes(y = condition_long, 
      x = nr_genes_used,
      color = color_id, 
      size = 10^-pval_corrected))+
  ggplot2::geom_point(alpha = 1)+
  ggplot2::facet_grid(cols = vars(corr_pval_df_sub$score_long),
                      switch = "y",
                      rows = vars(corr_pval_df_sub$cons_level_long))+
  ggplot2::theme_classic()+
  ggplot2::scale_x_continuous(limits = c(0, max(corr_pval_df_sub$nr_genes_used)))+
  ggplot2::scale_color_manual(values = color_significance)
```

```{r h_theme_plot, fig.width = 10, fig.height = 3} 
h_theme_plot <- h_base_plot+
  ggplot2::theme_classic()+
  theme_all+
  ggplot2::scale_x_continuous(
    position = "bottom",
    limits = c(0, base::max(corr_pval_df_sub$nr_genes_used)))+
  ggplot2::scale_color_manual(values = color_significance)+
  ggplot2::theme(
    strip.text.x = element_text(
      size = plot_title_size,
      color = plot_title_color,
      face = plot_title_face),
    strip.text.y.left = element_blank(),
    strip.background = element_blank(),
    axis.title.y = element_blank(),
    strip.placement = "outside",
    legend.position = "none")+
  ggplot2::xlab("# re-clustering genes")
h_theme_plot
```

```{r h_legend_base_plot}
h_legend_base_plot <- ggplot2::ggplot(
  corr_pval_df,
  aes(y = condition, 
      x = nr_genes_used,
      color = color_id, 
      size = 10^-pval_corrected))+
  ggplot2::geom_point(alpha = 1)+
  ggplot2::facet_grid(cols = vars(corr_pval_df$score_long),
                      switch = "y",
                      rows = vars(corr_pval_df$cons_level_long))+
  ggplot2::theme_classic()+
  ggplot2::scale_x_continuous(limits = c(0, max(corr_pval_df$nr_genes_used)))+
  ggplot2::scale_color_manual(values = color_significance)
```

```{r h_legend_theme_plot, fig.width = 3, fig.height= 3}
h_legend_theme_plot <- g_legend_base_plot+
   ggplot2::theme_classic()+
  ggplot2::scale_x_continuous(
    limits = c(0, base::max(corr_pval_df_sub$nr_genes_used)))+
  ggplot2::scale_color_manual("", values = color_significance)+
  ggplot2::scale_size_continuous("10 adjusted p val")+
  ggplot2::theme(
    legend.title = element_text(
      size = legend_title_size,
      color = legend_title_color,
      face = legend_title_face),
    legend.text = element_text(
      size = legend_text_size,
      color = legend_text_color,
      face = legend_text_face))

h_legend_theme <- ggpubr::get_legend(h_legend_theme_plot)

h_legend <- ggpubr::ggarrange(h_legend_theme)
h_legend
```

```{r h_plot_export}
pdf(output_pdf_h_plot, width = 9.3, height = 3)
h_theme_plot
dev.off()
```

```{r h_legend_export}
pdf(output_pdf_h_legend, width = 3, height = 3)
h_legend
dev.off()
```
