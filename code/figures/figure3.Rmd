---
title: "Figure 3"
date: '2024-09-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Generate Figure 3, current title:
"Mouse cell type signature genes alone are sufficient to identify cell types."

#### Load objects

```{r seed, message = FALSE}
base::RNGkind(kind = "Mersenne-Twister")
set.seed(37)
```

```{r load_packages, message = FALSE}
library(SingleCellExperiment, quietly = TRUE)
library(ggpubr, quietly = TRUE)
library(gghalves, quietly = TRUE)
library(tidyverse, quietly = TRUE)
library(ggpattern, quietly = TRUE)
```

```{r load_manual, eval = FALSE, include = FALSE}

base_path <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data"

#-------------------------------------------------------------------------------
#### OWN DATASET (HSPCs)

# SCE with reclustering vectors for each gene set
sce_hsc_recl <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/03_recl/sce_hsc"))

# score DF 
score_df_hsc <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/04_rcls/score_df_hsc"))

# perm score DFs from gene sets permutation
psdf_hsc_mark_signrand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_perg/perm_score_df_mark_hsc"))
psdf_hsc_mmms_signrand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_perg/perm_score_df_mmms_hsc"))

# perm score DF from background permutation
psdf_hsc_sign_rand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/06_psig/perm_score_df_hsc"))

#-------------------------------------------------------------------------------
#### OTHER MOUSE DATASET (HSPC)
# TODO: ADJUST TO DESIRED DATASET

# list of seurat objects with reclustering vectors for each gene set
seu_hsc_recl_list <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/03_recl/reclustered_mus_weinreb_hspc_list"))

# data frame containing the correct resolutions for each dataset as visually determined
resolution_df_path <- base::paste0(
  base_path,
  "/metadata/scRNAseq/03_sce_analysis/reclustering_bm/reclustering_other_resolution.txt")

resolution_df <- utils::read.csv(file = resolution_df_path, 
                               header = TRUE, 
                               sep = ";", 
                               check.names=FALSE, 
                               stringsAsFactors=FALSE, 
                               as.is=TRUE, 
                               colClasses = "character")
 
resolution_df <- resolution_df[resolution_df$dataset == "mus_weinreb_hspc",]

# score DF1 
score_df_hsc_list_other1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/04_rcls/score_df_li_all_stromal_list"))

# perm score DFs from gene set permutation
psdf_hsc_mark_signrand_other1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mark_li_all_stromal"))
psdf_hsc_mmms_signrand_other1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mmms_li_all_stromal"))
psdf_hsc_mmms_markrand_other1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mmms_mark_li_all_stromal"))

# perm score DF from background permutation (SIGN)
psdf_hsc_sign_rand_other1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/06_psig/perm_score_df_li_all_stromal"))

# perm score DF from background permutation (MARK)
psdf_hsc_sign_rand_other1 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_pmrk/perm_score_df_li_all_stromal"))


#-------------------------------------------------------------------------------
#### REMAINING

# geneset list
geneset_list_hsc <-base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/01_gens/geneset_list_hsc"))

colors_path <- base::paste0(
  base_path,
  "/metadata/colors/colors.txt")

source("../source/colors.R")
source("../source/plotting.R")
source("../source/sce_functions_reclustering.R")
```

```{r params}
# global params
source("determine_params.R")

col_cons <- c("conserved_signature" = "#db5b00ff",
              "conserved_markers" = "#eb9523ff",
              "mmusall_markers" = "#a7c5a3ff",
              "ndges" = "#ea91adff",
              "random_features" = "grey80")

col_cons_long <- c(
  "conserved identity signature" = "#db5b00ff",
  "conserved markers" = "#eb9523ff",
  "total BL6 markers" = "#a7c5a3ff",
  "ndges" = "#ea91adff",
  "random genes" = "grey80")

point_plot_size <- 4

pattern_fill_color <- "white"
pattern_line_colour <- "white"
pattern_density_val <- 0.4
pattern_spacing_val <- 0.1
pattern_key_scale_factor_val <- 1.5

```

```{r export_paths}
output_pdf_a_plot <- base::paste0(base_path, "/manuscript1/figures/figure3_a.pdf")
output_pdf_a_legend <- base::paste0(base_path, "/manuscript1/figures/figure3_a_legend.pdf")
```

# A

Heatmaps of own re-clustered HSPC mouse data using signature genes/
conserved markers/BL6 markers/nDGEs.

#### Prep

```{r a_prep_conserved_signature}
mat_sign <- base::table(sce_hsc_recl$celltypes, sce_hsc_recl$cluster_signt)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign)){mat_sign[,i] <- mat_sign[,i]/base::sum(mat_sign[,i])}
sign_df <- base::as.data.frame(mat_sign)

# manually factorise clusters
sign_df$Var2 <- factor(
  sign_df$Var2,
  levels = base::rev(c(1, 3, 2, 5, 8, 4, 6, 7)))
```

```{r a_prep_conserved_markers}
mat_mark <- base::table(sce_hsc_recl$celltypes, sce_hsc_recl$cluster_consm)

for(i in 1:ncol(mat_mark)){mat_mark[,i] <- mat_mark[,i]/base::sum(mat_mark[,i])}
mark_df <- base::as.data.frame(mat_mark)

mark_df$Var2 <- factor(
  mark_df$Var2,
  levels = base::rev(c(1, 3, 8, 10, 5, 2, 11, 4, 6, 7, 12, 9)))
```

```{r a_prep_all_bl6_markers}
mat_mmms <- base::table(sce_hsc_recl$celltypes, sce_hsc_recl$cluster_mmusm)

for(i in 1:ncol(mat_mmms)){mat_mmms[,i] <- mat_mmms[,i]/base::sum(mat_mmms[,i])}
mmms_df <- base::as.data.frame(mat_mmms)

mmms_df$Var2 <- factor(
  mmms_df$Var2,
  levels = base::rev(c(1, 3, 10, 11, 12, 5, 2, 9, 4, 6, 14, 13, 8, 7)))
```

```{r a_prep_ndges}
mat_ndge <- base::table(sce_hsc_recl$celltypes, sce_hsc_recl$cluster_ndges)

for(i in 1:ncol(mat_ndge)){mat_ndge[,i] <- mat_ndge[,i]/base::sum(mat_ndge[,i])}
ndge_df <- base::as.data.frame(mat_ndge)

ndge_df$Var2 <- factor(
  ndge_df$Var2,
  levels = base::rev(c(1, 4, 3, 6, 8, 7, 10, 2, 5, 9, 11)))
```

#### Plot Components

```{r a_sign_base_plot}
a_sign_base_plot <- ggplot2::ggplot(
  sign_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r a_mark_base_plot}
a_mark_base_plot <- ggplot2::ggplot(
  mark_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r a_mmms_base_plot}
a_mmms_base_plot <- ggplot2::ggplot(
  mmms_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r a_ndge_base_plot}
a_ndge_base_plot <- ggplot2::ggplot(
  ndge_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r a_sign_theme_plot}
a_sign_theme_plot <- a_sign_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = col_cons_long["conserved identity signature"]
    )
  )+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("Conserved identity signature")
```

```{r a_mark_theme_plot}
a_mark_theme_plot <- a_mark_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = col_cons_long["conserved markers"]
    )
  )+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("Conserved markers")
```

```{r a_mmms_theme_plot}
a_mmms_theme_plot <- a_mmms_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = col_cons_long["total BL6 markers"]))+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("total BL6 markers")
```

```{r a_legend_theme_plot}
a_legend_plot <- a_mmms_base_plot+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::theme(
    legend.title = element_text(
      face = legend_title_face,
      size = legend_title_size,
      color = legend_title_color,
      margin = margin(r = 10),
      vjust = 0.85),
    legend.text = element_text(
      face = legend_text_face,
      size = legend_text_size,
      color = legend_text_color),
    legend.position = "bottom",
  )
a_legend_theme <- ggpubr::get_legend(a_legend_plot)
```

#### Construct

```{r a_construct, fig.height = 8, fig.width = 3}

a_theme_plot <- ggpubr::ggarrange(
  ncol = 1,
  a_sign_theme_plot,
  a_mark_theme_plot,
  a_mmms_theme_plot+
  ggplot2::theme(
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 90,
      hjust = 0,
      vjust = 0.5)),
  align = "v",
  heights = c(1, 1.5, 2.4)
)

a_theme_plot
```

```{r a_construct_legend, fig.width = 6, fig.height = 1}
a_legend <- ggpubr::ggarrange(a_legend_theme)
```

```{r a_plot_export}
pdf(output_pdf_a_plot, width = 3, height = 8)
a_theme_plot
dev.off()
```

```{r a_legend_export}
pdf(output_pdf_a_legend, width = 6, height = 1)
a_legend
dev.off()
```

## B

(Re-) clustering metrics to compare re-clustering of own dataset with signature
genes, conserved markers or all BL6 markers, permuted with different sets of
random genes as indicated (signature + random_conserved_markers,
signature + conserved markers + random_bl6_markers). 

#### Prep

##### perm plots

```{r b_prep1}
score_df_sign <- score_df_hsc[score_df_hsc$conservation_level == "conserved_signature",]
score_df_sign_score_1 <- score_df_sign[score_df_sign$type == "adjusted_rand_index",]
score_df_sign_score_2 <- score_df_sign[score_df_sign$type == "variation_information",]
score_df_sign_score_3 <- score_df_sign[score_df_sign$type == "mean_prop_cells_cluster",]

score_df_sign_score_1$conservation_level <- "conserved identity signature"
score_df_sign_score_2$conservation_level <- "conserved identity signature"
score_df_sign_score_3$conservation_level <- "conserved identity signature"
```

```{r b_prep2}
score_df_mark <- score_df_hsc[score_df_hsc$conservation_level == "conserved_markers",]
score_df_mark_score_1 <- score_df_mark[score_df_mark$type == "adjusted_rand_index",]
score_df_mark_score_2 <- score_df_mark[score_df_mark$type == "variation_information",]
score_df_mark_score_3 <- score_df_mark[score_df_mark$type == "mean_prop_cells_cluster",]

score_df_mark_score_1$conservation_level <- "conserved markers"
score_df_mark_score_2$conservation_level <- "conserved markers"
score_df_mark_score_3$conservation_level <- "conserved markers"
```

```{r b_prep3}
psdf_mark_signrand_long <- pivot_longer(
  psdf_hsc_mark_signrand, 
  c = 1:ncol(psdf_hsc_mark_signrand),
  values_to = "value",
  names_to = "type")

psdf_mark_signrand_score_1 <- psdf_mark_signrand_long[psdf_mark_signrand_long$type %in% c("adjusted_rand_index"),]
psdf_mark_signrand_score_2 <- psdf_mark_signrand_long[psdf_mark_signrand_long$type %in% c("variation_information"),]
psdf_mark_signrand_score_3 <- psdf_mark_signrand_long[psdf_mark_signrand_long$type %in% c("mean_prop_cells_cluster"),]

psdf_mark_signrand_score_1$conservation_level = base::rep("conserved markers", nrow(psdf_mark_signrand_score_1))
psdf_mark_signrand_score_2$conservation_level = base::rep("conserved markers", nrow(psdf_mark_signrand_score_2))
psdf_mark_signrand_score_3$conservation_level = base::rep("conserved markers", nrow(psdf_mark_signrand_score_3))
```

```{r b_prep4}
score_df_mmms <- score_df_hsc[score_df_hsc$conservation_level == "mmusall_markers",]
score_df_mmms_score_1 <- score_df_mmms[score_df_mmms$type == "adjusted_rand_index",]
score_df_mmms_score_2 <- score_df_mmms[score_df_mmms$type == "variation_information",]
score_df_mmms_score_3 <- score_df_mmms[score_df_mmms$type == "mean_prop_cells_cluster",]

score_df_mmms_score_1$conservation_level <- "total BL6 markers"
score_df_mmms_score_2$conservation_level <- "total BL6 markers"
score_df_mmms_score_3$conservation_level <- "total BL6 markers"
```

```{r b_prep5}
psdf_mmms_signrand_long <- pivot_longer(
  psdf_hsc_mmms_signrand, 
  c = 1:ncol(psdf_hsc_mmms_signrand),
  values_to = "value",
  names_to = "type")

psdf_mmms_signrand_score_1 <- psdf_mmms_signrand_long[psdf_mmms_signrand_long$type %in% c("adjusted_rand_index"),]
psdf_mmms_signrand_score_2 <- psdf_mmms_signrand_long[psdf_mmms_signrand_long$type %in% c("variation_information"),]
psdf_mmms_signrand_score_3 <- psdf_mmms_signrand_long[psdf_mmms_signrand_long$type %in% c("mean_prop_cells_cluster"),]

psdf_mmms_signrand_score_1$conservation_level = base::rep("total BL6 markers", nrow(psdf_mmms_signrand_score_1))
psdf_mmms_signrand_score_2$conservation_level = base::rep("total BL6 markers", nrow(psdf_mmms_signrand_score_2))
psdf_mmms_signrand_score_3$conservation_level = base::rep("total BL6 markers", nrow(psdf_mmms_signrand_score_3))
```

```{r max_vi}
max_vi <- base::max(c(
  score_df_hsc$value[score_df_hsc$type == "variation_information"],
  psdf_hsc_sign_rand$variation_information,
  psdf_hsc_mmms_signrand$variation_information,
  psdf_hsc_mark_signrand$variation_information))
```

##### box plots

```{r b_prep4}
# get the number of genes used for each gene set


nr_sign_used <- sce_hsc_recl$cluster_signt_genes_used[1]
nr_mark_used <- sce_hsc_recl$cluster_consm_genes_used[1]
nr_mmms_used <- sce_hsc_recl$cluster_mmusm_genes_used[1]

nr_mark_left <- nr_mark_used - nr_sign_used
nr_mark_rand <- nr_mark_left

nr_mmms_left <- nr_mmms_used - nr_sign_used
nr_mmms_rand <- nr_mmms_left

max_genes <- nr_mmms_used
```

```{r b_prep5}
vis_df_sign <- base::data.frame(
  type_y = "conserved identity signature",
  type_fill = "conserved identity signature",
  number = nr_sign_used
)
```

```{r b_prep6}
vis_df_mark <- base::data.frame(
  type_y = c(
    "conserved markers",
    "conserved markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "conserved markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used,
    nr_mark_left,
    nr_sign_used,
    nr_mark_rand)
)

vis_df_mark$type_fill <- factor(vis_df_mark$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "conserved markers",
  "random genes"
)))
vis_df_mark$type_y <- factor(vis_df_mark$type_y, levels = base::rev(c(
  "conserved markers",
  "permutation gene set"
)))

vis_df_mark_legend <- vis_df_mark
vis_df_mark_legend$type_fill <- factor(vis_df_mark_legend$type_fill, levels = c(
  "conserved identity signature",
  "conserved markers",
  "random genes"
))
vis_df_mark_legend$type_y <- factor(vis_df_mark_legend$type_y, levels = c(
  "conserved markers",
  "permutation gene set"
))
```

```{r b_prep7}
vis_df_mmms <- base::data.frame(
  type_y = c(
    "total BL6 markers",
    "total BL6 markers",
    "permutation gene set",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "total BL6 markers",
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used,
    nr_mmms_left,
    nr_sign_used,
    nr_mmms_rand)
)

vis_df_mmms$type_fill <- factor(vis_df_mmms$type_fill, levels = base::rev(c(
  "conserved identity signature",
  "total BL6 markers",
  "random genes"
)))
vis_df_mmms$type_y <- factor(vis_df_mmms$type_y, levels = base::rev(c(
  "total BL6 markers",
  "permutation gene set"
)))

vis_df_mmms_legend <- vis_df_mmms
vis_df_mmms_legend$type_fill <- factor(vis_df_mmms_legend$type_fill, levels = c(
  "conserved identity signature",
  "total BL6 markers",
  "random genes"
))
vis_df_mmms_legend$type_y <- factor(vis_df_mmms_legend$type_y, levels = c(
  "total BL6 markers",
  "permutation gene set"
))

```

#### Plot Components

##### part a (left, score1) Adjusted Rand index

```{r b_base_plot_a1}
b_base_plot_a1 <- ggplot2::ggplot(
  score_df_sign_score_1,
  aes(y = conservation_level,
      x = value,
      color = conservation_level))+
  ggplot2::geom_vline(xintercept = 0.25,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_vline(xintercept = 0.75,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r b_theme_plot_a1}
b_theme_plot_a1 <- b_base_plot_a1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top", 
    limits = c(0, 1))+
  ggplot2::ggtitle("Adjusted rand index")

```

```{r b_base_plot_a2}
b_base_plot_a2 <- ggplot2::ggplot(
  score_df_mark_score_1,
  aes(x = conservation_level,
      y = value,
      fill = conservation_level,
      color = conservation_level))+
  ggplot2::geom_hline(yintercept = 0.25,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_hline(yintercept = 0.75,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size,
    position = position_nudge(x = 0.25, y = 0))+
  geom_half_violin(
    data = psdf_mark_signrand_score_1,
    color = col_cons_long["conserved markers"],
    alpha = 1,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  geom_violin_pattern(
    pattern = "circle",
    inherit.aes = FALSE,
    scale = "width",
    trim = FALSE,
    position = position_nudge(x = -0.5, y = 0),
    data = psdf_mark_signrand_score_1,
    mapping = aes(y = value, x = conservation_level),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)+
  geom_half_violin(
    data = psdf_mark_signrand_score_1,
    color = col_cons_long["conserved markers"],
    alpha = 0,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  ggplot2::coord_flip()
```

```{r b_theme_plot_a2}
b_theme_plot_a2 <- b_base_plot_a2+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::scale_fill_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::ylim(0, 1) # because flipped
```

```{r b_base_plot_a3}
b_base_plot_a3 <- ggplot2::ggplot(
  score_df_mmms_score_1,
  aes(x = conservation_level,
      y = value,
      fill = conservation_level,
      color = conservation_level))+
  ggplot2::geom_hline(yintercept = 0.25,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_hline(yintercept = 0.75,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size,
    position = position_nudge(x = 0.25, y = 0))+
  geom_half_violin(
    data = psdf_mmms_signrand_score_1,
    color = col_cons_long["total BL6 markers"],
    alpha = 1,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  geom_violin_pattern(
    pattern = "circle",
    inherit.aes = FALSE,
    scale = "width",
    trim = FALSE,
    position = position_nudge(x = -0.5, y = 0),
    data = psdf_mmms_signrand_score_1,
    mapping = aes(y = value, x = conservation_level),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)+
  geom_half_violin(
    data = psdf_mmms_signrand_score_1,
    color = col_cons_long["total BL6 markers"],
    alpha = 0,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  ggplot2::coord_flip()
```

```{r b_theme_plot_a3}
b_theme_plot_a3 <- b_base_plot_a3+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::scale_fill_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      vjust = 0.5),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::ylim(0, 1) # because flipped
```

```{r b_construct_a, fig.height = 2.8, fig.width = 5}
b_part_a <- ggpubr::ggarrange(
  ncol = 1, 
  b_theme_plot_a1,
  b_theme_plot_a2,
  b_theme_plot_a3,
  heights = c(1.05, 1, 1),
  align = "v"
)
b_part_a
```

##### part b (middle, score2)

```{r b_base_plot_b1}
b_base_plot_b1 <- ggplot2::ggplot(
  score_df_sign_score_2,
  aes(y = conservation_level,
      x = value,
      color = conservation_level))+
  ggplot2::geom_vline(xintercept = 1.5,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_vline(xintercept = 4.5,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r b_theme_plot_b1}
b_theme_plot_b1 <- b_base_plot_b1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top", 
    limits = c(0, max_vi))+
  ggplot2::ggtitle("Variation of information")
```

```{r b_base_plot_b2}
b_base_plot_b2 <- ggplot2::ggplot(
  score_df_mark_score_2,
  aes(x = conservation_level,
      y = value,
      fill = conservation_level,
      color = conservation_level))+
  ggplot2::geom_hline(yintercept = 1.5,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_hline(yintercept = 4.5,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size,
    position = position_nudge(x = 0.25, y = 0))+
  geom_half_violin(
    data = psdf_mark_signrand_score_2,
    color = col_cons_long["conserved markers"],
    alpha = 1,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  geom_violin_pattern(
    pattern = "circle",
    inherit.aes = FALSE,
    scale = "width",
    trim = FALSE,
    position = position_nudge(x = -0.5, y = 0),
    data = psdf_mark_signrand_score_2,
    mapping = aes(y = value, x = conservation_level),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)+
  geom_half_violin(
    data = psdf_mark_signrand_score_2,
    color = col_cons_long["conserved markers"],
    alpha = 0,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
   ggplot2::coord_flip()
```

```{r b_theme_plot_b2}
b_theme_plot_b2 <- b_base_plot_b2+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::scale_fill_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::ylim(0, max_vi) # because flipped
```

```{r b_base_plot_b3}
b_base_plot_b3 <- ggplot2::ggplot(
  score_df_mmms_score_2,
  aes(x = conservation_level,
      y = value,
      fill = conservation_level,
      color = conservation_level))+
  ggplot2::geom_hline(yintercept = 1.5,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_hline(yintercept = 4.5,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size,
    position = position_nudge(x = 0.25, y = 0))+
  geom_half_violin(
    data = psdf_mmms_signrand_score_2,
    color = col_cons_long["total BL6 markers"],
    alpha = 1,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  geom_violin_pattern(
    pattern = "circle",
    inherit.aes = FALSE,
    scale = "width",
    trim = FALSE,
    position = position_nudge(x = -0.5, y = 0),
    data = psdf_mmms_signrand_score_2,
    mapping = aes(y = value, x = conservation_level),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)+
  geom_half_violin(
    data = psdf_mmms_signrand_score_2,
    color = col_cons_long["total BL6 markers"],
    alpha = 0,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  ggplot2::coord_flip()
```

```{r b_theme_plot_b3}
b_theme_plot_b3 <- b_base_plot_b3+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::scale_fill_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::ylim(0, max_vi) # because flipped
```

```{r b_construct_b, fig.height = 2.8, fig.width = 2.8}
b_part_b <- ggpubr::ggarrange(
  ncol = 1, 
  b_theme_plot_b1,
  b_theme_plot_b2,
  b_theme_plot_b3,
  heights = c(1.05, 1, 1),
  align = "v"
)
b_part_b
```

##### part c (right, score3) mean prop cells

```{r b_base_plot_c1}
b_base_plot_c1 <- ggplot2::ggplot(
  score_df_sign_score_3,
  aes(y = conservation_level,
      x = value,
      color = conservation_level))+
  ggplot2::geom_vline(xintercept = 0.25,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_vline(xintercept = 0.75,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size)
```

```{r b_theme_plot_c1}
b_theme_plot_c1 <- b_base_plot_c1+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 0,
      hjust = 0.5,
      vjust = 0.5),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color, 
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top", 
    limits = c(0, 1))+
  ggplot2::ggtitle("Mean prop. cells/cluster")
```

```{r b_base_plot_c2}
b_base_plot_c2 <- ggplot2::ggplot(
  score_df_mark_score_3,
  aes(x = conservation_level,
      y = value,
      fill = conservation_level,
      color = conservation_level))+
  ggplot2::geom_hline(yintercept = 0.25,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_hline(yintercept = 0.75,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size,
    position = position_nudge(x = 0.25, y = 0))+
  geom_half_violin(
    data = psdf_mark_signrand_score_3,
    color = col_cons_long["conserved markers"],
    alpha = 1,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  geom_violin_pattern(
    pattern = "circle",
    inherit.aes = FALSE,
    scale = "width",
    trim = FALSE,
    position = position_nudge(x = -0.5, y = 0),
    data = psdf_mark_signrand_score_3,
    mapping = aes(y = value, x = conservation_level),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)+
  geom_half_violin(
    data = psdf_mark_signrand_score_3,
    color = col_cons_long["conserved markers"],
    alpha = 0,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  ggplot2::coord_flip()
```

```{r b_theme_plot_c2}
b_theme_plot_c2 <- b_base_plot_c2+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::scale_fill_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::ylim(0, 1) # because flipped
```

```{r b_base_plot_c3}
b_base_plot_c3 <- ggplot2::ggplot(
  score_df_mmms_score_3,
  aes(x = conservation_level,
      y = value,
      fill = conservation_level,
      color = conservation_level))+
  ggplot2::geom_hline(yintercept = 0.25,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_hline(yintercept = 0.75,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size,
    position = position_nudge(x = 0.25, y = 0))+
  geom_half_violin(
    data = psdf_mmms_signrand_score_3,
    color = col_cons_long["total BL6 markers"],
    alpha = 1,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  geom_violin_pattern(
    pattern = "circle",
    inherit.aes = FALSE,
    scale = "width",
    trim = FALSE,
    position = position_nudge(x = -0.5, y = 0),
    data = psdf_mmms_signrand_score_3,
    mapping = aes(y = value, x = conservation_level),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)+
  geom_half_violin(
    data = psdf_mmms_signrand_score_3,
    color = col_cons_long["total BL6 markers"],
    alpha = 0,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  ggplot2::coord_flip()
```

```{r b_theme_plot_c3}
b_theme_plot_c3 <- b_base_plot_c3+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::scale_fill_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::ylim(0, 1) # because flipped
```

```{r b_construct_c, fig.height = 2.8, fig.width = 2.8}
b_part_c <- ggpubr::ggarrange(
  ncol = 1, 
  b_theme_plot_c1,
  b_theme_plot_c2,
  b_theme_plot_c3,
  heights = c(1.05, 1, 1),
  align = "v"
)
b_part_c
```

##### part D, boxplots

```{r b_base_plot_d1}
b_base_plot_d1 <- ggplot2::ggplot(
  vis_df_sign,
  aes(y = type_y, x = number, fill = type_fill))+
  ggplot2::geom_col(position = position_stack())
```

```{r b_theme_plot_d1}
b_theme_plot_d1 <- b_base_plot_d1+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(
      size = axis_text_size,
      face = axis_text_face,
      color = axis_text_color),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    position = "top", 
    limits = c(0, max_genes))+
  ggplot2::ggtitle("Number of genes")+
  ggplot2::scale_fill_manual( values = col_cons_long)
```

```{r b_base_plot_d2}
b_base_plot_d2 <- ggplot2::ggplot(
  vis_df_mark,
  aes(y = type_y, x=  number, fill = type_fill))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = data.frame("type_y" = base::rep("permutation gene set", nr_mark_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    position = position_dodge(preserve = "single"),
    pattern = "circle",
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)
```

```{r b_theme_plot_d2}
b_theme_plot_d2 <- b_base_plot_d2+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, max_genes))+
  ggplot2::xlab("Number of genes")+
  ggplot2::scale_fill_manual( values = col_cons_long)
```

```{r b_base_plot_d3}
b_base_plot_d3 <- ggplot2::ggplot(
  vis_df_mmms,
  aes(y = type_y, x = number, fill = type_fill, pattern = type_y))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = data.frame("type_y" = base::rep("permutation gene set", nr_mmms_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    pattern = "circle",
    position = position_dodge(preserve = "single"),
    color = "white", 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val
    )
```

```{r b_theme_plot_d3}
b_theme_plot_d3 <- b_base_plot_d3+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank())+
  ggplot2::scale_x_continuous(
    limits = c(0, max_genes))+
  ggplot2::xlab("Number of genes")+
  ggplot2::scale_fill_manual( values = col_cons_long)
```

```{r b_construct_d, fig.height = 2.8, fig.width = 2.8}
b_part_d <- ggpubr::ggarrange(
  ncol = 1, 
  b_theme_plot_d1,
  b_theme_plot_d2,
  b_theme_plot_d3,
  heights = c(1.05, 1, 1),
  align = "v"
)
b_part_d
```


```{r b_construct_all, fig.height = 3.5, fig.width = 13}

# the ratio between upper panel and lower two panels depends on the
# height of the entire plot

b_all <- ggpubr::ggarrange(
  ncol = 4,
  b_part_a,
  b_part_b,
  b_part_c,
  b_part_d,
  widths = c(3.8, 2, 2, 1.5),
  align = "v"
)
b_all
```

## C

#### Prep

Can use many of the dfs generated for B

```{r c_prep1}
psdf_sign_rand_long <- pivot_longer(
  psdf_hsc_sign_rand, 
  c = 1:ncol(psdf_hsc_sign_rand),
  values_to = "value",
  names_to = "type")

psdf_sign_rand_score_1 <- psdf_sign_rand_long[psdf_sign_rand_long$type %in% 
                                               c("adjusted_rand_index"),]
psdf_sign_rand_score_2 <- psdf_sign_rand_long[psdf_sign_rand_long$type %in% 
                                               c("variation_information"),]
psdf_sign_rand_score_3 <- psdf_sign_rand_long[psdf_sign_rand_long$type %in% 
                                               c("mean_prop_cells_cluster"),]

psdf_sign_rand_score_1$conservation_level <- base::rep(
  "conserved identity signature", nrow(psdf_sign_rand_score_1))
psdf_sign_rand_score_2$conservation_level <- base::rep(
  "conserved identity signature", nrow(psdf_sign_rand_score_2))
psdf_sign_rand_score_3$conservation_level <- base::rep(
  "conserved identity signature", nrow(psdf_sign_rand_score_3))
```

```{r c_prep1}
vis_df_sign_rand <- base::data.frame(
  type_y = c(
    "conserved identity signature",
    "permutation gene set"),
  type_fill = c(
    "conserved identity signature",
    "random genes"),
  number = c(
    nr_sign_used,
    nr_sign_used))

vis_df_sign_rand$type_fill <- factor(vis_df_sign_rand$type_fill,
                                     levels = base::rev(c(
  "conserved identity signature",
  "random genes"
)))
vis_df_sign_rand$type_y <- factor(vis_df_sign_rand$type_y, levels = base::rev(c(
  "conserved identity signature",
  "permutation gene set"
)))

vis_df_sign_rand_legend <- vis_df_sign_rand
vis_df_sign_rand_legend$type_fill <- factor(vis_df_sign_rand_legend$type_fill,
                                            levels = c(
  "conserved identity signature",
  "random genes"
))
vis_df_sign_rand_legend$type_y <- factor(vis_df_sign_rand_legend$type_y,
                                         levels = c(
  "conserved identity signature",
  "permutation gene set"
))
```

#### part left, (rand index) 

```{r c_base_plot_left}
c_base_plot_left <- ggplot2::ggplot(
  score_df_sign_score_1,
  aes(x = conservation_level,
      y = value,
      fill = conservation_level,
      color = conservation_level))+
  ggplot2::geom_hline(yintercept = 0.25,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_hline(yintercept = 0.75,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size,
    position = position_nudge(x = 0.25, y = 0))+
  geom_half_violin(
    data = psdf_sign_rand_score_1,
    color = col_cons_long["conserved identity signature"],
    alpha = 1,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  geom_violin_pattern(
    pattern = "circle",
    inherit.aes = FALSE,
    scale = "width",
    trim = FALSE,
    position = position_nudge(x = -0.5, y = 0),
    data = psdf_sign_rand_score_1,
    mapping = aes(y = value, x = conservation_level),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)+
  geom_half_violin(
    data = psdf_sign_rand_score_1,
    color = col_cons_long["conserved identity signature"],
    alpha = 0,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  ggplot2::coord_flip()
```

```{r c_theme_plot_left}
c_theme_plot_left <- c_base_plot_left+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::scale_fill_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.x = element_text(
      face = axis_text_face,
      color = axis_text_color,
      size = axis_text_size),
    axis.text.y = element_text(
      face = axis_text_face,
      color = axis_text_color,
      size = axis_text_size),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5))+
  ggplot2::scale_y_continuous(position = "right", limits = c(0,1))+# because flipped
  ggplot2::scale_x_discrete(expand = expansion(add = c(-1)))+
  ggplot2::ggtitle("Adjusted rand index")
```

#### part middle, (variation information) 

```{r c_base_plot_middle}
c_base_plot_middle <- ggplot2::ggplot(
  score_df_sign_score_2,
  aes(x = conservation_level,
      y = value,
      fill = conservation_level,
      color = conservation_level))+
  ggplot2::geom_hline(yintercept = 1.5,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_hline(yintercept = 4.5,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size,
    position = position_nudge(x = 0.25, y = 0))+
  geom_half_violin(
    data = psdf_sign_rand_score_2,
    color = col_cons_long["conserved identity signature"],
    alpha = 1,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  geom_violin_pattern(
    pattern = "circle",
    inherit.aes = FALSE,
    scale = "width",
    trim = FALSE,
    position = position_nudge(x = -0.5, y = 0),
    data = psdf_sign_rand_score_2,
    mapping = aes(y = value, x = conservation_level),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)+
  geom_half_violin(
    data = psdf_sign_rand_score_2,
    color = col_cons_long["conserved identity signature"],
    alpha = 0,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  ggplot2::coord_flip()
```

```{r c_theme_plot_middle}
c_theme_plot_middle <- c_base_plot_middle+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::scale_fill_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.text.x = element_text(
      face = axis_text_face,
      color = axis_text_color,
      size = axis_text_size),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5))+
  ggplot2::scale_y_continuous(position = "right", limits = c(0,max_vi))+# because flipped
  ggplot2::scale_x_discrete(expand = expansion(add = c(-1)))+
  ggplot2::ggtitle("Variation of information")
```

#### part right, (prop cells/cluster) 

```{r c_base_plot_right}
c_base_plot_right <- ggplot2::ggplot(
  score_df_sign_score_3,
  aes(x = conservation_level,
      y = value,
      fill = conservation_level,
      color = conservation_level))+
  ggplot2::geom_hline(yintercept = 0.25,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_hline(yintercept = 0.75,
                      color = "grey95",
                      linewidth = 3)+
  ggplot2::geom_point(
    size = point_plot_size,
    position = position_nudge(x = 0.25, y = 0))+
  geom_half_violin(
    data = psdf_sign_rand_score_3,
    color = col_cons_long["conserved identity signature"],
    alpha = 1,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  geom_violin_pattern(
    pattern = "circle",
    inherit.aes = FALSE,
    scale = "width",
    trim = FALSE,
    position = position_nudge(x = -0.5, y = 0),
    data = psdf_sign_rand_score_3,
    mapping = aes(y = value, x = conservation_level),
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)+
  geom_half_violin(
    data = psdf_sign_rand_score_3,
    color = col_cons_long["conserved identity signature"],
    alpha = 0,
    side = "r",
    scale = "width",
    position = position_nudge(x = -0.5, y = 0))+
  ggplot2::coord_flip()
```

```{r c_theme_plot_right}
c_theme_plot_right <- c_base_plot_right+
  ggplot2::theme_classic()+
  ggplot2::scale_color_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::scale_fill_manual(
    "Score",
    values = col_cons_long)+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.text.x = element_text(
      face = axis_text_face,
      color = axis_text_color,
      size = axis_text_size),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5))+
  ggplot2::scale_y_continuous(position = "right", 
                              limits = c(0, 1))+ # because flipped
  ggplot2::scale_x_discrete(expand = expansion(add = c(-1)))+
  ggplot2::ggtitle("Mean prop. cells/cluster")
```

#### part col

```{r c_base_plot_col}
c_base_plot_col <- ggplot2::ggplot(
  vis_df_sign_rand,
  aes(y = type_y, x = number, fill = type_fill))+
  ggplot2::geom_col(position = position_stack())+
  ggpattern::geom_bar_pattern(
    data = data.frame("type_y" = base::rep("permutation gene set", nr_sign_used)),
    inherit.aes = FALSE,
    mapping = aes(y = type_y),
    position = position_dodge(preserve = "single"),
    pattern = "circle",
    color = NA, 
    alpha = 0,
    pattern_fill = pattern_fill_color,
    pattern_colour = pattern_line_colour,
    pattern_density =pattern_density_val,
    pattern_spacing = pattern_spacing_val,
    pattern_key_scale_factor = pattern_key_scale_factor_val)
```

```{r c_theme_plot_col}
c_theme_plot_col <- c_base_plot_col+
  ggplot2::theme_classic()+
  ggplot2::theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(
      size = axis_title_size,
      face = axis_title_face,
      color = axis_title_color,
      hjust = 0.5),
    axis.title.x = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = plot_title_color,
      hjust = 0.5))+
  ggplot2::scale_x_continuous(
    limits = c(0, max_genes),
    position = "top")+
  ggplot2::xlab("Number of genes")+
  ggplot2::scale_fill_manual( values = col_cons_long)+
  ggplot2::ggtitle("Number of genes")
```

#### Assemble

```{r c_assemble_plot, fig.width = 13, fig.height = 2}

c_theme_plot <- ggpubr::ggarrange(
  c_theme_plot_left,
  c_theme_plot_middle,
  c_theme_plot_right,
  c_theme_plot_col,
  nrow = 1,
  widths = c(3.8, 2, 2, 1.5)
)

```

## D 

#### Prep

```{r d_prep1}

selected_seu_list <- lapply(seu_hsc_recl_list, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  
  resdf_temp <- resolution_df[resolution_df$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
  
})
selected_seu_list

```

```{r d_prep_conserved_signature}
d_mat_sign <- base::table(selected_seu_list$seu_sign$cell_type, 
                          selected_seu_list$seu_sign$seurat_clusters)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(d_mat_sign)){
  d_mat_sign[,i] <- d_mat_sign[,i]/base::sum(d_mat_sign[,i])
}
d_sign_df <- base::as.data.frame(d_mat_sign)

# manually factorise clusters
# d_sign_df$Var2 <- factor(
#   d_sign_df$Var2,
#   levels = base::rev(c(1, 3, 2, 5, 8, 4, 6, 7)))
```

```{r a_prep_conserved_markers}
d_mat_mark <- base::table(selected_seu_list$seu_mark$cell_type, 
                          selected_seu_list$seu_mark$seurat_clusters)

for(i in 1:ncol(d_mat_mark)){
  d_mat_mark[,i] <- d_mat_mark[,i]/base::sum(d_mat_mark[,i])
  }
d_mark_df <- base::as.data.frame(d_mat_mark)

# d_mark_df$Var2 <- factor(
#   d_mark_df$Var2,
#   levels = base::rev(c(1, 3, 8, 10, 5, 2, 11, 4, 6, 7, 12, 9)))
```

```{r a_prep_all_bl6_markers}
d_mat_mmms <- base::table(selected_seu_list$seu_mmms$cell_type, 
                          selected_seu_list$seu_mmms$seurat_clusters)

for(i in 1:ncol(d_mat_mmms)){
  d_mat_mmms[,i] <- d_mat_mmms[,i]/base::sum(d_mat_mmms[,i])
}
d_mmms_df <- base::as.data.frame(d_mat_mmms)

# mmms_df$Var2 <- factor(
#   mmms_df$Var2,
#   levels = base::rev(c(1, 3, 10, 11, 12, 5, 2, 9, 4, 6, 14, 13, 8, 7)))
```

#### Plot Components

```{r d_sign_base_plot}
d_sign_base_plot <- ggplot2::ggplot(
  d_sign_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r d_mark_base_plot}
d_mark_base_plot <- ggplot2::ggplot(
  d_mark_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r d_mmms_base_plot}
d_mmms_base_plot <- ggplot2::ggplot(
  d_mmms_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r d_sign_theme_plot}
d_sign_theme_plot <- d_sign_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = col_cons_long["conserved identity signature"]
    )
  )+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("Conserved identity signature")
```

```{r d_mark_theme_plot}
d_mark_theme_plot <- d_mark_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = col_cons_long["conserved markers"]
    )
  )+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("Conserved markers")
```

```{r d_mmms_theme_plot}
d_mmms_theme_plot <- d_mmms_base_plot+
  ggplot2::theme_classic()+
  ggplot2::theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    plot.title = element_text(
      size = plot_title_size,
      face = plot_title_face,
      color = col_cons_long["total BL6 markers"]))+
  ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ggtitle("total BL6 markers")
```

#### Construct

```{r d_construct, fig.height = 8, fig.width = 3}

d_theme_plot <- ggpubr::ggarrange(
  ncol = 1,
  d_sign_theme_plot,
  d_mark_theme_plot,
  d_mmms_theme_plot+
  ggplot2::theme(
    axis.text.x = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color, 
      angle = 90,
      hjust = 0,
      vjust = 0.5)),
  align = "v",
  heights = c(1, 1.5, 2.4)
)

d_theme_plot
```

## E

#### Prep

##### perm plots

```{r}
selected_score_df_list <- lapply(score_df_hsc_list_other1, function(score_df_list){
  
  conslev_curr <- score_df_list[[1]]$conservation_level[1]
  
  resdf_temp <- resolution_df[resolution_df$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  score_df_return <- score_df_list[[res_curr]]
  return(score_df_return)
  
})
selected_score_df_list
score_df_hsc_other1 <- bind_rows(selected_score_df_list)
```

```{r e_prep1}
score_df_sign_other1 <- score_df_hsc_other1[score_df_hsc_other1$conservation_level == "conserved_signature",]
score_df_sign_score_1_other1 <- score_df_sign_other1[score_df_sign_other1$type == "adjusted_rand_index",]
score_df_sign_score_2_other1 <- score_df_sign_other1[score_df_sign_other1$type == "variation_information",]
score_df_sign_score_3_other1 <- score_df_sign_other1[score_df_sign_other1$type == "mean_prop_cells_cluster",]

score_df_sign_score_1$conservation_level <- "conserved identity signature"
score_df_sign_score_2$conservation_level <- "conserved identity signature"
score_df_sign_score_3$conservation_level <- "conserved identity signature"
```

```{r e_prep2}
score_df_mark_other1 <- score_df_hsc_other1[score_df_hsc_other1$conservation_level == "conserved_markers",]
score_df_mark_score_1_other1 <- score_df_mark_other1[score_df_mark_other1$type == "adjusted_rand_index",]
score_df_mark_score_2_other1 <- score_df_mark_other1[score_df_mark_other1$type == "variation_information",]
score_df_mark_score_3_other1 <- score_df_mark_other1[score_df_mark_other1$type == "mean_prop_cells_cluster",]

score_df_mark_score_1_other1$conservation_level <- "conserved markers"
score_df_mark_score_2_other1$conservation_level <- "conserved markers"
score_df_mark_score_3_other1$conservation_level <- "conserved markers"
```

!# TODO: CONTINUE HERE

```{r e_prep3}
psdf_mark_signrand_long_other1 <- pivot_longer(
  psdf_hsc_mark_signrand_other1, 
  c = 1:ncol(psdf_hsc_mark_signrand_other1),
  values_to = "value",
  names_to = "type")

psdf_mark_signrand_score_1_other1 <- psdf_mark_signrand_long_other1[psdf_mark_signrand_long_other1$type %in% c("adjusted_rand_index"),]
psdf_mark_signrand_score_2_other1 <- psdf_mark_signrand_long_other1[psdf_mark_signrand_long_other1$type %in% c("variation_information"),]
psdf_mark_signrand_score_3_other1 <- psdf_mark_signrand_long_other1[psdf_mark_signrand_long_other1$type %in% c("mean_prop_cells_cluster"),]

psdf_mark_signrand_score_1_other1$conservation_level = base::rep("conserved markers", nrow(psdf_mark_signrand_score_1_other1))
psdf_mark_signrand_score_2_other1$conservation_level = base::rep("conserved markers", nrow(psdf_mark_signrand_score_2_other1))
psdf_mark_signrand_score_3_other1$conservation_level = base::rep("conserved markers", nrow(psdf_mark_signrand_score_3_other1))
```

```{r e_prep4}
score_df_mmms_other_1  <- score_df_hsc_other_1[score_df_hsc_other_1 $conservation_level == "mmusall_markers",]
score_df_mmms_score_1_other_1 <- score_df_mmms_other_1[score_df_mmms_other_1$type == "adjusted_rand_index",]
score_df_mmms_score_2_other_1 <- score_df_mmms_other_1[score_df_mmms_other_1$type == "variation_information",]
score_df_mmms_score_3_other_1 <- score_df_mmms_other_1[score_df_mmms_other_1$type == "mean_prop_cells_cluster",]

score_df_mmms_score_1_other_1$conservation_level <- "total BL6 markers"
score_df_mmms_score_2_other_1$conservation_level <- "total BL6 markers"
score_df_mmms_score_3_other_1$conservation_level <- "total BL6 markers"
```

```{r e_prep5}
psdf_mmms_signrand_long_other_1 <- pivot_longer(
  psdf_hsc_mmms_signrand_other1, 
  c = 1:ncol(psdf_hsc_mmms_signrand_other1),
  values_to = "value",
  names_to = "type")

psdf_mmms_signrand_score_1_other_1 <- psdf_mmms_signrand_long_other_1[psdf_mmms_signrand_long_other_1$type %in% c("adjusted_rand_index"),]
psdf_mmms_signrand_score_2_other_1 <- psdf_mmms_signrand_long_other_1[psdf_mmms_signrand_long_other_1$type %in% c("variation_information"),]
psdf_mmms_signrand_score_3_other_1 <- psdf_mmms_signrand_long_other_1[psdf_mmms_signrand_long_other_1$type %in% c("mean_prop_cells_cluster"),]

psdf_mmms_signrand_score_1_other_1$conservation_level = base::rep("total BL6 markers", nrow(psdf_mmms_signrand_score_1_other_1))
psdf_mmms_signrand_score_2_other_1$conservation_level = base::rep("total BL6 markers", nrow(psdf_mmms_signrand_score_2_other_1))
psdf_mmms_signrand_score_3_other_1$conservation_level = base::rep("total BL6 markers", nrow(psdf_mmms_signrand_score_3_other_1))
```

```{r e_prep7}
psdf_mmms_markrand_long_other_1 <- pivot_longer(
  psdf_hsc_mmms_markrand_other1, 
  c = 1:ncol(psdf_hsc_mmms_markrand_other1),
  values_to = "value",
  names_to = "type")

psdf_mmms_markrand_score_1_other1 <- psdf_mmms_markrand_long_other_1[psdf_mmms_markrand_long_other_1$type %in% c("adjusted_rand_index"),]
psdf_mmms_markrand_score_2_other1 <- psdf_mmms_markrand_long_other_1[psdf_mmms_markrand_long_other_1$type %in% c("variation_information"),]
psdf_mmms_markrand_score_3_other1 <- psdf_mmms_markrand_long_other_1[psdf_mmms_markrand_long_other_1$type %in% c("mean_prop_cells_cluster"),]

psdf_mmms_markrand_score_1_other1$conservation_level = base::rep("total BL6 markers", nrow(psdf_mmms_markrand_score_1_other1))
psdf_mmms_markrand_score_2_other1$conservation_level = base::rep("total BL6 markers", nrow(psdf_mmms_markrand_score_2_other1))
psdf_mmms_markrand_score_3_other1$conservation_level = base::rep("total BL6 markers", nrow(psdf_mmms_markrand_score_3_other1))
```

```{r max_vi}
max_vi <- base::max(c(
  score_df_hsc_other1$value[score_df_hsc_other1$type == "variation_information"],
  psdf_hsc_sign_rand_other1$variation_information,
  psdf_hsc_mmms_signrand_other1$variation_information,
  psdf_hsc_mark_signrand_other1$variation_information,
  psdf_hsc_mmms_markrand_other1$variation_information))
```


