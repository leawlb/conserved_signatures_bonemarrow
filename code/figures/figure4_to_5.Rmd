---
title: "Figure 5"
date: '2024-09-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Generate Figure 5, current title:
"Mouse cell type conserved identity signature genes alone are sufficient to identify Niche types."

#### Load objects

```{r seed, message = FALSE}
base::RNGkind(kind = "Mersenne-Twister")
set.seed(37)
```

```{r load_packages, message = FALSE}
library(SingleCellExperiment, quietly = TRUE)
library(ggpubr, quietly = TRUE)
library(tidyverse, quietly = TRUE)
library(gghalves, quietly = TRUE) # not in conda env
library(ggpattern, quietly = TRUE) # not in conda env
```

```{r load_manual_basepath}
base_path_input <- "/omics/odcf/analysis/OE0538_projects/DO-0008/data"
base_path_output_temp <- "/omics/odcf/analysis/OE0538_projects_temp/DO-0008/data_temp"
```

```{r base_path_snakemake, eval = FALSE, include = FALSE}
base_path_input <- snakemake@input[["base_path_input"]]
base_path_output_temp <- snakemake@params[["base_path_output_temp"]]
```

```{r load_manual_remaining}
#-------------------------------------------------------------------------------
#### REMAINING

# list of gene sets for HSPCs (conserved signature, conserved markers, etc.)
geneset_list_str <-base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/01_gens/geneset_list_str"))

# data frame containing the correct resolutions for other datasets as visually determined
resolution_df_path <- base::paste0(
  base_path_input,
  "/metadata/scRNAseq/03_sce_analysis/reclustering_bm/reclustering_other_resolution.txt")

resolution_df <- utils::read.csv(
  file = resolution_df_path, 
  header = TRUE, 
  sep = ";", 
  check.names=FALSE, 
  stringsAsFactors=FALSE, 
  as.is=TRUE, 
  colClasses = "character")

# dataframe containing corrected pvalues for all tests
corr_pval_df <-  readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/09_crpv/all_corrected_pval"))

colors_path <- base::paste0(
  base_path_input,
  "/metadata/colors/colors.txt")

source("../source/colors.R")
source("../source/plotting.R")
source("../source/sce_functions_reclustering.R")
```

```{r load_manual}
#-------------------------------------------------------------------------------
#### OWN DATASET (Niche)

# annotated SCE
sce_str <- base::readRDS(base::paste0(
  base_path_input, 
  "/scRNAseq/main_analysis/sce_objects/02_sce_anno/10_anns/sce_str-10"))

# SCE with reclustering vectors for each gene set
sce_str_recl <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/03_recl/sce_str"))

# dataframe of re-clustering scores for each gene set
score_df_str <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/04_rcls/score_df_str"))

# dataframes of re-clustering scores after permutation comparing gene sets
psdf_str_mark_signrand <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_perg/perm_score_df_mark_str"))
psdf_str_mmms_signrand <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_perg/perm_score_df_mmms_str"))

# dataframes of re-clustering scores after background permutation
psdf_str_sign_rand <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/06_psig/perm_score_df_str"))

cts_exclude <- c("Lymphoid ECs", "Chondrocytes")
print(cts_exclude)
```

```{r load_manual_other2}
#-------------------------------------------------------------------------------
#### OTHER MOUSE DATASET 2 (Niche)
#### MUS_TIK_STROMAL

dataset_o2 <- "mus_tik_stromal"

# list of seurat objects with reclustering vectors for each gene set and resolution
seu_str_recl_list_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/03_recl/reclustered_mus_tik_stromal_list"))

# list of dataframes of re-clustering scores for each gene set and resolution
score_df_str_list_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/04_rcls/score_df_mus_tik_stromal_list"))

# dataframes of re-clustering scores after permutation comparing gene sets
psdf_str_mark_signrand_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mark_mus_tik_stromal"))
psdf_str_mmms_signrand_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mmms_mus_tik_stromal"))
psdf_str_mmms_markrand_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mmms_mark_mus_tik_stromal"))

# perm score DF from background permutation (SIGN)
psdf_str_sign_rand_o2 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/06_psig/perm_score_df_mus_tik_stromal"))
```

```{r selected_seu_o2}

resolution_df_o2 <- resolution_df[resolution_df$dataset == dataset_o2,]

selected_seu_list_o2 <- lapply(seu_str_recl_list_o2, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  
  resdf_temp <- resolution_df_o2[
    resolution_df_o2$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
  
})

rm(seu_str_recl_list_o2)
gc()
```

```{r load_manual_other3}
#-------------------------------------------------------------------------------
#### OTHER MOUSE DATASET 3 (Niche)
#### li_all_stromal

dataset_o3 <- "li_all_stromal"

# list of seurat objects with reclustering vectors for each gene set and resolution
seu_str_recl_list_o3 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/03_recl/reclustered_li_all_stromal_list"))

# list of dataframes of re-clustering scores for each gene set and resolution
score_df_str_list_o3 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/04_rcls/score_df_li_all_stromal_list"))

# dataframes of re-clustering scores after permutation comparing gene sets
psdf_str_mark_signrand_o3 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mark_li_all_stromal"))
psdf_str_mmms_signrand_o3 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mmms_li_all_stromal"))
psdf_str_mmms_markrand_o3 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_perg/perm_score_df_mmms_mark_li_all_stromal"))

# perm score DF from background permutation (SIGN)
psdf_str_sign_rand_o3 <- base::readRDS(base::paste0(
  base_path_input,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/06_psig/perm_score_df_li_all_stromal"))

# perm score DF from background permutation (MARK)
# psdf_str_mark_rand_o1 <- base::readRDS(base::paste0(
#   base_path_input,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_pmrk/perm_score_df_li_all_stromal"))
```

```{r selected_seu_o3}

resolution_df_o3 <- resolution_df[resolution_df$dataset == dataset_o3,]

selected_seu_list_o3 <- lapply(seu_str_recl_list_o3, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  
  resdf_temp <- resolution_df_o3[
    resolution_df_o3$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
  
})

rm(seu_str_recl_list_o3)
gc()
```

```{r params}
# global params
source("determine_params.R")
```

```{r export_paths}
# output_pdf_a_plot <- base::paste0(
#   base_path, "/manuscript1/figures/figure4_a.pdf")
# output_pdf_a_legend <- base::paste0(
#   base_path, "/manuscript1/figures/figure4_a_legend.pdf")
# output_pdf_bcd_plot <- base::paste0(
#   base_path, "/manuscript1/figures/figure4_bcd.pdf")
# output_pdf_e_plot <- base::paste0(
#   base_path, "/manuscript1/figures/figure4_e.pdf")
# output_pdf_e_legend <- base::paste0(
#   base_path, "/manuscript1/figures/figure4_e_legend.pdf")
```

## A Expression heat map

Expression of conserved signature genes in all mouse species across HSPC
cell types (scaled by z-score per gene).

### Prep

```{r a_prep1}
# get all unique signature genes
all_sign_genes <- vector()
for(i in 1:length(geneset_list_str)){
  sign_genes <- geneset_list_str[[i]]$conserved_signature
  all_sign_genes <- c(all_sign_genes, sign_genes)
}
all_sign_genes_str <- base::unique(all_sign_genes)
```

```{r a_prep2}
# aggregate per cell type and species
cts_str <- as.list(names(geneset_list_str))

sce_str$species_pub <- vector(length = ncol(sce_str))
sce_str$species_pub[sce_str$Species_ID == "mmus"] <- "BL6"
sce_str$species_pub[sce_str$Species_ID == "mcas"] <- "CAST"
sce_str$species_pub[sce_str$Species_ID == "mspr"] <- "SPRETUS"
sce_str$species_pub[sce_str$Species_ID == "mcar"] <- "CAROLI"
sce_str$species_pub <- factor(sce_str$species_pub, 
                              levels = names(col_spc_pub))
# remove cell types to be removed
cts_str <- cts_str[!cts_str %in% cts_exclude]
cts_list <- as.list(cts_str)

sce_str <- sce_str[,!sce_str$celltypes %in% cts_exclude]
sce_str$celltypes <- factor(sce_str$celltypes, levels(sce_str$celltypes)[
  !levels(sce_str$celltypes) %in% cts_exclude])

# separate SCE objects by cell type, then aggregate the counts to obtain
# the average counts per species for each cell type separately
# use the multi-batchnorm-corrected logcounts 

agg_str_list <- lapply(cts_str, function(ct){
  
  sce_ct <- sce_str[,sce_str$celltypes == ct]
  agg_str <- scuttle::aggregateAcrossCells(
    sce_ct, 
    id=colData(sce_ct)[,c("species_pub")], 
    statistics = "mean",
    use.assay.type = "logcounts") #multibatchnorm
  
  return(agg_str)
})
names(agg_str_list) <- names(geneset_list_str)
```

```{r a_prep3}
expr_df_list_str <- lapply(agg_str_list, function(agg_str){
  
  # get current cell type and relevant signature genes
  ct_curr <- agg_str$celltypes[1]
  print(ct_curr)
  
  sign_genes_ct <- geneset_list_str[[
    which(names(geneset_list_str) == ct_curr)]]$conserved_signature
  print(head(sign_genes_ct))
  
  # get a df from average logcounts per ct and species
  vis_df <- base::as.data.frame(
    t(SummarizedExperiment::assays(agg_str)$logcounts))
  
  # subset to all signature genes of this tissue
  vis_df <- vis_df[,colnames(vis_df) %in% all_sign_genes_str]
  
  # change df format 
  vis_df <- tibble::rownames_to_column(vis_df, "species")
  vis_df <- tidyr::pivot_longer(vis_df, 
                                cols = c(2:ncol(vis_df)),
                                values_to = "expression",
                                names_to = "gene")
  
  # add ct info
  vis_df$cell_type <- base::rep(ct_curr)

  # add info on genes that are signature genes of this ct
  vis_df$is_sign_gene <- vector(length = nrow(vis_df))
  vis_df$is_sign_gene[vis_df$gene %in% sign_genes_ct] <- TRUE

  # scale expression of all genes per cell type 
  # for ordering of genes ONLY
  vis_df$scaled_expression_per_ct <- base::scale(vis_df$expression)
  vis_df <- vis_df[base::order(vis_df$scaled_expression_per_ct, 
                               decreasing = TRUE),]

  return(vis_df)
})

# bind dfs 
agg_str_df <- dplyr::bind_rows(expr_df_list_str)
```

```{r a_prep4}
# scale expression per gene using z-scores
agg_str_df$zscore_gene <- vector(length = nrow(agg_str_df), mode = "numeric")
for(g in base::unique(agg_str_df$gene)){
  
  expr_vector_g <- agg_str_df[agg_str_df$gene == g,]$expression

  # calculate z score per gene
  z_score_g <- (expr_vector_g - base::mean(expr_vector_g))/
    stats::sd(expr_vector_g)
  agg_str_df$zscore_gene[agg_str_df$gene == g] <- z_score_g
}
```

```{r a_prep5}
# get a well ordered list of unique genes for factorization (after order above)
all_sign_genes_for_factor <- base::unique(agg_str_df$gene[
  agg_str_df$is_sign_gene == TRUE])

# factorize
agg_str_df$gene <- factor(agg_str_df$gene,
                          levels = all_sign_genes_for_factor)
agg_str_df$species <- factor(agg_str_df$species,
                             levels = base::rev(names(col_spc_pub)))

print(levels(agg_str_df$gene))
```

```{r a_prep6}
interest_genes <- c("Cxcl12",
                    "Marcks",
                    "Kitl",
                    "Cd34",
                    "Efnb2",
                    "Mmp13",
                    "Tie1",
                    "Actn4",
                    "Lrg1")

agg_str_df$is_gene <- vector(length = nrow(agg_str_df))
agg_str_df$is_gene[agg_str_df$gene %in% interest_genes] <- "TRUE"
agg_str_df$is_gene <- as.logical(agg_str_df$is_gene)
```

#### Plot

```{r a_base_plot}
a_base_plot <- ggplot2::ggplot(
  agg_str_df,
  aes(y = species, x = gene, fill = zscore_gene))+
  ggplot2::geom_tile()+
  ggplot2::facet_grid(rows = vars(agg_str_df$cell_type))
```

```{r a_theme_plot}
a_theme_plot <- a_base_plot+
  theme_all+
  ggplot2::theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(
      vjust = 0.5,
      hjust = 0.5,
      color = col_cons_long["conserved identity signature"]),
    axis.title.y = element_blank(),
    axis.line.x = element_blank(),
    axis.text.y = element_text(
      angle = 0,
      vjust = 0.5,
      hjust = 0),
    strip.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      angle = 0,
      vjust = 0.5,
      hjust = 0),
    strip.background.y = element_blank())+
  ggplot2::ggtitle("Conserved identity signature genes")+
  ggplot2::scale_fill_gradientn(
    "z-score per gene", 
    colours = colors_z_score,
    breaks = c(-5, -2.5,  0, 2.5, 5), 
    limits = c(-5,5))+
  ggplot2::scale_x_discrete(
    position =  "bottom",
    breaks = agg_str_df$gene[agg_str_df$is_gene])

a_legend <- ggpubr::get_legend(a_theme_plot)
a_legend <- ggpubr::ggarrange(a_legend)
```

#### Assemble

```{r a_assemble, fig.width = 5.5, fig.height = 6}
a_plot <- ggpubr::ggarrange(
  a_theme_plot + theme(legend.position = "none",
                       plot.title = element_blank())
)
a_plot
```

```{r a_plot_export}
# pdf(output_pdf_a_plot, width = 5.5, height = 5.5)
# a_plot
# dev.off()
```

```{r a_legend_export}
# pdf(output_pdf_a_legend, width = 3, height = 1)
# a_legend
# dev.off()
```

## BCD Re-clusterung Heatmaps 

Heatmaps of own re-clustered HSPC mouse data using signature genes/
conserved markers/BL6 markers/nDGEs.

### Own

```{r mat_sign}
mat_sign <- base::table(
  sce_str_recl$celltypes, 
  sce_str_recl$cluster_signt)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign)){
  mat_sign[,i] <- mat_sign[,i]/base::sum(mat_sign[,i])
}
sign_df <- base::as.data.frame(mat_sign)

#manually factorise clusters for nice order
sign_df$Var2 <- factor(
  sign_df$Var2,
  levels = base::rev(c(5, 8, 1, 3, 4, 2, 6, 7)))
```

```{r sign_base_plot}
sign_base_plot <- ggplot2::ggplot(
  sign_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r sign_theme_plot}
sign_theme_plot <- sign_base_plot+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5),
    axis.ticks.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ylab("New clusters")
```

### Other 2

```{r mat_sign_o2}
mat_sign_o2 <- base::table(selected_seu_list_o2$seu_sign$cell_type, 
                          selected_seu_list_o2$seu_sign$seurat_clusters)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign_o2)){
  mat_sign_o2[,i] <- mat_sign_o2[,i]/base::sum(mat_sign_o2[,i])
}
sign_df_o2 <- base::as.data.frame(mat_sign_o2)

sign_df_o2$Var2 <- factor(
  sign_df_o2$Var2,
  levels = base::rev(c(0, 11, 5, 4, 7, 10, 9, 8, 12, 13, 6, 1, 2, 3)))
```

```{r sign_base_plot_o2}
sign_base_plot_o2 <- ggplot2::ggplot(
  sign_df_o2, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r sign_theme_plot_o2}
sign_theme_plot_o2 <- sign_base_plot_o2+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5),
    axis.ticks.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::xlab("Original cell types")
```

### Other 3

```{r mat_sign_o3}
mat_sign_o3 <- base::table(selected_seu_list_o3$seu_sign$cell_type, 
                           selected_seu_list_o3$seu_sign$seurat_clusters)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign_o3)){
  mat_sign_o3[,i] <- mat_sign_o3[,i]/base::sum(mat_sign_o3[,i])
}
sign_df_o3 <- base::as.data.frame(mat_sign_o3)

sign_df_o3$Var2 <- factor(
  sign_df_o3$Var2,
  levels = base::rev(c(2, 6, 1, 0, 7, 4, 5, 3)))
```

```{r sign_base_plot_o3}
sign_base_plot_o3 <- ggplot2::ggplot(
  sign_df_o3, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r sign_theme_plot_o3}
sign_theme_plot_o3 <- sign_base_plot_o3+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text.y = element_blank(),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5),
    axis.ticks.y = element_blank())+
   ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))
```

### Assemble

```{r assemble_bcd, fig.width = 8, fig.height = 6}

sign_plots_single <- ggpubr::ggarrange(
  ncol = 3,
  align = "h",
  sign_theme_plot + theme(plot.margin = margin(r = 1.5, unit = "cm")), # some space
  sign_theme_plot_o2,
  sign_theme_plot_o3,
  widths = c(1.3, 1, 1))

bcd_theme_plot <- ggpubr::annotate_figure(
  sign_plots_single,
  top = ggpubr::text_grob(
    "Conserved identity signature", 
    color = col_cons_long["conserved identity signature"], 
    face = plot_title_face,
    size = plot_title_size))
bcd_theme_plot
```

```{r bcd_plot_export}
pdf(output_pdf_bcd_plot, width = 8, height = 6.5)
bcd_theme_plot
dev.off()
```

## E PVal plot

#### Prep

```{r e_prep1}

# add more columns for nicer visualisation
corr_pval_df$color_id <- vector(length = nrow(corr_pval_df))
corr_pval_df$color_id[corr_pval_df$pval_corrected < 0.05] <- "significant"
corr_pval_df$color_id[corr_pval_df$pval_corrected == 0] <- "is_null"
corr_pval_df$color_id[corr_pval_df$pval_corrected >= 0.05] <- "non_significant"

corr_pval_df$cons_level_long <- vector(length = nrow(corr_pval_df))
corr_pval_df$cons_level_long[
  corr_pval_df$conservation_level == "conserved_signature"] <- "conserved identity signature"
corr_pval_df$cons_level_long[
  corr_pval_df$conservation_level == "conserved_markers"] <- "conserved markers"
corr_pval_df$cons_level_long[
  corr_pval_df$conservation_level == "mmusall_markers"] <- "all BL6 markers"

corr_pval_df$score_long <- vector(length = nrow(corr_pval_df))
corr_pval_df$score_long[
  corr_pval_df$type == "adjusted_rand_index"] <- "Adjusted rand index"
corr_pval_df$score_long[
  corr_pval_df$type == "variation_information"] <- "Variation of information"
corr_pval_df$score_long[
  corr_pval_df$type == "mean_prop_cells_cluster"] <- "Mean prop. cells/cluster"

corr_pval_df$cons_level_long <- factor(
  corr_pval_df$cons_level_long, levels = c(
    "conserved identity signature",
    "conserved markers",
    "all BL6 markers"))

corr_pval_df$score_long <- factor(
  corr_pval_df$score_long, levels = c(
    "Adjusted rand index",
    "Variation of information",
    "Mean prop. cells/cluster"))

corr_pval_df$color_id <- factor(
  corr_pval_df$color_id, levels = rev(c(
    "non_significant",
    "significant",
    "is_null")))

color_significance <- c("non_significant" = "grey70",
                        "significant" = "black", 
                        "is_null" = "blue")
```

```{r e_prep2_subset}

corr_pval_df_sub <- corr_pval_df[corr_pval_df$condition %in% c(
  "str",
  "mus_tik_stromal",
  "mus_bar_stromal",
  "li_all_stromal",
  "ts_all_stromal"),]

corr_pval_df_sub$condition_long <- vector(length = nrow(corr_pval_df_sub))
corr_pval_df_sub$condition_long[
  corr_pval_df_sub$condition == "mus_bar_stromal"] <- "Baryawno et al."
corr_pval_df_sub$condition_long[
  corr_pval_df_sub$condition == "mus_tik_stromal"] <- "Tikhonova et al."
corr_pval_df_sub$condition_long[
  corr_pval_df_sub$condition == "li_all_stromal"] <- "Li et al."
corr_pval_df_sub$condition_long[
  corr_pval_df_sub$condition == "ts_all_stromal"] <- "Stromal tabula sapiens"
corr_pval_df_sub$condition_long[
  corr_pval_df_sub$condition == "str"] <- "Niche"


corr_pval_df_sub$condition_long <- factor(
  corr_pval_df_sub$condition_long, levels = rev(c(
    "Niche",
    "Tikhonova et al.",
    "Baryawno et al.",
    "Li et al.",
    "Stromal tabula sapiens")))
```

```{r e_print_for_control}
print(corr_pval_df_sub)
```

```{r e_base_plot, fig.width = 10, fig.height= 3} 
e_base_plot <- ggplot2::ggplot(
  corr_pval_df_sub,
  aes(y = condition_long, 
      x = nr_genes_used,
      color = color_id, 
      size = 10^-pval_corrected))+
  ggplot2::geom_point(alpha = 1)+
  ggplot2::facet_grid(cols = vars(corr_pval_df_sub$score_long),
                      switch = "y",
                      rows = vars(corr_pval_df_sub$cons_level_long))
```

```{r e_theme_plot, fig.width = 12.5, fig.height = 4} 
e_theme_plot <- e_base_plot+
  ggplot2::theme_classic()+
  theme_all+
  ggplot2::scale_x_continuous(
    position = "bottom",
    limits = c(0, base::max(corr_pval_df_sub$nr_genes_used)))+
  ggplot2::scale_color_manual(values = color_significance)+
  ggplot2::theme(
    strip.text.x = element_text(
      size = plot_title_size,
      color = plot_title_color,
      face = plot_title_face),
    strip.background = element_blank(),
    strip.text.y.left = element_text(
      size = axis_text_size,
      color = axis_text_color,
      face = axis_text_face,
      angle = 0,
      hjust = 0),
    axis.title.y = element_blank(),
    strip.placement = "outside",
    legend.position = "none")+
  ggplot2::xlab("# re-clustering genes")
e_theme_plot
```

```{r e_legend_base_plot}
e_legend_base_plot <- ggplot2::ggplot(
  corr_pval_df,
  aes(y = condition, 
      x = nr_genes_used,
      color = color_id, 
      size = 10^-pval_corrected))+
  ggplot2::geom_point(alpha = 1)+
  ggplot2::facet_grid(cols = vars(corr_pval_df$score_long),
                      switch = "y",
                      rows = vars(corr_pval_df$cons_level_long))
```

```{r e_legend_theme_plot, fig.width = 3, fig.height= 3}
e_legend_theme_plot <- e_legend_base_plot+
  ggplot2::theme_classic()+
  theme_all+
  ggplot2::scale_x_continuous(
    limits = c(0, base::max(corr_pval_df_sub$nr_genes_used)))+
  ggplot2::scale_color_manual("", values = color_significance)+
  ggplot2::scale_size_continuous("10 adjusted p val")

e_legend_theme <- ggpubr::get_legend(e_legend_theme_plot)

e_legend <- ggpubr::ggarrange(e_legend_theme)
e_legend
```

```{r e_plot_export}
pdf(output_pdf_e_plot, width = 12.5, height = 4)
e_theme_plot
dev.off()
```

```{r e_legend_export}
pdf(output_pdf_e_legend, width = 3, height = 3)
e_legend
dev.off()
```

```{r session_info}
utils::sessionInfo()
```
