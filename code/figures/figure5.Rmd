---
title: "Figure 5"
date: '2024-09-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Generate Figure 5

#### Load objects

```{r seed, message = FALSE}
base::RNGkind(kind = "Mersenne-Twister")
set.seed(37)
```

```{r load_packages, message = FALSE}
library(SingleCellExperiment, quietly = TRUE)
library(ggpubr, quietly = TRUE)
library(tidyverse, quietly = TRUE)
library(Seurat, quietly = TRUE)
```

```{r define_basepath}
base_path <- "/omics/odcf/analysis/OE0538_projects_temp/DO-0008/data_temp/micromamba_test_rerun/data/"
```

```{r load_short}
#-------------------------------------------------------------------------------
#### REMAINING

# list of gene sets for HSPCs (conserved signature, conserved markers, etc.)
geneset_list_str <-base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/01_gens/geneset_list_str"))

# data frame containing the correct resolutions for other datasets as visually determined
resolution_df_path <- base::paste0(
  base_path,
  "/metadata/scRNAseq/03_sce_analysis/reclustering_bm/reclustering_other_resolution.txt")

resolution_df <- utils::read.csv(
  file = resolution_df_path, 
  header = TRUE, 
  sep = ";", 
  check.names=FALSE, 
  stringsAsFactors=FALSE, 
  as.is=TRUE, 
  colClasses = "character")

ensembl_sign <- readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/02_endf/ensembl_sign_str"))

colors_path <- base::paste0(
  base_path,
  "/metadata/colors/colors.txt")

source("../source/colors.R")
source("../source/plotting.R")
```

```{r load_own}
#-------------------------------------------------------------------------------
#### OWN DATASET (Niche)

# annotated SCE
sce_str <- base::readRDS(base::paste0(
  base_path, 
  "/scRNAseq/main_analysis/sce_objects/02_sce_anno/10_anns/sce_str-10"))

# SCE with reclustering vectors for each gene set
sce_str_recl <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/03_recl/sce_str"))

# dataframe of re-clustering scores for each gene set
score_df_str <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/04_rcls/score_df_str"))

# dataframes of re-clustering scores after permutation comparing gene sets
psdf_str_mark_signrand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/06_perg/perm_score_df_mark_str"))
psdf_str_mmms_signrand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/06_perg/perm_score_df_mmms_str"))

# dataframes of re-clustering scores after background permutation
psdf_str_sign_rand <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/01_reclustering_own/05_psig/perm_score_df_str"))
```

```{r load_other2}
#-------------------------------------------------------------------------------
#### OTHER MOUSE DATASET 2 (Niche)
#### MUS_TIK_STROMAL

dataset_o2 <- "mus_tik_stromal"

# list of seurat objects with reclustering vectors for each gene set and resolution
seu_str_recl_list_o2 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/03_recl/reclustered_mus_tik_stromal_list"))

# # list of dataframes of re-clustering scores for each gene set and resolution
# score_df_str_list_o2 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/04_rcls/score_df_mus_tik_stromal_list"))
# 
# # dataframes of re-clustering scores after permutation comparing gene sets
# psdf_str_mark_signrand_o2 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_perg/perm_score_df_mark_mus_tik_stromal"))
# psdf_str_mmms_signrand_o2 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_perg/perm_score_df_mmms_mus_tik_stromal"))
# psdf_str_mmms_markrand_o2 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_perg/perm_score_df_mmms_mark_mus_tik_stromal"))
# 
# # perm score DF from background permutation (SIGN)
# psdf_str_sign_rand_o2 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_psig/perm_score_df_mus_tik_stromal"))
```

```{r selected_seu_o2}

resolution_df_o2 <- resolution_df[resolution_df$dataset == dataset_o2,]

selected_seu_list_o2 <- lapply(seu_str_recl_list_o2, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  
  resdf_temp <- resolution_df_o2[
    resolution_df_o2$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
  
})

rm(seu_str_recl_list_o2)
gc()
```

```{r load_other3}
#-------------------------------------------------------------------------------
#### OTHER MOUSE DATASET 3 (Niche)
#### li_all_stromal

dataset_o3 <- "li_all_stromal"

# list of seurat objects with reclustering vectors for each gene set and resolution
seu_str_recl_list_o3 <- base::readRDS(base::paste0(
  base_path,
  "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/03_recl/reclustered_li_all_stromal_list"))

# list of dataframes of re-clustering scores for each gene set and resolution
# score_df_str_list_o3 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/04_rcls/score_df_li_all_stromal_list"))
# 
# # dataframes of re-clustering scores after permutation comparing gene sets
# psdf_str_mark_signrand_o3 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_perg/perm_score_df_mark_li_all_stromal"))
# psdf_str_mmms_signrand_o3 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_perg/perm_score_df_mmms_li_all_stromal"))
# psdf_str_mmms_markrand_o3 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_perg/perm_score_df_mmms_mark_li_all_stromal"))
# 
# # perm score DF from background permutation (SIGN)
# psdf_str_sign_rand_o3 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/05_psig/perm_score_df_li_all_stromal"))

# perm score DF from background permutation (MARK)
# psdf_str_mark_rand_o1 <- base::readRDS(base::paste0(
#   base_path,
#   "/scRNAseq/main_analysis/sce_objects/03_sce_analysis/04_signatures/02_reclustering_other/07_pmrk/perm_score_df_li_all_stromal"))
```

```{r selected_seu_o3}

resolution_df_o3 <- resolution_df[resolution_df$dataset == dataset_o3,]

selected_seu_list_o3 <- lapply(seu_str_recl_list_o3, function(seu_list){
  
  conslev_curr <- seu_list[[1]]@misc$used_genes
  
  resdf_temp <- resolution_df_o3[
    resolution_df_o3$conservation_level == conslev_curr,]
  res_curr <- resdf_temp$resolution
  
  seu_return <- seu_list[[res_curr]]
  return(seu_return)
  
})

rm(seu_str_recl_list_o3)
gc()
```

```{r params}
# global params
source("determine_params.R")

cts_exclude <- c("Lymphoid ECs", "Chondrocytes")
print(cts_exclude)
```

```{r export_paths}
output_pdf_a_plot <- base::paste0(
  base_path, "/manuscript1/figure5/figure5_a.pdf")
output_pdf_a_legend <- base::paste0(
  base_path, "/manuscript1/figure5/figure5_a_legend.pdf")
output_pdf_b_plot <- base::paste0(
  base_path, "/manuscript1/figure5/figure5_b.pdf")
output_pdf_cd_plot <- base::paste0(
  base_path, "/manuscript1/figure5/figure5_cd.pdf")
output_pdf_e_plot <- base::paste0(
  base_path, "/manuscript1/figure5/figure5_e.pdf")
output_pdf_e_legend <- base::paste0(
  base_path, "/manuscript1/figure5/figure5_e_legend.pdf")
```

## Obtain data

```{r obtain_data}
#print(sort(geneset_list_str$Fibroblasts$conserved_signature))
#print(sort(geneset_list_str$`Sinusoidal ECs`$conserved_signature))
#print(sort(geneset_list_str$`Sinusoidal/Venular ECs`$conserved_signature))
#print(sort(geneset_list_str$`Arteriolar/Capillary ECs`$conserved_signature))
```

## A Expression heat map

Expression of conserved signature genes in all mouse species across HSPC
cell types (scaled by z-score per gene).

### Prep

```{r a_prep1}
# get all unique signature genes
all_sign_genes <- vector()
for(i in 1:length(geneset_list_str)){
  sign_genes <- geneset_list_str[[i]]$conserved_signature
  all_sign_genes <- c(all_sign_genes, sign_genes)
}
all_sign_genes_str <- base::unique(all_sign_genes)
```

```{r a_prep2}
# aggregate per cell type and species
cts_str <- as.list(names(geneset_list_str))

sce_str$species_pub <- vector(length = ncol(sce_str))
sce_str$species_pub[sce_str$Species_ID == "mmus"] <- "BL6"
sce_str$species_pub[sce_str$Species_ID == "mcas"] <- "CAST"
sce_str$species_pub[sce_str$Species_ID == "mspr"] <- "SPRET"
sce_str$species_pub[sce_str$Species_ID == "mcar"] <- "CAROLI"
sce_str$species_pub <- factor(sce_str$species_pub, 
                              levels = names(col_spc_pub))
# remove cell types to be removed
cts_str <- cts_str[!cts_str %in% cts_exclude]
cts_list <- as.list(cts_str)

sce_str <- sce_str[,!sce_str$celltypes %in% cts_exclude]
sce_str$celltypes <- factor(sce_str$celltypes, levels(sce_str$celltypes)[
  !levels(sce_str$celltypes) %in% cts_exclude])

# separate SCE objects by cell type, then aggregate the counts to obtain
# the average counts per species for each cell type separately
# use the multi-batchnorm-corrected logcounts 

agg_str_list <- lapply(cts_str, function(ct){
  
  sce_ct <- sce_str[,sce_str$celltypes == ct]
  agg_str <- scuttle::aggregateAcrossCells(
    sce_ct, 
    id=colData(sce_ct)[,c("species_pub")], 
    statistics = "mean",
    use.assay.type = "logcounts") #multibatchnorm
  
  return(agg_str)
})
names(agg_str_list) <- names(geneset_list_str)
```

```{r a_prep3}
expr_df_list_str <- lapply(agg_str_list, function(agg_str){
  
  # get current cell type and relevant signature genes
  ct_curr <- agg_str$celltypes[1]
  print(ct_curr)
  
  sign_genes_ct <- geneset_list_str[[
    which(names(geneset_list_str) == ct_curr)]]$conserved_signature
  print(head(sign_genes_ct))
  
  # get a df from average logcounts per ct and species
  vis_df <- base::as.data.frame(
    t(SummarizedExperiment::assays(agg_str)$logcounts))
  
  # subset to all signature genes of this tissue
  vis_df <- vis_df[,colnames(vis_df) %in% all_sign_genes_str]
  
  # change df format 
  vis_df <- tibble::rownames_to_column(vis_df, "species")
  vis_df <- tidyr::pivot_longer(vis_df, 
                                cols = c(2:ncol(vis_df)),
                                values_to = "expression",
                                names_to = "gene")
  
  # add ct info
  vis_df$cell_type <- base::rep(ct_curr)

  # add info on genes that are signature genes of this ct
  vis_df$is_sign_gene <- vector(length = nrow(vis_df))
  vis_df$is_sign_gene[vis_df$gene %in% sign_genes_ct] <- TRUE

  # scale expression of all genes per cell type 
  # for ordering of genes ONLY
  vis_df$scaled_expression_per_ct <- base::scale(vis_df$expression)
  vis_df <- vis_df[base::order(vis_df$scaled_expression_per_ct, 
                               decreasing = TRUE),]

  return(vis_df)
})

# bind dfs 
agg_str_df <- dplyr::bind_rows(expr_df_list_str)
```

```{r a_prep4}
# scale expression per gene using z-scores
agg_str_df$zscore_gene <- vector(length = nrow(agg_str_df), mode = "numeric")
for(g in base::unique(agg_str_df$gene)){
  
  expr_vector_g <- agg_str_df[agg_str_df$gene == g,]$expression

  # calculate z score per gene
  z_score_g <- (expr_vector_g - base::mean(expr_vector_g))/
    stats::sd(expr_vector_g)
  agg_str_df$zscore_gene[agg_str_df$gene == g] <- z_score_g
}
```

```{r a_prep5}
# get a well ordered list of unique genes for factorization (after order above)
all_sign_genes_for_factor <- base::unique(agg_str_df$gene[
  agg_str_df$is_sign_gene == TRUE])

# factorize
agg_str_df$gene <- factor(agg_str_df$gene,
                          levels = all_sign_genes_for_factor)
agg_str_df$species <- factor(agg_str_df$species,
                             levels = base::rev(names(col_spc_pub)))

#print(levels(agg_str_df$gene))
```

```{r a_prep6}
interest_genes <- c("Cxcl12",
                    "Marcks",
                    "Kitl",
                    "Cd34",
                    "Efnb2",
                    "Mmp13",
                    "Tie1",
                    "Actn4",
                    "Lrg1")

agg_str_df$is_gene <- vector(length = nrow(agg_str_df))
agg_str_df$is_gene[agg_str_df$gene %in% interest_genes] <- "TRUE"
agg_str_df$is_gene <- as.logical(agg_str_df$is_gene)

print(levels(agg_str_df$gene)[levels(agg_str_df$gene) %in% interest_genes])
```

#### Plot

```{r a_base_plot}
a_base_plot <- ggplot2::ggplot(
  agg_str_df,
  aes(y = species, x = gene, fill = zscore_gene))+
  ggplot2::geom_tile()+
  ggplot2::facet_grid(rows = vars(agg_str_df$cell_type))
```

```{r a_theme_plot}
a_theme_plot <- a_base_plot+
  theme_all+
  ggplot2::theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(
      vjust = 0.5,
      hjust = 0.5,
      color = col_cons_long["conserved identity signature"]),
    axis.title.y = element_blank(),
    axis.line.x = element_blank(),
    axis.text.y = element_text(
      angle = 0,
      vjust = 0.5,
      hjust = 1),
    strip.text.y = element_text(
      face = axis_text_face,
      size = axis_text_size,
      color = axis_text_color,
      angle = 0,
      vjust = 0.5,
      hjust = 0),
    strip.background.y = element_blank())+
  ggplot2::ggtitle("Conserved identity signature genes")+
  ggplot2::scale_fill_gradientn(
    "z-score per gene", 
    colours = colors_z_score,
    breaks = c(-5, -2.5,  0, 2.5, 5), 
    limits = c(-5,5))+
  ggplot2::scale_x_discrete(
    position =  "bottom",
    breaks = agg_str_df$gene[agg_str_df$is_gene])

a_legend <- ggpubr::get_legend(a_theme_plot)
a_legend <- ggpubr::ggarrange(a_legend)
```

#### Assemble

```{r a_assemble, fig.width = 5, fig.height = 5}
a_plot <- ggpubr::ggarrange(
  a_theme_plot + theme(legend.position = "none",
                       plot.title = element_blank())
)
a_plot
```

```{r a_plot_export}
pdf(output_pdf_a_plot, width = 6.5, height = 4)
a_plot
dev.off()
```

```{r a_legend_export}
pdf(output_pdf_a_legend, width = 3, height = 3)
a_legend
dev.off()
```

## BCD Re-clusterung Heatmaps 

Heatmaps of own re-clustered HSPC mouse data using signature genes/
conserved markers/BL6 markers/nDGEs.

For other datasets, this requires BLINDED RE-ANNOTATION BASED ON
CLUSTER MARKER GENES

### Prepare

```{r prepare_annotate_o2}

# mus tik stromal

seu_sign_o2 <- selected_seu_list_o2$seu_sign
reclustered_o2 <- base::unique(seu_sign_o2$seurat_clusters)

clust_list_o2 <- as.list(reclustered_o2)

ct_markers_o2 <- lapply(clust_list_o2, function(x){
  markers <- Seurat::FindMarkers(seu_sign_o2,
                                 test.use = "wilcox",
                                 ident.1 = x)
  markers <- markers[base::order(base::abs(markers$avg_log2FC), 
                                 decreasing=TRUE),]
  markers$which_cluster <- base::rep(x, nrow(markers))
  markers <- rownames_to_column(markers, var = "genes")
  
  return(markers)
})
names(ct_markers_o2) <- reclustered_o2

ct_markers_df_o2 <- bind_rows(ct_markers_o2)
head(ct_markers_df_o2)

```

```{r prepare_annotate_o3}

seu_sign_o3 <- selected_seu_list_o3$seu_sign
reclustered_o3 <- base::unique(seu_sign_o3$seurat_clusters)

clust_list_o3 <- as.list(reclustered_o3)

ct_markers_o3 <- lapply(clust_list_o3, function(x){
  markers <- Seurat::FindMarkers(seu_sign_o3,
                                 test.use = "wilcox",
                                 ident.1 = x)
  markers <- markers[base::order(base::abs(markers$avg_log2FC), 
                                 decreasing=TRUE),]
  markers$which_cluster <- base::rep(x, nrow(markers))
  markers <- rownames_to_column(markers, var = "genes")
  
  # need to add only ensembl gene symbols as I will not be using others
  markers$symbol <- markers$genes
  markers$symbol <- ensembl_sign$HSAPIENS_SYMBOL[
    base::match(markers$genes, ensembl_sign$ENSG_ID)]
  return(markers)
})
names(ct_markers_o3) <- reclustered_o3

ct_markers_df_o3 <- bind_rows(ct_markers_o3)
head(ct_markers_df_o3)

```

```{r prep_bcd}
# make a signature gene list with cell types of origin for helping annotation

signature_df <- data.frame(
  genes = unique(ensembl_sign$MMUS_SYMBOL),
  celltype = vector(length = length(unique(ensembl_sign$MMUS_SYMBOL)), mode = "character")
)

# ugly solution but works for this purpose
for(ct in names(geneset_list_str)){
  for(g in signature_df$genes){
    if(g %in% geneset_list_str[[ct]]$conserved_signature){
      signature_df[which(signature_df$genes == g),]$celltype <- paste(
        signature_df[which(signature_df$genes == g),]$celltype, ct)
    }
  }
}

```


#### Others -3

```{r umap_others_3}
DimPlot(seu_sign_o3, dims = c(1,2), group.by = "seurat_clusters")
DimPlot(seu_sign_o3, dims = c(1,2), group.by = "orig.ident")

seu_sign_o3$annotated_reclustered <- vector(length = ncol(seu_sign_o3))
```

order: 6, 1, 2, 0, 7, 4, 5, 3

```{r others3_cluster6}
nr <- "6"
markers <- ct_markers_o3[[nr]]$gene[
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05]

# check "CXCL12", "CXCL14", "EDIL3", "ABI3BP", "SOD3", "COL6A3", "ABCA8" rerun
ct_markers_o3[[nr]][
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05,][1:50,]

FeaturePlot(seu_sign_o3, markers[1:6])
FeaturePlot(seu_sign_o3, markers[7:12])
FeaturePlot(seu_sign_o3, markers[13:18])

FeaturePlot(seu_sign_o3, "ENSG00000107562") #CXCL12
FeaturePlot(seu_sign_o3, "ENSG00000145824") #CXCL14
FeaturePlot(seu_sign_o3, "ENSG00000164176") #EDIL3
FeaturePlot(seu_sign_o3, "ENSG00000154175") #ABI3BP
FeaturePlot(seu_sign_o3, "ENSG00000109610") #SOD3
FeaturePlot(seu_sign_o3, "ENSG00000163359") #COL6A3
FeaturePlot(seu_sign_o3, "ENSG00000141338") #ABCA8

# genes of interest
GOI <- c("CXCL12", "CXCL14", "EDIL3", "ABI3BP", "SOD3", "COL6A3", "ABCA8")
# mouse symbols of interest
SOI <- ensembl_sign$MMUS_SYMBOL[ensembl_sign$HSAPIENS_SYMBOL %in% GOI]
# cell types of origin for signature genes
signature_df[signature_df$genes %in% SOI,]

# CXCL12: CAR cell
# CXCL14: fibro, stromal, MSC
# ABCA8: cancer fibro, normal fibro, lipo
# EDIL3: osteo, EMT, CAR/Osteo
# ABI3BP: MSC, quiescence, osteogenic and adipogenic differentiation, cartilage
# SOD3: Chondro + osteogenesis, MSC, cartilage
# COL6A3: osteoadipo diff, chondro

seu_sign_o3$annotated_reclustered[seu_sign_o3$seurat_clusters == nr] <- "Fibro/Chondro-like CAR"
```

```{r others3_cluster1}
nr <- "1"
markers <- ct_markers_o3[[nr]]$gene[
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05]

# check "CXCL12", "FSTL1", "MME", "HP", "TJP1", "SPARCL1", "FBN1", "RSPO3", "FBLN5" rerun
ct_markers_o3[[nr]][
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05,][1:50,]

FeaturePlot(seu_sign_o3, markers[1:6])
FeaturePlot(seu_sign_o3, markers[7:12])
FeaturePlot(seu_sign_o3, markers[13:18])

FeaturePlot(seu_sign_o3, "ENSG00000107562") #CXCL12
FeaturePlot(seu_sign_o3, "ENSG00000163430") #FSTL1
FeaturePlot(seu_sign_o3, "ENSG00000196549") #MME
FeaturePlot(seu_sign_o3, "ENSG00000257017") #HP
FeaturePlot(seu_sign_o3, "ENSG00000104067") #TJP1
FeaturePlot(seu_sign_o3, "ENSG00000152583") #SPARCL1
FeaturePlot(seu_sign_o3, "ENSG00000166147") #FBN1
FeaturePlot(seu_sign_o3, "ENSG00000146374") #RSPO3
FeaturePlot(seu_sign_o3, "ENSG00000140092") #FBLN5

GOI <- c("CXCL12", "FSTL1", "MME", "HP", "TJP1", "SPARCL1", "FBN1",
         "RSPO3", "FBLN5")
SOI <- ensembl_sign$MMUS_SYMBOL[ensembl_sign$HSAPIENS_SYMBOL %in% GOI]
signature_df[signature_df$genes %in% SOI,]

# CXCL12: CAR cell
# FSTL1: MSC protection, differentiation, to chondrocytes, adipogenesis 
# HP: adipogenesis
# MME: osteo and adipo genesis, enriched in osteoblasts, preadipocytes
# TJP1: tight junction protein, MSC migration 
# SPARCL1: MSCs/Progs, skeletal stem cell, chondro/fibro, negative for adipog.
# FBN1: related to TGFÎ², MSC diff, MSC niche/decisions, MSC activitiy
# RSPO3: osteoblast, niche, bone density

seu_sign_o3$annotated_reclustered[seu_sign_o3$seurat_clusters == nr] <- "multi-lineage CAR"
```

```{r others3_cluster2}
nr <- "2"
markers <- ct_markers_o3[[nr]]$gene[
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05]

# check "CXCL12", "KITL", "PDGFRB", "FBN1", "COL3A1", "C1S", "SPARCL1", "ABCA8" rerun
ct_markers_o3[[nr]][
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05,][1:50,]

FeaturePlot(seu_sign_o3, markers[1:6])
FeaturePlot(seu_sign_o3, markers[7:12])
FeaturePlot(seu_sign_o3, markers[13:18])

FeaturePlot(seu_sign_o3, "ENSG00000107562") #CXCL12
FeaturePlot(seu_sign_o3, "ENSG00000049130") #KITL
FeaturePlot(seu_sign_o3, "ENSG00000113721") #PDGFRB
FeaturePlot(seu_sign_o3, "ENSG00000166147") #FBN1
FeaturePlot(seu_sign_o3, "ENSG00000168542") #COL3A1
FeaturePlot(seu_sign_o3, "ENSG00000182326") #C1S
FeaturePlot(seu_sign_o3, "ENSG00000152583") #SPARCL1
FeaturePlot(seu_sign_o3, "ENSG00000141338") #ABCA8

GOI <- c("CXCL12", "KITL", "PDGFRB", "FBN1", "COL3A1", "C1S", "SPARCL1",
         "ABCA8")
SOI <- ensembl_sign$MMUS_SYMBOL[ensembl_sign$HSAPIENS_SYMBOL %in% GOI]
signature_df[signature_df$genes %in% SOI,]

# CXCL12: CAR cell
# PDGFRB: fibroblast activation, MSC
# FBN1: related to TGFÎ², MSC diff, MSC niche/decisions, MSC activitiy
# COL3A1: Fibro
# C1S; chondrocytes, ossification, cartilage remodelling 
# SPARCL1: MSCs/Progs, skeletal stem cell, chondro/fibro, negative for adipog.
# ABCA8: cancer fibro, normal fibro, lipo

seu_sign_o3$annotated_reclustered[seu_sign_o3$seurat_clusters == nr] <- "Fibro-like CAR"
```

```{r others3_cluster0}
nr <- "0"
markers <- ct_markers_o3[[nr]]$gene[
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05]

# check "CXCL12", "EMP1", "ID1", "DEPP1", "LMNA", "FABP4", "OSR2", "PPP1R15A" rerun
ct_markers_o3[[nr]][
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05,]

FeaturePlot(seu_sign_o3, markers[1:6])
FeaturePlot(seu_sign_o3, markers[7:12])
FeaturePlot(seu_sign_o3, markers[13:18])

FeaturePlot(seu_sign_o3, "ENSG00000107562") #CXCL12
FeaturePlot(seu_sign_o3, "ENSG00000134531") #EMP1
FeaturePlot(seu_sign_o3, "ENSG00000166147") #ID1
FeaturePlot(seu_sign_o3, "ENSG00000165507") #DEPP1
FeaturePlot(seu_sign_o3, "ENSG00000160789") #LMNA  
FeaturePlot(seu_sign_o3, "ENSG00000170323") #FABP4
FeaturePlot(seu_sign_o3, "ENSG00000164920") #OSR2
FeaturePlot(seu_sign_o3, "ENSG00000087074") #PPP1R15A

GOI <- c("CXCL12", "EMP1", "ID1", "DEPP1", "LMNA", "FABP4", "OSR2",
         "PPP1R15A")
SOI <- ensembl_sign$MMUS_SYMBOL[ensembl_sign$HSAPIENS_SYMBOL %in% GOI]
signature_df[signature_df$genes %in% SOI,]

# CXCL12: CAR cell
# EMP1: fibro, growth
# ID1: required for HSC niche, osteogenic
# DEPP1: committed pre-adipocytes, cancer fibroblasts, autoophagy
# LMNA:  osteoporosis, migration and osteogenesis, anti-chondro diff 
# FABP4: adipogenic, MSC, fatty acid metabolic, marrow adipocytes, adipogenesis 
# OSR2:  uncommited adipose progenitors 
# PPP1R15A: adipocytic signalling, autophagy and stress

seu_sign_o3$annotated_reclustered[seu_sign_o3$seurat_clusters == nr] <- "Adipo-like CAR"
```

```{r}
DimPlot(seu_sign_o3, dims = c(1,2), group.by = "seurat_clusters")
```

```{r others3_cluster7}
nr <- "7"
markers <- ct_markers_o3[[nr]]$gene[
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05]

# check "CPE", "SP7", "PTPRD", "RUNX2", "PALS2", "OMD", "MMP13", "PTH1R", "CD9" rerun
ct_markers_o3[[nr]][
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05,][1:50,]

FeaturePlot(seu_sign_o3, markers[1:6])
FeaturePlot(seu_sign_o3, markers[7:12])
FeaturePlot(seu_sign_o3, markers[13:18])

FeaturePlot(seu_sign_o3, "ENSG00000107562") #CXCL12 actually only weakly expr.

GOI <- c("CPE", "SP7", "PTPRD", "RUNX2", "PALS2", "OMD", "MMP13",
         "PTH1R", "CD9")
SOI <- ensembl_sign$MMUS_SYMBOL[ensembl_sign$HSAPIENS_SYMBOL %in% GOI]
signature_df[signature_df$genes %in% SOI,]

# CPE, SP7, PTPRD, RUNX2, PALS2, OMD, MMP13, PTH1R, CD9
seu_sign_o3$annotated_reclustered[seu_sign_o3$seurat_clusters == nr] <- "Osteo-Chondro"
```

```{r}
DimPlot(seu_sign_o3, dims = c(1,2), group.by = "seurat_clusters")
```

```{r others3_cluster5}
nr <- "5"
markers <- ct_markers_o3[[nr]]$gene[
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05]

# check "CD34", "RGCC", "TSPAN13", "CAPG", "MGST1", "GPX1", "PPP1R14B", "TXN", "CD36", "NOTCH1"
ct_markers_o3[[nr]][
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05,][1:50,]

FeaturePlot(seu_sign_o3, markers[1:6])
FeaturePlot(seu_sign_o3, markers[7:12])
FeaturePlot(seu_sign_o3, markers[13:18])

FeaturePlot(seu_sign_o3, "ENSG00000106537") #TSPAN13
FeaturePlot(seu_sign_o3, "ENSG00000149564") #ESAM # BARELY EXPR
FeaturePlot(seu_sign_o3, "ENSG00000042493") #CAPG
FeaturePlot(seu_sign_o3, "ENSG00000174059") #CD34
FeaturePlot(seu_sign_o3, "ENSG00000102760") #RGCC
FeaturePlot(seu_sign_o3, "ENSG00000008394") #MGST1
FeaturePlot(seu_sign_o3, "ENSG00000135218") #CD36
FeaturePlot(seu_sign_o3, "ENSG00000148400") #NOTCH1

GOI <- c("CD34", "RGCC", "TSPAN13", "CAPG", "MGST1", "GPX1",
         "PPP1R14B", "TXN", "CD36", "NOTCH1")
SOI <- ensembl_sign$MMUS_SYMBOL[ensembl_sign$HSAPIENS_SYMBOL %in% GOI]
signature_df[signature_df$genes %in% SOI,]

# CD36: related to FA uptake, angiogenesis, response to injury
# TSPAN13: dysfunctional endothelium 
# CAPG: motility and shear stress in ECs 
# MGST1: antioxidant, oxidative stress
# GPX1: oxidative stress, endothelial dysfunction
# PPP1R14B: endo migration
# CD34: arteriolar
# TXN: antioxidant (thioredoxin), redox sensor 
# RGCC capillary
# CD34 a little bit

seu_sign_o3$annotated_reclustered[seu_sign_o3$seurat_clusters == nr] <- "EC1"
```

```{r others3_cluster3}
nr <- "3"
markers <- ct_markers_o3[[nr]]$gene[
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05]

# check "PECAM1", "FLI1", "ICAM2", "CRIP1", "FCER1G", "SH2D3C"
ct_markers_o3[[nr]][
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05,][1:50,]

FeaturePlot(seu_sign_o3, markers[1:6])
FeaturePlot(seu_sign_o3, markers[7:12])
FeaturePlot(seu_sign_o3, markers[13:18])

FeaturePlot(seu_sign_o3, "ENSG00000261371") #PECAM1 
FeaturePlot(seu_sign_o3, "ENSG00000151702") #FLI1

FeaturePlot(seu_sign_o3, "ENSG00000108622") #ICAM2
FeaturePlot(seu_sign_o3, "ENSG00000213145") #CRIP1
FeaturePlot(seu_sign_o3, "ENSG00000158869") #FCER1G
FeaturePlot(seu_sign_o3, "ENSG00000108622") #ICAM2
FeaturePlot(seu_sign_o3, "ENSG00000095370") #SH2D3C

GOI <- c("PECAM1", "FLI1", "ICAM2", "CRIP1", "FCER1G", "SH2D3C")
SOI <- ensembl_sign$MMUS_SYMBOL[ensembl_sign$HSAPIENS_SYMBOL %in% GOI]
signature_df[signature_df$genes %in% SOI,]

# SH2D3C: capillary signalling

seu_sign_o3$annotated_reclustered[seu_sign_o3$seurat_clusters == nr] <- "EC3"
```

```{r others3_cluster4}
nr <- "4"
markers <- ct_markers_o3[[nr]]$gene[
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05]

# check "CELF2", "LYN", "PECAM1", "SRGN", "NFKBIA"
ct_markers_o3[[nr]][
  !is.na(ct_markers_o3[[nr]]$symbol) & 
    ct_markers_o3[[nr]]$avg_log2FC > 0 &
    ct_markers_o3[[nr]]$p_val_adj < 0.05,][1:50,]

FeaturePlot(seu_sign_o3, markers[1:6])
FeaturePlot(seu_sign_o3, markers[7:12])
FeaturePlot(seu_sign_o3, markers[13:18])

FeaturePlot(seu_sign_o3, "ENSG00000048740") #CELF2
FeaturePlot(seu_sign_o3, "ENSG00000254087") #LYN
FeaturePlot(seu_sign_o3, "ENSG00000261371") #PECAM1
FeaturePlot(seu_sign_o3, "ENSG00000122862") #SRGN
FeaturePlot(seu_sign_o3, "ENSG00000100906") #NFKBIA

GOI <- c("CELF2", "LYN", "PECAM1", "SRGN", "NFKBIA")
SOI <- ensembl_sign$MMUS_SYMBOL[ensembl_sign$HSAPIENS_SYMBOL %in% GOI]
signature_df[signature_df$genes %in% SOI,]

seu_sign_o3$annotated_reclustered[seu_sign_o3$seurat_clusters == nr] <- "EC2"
```

#### Others 2

```{r umap_others_2}
DimPlot(seu_sign_o2, dims = c(1,2), group.by = "seurat_clusters")
DimPlot(seu_sign_o2, dims = c(1,2), group.by = "batch")
# 1 = non-pbs
# 2 = pbs
# 3 = non-pbs

# 4 = non-pbs
# 0 = pbs

seu_sign_o2$annotated_reclustered <- vector(length = ncol(seu_sign_o2))
```

Order: 0, 5, 4, 7, 10, 9, 11, 8, 12, 13, 6, 1, 2, 3

```{r others2_cluster0}
nr <- "0"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Mgp", "Cxcl12", "Hp", "Notch3", "Ebf3", "Dpep1", "Cxcl14", "Cyp1b1", "Esm1"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

FeaturePlot(seu_sign_o2, "Cxcl12")

SOI <-  c("Mgp", "Cxcl12", "Hp", "Notch3", "Ebf3", "Dpep1", "Cxcl14", "Cyp1b1",
          "Esm1")
signature_df[signature_df$genes %in% SOI,]

# Mgp: adipogenesis
# Hp: adipocytes
# Notch3: osteoblastic - lymphoid niche
# Dpep1: adipogenic

seu_sign_o2$annotated_reclustered[
  seu_sign_o2$seurat_clusters == nr] <- "Adipo/CAR1, pbs"
```

```{r others2_cluster5}
nr <- "5"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Alpl", "Limch1", "Lrp4", "Dlx5", "Olfml3", "Sp7", "Pth1r", "Satb2", "Cxcl12"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

FeaturePlot(seu_sign_o2, "Cxcl12")

SOI <-  c("Alpl", "Limch1", "Lrp4", "Dlx5", "Olfml3", "Sp7", "Pth1r", "Satb2",
          "Cxcl12")
signature_df[signature_df$genes %in% SOI,]

# Alpl: Osteo
# Sp7: Osteo
# Pth1r: Osteo-Chondro

seu_sign_o2$annotated_reclustered[
  seu_sign_o2$seurat_clusters == nr] <- "Osteo/CAR"
```

```{r others2_cluster4}
nr <- "4"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Angptl1", "Kitl", "Esm1", "Igfbp5", "Mme", "C1s1", "Dpep1", "Vegfc", "Cxcl12"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

FeaturePlot(seu_sign_o2, "Cxcl12")

SOI <-  c("Angptl1", "Kitl", "Esm1", "Igfbp5", "Mme", "C1s1", "Dpep1", "Vegfc",
          "Cxcl12")
signature_df[signature_df$genes %in% SOI,]

# Kitl: CAR
# Dpep: adipo

seu_sign_o2$annotated_reclustered[
  seu_sign_o2$seurat_clusters == nr] <- "Adipo/CAR3, non-pbs"
```

```{r others2_cluster7}
nr <- "7"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Mmp13", "Slit2", "Lrp4", "Ptgis", "Gpc1", "Mrc2", "S100a6", "Satb2", "Pth1r", "Cfh"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

SOI <-  c("Mmp13", "Slit2", "Lrp4", "Ptgis", "Gpc1", "Mrc2", "S100a6", "Satb2",
          "Pth1r", "Cfh")
signature_df[signature_df$genes %in% SOI,]

# Sp7, Runx2, Alpl, Satb2, Ptgis, S100a6 are strongly osteogenic
# Mmp13, Pth1r, Tpm1 are also kind of chondro

seu_sign_o2$annotated_reclustered[seu_sign_o2$seurat_clusters == nr] <- "Osteo-Chondro"
```

```{r others2_cluster10}
nr <- "10"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Aspn", "Edil3", "Fmod", "Lum", "Mmp2", "Prrx2", "Sema3c"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

SOI <-  c("Aspn", "Edil3", "Fmod", "Lum", "Mmp2", "Prrx2", "Sema3c")
signature_df[signature_df$genes %in% SOI,]

# Fmod: Chondro/fibro
# Lum: fibro/chondro
# Prrx2: chondro, osteogenic
# Sema3c: Chondro, related to Itgbl1, cartilage

seu_sign_o2$annotated_reclustered[
  seu_sign_o2$seurat_clusters == nr] <- "Fibro-Chondro"
```

```{r others2_cluster9}
nr <- "9"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Thbs4", "Clec3b", "Crispld2", "Tnxb", "Itgbl1", "Sema3c", "Prrx2"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

# Thbs4: articular cartilage, articular stem and progenitor cells, 
# Clec3b osteoblasts, mineralization
# Crispld2: osteogenic potential, cartilage, osteparthritis, cartilage
# Tnxb articular cartilage
# Itgbl1, developing chondrocytes 
# Sema3c related to Itgbl1, cartilage
# Prrx2 osteogenic

SOI <-  c("Thbs4", "Clec3b", "Crispld2", "Tnxb", "Itgbl1", "Sema3c", "Prrx2")
signature_df[signature_df$genes %in% SOI,]

seu_sign_o2$annotated_reclustered[
  seu_sign_o2$seurat_clusters == nr] <- "Chondro"
```

```{r others2_cluster11}
nr <- "11"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Scara5", "Pdgfrb", "Snrk", "Ebf3", "Ltbp3", "Mgp", "Hp", "Foxc1"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:4])
FeaturePlot(seu_sign_o2, markers[5:8])
FeaturePlot(seu_sign_o2, markers[9:12])
FeaturePlot(seu_sign_o2, markers[13:16])

SOI <-  c("Scara5", "Pdgfrb", "Snrk", "Ebf3", "Ltbp3", "Mgp", "Hp", "Foxc1")
signature_df[signature_df$genes %in% SOI,]

# Scara5: adipogenesis
# Pdgfrb: fibro
# Ltbp3: early MSC diff, downregulated during osteo, required for adipo
# Foxc1: highly adipo
# Snrk:  adipo

seu_sign_o2$annotated_reclustered[
  seu_sign_o2$seurat_clusters == nr] <- "Adipo/CAR2, pbs"
```

```{r others2_cluster8}
nr <- "8"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Serpinf1", "Sgms2", "Col5a2", "Cpe", "Dcn", "Satb2", "Sp7", "Serpinh1", "Lum", "Ptgis"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

SOI <-  c("Serpinf1", "Sgms2", "Col5a2", "Cpe", "Dcn", "Satb2", "Sp7",
          "Serpinh1", "Lum", "Ptgis")
signature_df[signature_df$genes %in% SOI,]

# Serpins; related to osteogenesis
# Sgms2: osteogenesis and osteo blasts
# Col5a2: osteo progenitors, 
# Satb2: osteogenesis
# Sp7: osteo
# Ptgis higher in osteo diff

seu_sign_o2$annotated_reclustered[seu_sign_o2$seurat_clusters == nr] <- "Osteo1"
```

```{r others2_cluster12}
nr <- "12"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Ackr3", "Jam2", "Mustn1", "Cryab", "Sgms2", "Ptgis"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

SOI <-  c("Ackr3", "Jam2", "Mustn1", "Cryab", "Sgms2", "Ptgis")
signature_df[signature_df$genes %in% SOI,]

# Ackr3: osteogenic differentiation
# Mustn1: pan osteo muscle, muscle
# Cryab: increased during osteogebic diff in human, osteogenesis 
# Sgms2: osteogenesis and osteo blasts
# Ptgis: osteo

seu_sign_o2$annotated_reclustered[seu_sign_o2$seurat_clusters == nr] <- "Osteo2"
```

```{r others2_cluster13}

nr <- "13"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Serpinf1", "Cpe", "Col5a2", "Sgms2", "Mmp2", "Thbs1", "Lum", "Col5a1", "Omd", "Ptgis", "Satb2", "Sp7"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

SOI <-  c("Serpinf1", "Cpe", "Col5a2", "Sgms2", "Mmp2", "Thbs1", "Lum",
          "Col5a1", "Omd", "Ptgis", "Satb2", "Sp7")
signature_df[signature_df$genes %in% SOI,]

# high expression of Osteo-markers

seu_sign_o2$annotated_reclustered[seu_sign_o2$seurat_clusters == nr] <- "Osteo3"
```

```{r others2_cluster6}

nr <- "6"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check for "Mcf2l", "Cd34", "Lims2", "Mecom", "Cav1", "Sparcl1" in rerun
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

# marker genes (cap)
FeaturePlot(seu_sign_o2, "Mcf2l")
FeaturePlot(seu_sign_o2, "Cd34")
FeaturePlot(seu_sign_o2, "Lims2")
FeaturePlot(seu_sign_o2, "Mecom")
FeaturePlot(seu_sign_o2, "Cav1")
FeaturePlot(seu_sign_o2, "Sparcl1")

# arteriolar genes
FeaturePlot(seu_sign_o2, "Sox18")
FeaturePlot(seu_sign_o2, "Efnb2")

# cap gene
FeaturePlot(seu_sign_o2, "Rgcc") 

SOI <-  c("Mcf2l", "Cd34", "Lims2", "Mecom", "Cav1", "Sparcl1")
signature_df[signature_df$genes %in% SOI,]

# Mcf2l capillary 
# Cd34 capillary, EC prolif, progenitor
# Lims2 shear stress, capillary and post capillary venule
# Cav1 not specific to one EC subtype, differentiation 30% of capillary surface
# Sparcl1 quiescence, stability, capillary morphogenesis, capillary inflammation
# Mecom EC differentiation, arterial identity, artery 

seu_sign_o2$annotated_reclustered[seu_sign_o2$seurat_clusters == nr] <- "Art/Cap-EC"
```

```{r others2_cluster1}

nr <- "1"

markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check for "Axl", "Lpar6", "Clec14a", "Ephb4" in rerun
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

FeaturePlot(seu_sign_o2, "Axl")
FeaturePlot(seu_sign_o2, "Lpar6")
FeaturePlot(seu_sign_o2, "Aebp1")
FeaturePlot(seu_sign_o2, "Tgfbi")
FeaturePlot(seu_sign_o2, "Clec14a")
FeaturePlot(seu_sign_o2, "Prex2")
FeaturePlot(seu_sign_o2, "Lrg1")

# AEC
FeaturePlot(seu_sign_o2, "Sox18")
FeaturePlot(seu_sign_o2, "Clec14a")

# VEC
FeaturePlot(seu_sign_o2, "Nr2f2")
FeaturePlot(seu_sign_o2, "Ephb4")
FeaturePlot(seu_sign_o2, "Vcam1")

# non capillary
FeaturePlot(seu_sign_o2, "Rgcc")
FeaturePlot(seu_sign_o2, "Cd34")

# this cluster is mostly marked by NEGATIVE markers

SOI <-  c("Axl", "Lpar6", "Clec14a", "Ephb4")
signature_df[signature_df$genes %in% SOI,]

# Axl: flow-dependent modelling, remodelling
# Lpar6: EC barrier, angiogenesis
# Aebp1: tumor ECs, proliferation, migration, angiogenesis, microvessel

seu_sign_o2$annotated_reclustered[seu_sign_o2$seurat_clusters == nr] <- "Ven EC1, non-pbs"
```

```{r others2_cluster2}

nr <- "3"
markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Tmcc3", "Dll4", "Klf4", "Itga6", "Nr2f2", "Vcam1", "Nfkbia", "Spry2"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,][1:50,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

FeaturePlot(seu_sign_o2, "Tmcc3")
FeaturePlot(seu_sign_o2, "Spry2")
FeaturePlot(seu_sign_o2, "Sdc4")
FeaturePlot(seu_sign_o2, "Nfkbia")

FeaturePlot(seu_sign_o2, "Klf4") # angiogenesis
FeaturePlot(seu_sign_o2, "Rgcc") # capillary
 
# VEC 
FeaturePlot(seu_sign_o2, "Nr2f2") 
FeaturePlot(seu_sign_o2, "Ephb4") 
FeaturePlot(seu_sign_o2, "Vcam1") 

SOI <-  c("Tmcc3", "Dll4", "Klf4", "Itga6", "Nr2f2", "Vcam1", "Nfkbia", "Spry2")
signature_df[signature_df$genes %in% SOI,]

# Tmcc3  
# Spry2: related to Dll4, negatively regulate angiogenesis 
# Klf4: integrity, pro inflammation and prolif, homeostatic, angiogenesis
# Dll4: arterial diff, sprouting angiogenesis and artery formation, capillary  tip cells, capillarization of liver sinusoids 
# Itga6; angiogenesis, tumor ECs, related to sprouting, 
# Sdc4: wound healing and angiogenesis EC dysfunction or inflammation 

seu_sign_o2$annotated_reclustered[seu_sign_o2$seurat_clusters == nr] <- "Ven EC3, non-pbs"
```

```{r others2_cluster3}

nr <- "2"

markers <- ct_markers_o2[[nr]]$genes[
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL]

# check "Fabp4", "Ier3", "Cd36", "Lrg1", "Srgn", "Cldn5", "Fam167b", "Vcam1"
ct_markers_o2[[nr]][
    ct_markers_o2[[nr]]$avg_log2FC > 0 &
    ct_markers_o2[[nr]]$p_val_adj < 0.05 &
    ct_markers_o2[[nr]]$genes %in% ensembl_sign$MMUS_SYMBOL,]

FeaturePlot(seu_sign_o2, markers[1:6])
FeaturePlot(seu_sign_o2, markers[7:12])
FeaturePlot(seu_sign_o2, markers[13:18])

FeaturePlot(seu_sign_o2, "Vcam1") # activation
FeaturePlot(seu_sign_o2, "Kdr") # activation
FeaturePlot(seu_sign_o2, "Cd36") # activation all kind of unspecific

FeaturePlot(seu_sign_o2, "Ier3") 
FeaturePlot(seu_sign_o2, "Fabp4")
FeaturePlot(seu_sign_o2, "Fam167b") 

FeaturePlot(seu_sign_o2, "Il6st")
FeaturePlot(seu_sign_o2, "Fabp4")
FeaturePlot(seu_sign_o2, "Lrg1")

SOI <-  c("Fabp4", "Ier3", "Cd36", "Lrg1", "Srgn", "Cldn5", "Fam167b", "Vcam1")
signature_df[signature_df$genes %in% SOI,]

# Fabp4 in ECs related to VEGFA and DLL4, pro-angiogenic
# Ier3: immediate early response
# Cd36: also related to fatty acid, FA uptake, angiogenesis, response to injury
# Lrg1: angiogenesis, mitogenic, neovascularization, 
# Srgn: shear-stress response
# Cldn5 - sinusoidal in human, tight junction protein in ECs
# Fam167b, aorta-specific EC, pancreas ECs, kidney capillary cells

seu_sign_o2$annotated_reclustered[
  seu_sign_o2$seurat_clusters == nr] <- "Ven EC2, pbs"
```

### Plots

#### Own

```{r mat_sign}
mat_sign <- base::table(
  sce_str_recl$celltypes, 
  sce_str_recl$cluster_signt)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign)){
  mat_sign[,i] <- mat_sign[,i]/base::sum(mat_sign[,i])
}
sign_df <- base::as.data.frame(mat_sign)

#manually factorise clusters for nice order
sign_df$Var2 <- factor(
  sign_df$Var2,
  levels = base::rev(c(4, 8, 1, 3, 5, 2, 6, 7)))
```

```{r sign_base_plot}
sign_base_plot <- ggplot2::ggplot(
  sign_df, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r sign_theme_plot}
sign_theme_plot <- sign_base_plot+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5),
    axis.ticks.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::ylab("Reclustered")
```

### Other 2

```{r mat_sign_o2}
mat_sign_o2 <- base::table(seu_sign_o2$cell_type, 
                           seu_sign_o2$annotated_reclustered)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign_o2)){
  mat_sign_o2[,i] <- mat_sign_o2[,i]/base::sum(mat_sign_o2[,i])
}
sign_df_o2 <- base::as.data.frame(mat_sign_o2)

sign_df_o2$Var2 <- unfactor(sign_df_o2$Var2)

sign_df_o2$Var2 <- factor(
  sign_df_o2$Var2,
  levels = base::rev(c(
    "Adipo/CAR1, pbs",
    "Adipo/CAR2, pbs",
    "Adipo/CAR3, non-pbs",
    "Osteo/CAR",
    "Osteo-Chondro",
    "Fibro-Chondro",
    "Chondro",
    "Osteo1",
    "Osteo2",
    "Osteo3",
    "Art/Cap-EC",
    "Ven EC1, non-pbs",
    "Ven EC2, pbs",
    "Ven EC3, non-pbs"
)))

sign_df_o2$Var1 <- unfactor(sign_df_o2$Var1)
sign_df_o2$Var1[sign_df_o2$Var1 == "P1"] <- "P1 adipogenesis1"
sign_df_o2$Var1[sign_df_o2$Var1 == "P2"] <- "P2 adipogenesis2"
sign_df_o2$Var1[sign_df_o2$Var1 == "P3"] <- "P3 osteo early"
sign_df_o2$Var1[sign_df_o2$Var1 == "P4"] <- "P4 osteo later"

sign_df_o2$Var1[sign_df_o2$Var1 == "O1"] <- "O1 osteo, Col16a"
sign_df_o2$Var1[sign_df_o2$Var1 == "O2"] <- "O2 osteo-chondro"
sign_df_o2$Var1[sign_df_o2$Var1 == "O3"] <- "O3 osteoblasts"

sign_df_o2$Var1[sign_df_o2$Var1 == "V1"] <- "V1 arterial"
sign_df_o2$Var1[sign_df_o2$Var1 == "V2"] <- "V2 sinusoidal" 

sign_df_o2$Var1 <- factor(
  sign_df_o2$Var1,
  levels = c(
    "P1 adipogenesis1",
    "P2 adipogenesis2",
    "P3 osteo early",
    "P4 osteo later",
    "O1 osteo, Col16a",
    "O2 osteo-chondro",
    "O3 osteoblasts",
    "V1 arterial",
    "V2 sinusoidal" 
))
unique(seu_sign_o2$annotated_reclustered)

```

```{r sign_base_plot_o2}
sign_base_plot_o2 <- ggplot2::ggplot(
  sign_df_o2, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r sign_theme_plot_o2, fig.height = 5.5, fig.width = 5}
sign_theme_plot_o2 <- sign_base_plot_o2+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.text.y = element_text(
      hjust = 1),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5),
    axis.ticks.y = element_blank())+
  ggplot2::scale_fill_gradientn(
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))+
  ggplot2::xlab("Original cell types")+
  ggplot2::ylab("Reclustered & Re-annotated")
sign_theme_plot_o2
```

### Other 3

```{r mat_sign_o3}
mat_sign_o3 <- base::table(seu_sign_o3$cell_type, 
                           seu_sign_o3$annotated_reclustered)

# normalise per column = new clusters and turn into DF
for(i in 1:ncol(mat_sign_o3)){
  mat_sign_o3[,i] <- mat_sign_o3[,i]/base::sum(mat_sign_o3[,i])
}
sign_df_o3 <- base::as.data.frame(mat_sign_o3)

sign_df_o3$Var2 <- factor(
  sign_df_o3$Var2,
  levels = base::rev(c(
    "Fibro-like CAR",
    "Fibro/Chondro-like CAR",
    "multi-lineage CAR",
    "Adipo-like CAR",
    "Osteo-Chondro",
    "EC1",
    "EC2",
    "EC3"
    )))

sign_df_o3$Var1 <- unfactor(sign_df_o3$Var1)
sign_df_o3$Var1[sign_df_o3$Var1 == "multipotent stromal stem cells"] <- "stromal stem cell"
sign_df_o3$Var1[sign_df_o3$Var1 == "balanced prog."] <- "balanced prog"
sign_df_o3$Var1[sign_df_o3$Var1 == "highly adipocytic gene-expressing progenitors"] <- "adipo-prog"
sign_df_o3$Var1[sign_df_o3$Var1 == "osteochondrogenic progenitors 1"] <- "osteo-chondro prog 1"
sign_df_o3$Var1[sign_df_o3$Var1 == "osteochondrogenic progenitors 2"] <- "osteo-chondro prog 2"

sign_df_o3$Var1 <- factor(
  sign_df_o3$Var1,
  levels = c(
    "stromal stem cell",
    "balanced prog",
    "adipo-prog",
    "pre-osteoblast",
    "osteo-chondro prog 1",
    "osteo-chondro prog 2",
    "pre-fibroblast 1",
    "pre-fibroblast 2",
    "pre-fibroblast 3",
    "endothelial"
    ))
```

```{r sign_base_plot_o3}
sign_base_plot_o3 <- ggplot2::ggplot(
  sign_df_o3, 
  aes(x = Var1, 
      y = Var2,
      fill = Freq))+
  ggplot2::geom_tile()
```

```{r sign_theme_plot_o3}
sign_theme_plot_o3 <- sign_base_plot_o3+
  theme_all+
  ggplot2::theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text.y = element_text(
      hjust = 1),
    axis.text.x = element_text(
      angle = 90,
      hjust = 0,
      vjust = 0.5),
    axis.ticks.y = element_blank())+
   ggplot2::scale_fill_gradientn(
    "Proportion of cells per cluster",
    colors = mycolors_to1,
    limits = c(0, 1),
    breaks = c(0, 0.5, 1))
sign_theme_plot_o3
```

### Assemble

```{r assemble_cd, fig.width = 15, fig.height =5.5}

cd_plots <- ggpubr::ggarrange(
  ncol = 2,
  align = "h",
  sign_theme_plot_o2,
  sign_theme_plot_o3,
  widths = c(1.6, 1.4))

```

```{r b_plot_export}
pdf(output_pdf_b_plot, width = 5, height = 5.5)
sign_theme_plot
dev.off()
```

```{r cd_plot_export}
pdf(output_pdf_cd_plot, width = 15, height = 7)
cd_plots
dev.off()
```

```{r session_info}
utils::sessionInfo()
```
